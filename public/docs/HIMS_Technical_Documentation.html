<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIMS Technical Documentation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        @page {
            size: A4;
            margin: 20mm 15mm 20mm 15mm;
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 9px;
                color: #718096;
                font-family: 'Inter', sans-serif;
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.75;
            color: #000000;
            max-width: 100%;
            margin: 0;
            padding: 0;
            font-size: 11.5px;
            font-weight: 400;
            letter-spacing: -0.011em;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        /* Cover Page */
        .cover-page {
            page-break-after: always;
            min-height: 100vh;
            display: block;
            text-align: center;
            background: #0066CC;
            color: white;
            padding: 80px 40px;
        }

        .cover-logo {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .cover-logo span {
            font-size: 52px;
            font-weight: 700;
            color: #0066CC;
            font-family: 'Playfair Display', Georgia, serif;
        }

        .cover-title {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            font-family: 'Playfair Display', Georgia, serif;
            letter-spacing: -0.02em;
            color: white;
        }

        .cover-subtitle {
            font-size: 20px;
            margin-bottom: 40px;
            font-weight: 300;
            letter-spacing: 0.02em;
            color: white;
        }

        .cover-description {
            font-size: 14px;
            max-width: 600px;
            margin: 0 auto 60px auto;
            line-height: 1.8;
            font-weight: 300;
            color: white;
        }

        .cover-meta {
            font-size: 13px;
            font-weight: 400;
            color: white;
        }

        .cover-meta p {
            margin: 8px 0;
            letter-spacing: 0.01em;
            color: white;
        }

        .cover-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 10px 24px;
            border-radius: 30px;
            margin-top: 20px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }

        /* Table of Contents */
        .toc {
            page-break-after: always;
            padding: 40px;
        }

        .toc h1 {
            color: #0066CC;
            border-bottom: 3px solid #0066CC;
            padding-bottom: 12px;
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 32px;
            font-weight: 700;
        }

        .toc-list {
            list-style: none;
            padding: 0;
        }

        .toc-list li {
            padding: 10px 0;
            border-bottom: 1px dotted #cbd5e0;
        }

        .toc-list li a {
            color: #0066CC;
            text-decoration: none;
        }

        .toc-list .toc-section {
            font-weight: 600;
            font-size: 13px;
            color: #0066CC;
        }

        .toc-list .toc-subsection {
            padding-left: 24px;
            font-size: 11.5px;
            color: #000000;
            font-weight: 400;
        }

        /* Content Sections */
        .section {
            page-break-before: always;
            padding: 20px 0;
        }

        .section:first-of-type {
            page-break-before: avoid;
        }

        h1 {
            color: #0066CC;
            font-size: 28px;
            border-bottom: 3px solid #0066CC;
            padding-bottom: 12px;
            margin-top: 0;
            font-family: 'Playfair Display', Georgia, serif;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        h2 {
            color: #0066CC;
            font-size: 18px;
            margin-top: 32px;
            border-left: 4px solid #3182ce;
            padding-left: 16px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        h3 {
            color: #0055AA;
            font-size: 15px;
            margin-top: 26px;
            font-weight: 600;
        }

        h4 {
            color: #0055AA;
            font-size: 13px;
            margin-top: 22px;
            font-weight: 600;
        }

        p {
            margin: 12px 0;
            color: #000000;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 18px 0;
            font-size: 10.5px;
        }

        th, td {
            border: 1px solid #e2e8f0;
            padding: 10px 12px;
            text-align: left;
        }

        th {
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
            font-weight: 600;
            font-size: 10.5px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        td {
            color: #000000;
        }

        tr:nth-child(even) {
            background: #f7fafc;
        }

        tr:hover {
            background: #edf2f7;
        }

        /* Code blocks */
        code {
            background: #edf2f7;
            padding: 3px 7px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            color: #c53030;
            font-weight: 500;
        }

        pre {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
            padding: 18px 20px;
            border-radius: 10px;
            overflow-x: auto;
            font-size: 10.5px;
            line-height: 1.6;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            border: 1px solid #4a5568;
        }

        pre code {
            background: none;
            padding: 0;
            color: #e2e8f0;
            font-weight: 400;
        }

        /* Architecture diagrams */
        .diagram {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin: 22px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .diagram-title {
            font-weight: 600;
            color: #1a365d;
            margin-bottom: 18px;
            font-size: 14px;
            letter-spacing: 0.01em;
            font-family: 'Inter', sans-serif;
        }

        /* SVG Styles */
        .arch-box {
            fill: #3182ce;
            stroke: #2c5282;
            stroke-width: 2;
        }

        .arch-box-light {
            fill: #63b3ed;
            stroke: #3182ce;
            stroke-width: 2;
        }

        .arch-box-green {
            fill: #48bb78;
            stroke: #38a169;
            stroke-width: 2;
        }

        .arch-box-orange {
            fill: #ed8936;
            stroke: #dd6b20;
            stroke-width: 2;
        }

        .arch-box-purple {
            fill: #9f7aea;
            stroke: #805ad5;
            stroke-width: 2;
        }

        .arch-box-red {
            fill: #fc8181;
            stroke: #f56565;
            stroke-width: 2;
        }

        .arch-box-gray {
            fill: #a0aec0;
            stroke: #718096;
            stroke-width: 2;
        }

        .arch-text {
            fill: white;
            font-size: 11px;
            font-weight: 600;
            text-anchor: middle;
            font-family: 'Inter', sans-serif;
        }

        .arch-text-dark {
            fill: #1a202c;
            font-size: 10px;
            text-anchor: middle;
            font-family: 'Inter', sans-serif;
        }

        .arch-arrow {
            stroke: #4a5568;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .arch-line {
            stroke: #a0aec0;
            stroke-width: 1;
            stroke-dasharray: 5,5;
        }

        /* Info boxes */
        .info-box {
            background: linear-gradient(135deg, #ebf8ff 0%, #e6f4ff 100%);
            border-left: 5px solid #3182ce;
            padding: 18px 20px;
            margin: 18px 0;
            border-radius: 0 10px 10px 0;
            font-size: 11px;
            line-height: 1.7;
        }

        .info-box strong {
            color: #1a365d;
            font-weight: 600;
        }

        .warning-box {
            background: linear-gradient(135deg, #fffaf0 0%, #fef5e7 100%);
            border-left: 5px solid #ed8936;
            padding: 18px 20px;
            margin: 18px 0;
            border-radius: 0 10px 10px 0;
            font-size: 11px;
        }

        .success-box {
            background: linear-gradient(135deg, #f0fff4 0%, #e6ffed 100%);
            border-left: 5px solid #48bb78;
            padding: 18px 20px;
            margin: 18px 0;
            border-radius: 0 10px 10px 0;
            font-size: 11px;
        }

        /* Lists */
        ul, ol {
            margin: 12px 0;
            padding-left: 28px;
        }

        li {
            margin: 7px 0;
            color: #2d3748;
            line-height: 1.7;
        }

        /* Feature grid */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 22px 0;
        }

        .feature-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
        }

        .feature-card h4 {
            color: #1a365d;
            margin: 0 0 10px 0;
            font-size: 13px;
            font-weight: 600;
        }

        .feature-card p {
            margin: 0;
            font-size: 11px;
            color: #4a5568;
            line-height: 1.6;
        }

        /* Module cards */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 22px 0;
        }

        .module-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 18px;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
            background: white;
        }

        .module-card h4 {
            color: #2c5282;
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #3182ce;
        }

        /* Page break helpers */
        .page-break {
            page-break-before: always;
        }

        .no-break {
            page-break-inside: avoid;
        }

        /* Footer */
        .page-footer {
            position: fixed;
            bottom: 10mm;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 9px;
            color: #718096;
        }
    </style>
</head>
<body>

<!-- Cover Page -->
<div class="cover-page">
    <div class="cover-logo">
        <span>H</span>
    </div>
    <div class="cover-title">HIMS</div>
    <div class="cover-subtitle">Hospital Information Management System</div>
    <div class="cover-description">
        Comprehensive Technical Documentation for System Administrators<br>
        Enterprise-grade healthcare management platform with integrated clinical workflows,
        billing, inventory, and interoperability features.
    </div>
    <div class="cover-meta">
        <p><strong>Version:</strong> 1.0.0</p>
        <p><strong>Platform:</strong> Laravel 12.0 + Vue 3</p>
        <p><strong>Date:</strong> January 2026</p>
        <div class="cover-badge">CONFIDENTIAL - FOR INTERNAL USE ONLY</div>
    </div>
</div>

<!-- Table of Contents -->
<div class="toc">
    <h1>Table of Contents</h1>
    <ul class="toc-list">
        <li class="toc-section">1. Executive Summary</li>
        <li class="toc-section">2. System Architecture</li>
        <li class="toc-subsection">2.1 High-Level Architecture</li>
        <li class="toc-subsection">2.2 Technology Stack</li>
        <li class="toc-subsection">2.3 Multi-Tenant Architecture</li>
        <li class="toc-subsection">2.4 Security Architecture</li>
        <li class="toc-section">3. System Requirements</li>
        <li class="toc-subsection">3.1 Hardware Requirements</li>
        <li class="toc-subsection">3.2 Software Requirements</li>
        <li class="toc-subsection">3.3 Network Requirements</li>
        <li class="toc-section">4. Module Documentation</li>
        <li class="toc-subsection">4.1 Patient Management</li>
        <li class="toc-subsection">4.2 OPD Module</li>
        <li class="toc-subsection">4.3 IPD Module</li>
        <li class="toc-subsection">4.4 Appointments</li>
        <li class="toc-subsection">4.5 Laboratory</li>
        <li class="toc-subsection">4.6 Radiology</li>
        <li class="toc-subsection">4.7 Operation Theater</li>
        <li class="toc-subsection">4.8 Pharmacy</li>
        <li class="toc-subsection">4.9 Inventory</li>
        <li class="toc-subsection">4.10 Billing</li>
        <li class="toc-section">5. Database Schema</li>
        <li class="toc-subsection">5.1 Entity Relationship Diagram</li>
        <li class="toc-subsection">5.2 Core Tables</li>
        <li class="toc-subsection">5.3 Module Tables</li>
        <li class="toc-section">6. API Architecture</li>
        <li class="toc-subsection">6.1 Authentication</li>
        <li class="toc-subsection">6.2 Endpoint Summary</li>
        <li class="toc-subsection">6.3 Response Formats</li>
        <li class="toc-section">7. Integration & Interoperability</li>
        <li class="toc-subsection">7.1 ABHA/ABDM Integration</li>
        <li class="toc-subsection">7.2 FHIR R4 API</li>
        <li class="toc-subsection">7.3 HL7 Messaging</li>
        <li class="toc-section">8. Security & Compliance</li>
        <li class="toc-section">9. Deployment Guide</li>
        <li class="toc-section">10. Maintenance & Operations</li>
        <li class="toc-section">11. Troubleshooting</li>
        <li class="toc-section">Appendices</li>
    </ul>
</div>

<!-- Section 1: Executive Summary -->
<div class="section">
    <h1>1. Executive Summary</h1>

    <p>HIMS (Hospital Information Management System) is an enterprise-grade, cloud-ready hospital management platform designed to streamline clinical and administrative workflows across healthcare facilities. Built on modern web technologies, it provides a comprehensive solution for managing patient care, clinical operations, billing, inventory, and regulatory compliance.</p>

    <h2>1.1 Key Features</h2>

    <div class="feature-grid">
        <div class="feature-card">
            <h4>Multi-Tenant</h4>
            <p>Support for multiple hospitals with complete data isolation</p>
        </div>
        <div class="feature-card">
            <h4>Clinical Workflows</h4>
            <p>OPD, IPD, Lab, Radiology, OT, Pharmacy modules</p>
        </div>
        <div class="feature-card">
            <h4>Billing & Revenue</h4>
            <p>Comprehensive billing with insurance support</p>
        </div>
        <div class="feature-card">
            <h4>RBAC Security</h4>
            <p>Role-based access control with granular permissions</p>
        </div>
        <div class="feature-card">
            <h4>Interoperability</h4>
            <p>FHIR R4, HL7, ABHA/ABDM integration</p>
        </div>
        <div class="feature-card">
            <h4>Patient Portal</h4>
            <p>Self-service appointments and record access</p>
        </div>
    </div>

    <h2>1.2 Platform Statistics</h2>

    <table>
        <tr>
            <th>Component</th>
            <th>Count</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>API Controllers</td>
            <td>61</td>
            <td>RESTful API endpoints for all operations</td>
        </tr>
        <tr>
            <td>Data Models</td>
            <td>118</td>
            <td>Eloquent models representing business entities</td>
        </tr>
        <tr>
            <td>API Endpoints</td>
            <td>200+</td>
            <td>Complete CRUD and workflow operations</td>
        </tr>
        <tr>
            <td>Database Tables</td>
            <td>100+</td>
            <td>Normalized relational schema</td>
        </tr>
        <tr>
            <td>Vue Components</td>
            <td>54+</td>
            <td>Frontend views and components</td>
        </tr>
        <tr>
            <td>Functional Modules</td>
            <td>20</td>
            <td>Integrated hospital management modules</td>
        </tr>
    </table>
</div>

<!-- Section 2: System Architecture -->
<div class="section">
    <h1>2. System Architecture</h1>

    <h2>2.1 High-Level Architecture</h2>

    <div class="diagram">
        <div class="diagram-title">HIMS System Architecture Overview</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Client Layer -->
            <rect x="50" y="20" width="650" height="70" rx="10" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="375" y="45" class="arch-text-dark" font-weight="bold" font-size="12">CLIENT LAYER</text>

            <rect x="70" y="55" width="120" height="30" rx="5" class="arch-box"/>
            <text x="130" y="75" class="arch-text">Web Browser</text>

            <rect x="210" y="55" width="120" height="30" rx="5" class="arch-box"/>
            <text x="270" y="75" class="arch-text">Mobile App</text>

            <rect x="350" y="55" width="120" height="30" rx="5" class="arch-box"/>
            <text x="410" y="75" class="arch-text">Patient Portal</text>

            <rect x="490" y="55" width="120" height="30" rx="5" class="arch-box-gray"/>
            <text x="550" y="75" class="arch-text">Third Party</text>

            <!-- Arrows from Client to API -->
            <line x1="375" y1="90" x2="375" y2="120" class="arch-arrow"/>

            <!-- API Gateway Layer -->
            <rect x="50" y="120" width="650" height="70" rx="10" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="375" y="145" class="arch-text-dark" font-weight="bold" font-size="12">API GATEWAY / LOAD BALANCER</text>

            <rect x="100" y="155" width="100" height="25" rx="5" class="arch-box-purple"/>
            <text x="150" y="172" class="arch-text" font-size="9">HTTPS/SSL</text>

            <rect x="220" y="155" width="100" height="25" rx="5" class="arch-box-purple"/>
            <text x="270" y="172" class="arch-text" font-size="9">Rate Limiting</text>

            <rect x="340" y="155" width="100" height="25" rx="5" class="arch-box-purple"/>
            <text x="390" y="172" class="arch-text" font-size="9">CORS</text>

            <rect x="460" y="155" width="100" height="25" rx="5" class="arch-box-purple"/>
            <text x="510" y="172" class="arch-text" font-size="9">Auth Check</text>

            <!-- Arrow to Application -->
            <line x1="375" y1="190" x2="375" y2="220" class="arch-arrow"/>

            <!-- Application Layer -->
            <rect x="50" y="220" width="650" height="120" rx="10" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="375" y="245" class="arch-text-dark" font-weight="bold" font-size="12">APPLICATION LAYER (Laravel 12)</text>

            <!-- Controllers -->
            <rect x="70" y="260" width="130" height="70" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="135" y="280" class="arch-text-dark" font-weight="bold" font-size="10">API Controllers</text>
            <text x="135" y="295" class="arch-text-dark" font-size="8">61 Controllers</text>
            <text x="135" y="310" class="arch-text-dark" font-size="8">200+ Endpoints</text>

            <!-- Services -->
            <rect x="220" y="260" width="130" height="70" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="285" y="280" class="arch-text-dark" font-weight="bold" font-size="10">Business Logic</text>
            <text x="285" y="295" class="arch-text-dark" font-size="8">Services Layer</text>
            <text x="285" y="310" class="arch-text-dark" font-size="8">Notifications, SMS</text>

            <!-- Models -->
            <rect x="370" y="260" width="130" height="70" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="435" y="280" class="arch-text-dark" font-weight="bold" font-size="10">Data Models</text>
            <text x="435" y="295" class="arch-text-dark" font-size="8">118 Eloquent Models</text>
            <text x="435" y="310" class="arch-text-dark" font-size="8">Relationships</text>

            <!-- Queue -->
            <rect x="520" y="260" width="130" height="70" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="585" y="280" class="arch-text-dark" font-weight="bold" font-size="10">Background Jobs</text>
            <text x="585" y="295" class="arch-text-dark" font-size="8">Queue Workers</text>
            <text x="585" y="310" class="arch-text-dark" font-size="8">5 Job Types</text>

            <!-- Arrow to Data -->
            <line x1="375" y1="340" x2="375" y2="370" class="arch-arrow"/>

            <!-- Data Layer -->
            <rect x="50" y="370" width="650" height="110" rx="10" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="395" class="arch-text-dark" font-weight="bold" font-size="12">DATA LAYER</text>

            <rect x="80" y="410" width="140" height="55" rx="5" class="arch-box-orange"/>
            <text x="150" y="435" class="arch-text" font-size="10">MySQL Database</text>
            <text x="150" y="450" class="arch-text" font-size="8">100+ Tables</text>

            <rect x="250" y="410" width="140" height="55" rx="5" class="arch-box-orange"/>
            <text x="320" y="435" class="arch-text" font-size="10">Redis Cache</text>
            <text x="320" y="450" class="arch-text" font-size="8">(Optional)</text>

            <rect x="420" y="410" width="140" height="55" rx="5" class="arch-box-orange"/>
            <text x="490" y="435" class="arch-text" font-size="10">File Storage</text>
            <text x="490" y="450" class="arch-text" font-size="8">Documents, Images</text>

            <rect x="590" y="410" width="100" height="55" rx="5" class="arch-box-orange"/>
            <text x="640" y="435" class="arch-text" font-size="10">Sessions</text>
            <text x="640" y="450" class="arch-text" font-size="8">Queue Jobs</text>
        </svg>
    </div>

    <h2>2.2 Technology Stack</h2>

    <table>
        <tr>
            <th>Layer</th>
            <th>Technology</th>
            <th>Version</th>
            <th>Purpose</th>
        </tr>
        <tr>
            <td rowspan="4"><strong>Backend</strong></td>
            <td>PHP</td>
            <td>8.2+</td>
            <td>Server-side programming language</td>
        </tr>
        <tr>
            <td>Laravel</td>
            <td>12.0</td>
            <td>Web application framework</td>
        </tr>
        <tr>
            <td>Laravel Sanctum</td>
            <td>4.0</td>
            <td>API token authentication</td>
        </tr>
        <tr>
            <td>Eloquent ORM</td>
            <td>-</td>
            <td>Database abstraction layer</td>
        </tr>
        <tr>
            <td rowspan="4"><strong>Frontend</strong></td>
            <td>Vue.js</td>
            <td>3.5.26</td>
            <td>Reactive UI framework</td>
        </tr>
        <tr>
            <td>Pinia</td>
            <td>3.0.4</td>
            <td>State management</td>
        </tr>
        <tr>
            <td>Tailwind CSS</td>
            <td>4.0</td>
            <td>Utility-first CSS framework</td>
        </tr>
        <tr>
            <td>Vite</td>
            <td>7.0.7</td>
            <td>Build tool and dev server</td>
        </tr>
        <tr>
            <td rowspan="2"><strong>Database</strong></td>
            <td>MySQL</td>
            <td>8.0+</td>
            <td>Primary relational database</td>
        </tr>
        <tr>
            <td>Redis</td>
            <td>7.0+</td>
            <td>Cache and queue (optional)</td>
        </tr>
        <tr>
            <td rowspan="2"><strong>Server</strong></td>
            <td>Nginx</td>
            <td>1.18+</td>
            <td>Web server / reverse proxy</td>
        </tr>
        <tr>
            <td>PHP-FPM</td>
            <td>8.2</td>
            <td>PHP process manager</td>
        </tr>
    </table>
</div>

<!-- Multi-Tenant Architecture -->
<div class="section">
    <h2>2.3 Multi-Tenant Architecture</h2>

    <p>HIMS implements a single-database multi-tenant architecture where all hospitals share the same database with data isolation achieved through a <code>hospital_id</code> foreign key on all relevant tables.</p>

    <div class="diagram">
        <div class="diagram-title">Multi-Tenant Data Isolation Model</div>
        <svg width="700" height="350" viewBox="0 0 700 350">
            <!-- Hospital boxes -->
            <rect x="50" y="30" width="180" height="100" rx="10" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="140" y="55" class="arch-text-dark" font-weight="bold">Hospital A</text>
            <text x="140" y="75" class="arch-text-dark" font-size="9">hospital_id = 1</text>
            <text x="140" y="95" class="arch-text-dark" font-size="9">Patients: 5000</text>
            <text x="140" y="115" class="arch-text-dark" font-size="9">Users: 50</text>

            <rect x="260" y="30" width="180" height="100" rx="10" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="350" y="55" class="arch-text-dark" font-weight="bold">Hospital B</text>
            <text x="350" y="75" class="arch-text-dark" font-size="9">hospital_id = 2</text>
            <text x="350" y="95" class="arch-text-dark" font-size="9">Patients: 8000</text>
            <text x="350" y="115" class="arch-text-dark" font-size="9">Users: 80</text>

            <rect x="470" y="30" width="180" height="100" rx="10" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="560" y="55" class="arch-text-dark" font-weight="bold">Hospital C</text>
            <text x="560" y="75" class="arch-text-dark" font-size="9">hospital_id = 3</text>
            <text x="560" y="95" class="arch-text-dark" font-size="9">Patients: 3000</text>
            <text x="560" y="115" class="arch-text-dark" font-size="9">Users: 30</text>

            <!-- Arrows down -->
            <line x1="140" y1="130" x2="140" y2="170" class="arch-arrow"/>
            <line x1="350" y1="130" x2="350" y2="170" class="arch-arrow"/>
            <line x1="560" y1="130" x2="560" y2="170" class="arch-arrow"/>

            <!-- Middleware box -->
            <rect x="100" y="170" width="500" height="50" rx="10" fill="#fed7d7" stroke="#f56565" stroke-width="2"/>
            <text x="350" y="200" class="arch-text-dark" font-weight="bold">Hospital Scope Middleware (Auto-filter by hospital_id)</text>

            <!-- Arrow to database -->
            <line x1="350" y1="220" x2="350" y2="260" class="arch-arrow"/>

            <!-- Database -->
            <rect x="150" y="260" width="400" height="70" rx="10" class="arch-box-orange"/>
            <text x="350" y="290" class="arch-text" font-size="12">Shared MySQL Database</text>
            <text x="350" y="310" class="arch-text" font-size="9">All tables include hospital_id column</text>
        </svg>
    </div>

    <div class="info-box">
        <strong>Implementation Details:</strong>
        <ul>
            <li><code>BelongsToHospital</code> trait automatically sets hospital_id on create</li>
            <li><code>HospitalScope</code> global scope filters all queries by current hospital</li>
            <li><code>SetCurrentHospital</code> middleware sets context from authenticated user</li>
            <li>Super Admins can access all hospitals and switch between them</li>
        </ul>
    </div>

    <h2>2.4 Security Architecture</h2>

    <div class="diagram">
        <div class="diagram-title">Authentication & Authorization Flow</div>
        <svg width="700" height="300" viewBox="0 0 700 300">
            <!-- Client -->
            <rect x="30" y="120" width="100" height="60" rx="8" class="arch-box"/>
            <text x="80" y="155" class="arch-text">Client</text>

            <!-- Arrow to Auth -->
            <line x1="130" y1="150" x2="180" y2="150" class="arch-arrow"/>
            <text x="155" y="140" class="arch-text-dark" font-size="8">1. Login</text>

            <!-- Auth Controller -->
            <rect x="180" y="100" width="120" height="100" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="240" y="130" class="arch-text-dark" font-weight="bold" font-size="10">Auth</text>
            <text x="240" y="145" class="arch-text-dark" font-size="8">Controller</text>
            <text x="240" y="165" class="arch-text-dark" font-size="8">Validate</text>
            <text x="240" y="180" class="arch-text-dark" font-size="8">Credentials</text>

            <!-- Arrow to Sanctum -->
            <line x1="300" y1="150" x2="350" y2="150" class="arch-arrow"/>
            <text x="325" y="140" class="arch-text-dark" font-size="8">2. Issue</text>

            <!-- Sanctum -->
            <rect x="350" y="100" width="120" height="100" rx="8" class="arch-box-purple"/>
            <text x="410" y="130" class="arch-text" font-size="10">Laravel</text>
            <text x="410" y="145" class="arch-text" font-size="10">Sanctum</text>
            <text x="410" y="170" class="arch-text" font-size="8">Token</text>
            <text x="410" y="185" class="arch-text" font-size="8">Generation</text>

            <!-- Arrow back to client -->
            <path d="M 410 200 L 410 250 L 80 250 L 80 180" fill="none" class="arch-arrow"/>
            <text x="250" y="265" class="arch-text-dark" font-size="8">3. Return Bearer Token</text>

            <!-- API Request flow -->
            <rect x="530" y="30" width="140" height="240" rx="8" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="600" y="55" class="arch-text-dark" font-weight="bold" font-size="10">Protected API</text>

            <rect x="545" y="70" width="110" height="30" rx="5" fill="#fed7d7"/>
            <text x="600" y="90" class="arch-text-dark" font-size="8">auth:sanctum</text>

            <rect x="545" y="110" width="110" height="30" rx="5" fill="#fed7d7"/>
            <text x="600" y="130" class="arch-text-dark" font-size="8">check_permission</text>

            <rect x="545" y="150" width="110" height="30" rx="5" fill="#fed7d7"/>
            <text x="600" y="170" class="arch-text-dark" font-size="8">set_hospital</text>

            <rect x="545" y="190" width="110" height="30" rx="5" fill="#c6f6d5"/>
            <text x="600" y="210" class="arch-text-dark" font-size="8">Controller</text>

            <rect x="545" y="230" width="110" height="30" rx="5" fill="#bee3f8"/>
            <text x="600" y="250" class="arch-text-dark" font-size="8">Response</text>

            <!-- Arrow from client to API -->
            <path d="M 80 120 L 80 30 L 530 30" fill="none" class="arch-arrow"/>
            <text x="300" y="20" class="arch-text-dark" font-size="8">4. API Request with Bearer Token</text>
        </svg>
    </div>
</div>

<!-- Section 3: System Requirements -->
<div class="section">
    <h1>3. System Requirements</h1>

    <h2>3.1 Hardware Requirements</h2>

    <table>
        <tr>
            <th>Resource</th>
            <th>Minimum</th>
            <th>Recommended</th>
            <th>Enterprise</th>
        </tr>
        <tr>
            <td>CPU Cores</td>
            <td>2 cores</td>
            <td>4 cores</td>
            <td>8+ cores</td>
        </tr>
        <tr>
            <td>RAM</td>
            <td>4 GB</td>
            <td>8 GB</td>
            <td>16+ GB</td>
        </tr>
        <tr>
            <td>Storage</td>
            <td>50 GB SSD</td>
            <td>200 GB SSD</td>
            <td>500+ GB NVMe</td>
        </tr>
        <tr>
            <td>Network</td>
            <td>100 Mbps</td>
            <td>1 Gbps</td>
            <td>10 Gbps</td>
        </tr>
        <tr>
            <td>Concurrent Users</td>
            <td>Up to 50</td>
            <td>Up to 200</td>
            <td>500+</td>
        </tr>
    </table>

    <h2>3.2 Software Requirements</h2>

    <div class="module-grid">
        <div class="module-card no-break">
            <h4>Operating System</h4>
            <ul>
                <li>Ubuntu 22.04 LTS (Recommended)</li>
                <li>Debian 12</li>
                <li>RHEL 9 / Rocky Linux 9</li>
                <li>CentOS Stream 9</li>
            </ul>
        </div>
        <div class="module-card no-break">
            <h4>Web Server</h4>
            <ul>
                <li>Nginx 1.18+ (Recommended)</li>
                <li>Apache 2.4+ with mod_rewrite</li>
                <li>PHP-FPM 8.2</li>
            </ul>
        </div>
        <div class="module-card no-break">
            <h4>PHP Extensions</h4>
            <ul>
                <li>php-bcmath, php-ctype, php-curl</li>
                <li>php-dom, php-fileinfo, php-json</li>
                <li>php-mbstring, php-openssl, php-pdo</li>
                <li>php-pdo_mysql, php-tokenizer</li>
                <li>php-xml, php-zip, php-gd</li>
            </ul>
        </div>
        <div class="module-card no-break">
            <h4>Database</h4>
            <ul>
                <li>MySQL 8.0+ (Recommended)</li>
                <li>MariaDB 10.6+</li>
                <li>Redis 7.0+ (Optional, for caching)</li>
            </ul>
        </div>
    </div>

    <h2>3.3 Network Requirements</h2>

    <table>
        <tr>
            <th>Port</th>
            <th>Protocol</th>
            <th>Service</th>
            <th>Access</th>
        </tr>
        <tr>
            <td>443</td>
            <td>HTTPS</td>
            <td>Web Application</td>
            <td>Public</td>
        </tr>
        <tr>
            <td>80</td>
            <td>HTTP</td>
            <td>Redirect to HTTPS</td>
            <td>Public</td>
        </tr>
        <tr>
            <td>3306</td>
            <td>TCP</td>
            <td>MySQL Database</td>
            <td>Internal Only</td>
        </tr>
        <tr>
            <td>6379</td>
            <td>TCP</td>
            <td>Redis (if used)</td>
            <td>Internal Only</td>
        </tr>
        <tr>
            <td>22</td>
            <td>SSH</td>
            <td>Server Administration</td>
            <td>Restricted</td>
        </tr>
    </table>
</div>

<!-- Section 4: Module Documentation -->
<div class="section">
    <h1>4. Module Documentation</h1>

    <h2>4.1 Module Overview</h2>

    <div class="diagram">
        <div class="diagram-title">HIMS Functional Modules</div>
        <svg width="750" height="400" viewBox="0 0 750 400">
            <!-- Central Hub -->
            <circle cx="375" cy="200" r="60" fill="#3182ce" stroke="#2c5282" stroke-width="3"/>
            <text x="375" y="195" class="arch-text" font-size="12">HIMS</text>
            <text x="375" y="210" class="arch-text" font-size="10">Core</text>

            <!-- Clinical Modules (Top) -->
            <rect x="80" y="30" width="90" height="50" rx="8" class="arch-box-green"/>
            <text x="125" y="60" class="arch-text" font-size="9">OPD</text>

            <rect x="190" y="30" width="90" height="50" rx="8" class="arch-box-green"/>
            <text x="235" y="60" class="arch-text" font-size="9">IPD</text>

            <rect x="300" y="30" width="90" height="50" rx="8" class="arch-box-green"/>
            <text x="345" y="60" class="arch-text" font-size="9">Laboratory</text>

            <rect x="410" y="30" width="90" height="50" rx="8" class="arch-box-green"/>
            <text x="455" y="60" class="arch-text" font-size="9">Radiology</text>

            <rect x="520" y="30" width="90" height="50" rx="8" class="arch-box-green"/>
            <text x="565" y="60" class="arch-text" font-size="9">OT</text>

            <rect x="630" y="30" width="90" height="50" rx="8" class="arch-box-green"/>
            <text x="675" y="60" class="arch-text" font-size="9">Pharmacy</text>

            <!-- Lines to center -->
            <line x1="125" y1="80" x2="330" y2="160" stroke="#48bb78" stroke-width="2"/>
            <line x1="235" y1="80" x2="345" y2="155" stroke="#48bb78" stroke-width="2"/>
            <line x1="345" y1="80" x2="365" y2="145" stroke="#48bb78" stroke-width="2"/>
            <line x1="455" y1="80" x2="395" y2="150" stroke="#48bb78" stroke-width="2"/>
            <line x1="565" y1="80" x2="415" y2="160" stroke="#48bb78" stroke-width="2"/>
            <line x1="675" y1="80" x2="425" y2="170" stroke="#48bb78" stroke-width="2"/>

            <!-- Administrative Modules (Left) -->
            <rect x="20" y="140" width="90" height="50" rx="8" class="arch-box-orange"/>
            <text x="65" y="170" class="arch-text" font-size="9">Patients</text>

            <rect x="20" y="210" width="90" height="50" rx="8" class="arch-box-orange"/>
            <text x="65" y="235" class="arch-text" font-size="8">Appointments</text>

            <rect x="20" y="280" width="90" height="50" rx="8" class="arch-box-orange"/>
            <text x="65" y="310" class="arch-text" font-size="9">Billing</text>

            <!-- Lines to center -->
            <line x1="110" y1="165" x2="315" y2="190" stroke="#ed8936" stroke-width="2"/>
            <line x1="110" y1="235" x2="315" y2="210" stroke="#ed8936" stroke-width="2"/>
            <line x1="110" y1="305" x2="325" y2="240" stroke="#ed8936" stroke-width="2"/>

            <!-- Support Modules (Right) -->
            <rect x="640" y="140" width="90" height="50" rx="8" class="arch-box-purple"/>
            <text x="685" y="170" class="arch-text" font-size="9">Inventory</text>

            <rect x="640" y="210" width="90" height="50" rx="8" class="arch-box-purple"/>
            <text x="685" y="240" class="arch-text" font-size="9">MRD</text>

            <rect x="640" y="280" width="90" height="50" rx="8" class="arch-box-purple"/>
            <text x="685" y="305" class="arch-text" font-size="8">Birth/Death</text>

            <!-- Lines to center -->
            <line x1="640" y1="165" x2="435" y2="190" stroke="#9f7aea" stroke-width="2"/>
            <line x1="640" y1="235" x2="435" y2="210" stroke="#9f7aea" stroke-width="2"/>
            <line x1="640" y1="305" x2="425" y2="240" stroke="#9f7aea" stroke-width="2"/>

            <!-- Integration Modules (Bottom) -->
            <rect x="140" y="330" width="100" height="50" rx="8" class="arch-box-light"/>
            <text x="190" y="360" class="arch-text" font-size="9">ABHA/ABDM</text>

            <rect x="260" y="330" width="100" height="50" rx="8" class="arch-box-light"/>
            <text x="310" y="360" class="arch-text" font-size="9">FHIR R4</text>

            <rect x="380" y="330" width="100" height="50" rx="8" class="arch-box-light"/>
            <text x="430" y="355" class="arch-text" font-size="8">Patient</text>
            <text x="430" y="370" class="arch-text" font-size="8">Portal</text>

            <rect x="500" y="330" width="100" height="50" rx="8" class="arch-box-light"/>
            <text x="550" y="355" class="arch-text" font-size="8">Notifications</text>

            <!-- Lines to center -->
            <line x1="190" y1="330" x2="350" y2="255" stroke="#63b3ed" stroke-width="2"/>
            <line x1="310" y1="330" x2="365" y2="260" stroke="#63b3ed" stroke-width="2"/>
            <line x1="430" y1="330" x2="385" y2="260" stroke="#63b3ed" stroke-width="2"/>
            <line x1="550" y1="330" x2="400" y2="255" stroke="#63b3ed" stroke-width="2"/>
        </svg>
    </div>

    <h2>4.2 OPD Module (Outpatient Department)</h2>

    <div class="diagram">
        <div class="diagram-title">OPD Workflow</div>
        <svg width="750" height="180" viewBox="0 0 750 180">
            <!-- Step boxes -->
            <rect x="10" y="60" width="100" height="60" rx="8" class="arch-box"/>
            <text x="60" y="85" class="arch-text" font-size="9">Patient</text>
            <text x="60" y="100" class="arch-text" font-size="9">Registration</text>

            <rect x="130" y="60" width="100" height="60" rx="8" class="arch-box"/>
            <text x="180" y="85" class="arch-text" font-size="9">OPD Visit</text>
            <text x="180" y="100" class="arch-text" font-size="9">Created</text>

            <rect x="250" y="60" width="100" height="60" rx="8" class="arch-box-green"/>
            <text x="300" y="85" class="arch-text" font-size="9">Waiting</text>
            <text x="300" y="100" class="arch-text" font-size="9">Queue</text>

            <rect x="370" y="60" width="100" height="60" rx="8" class="arch-box-green"/>
            <text x="420" y="85" class="arch-text" font-size="9">Doctor</text>
            <text x="420" y="100" class="arch-text" font-size="9">Consultation</text>

            <rect x="490" y="60" width="100" height="60" rx="8" class="arch-box-orange"/>
            <text x="540" y="85" class="arch-text" font-size="9">Add Services</text>
            <text x="540" y="100" class="arch-text" font-size="9">& Tests</text>

            <rect x="610" y="60" width="120" height="60" rx="8" class="arch-box-purple"/>
            <text x="670" y="85" class="arch-text" font-size="9">Billing &</text>
            <text x="670" y="100" class="arch-text" font-size="9">Payment</text>

            <!-- Arrows -->
            <line x1="110" y1="90" x2="130" y2="90" class="arch-arrow"/>
            <line x1="230" y1="90" x2="250" y2="90" class="arch-arrow"/>
            <line x1="350" y1="90" x2="370" y2="90" class="arch-arrow"/>
            <line x1="470" y1="90" x2="490" y2="90" class="arch-arrow"/>
            <line x1="590" y1="90" x2="610" y2="90" class="arch-arrow"/>

            <!-- Status labels -->
            <text x="60" y="140" class="arch-text-dark" font-size="8">POST /patients</text>
            <text x="180" y="140" class="arch-text-dark" font-size="8">POST /opd-visits</text>
            <text x="300" y="140" class="arch-text-dark" font-size="8">GET /doctor/queue</text>
            <text x="420" y="140" class="arch-text-dark" font-size="8">POST /complete</text>
            <text x="540" y="140" class="arch-text-dark" font-size="8">POST /add-service</text>
            <text x="670" y="140" class="arch-text-dark" font-size="8">POST /payment</text>
        </svg>
    </div>

    <table>
        <tr>
            <th>Endpoint</th>
            <th>Method</th>
            <th>Description</th>
        </tr>
        <tr><td>/api/opd-visits</td><td>GET</td><td>List OPD visits with filters</td></tr>
        <tr><td>/api/opd-visits</td><td>POST</td><td>Create new OPD visit</td></tr>
        <tr><td>/api/opd-visits/{id}/start-consultation</td><td>POST</td><td>Start doctor consultation</td></tr>
        <tr><td>/api/opd-visits/{id}/complete-consultation</td><td>POST</td><td>Complete with diagnosis</td></tr>
        <tr><td>/api/opd-visits/{id}/add-service</td><td>POST</td><td>Add billable service</td></tr>
        <tr><td>/api/opd-visits/{id}/add-investigation</td><td>POST</td><td>Order lab/radiology tests</td></tr>
        <tr><td>/api/opd-visits/{id}/payment</td><td>POST</td><td>Record payment</td></tr>
        <tr><td>/api/opd-visits/{id}/case-paper</td><td>GET</td><td>Generate case paper</td></tr>
        <tr><td>/api/opd-visits/doctor/{id}/queue</td><td>GET</td><td>Get doctor's today queue</td></tr>
    </table>

    <h3>4.2.1 Detailed OPD Patient Flow Diagrams</h3>

    <!-- Complete OPD Patient Journey -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Complete OPD Patient Journey</div>
        <svg width="750" height="650" viewBox="0 0 750 650">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="640" fill="#f8fafc" rx="10"/>

            <!-- Title -->
            <text x="375" y="30" text-anchor="middle" font-weight="bold" font-size="14" fill="#1a365d">End-to-End OPD Patient Flow</text>

            <!-- PHASE 1: Pre-Visit -->
            <rect x="20" y="45" width="710" height="100" rx="8" fill="#ebf8ff" stroke="#3182ce" stroke-width="1"/>
            <text x="35" y="65" font-weight="bold" font-size="11" fill="#2c5282">PHASE 1: Pre-Visit / Registration</text>

            <!-- Start -->
            <circle cx="60" cy="100" r="20" fill="#48bb78" stroke="#276749" stroke-width="2"/>
            <text x="60" y="105" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">START</text>

            <!-- Decision: New or Existing Patient -->
            <polygon points="160,80 200,100 160,120 120,100" fill="#fef3c7" stroke="#d69e2e" stroke-width="2"/>
            <text x="160" y="104" text-anchor="middle" font-size="8" fill="#744210">New?</text>

            <!-- New Patient Registration -->
            <rect x="230" y="75" width="100" height="50" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <text x="280" y="95" text-anchor="middle" font-size="9" fill="#2c5282">Patient</text>
            <text x="280" y="108" text-anchor="middle" font-size="9" fill="#2c5282">Registration</text>

            <!-- Existing Patient Search -->
            <rect x="230" y="45" width="100" height="25" rx="4" fill="#e2e8f0" stroke="#718096"/>
            <text x="280" y="62" text-anchor="middle" font-size="8" fill="#4a5568">Search Patient</text>

            <!-- Appointment Check -->
            <polygon points="400,80 440,100 400,120 360,100" fill="#fef3c7" stroke="#d69e2e" stroke-width="2"/>
            <text x="400" y="97" text-anchor="middle" font-size="7" fill="#744210">Has</text>
            <text x="400" y="107" text-anchor="middle" font-size="7" fill="#744210">Appt?</text>

            <!-- Book Appointment -->
            <rect x="470" y="50" width="90" height="40" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <text x="515" y="65" text-anchor="middle" font-size="8" fill="#553c9a">Book</text>
            <text x="515" y="77" text-anchor="middle" font-size="8" fill="#553c9a">Appointment</text>

            <!-- Create OPD Visit -->
            <rect x="580" y="75" width="120" height="50" rx="6" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="640" y="95" text-anchor="middle" font-size="9" fill="#276749">Create OPD Visit</text>
            <text x="640" y="108" text-anchor="middle" font-size="8" fill="#276749">(Token Generated)</text>

            <!-- Arrows Phase 1 -->
            <line x1="80" y1="100" x2="120" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="200" y1="100" x2="230" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="215" y="95" font-size="7" fill="#276749">Yes</text>
            <line x1="160" y1="80" x2="160" y2="57" stroke="#4a5568" stroke-width="1"/>
            <line x1="160" y1="57" x2="230" y2="57" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="195" y="52" font-size="7" fill="#c53030">No</text>
            <line x1="330" y1="100" x2="360" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="330" y1="57" x2="360" y2="100" stroke="#4a5568" stroke-width="1"/>
            <line x1="440" y1="100" x2="580" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="510" y="95" font-size="7" fill="#276749">Yes</text>
            <line x1="400" y1="80" x2="400" y2="70" stroke="#4a5568" stroke-width="1"/>
            <line x1="400" y1="70" x2="470" y2="70" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="435" y="65" font-size="7" fill="#c53030">No</text>
            <line x1="560" y1="70" x2="640" y2="75" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>

            <!-- PHASE 2: Waiting & Triage -->
            <rect x="20" y="155" width="710" height="90" rx="8" fill="#fef3c7" stroke="#d69e2e" stroke-width="1"/>
            <text x="35" y="175" font-weight="bold" font-size="11" fill="#744210">PHASE 2: Waiting &amp; Triage</text>

            <!-- Waiting Queue -->
            <rect x="60" y="190" width="100" height="45" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <text x="110" y="208" text-anchor="middle" font-size="9" fill="#c05621">Waiting Queue</text>
            <text x="110" y="222" text-anchor="middle" font-size="8" fill="#c05621">(Status: Waiting)</text>

            <!-- Vitals Recording -->
            <rect x="190" y="190" width="110" height="45" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <text x="245" y="208" text-anchor="middle" font-size="9" fill="#234e52">Vitals Recording</text>
            <text x="245" y="222" text-anchor="middle" font-size="8" fill="#234e52">BP, Pulse, Temp, SpO2</text>

            <!-- Triage Assessment -->
            <rect x="330" y="190" width="100" height="45" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <text x="380" y="208" text-anchor="middle" font-size="9" fill="#c53030">Triage</text>
            <text x="380" y="222" text-anchor="middle" font-size="8" fill="#c53030">Assessment</text>

            <!-- Priority Assignment -->
            <rect x="460" y="185" width="80" height="25" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="500" y="202" text-anchor="middle" font-size="8" fill="#c53030">Emergency</text>
            <rect x="460" y="212" width="80" height="25" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="500" y="229" text-anchor="middle" font-size="8" fill="#c05621">Urgent</text>

            <!-- Updated Queue Position -->
            <rect x="570" y="190" width="130" height="45" rx="6" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="635" y="208" text-anchor="middle" font-size="9" fill="#276749">Queue Updated</text>
            <text x="635" y="222" text-anchor="middle" font-size="8" fill="#276749">(Priority Adjusted)</text>

            <!-- Arrows Phase 2 -->
            <line x1="640" y1="125" x2="640" y2="150" stroke="#4a5568" stroke-width="1"/>
            <line x1="640" y1="150" x2="110" y2="150" stroke="#4a5568" stroke-width="1"/>
            <line x1="110" y1="150" x2="110" y2="190" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="160" y1="212" x2="190" y2="212" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="300" y1="212" x2="330" y2="212" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="430" y1="212" x2="460" y2="197" stroke="#4a5568" stroke-width="1"/>
            <line x1="430" y1="212" x2="460" y2="224" stroke="#4a5568" stroke-width="1"/>
            <line x1="540" y1="212" x2="570" y2="212" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>

            <!-- PHASE 3: Consultation -->
            <rect x="20" y="255" width="710" height="110" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="1"/>
            <text x="35" y="275" font-weight="bold" font-size="11" fill="#276749">PHASE 3: Doctor Consultation</text>

            <!-- Called to Room -->
            <rect x="60" y="290" width="90" height="45" rx="6" fill="#fff" stroke="#48bb78" stroke-width="2"/>
            <text x="105" y="308" text-anchor="middle" font-size="9" fill="#276749">Called to</text>
            <text x="105" y="322" text-anchor="middle" font-size="9" fill="#276749">Room</text>

            <!-- Start Consultation -->
            <rect x="170" y="290" width="100" height="45" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <text x="220" y="308" text-anchor="middle" font-size="9" fill="#2c5282">Start</text>
            <text x="220" y="322" text-anchor="middle" font-size="9" fill="#2c5282">Consultation</text>
            <text x="220" y="345" text-anchor="middle" font-size="7" fill="#4a5568">(Status: In Consultation)</text>

            <!-- History & Examination -->
            <rect x="290" y="290" width="100" height="45" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <text x="340" y="308" text-anchor="middle" font-size="9" fill="#553c9a">History &amp;</text>
            <text x="340" y="322" text-anchor="middle" font-size="9" fill="#553c9a">Examination</text>

            <!-- Diagnosis -->
            <rect x="410" y="290" width="90" height="45" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <text x="455" y="308" text-anchor="middle" font-size="9" fill="#553c9a">Diagnosis</text>
            <text x="455" y="322" text-anchor="middle" font-size="8" fill="#553c9a">(ICD Codes)</text>

            <!-- Order Investigations -->
            <rect x="520" y="285" width="90" height="35" rx="5" fill="#fed7d7" stroke="#f56565"/>
            <text x="565" y="300" text-anchor="middle" font-size="8" fill="#c53030">Lab Orders</text>
            <text x="565" y="312" text-anchor="middle" font-size="8" fill="#c53030">Radiology</text>

            <!-- Prescription -->
            <rect x="520" y="325" width="90" height="35" rx="5" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="565" y="340" text-anchor="middle" font-size="8" fill="#553c9a">Prescription</text>
            <text x="565" y="352" text-anchor="middle" font-size="8" fill="#553c9a">(Medications)</text>

            <!-- Complete Consultation -->
            <rect x="630" y="290" width="90" height="45" rx="6" fill="#c6f6d5" stroke="#276749" stroke-width="2"/>
            <text x="675" y="308" text-anchor="middle" font-size="9" fill="#276749">Complete</text>
            <text x="675" y="322" text-anchor="middle" font-size="9" fill="#276749">Consultation</text>

            <!-- Arrows Phase 3 -->
            <line x1="635" y1="235" x2="635" y2="250" stroke="#4a5568" stroke-width="1"/>
            <line x1="635" y1="250" x2="105" y2="250" stroke="#4a5568" stroke-width="1"/>
            <line x1="105" y1="250" x2="105" y2="290" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="150" y1="312" x2="170" y2="312" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="270" y1="312" x2="290" y2="312" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="390" y1="312" x2="410" y2="312" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="500" y1="302" x2="520" y2="302" stroke="#4a5568" stroke-width="1"/>
            <line x1="500" y1="320" x2="520" y2="342" stroke="#4a5568" stroke-width="1"/>
            <line x1="610" y1="302" x2="630" y2="302" stroke="#4a5568" stroke-width="1"/>
            <line x1="610" y1="342" x2="630" y2="322" stroke="#4a5568" stroke-width="1"/>

            <!-- PHASE 4: Post-Consultation Services -->
            <rect x="20" y="375" width="710" height="90" rx="8" fill="#e9d8fd" stroke="#9f7aea" stroke-width="1"/>
            <text x="35" y="395" font-weight="bold" font-size="11" fill="#553c9a">PHASE 4: Post-Consultation Services</text>

            <!-- Decision: Services Needed -->
            <polygon points="100,420 140,440 100,460 60,440" fill="#fef3c7" stroke="#d69e2e" stroke-width="2"/>
            <text x="100" y="437" text-anchor="middle" font-size="7" fill="#744210">Lab/</text>
            <text x="100" y="447" text-anchor="middle" font-size="7" fill="#744210">Rad?</text>

            <!-- Laboratory -->
            <rect x="170" y="410" width="90" height="40" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <text x="215" y="426" text-anchor="middle" font-size="9" fill="#234e52">Laboratory</text>
            <text x="215" y="440" text-anchor="middle" font-size="8" fill="#234e52">Sample Collection</text>

            <!-- Radiology -->
            <rect x="280" y="410" width="90" height="40" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <text x="325" y="426" text-anchor="middle" font-size="9" fill="#c05621">Radiology</text>
            <text x="325" y="440" text-anchor="middle" font-size="8" fill="#c05621">Imaging</text>

            <!-- Pharmacy -->
            <rect x="390" y="410" width="90" height="40" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <text x="435" y="426" text-anchor="middle" font-size="9" fill="#553c9a">Pharmacy</text>
            <text x="435" y="440" text-anchor="middle" font-size="8" fill="#553c9a">Dispensing</text>

            <!-- Procedures -->
            <rect x="500" y="410" width="90" height="40" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <text x="545" y="426" text-anchor="middle" font-size="9" fill="#c53030">Procedures</text>
            <text x="545" y="440" text-anchor="middle" font-size="8" fill="#c53030">(If Any)</text>

            <!-- Proceed to Billing -->
            <rect x="610" y="415" width="100" height="45" rx="6" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="660" y="433" text-anchor="middle" font-size="9" fill="#c05621">Proceed to</text>
            <text x="660" y="447" text-anchor="middle" font-size="9" fill="#c05621">Billing</text>

            <!-- Arrows Phase 4 -->
            <line x1="675" y1="335" x2="675" y2="370" stroke="#4a5568" stroke-width="1"/>
            <line x1="675" y1="370" x2="100" y2="370" stroke="#4a5568" stroke-width="1"/>
            <line x1="100" y1="370" x2="100" y2="420" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="140" y1="430" x2="170" y2="430" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="260" y1="430" x2="280" y2="430" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="370" y1="430" x2="390" y2="430" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="480" y1="430" x2="500" y2="430" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="590" y1="430" x2="610" y2="437" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="100" y1="460" x2="100" y2="480" stroke="#4a5568" stroke-width="1"/>
            <line x1="100" y1="480" x2="660" y2="480" stroke="#4a5568" stroke-width="1"/>
            <line x1="660" y1="480" x2="660" y2="460" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="380" y="475" font-size="7" fill="#276749">Skip services</text>

            <!-- PHASE 5: Billing & Closure -->
            <rect x="20" y="475" width="710" height="95" rx="8" fill="#feebc8" stroke="#ed8936" stroke-width="1"/>
            <text x="35" y="495" font-weight="bold" font-size="11" fill="#c05621">PHASE 5: Billing &amp; Closure</text>

            <!-- Generate Bill -->
            <rect x="80" y="510" width="100" height="45" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <text x="130" y="528" text-anchor="middle" font-size="9" fill="#c05621">Generate Bill</text>
            <text x="130" y="542" text-anchor="middle" font-size="8" fill="#c05621">(All Services)</text>

            <!-- Insurance Check -->
            <polygon points="240,515 280,535 240,555 200,535" fill="#fef3c7" stroke="#d69e2e" stroke-width="2"/>
            <text x="240" y="532" text-anchor="middle" font-size="7" fill="#744210">Insur</text>
            <text x="240" y="542" text-anchor="middle" font-size="7" fill="#744210">ance?</text>

            <!-- Insurance Processing -->
            <rect x="310" y="505" width="90" height="30" rx="5" fill="#bee3f8" stroke="#3182ce"/>
            <text x="355" y="524" text-anchor="middle" font-size="8" fill="#2c5282">TPA Processing</text>

            <!-- Payment -->
            <rect x="420" y="510" width="100" height="45" rx="6" fill="#fff" stroke="#48bb78" stroke-width="2"/>
            <text x="470" y="528" text-anchor="middle" font-size="9" fill="#276749">Payment</text>
            <text x="470" y="542" text-anchor="middle" font-size="8" fill="#276749">Collection</text>

            <!-- Print Documents -->
            <rect x="540" y="510" width="90" height="45" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <text x="585" y="528" text-anchor="middle" font-size="9" fill="#553c9a">Print</text>
            <text x="585" y="542" text-anchor="middle" font-size="8" fill="#553c9a">Documents</text>

            <!-- End -->
            <circle cx="680" cy="532" r="22" fill="#f56565" stroke="#c53030" stroke-width="2"/>
            <text x="680" y="537" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">END</text>

            <!-- Arrows Phase 5 -->
            <line x1="660" y1="460" x2="660" y2="490" stroke="#4a5568" stroke-width="1"/>
            <line x1="660" y1="490" x2="130" y2="490" stroke="#4a5568" stroke-width="1"/>
            <line x1="130" y1="490" x2="130" y2="510" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="180" y1="532" x2="200" y2="535" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="280" y1="525" x2="310" y2="520" stroke="#4a5568" stroke-width="1"/>
            <text x="295" y="515" font-size="7" fill="#276749">Yes</text>
            <line x1="280" y1="545" x2="420" y2="535" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="350" y="545" font-size="7" fill="#c53030">No</text>
            <line x1="400" y1="520" x2="420" y2="525" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="520" y1="532" x2="540" y2="532" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="630" y1="532" x2="658" y2="532" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>

            <!-- Follow-up Branch -->
            <rect x="540" y="560" width="90" height="30" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="585" y="580" text-anchor="middle" font-size="8" fill="#276749">Schedule Follow-up</text>
            <line x1="585" y1="555" x2="585" y2="560" stroke="#4a5568" stroke-width="1" stroke-dasharray="3"/>

            <!-- Legend -->
            <rect x="20" y="580" width="710" height="60" rx="6" fill="#edf2f7" stroke="#a0aec0"/>
            <text x="35" y="598" font-weight="bold" font-size="10" fill="#2d3748">Legend:</text>
            <rect x="100" y="590" width="15" height="15" rx="3" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="120" y="601" font-size="8" fill="#4a5568">Process Step</text>
            <polygon points="210,590 225,597 210,605 195,597" fill="#fef3c7" stroke="#d69e2e"/>
            <text x="235" y="601" font-size="8" fill="#4a5568">Decision</text>
            <circle cx="320" cy="597" r="8" fill="#48bb78"/>
            <text x="335" y="601" font-size="8" fill="#4a5568">Start/End</text>
            <rect x="400" y="590" width="15" height="15" rx="3" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <text x="420" y="601" font-size="8" fill="#4a5568">Action</text>
            <line x1="490" y1="597" x2="520" y2="597" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="530" y="601" font-size="8" fill="#4a5568">Flow Direction</text>

            <text x="35" y="625" font-size="9" fill="#718096">API Endpoints: POST /patients  POST /opd-visits  POST /start-consultation  POST /complete-consultation  POST /bills  POST /payments</text>

            <!-- Arrow marker definition -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#4a5568"/>
                </marker>
            </defs>
        </svg>
    </div>

    <!-- OPD Registration Types Workflow -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">OPD Registration Types &amp; Pathways</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="490" fill="#f8fafc" rx="10"/>

            <!-- Entry Point -->
            <circle cx="375" cy="40" r="25" fill="#3182ce" stroke="#2c5282" stroke-width="2"/>
            <text x="375" y="45" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Patient</text>

            <!-- Registration Type Selection -->
            <rect x="275" y="80" width="200" height="40" rx="8" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="375" y="105" text-anchor="middle" font-weight="bold" font-size="11" fill="#2c5282">Select Registration Purpose</text>

            <line x1="375" y1="65" x2="375" y2="80" stroke="#4a5568" stroke-width="2"/>

            <!-- Four Registration Types -->
            <!-- 1. Normal Registration -->
            <rect x="30" y="150" width="160" height="120" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <rect x="30" y="150" width="160" height="30" rx="8" fill="#48bb78"/>
            <text x="110" y="170" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">NORMAL</text>
            <text x="110" y="200" text-anchor="middle" font-size="9" fill="#276749">Regular OPD Visit</text>
            <text x="110" y="215" text-anchor="middle" font-size="8" fill="#4a5568"> Appointment-based</text>
            <text x="110" y="230" text-anchor="middle" font-size="8" fill="#4a5568"> Walk-in accepted</text>
            <text x="110" y="245" text-anchor="middle" font-size="8" fill="#4a5568"> Token generated</text>
            <text x="110" y="260" text-anchor="middle" font-size="8" fill="#4a5568"> Standard queue</text>

            <!-- 2. Direct Consultation -->
            <rect x="210" y="150" width="160" height="120" rx="8" fill="#bee3f8" stroke="#3182ce" stroke-width="2"/>
            <rect x="210" y="150" width="160" height="30" rx="8" fill="#3182ce"/>
            <text x="290" y="170" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">DIRECT</text>
            <text x="290" y="200" text-anchor="middle" font-size="9" fill="#2c5282">Direct Consultation</text>
            <text x="290" y="215" text-anchor="middle" font-size="8" fill="#4a5568"> Skip waiting queue</text>
            <text x="290" y="230" text-anchor="middle" font-size="8" fill="#4a5568"> VIP patients</text>
            <text x="290" y="245" text-anchor="middle" font-size="8" fill="#4a5568"> Premium service</text>
            <text x="290" y="260" text-anchor="middle" font-size="8" fill="#4a5568"> Higher charges</text>

            <!-- 3. Health Checkup -->
            <rect x="390" y="150" width="160" height="120" rx="8" fill="#e9d8fd" stroke="#9f7aea" stroke-width="2"/>
            <rect x="390" y="150" width="160" height="30" rx="8" fill="#9f7aea"/>
            <text x="470" y="170" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">HEALTH CHECKUP</text>
            <text x="470" y="200" text-anchor="middle" font-size="9" fill="#553c9a">Preventive Care</text>
            <text x="470" y="215" text-anchor="middle" font-size="8" fill="#4a5568"> Package-based</text>
            <text x="470" y="230" text-anchor="middle" font-size="8" fill="#4a5568"> Pre-defined tests</text>
            <text x="470" y="245" text-anchor="middle" font-size="8" fill="#4a5568"> Corporate clients</text>
            <text x="470" y="260" text-anchor="middle" font-size="8" fill="#4a5568"> Bundled pricing</text>

            <!-- 4. Emergency -->
            <rect x="570" y="150" width="160" height="120" rx="8" fill="#fed7d7" stroke="#f56565" stroke-width="2"/>
            <rect x="570" y="150" width="160" height="30" rx="8" fill="#f56565"/>
            <text x="650" y="170" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">EMERGENCY</text>
            <text x="650" y="200" text-anchor="middle" font-size="9" fill="#c53030">Critical Care</text>
            <text x="650" y="215" text-anchor="middle" font-size="8" fill="#4a5568"> Immediate attention</text>
            <text x="650" y="230" text-anchor="middle" font-size="8" fill="#4a5568"> MLC case handling</text>
            <text x="650" y="245" text-anchor="middle" font-size="8" fill="#4a5568"> Priority triage</text>
            <text x="650" y="260" text-anchor="middle" font-size="8" fill="#4a5568"> May convert to IPD</text>

            <!-- Arrows from selection to types -->
            <line x1="275" y1="100" x2="110" y2="150" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="325" y1="120" x2="290" y2="150" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="425" y1="120" x2="470" y2="150" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="475" y1="100" x2="650" y2="150" stroke="#4a5568" stroke-width="1.5"/>

            <!-- Processing Flow for each type -->
            <!-- Normal Flow -->
            <rect x="50" y="290" width="120" height="35" rx="5" fill="#fff" stroke="#48bb78"/>
            <text x="110" y="312" text-anchor="middle" font-size="8" fill="#276749">Queue Position</text>
            <line x1="110" y1="270" x2="110" y2="290" stroke="#48bb78" stroke-width="1.5"/>

            <!-- Direct Flow -->
            <rect x="230" y="290" width="120" height="35" rx="5" fill="#fff" stroke="#3182ce"/>
            <text x="290" y="312" text-anchor="middle" font-size="8" fill="#2c5282">Immediate Consult</text>
            <line x1="290" y1="270" x2="290" y2="290" stroke="#3182ce" stroke-width="1.5"/>

            <!-- Health Checkup Flow -->
            <rect x="410" y="290" width="120" height="35" rx="5" fill="#fff" stroke="#9f7aea"/>
            <text x="470" y="312" text-anchor="middle" font-size="8" fill="#553c9a">Package Services</text>
            <line x1="470" y1="270" x2="470" y2="290" stroke="#9f7aea" stroke-width="1.5"/>

            <!-- Emergency Flow -->
            <rect x="590" y="290" width="120" height="35" rx="5" fill="#fff" stroke="#f56565"/>
            <text x="650" y="312" text-anchor="middle" font-size="8" fill="#c53030">Triage &amp; Stabilize</text>
            <line x1="650" y1="270" x2="650" y2="290" stroke="#f56565" stroke-width="1.5"/>

            <!-- Convergence Point -->
            <rect x="275" y="360" width="200" height="50" rx="8" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="382" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Doctor Consultation</text>
            <text x="375" y="398" text-anchor="middle" font-size="9" fill="#c05621">(Common Flow)</text>

            <!-- Arrows to convergence -->
            <line x1="110" y1="325" x2="110" y2="350" stroke="#4a5568" stroke-width="1"/>
            <line x1="110" y1="350" x2="275" y2="385" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="290" y1="325" x2="290" y2="360" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="470" y1="325" x2="470" y2="360" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="650" y1="325" x2="650" y2="350" stroke="#4a5568" stroke-width="1"/>
            <line x1="650" y1="350" x2="475" y2="385" stroke="#4a5568" stroke-width="1.5"/>

            <!-- Post Consultation -->
            <rect x="275" y="430" width="200" height="40" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="375" y="455" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Billing &amp; Discharge</text>

            <line x1="375" y1="410" x2="375" y2="430" stroke="#4a5568" stroke-width="1.5"/>

            <!-- API Reference Box -->
            <rect x="30" y="350" width="180" height="80" rx="6" fill="#edf2f7" stroke="#a0aec0"/>
            <text x="120" y="370" text-anchor="middle" font-weight="bold" font-size="9" fill="#2d3748">API: POST /opd-visits</text>
            <text x="40" y="388" font-size="8" fill="#4a5568">registration_purpose:</text>
            <text x="50" y="402" font-size="8" fill="#718096"> "normal"</text>
            <text x="50" y="416" font-size="8" fill="#718096"> "direct"</text>
            <text x="120" y="402" font-size="8" fill="#718096"> "health_checkup"</text>
            <text x="120" y="416" font-size="8" fill="#718096"> "emergency"</text>
        </svg>
    </div>

    <!-- Doctor Queue Management Workflow -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Doctor Queue &amp; Consultation Management</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="470" fill="#f8fafc" rx="10"/>

            <!-- Doctor's Dashboard Section -->
            <rect x="20" y="20" width="350" height="200" rx="8" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="195" y="45" text-anchor="middle" font-weight="bold" font-size="12" fill="#2c5282">Doctor's Queue Dashboard</text>

            <!-- Queue List -->
            <rect x="35" y="60" width="150" height="145" rx="6" fill="#fff" stroke="#a0aec0"/>
            <text x="110" y="80" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Today's Queue</text>

            <!-- Queue Items -->
            <rect x="45" y="90" width="130" height="22" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="55" y="105" font-size="8" fill="#c53030">1. John Doe - Emergency</text>

            <rect x="45" y="115" width="130" height="22" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="55" y="130" font-size="8" fill="#c05621">2. Jane Smith - Urgent</text>

            <rect x="45" y="140" width="130" height="22" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="55" y="155" font-size="8" fill="#276749">3. Bob Wilson - Normal</text>

            <rect x="45" y="165" width="130" height="22" rx="4" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="55" y="180" font-size="8" fill="#4a5568">4. Alice Brown - Normal</text>

            <!-- Queue Stats -->
            <rect x="200" y="60" width="155" height="145" rx="6" fill="#fff" stroke="#a0aec0"/>
            <text x="277" y="80" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Statistics</text>

            <text x="210" y="100" font-size="9" fill="#4a5568">Total Patients:</text>
            <text x="330" y="100" text-anchor="end" font-weight="bold" font-size="9" fill="#2d3748">24</text>

            <text x="210" y="118" font-size="9" fill="#4a5568">Waiting:</text>
            <text x="330" y="118" text-anchor="end" font-weight="bold" font-size="9" fill="#ed8936">12</text>

            <text x="210" y="136" font-size="9" fill="#4a5568">In Consultation:</text>
            <text x="330" y="136" text-anchor="end" font-weight="bold" font-size="9" fill="#3182ce">1</text>

            <text x="210" y="154" font-size="9" fill="#4a5568">Completed:</text>
            <text x="330" y="154" text-anchor="end" font-weight="bold" font-size="9" fill="#48bb78">11</text>

            <text x="210" y="175" font-size="9" fill="#4a5568">Avg Wait Time:</text>
            <text x="330" y="175" text-anchor="end" font-weight="bold" font-size="9" fill="#9f7aea">18 min</text>

            <text x="210" y="193" font-size="9" fill="#4a5568">Avg Consult Time:</text>
            <text x="330" y="193" text-anchor="end" font-weight="bold" font-size="9" fill="#667eea">12 min</text>

            <!-- Consultation Room Section -->
            <rect x="390" y="20" width="340" height="200" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="560" y="45" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Active Consultation</text>

            <!-- Current Patient Info -->
            <rect x="405" y="60" width="155" height="145" rx="6" fill="#fff" stroke="#a0aec0"/>
            <text x="482" y="80" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Current Patient</text>

            <text x="415" y="100" font-size="9" fill="#4a5568">Name:</text>
            <text x="540" y="100" text-anchor="end" font-weight="bold" font-size="9" fill="#2d3748">John Doe</text>

            <text x="415" y="118" font-size="9" fill="#4a5568">Token:</text>
            <text x="540" y="118" text-anchor="end" font-weight="bold" font-size="9" fill="#f56565">T-001</text>

            <text x="415" y="136" font-size="9" fill="#4a5568">Visit Type:</text>
            <text x="540" y="136" text-anchor="end" font-weight="bold" font-size="9" fill="#ed8936">Follow-up</text>

            <text x="415" y="154" font-size="9" fill="#4a5568">Chief Complaint:</text>
            <text x="415" y="170" font-size="8" fill="#718096">Fever, Headache since 3 days</text>

            <rect x="415" y="180" width="135" height="20" rx="4" fill="#bee3f8" stroke="#3182ce"/>
            <text x="482" y="194" text-anchor="middle" font-size="8" fill="#2c5282">View History</text>

            <!-- Action Buttons -->
            <rect x="575" y="60" width="140" height="145" rx="6" fill="#fff" stroke="#a0aec0"/>
            <text x="645" y="80" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Actions</text>

            <rect x="585" y="90" width="120" height="28" rx="5" fill="#3182ce"/>
            <text x="645" y="108" text-anchor="middle" font-size="9" fill="#fff">Add Vitals</text>

            <rect x="585" y="123" width="120" height="28" rx="5" fill="#9f7aea"/>
            <text x="645" y="141" text-anchor="middle" font-size="9" fill="#fff">Add Prescription</text>

            <rect x="585" y="156" width="120" height="28" rx="5" fill="#ed8936"/>
            <text x="645" y="174" text-anchor="middle" font-size="9" fill="#fff">Order Tests</text>

            <rect x="585" y="175" width="120" height="28" rx="5" fill="#48bb78"/>
            <text x="645" y="193" text-anchor="middle" font-size="9" fill="#fff">Complete Visit</text>

            <!-- Status Flow Diagram -->
            <rect x="20" y="235" width="710" height="120" rx="8" fill="#fef3c7" stroke="#d69e2e" stroke-width="1"/>
            <text x="375" y="255" text-anchor="middle" font-weight="bold" font-size="12" fill="#744210">OPD Visit Status Transitions</text>

            <!-- Status Boxes -->
            <rect x="50" y="275" width="80" height="50" rx="6" fill="#e2e8f0" stroke="#718096" stroke-width="2"/>
            <text x="90" y="297" text-anchor="middle" font-size="9" fill="#4a5568">WAITING</text>
            <text x="90" y="312" text-anchor="middle" font-size="8" fill="#718096">(Initial)</text>

            <rect x="180" y="275" width="100" height="50" rx="6" fill="#bee3f8" stroke="#3182ce" stroke-width="2"/>
            <text x="230" y="297" text-anchor="middle" font-size="9" fill="#2c5282">IN_CONSUL</text>
            <text x="230" y="312" text-anchor="middle" font-size="9" fill="#2c5282">TATION</text>

            <rect x="330" y="275" width="100" height="50" rx="6" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="380" y="297" text-anchor="middle" font-size="9" fill="#276749">COMPLETED</text>
            <text x="380" y="312" text-anchor="middle" font-size="8" fill="#276749">(Success)</text>

            <rect x="480" y="275" width="80" height="50" rx="6" fill="#fed7d7" stroke="#f56565" stroke-width="2"/>
            <text x="520" y="297" text-anchor="middle" font-size="9" fill="#c53030">CANCELLED</text>
            <text x="520" y="312" text-anchor="middle" font-size="8" fill="#c53030">(Aborted)</text>

            <rect x="610" y="275" width="100" height="50" rx="6" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="660" y="297" text-anchor="middle" font-size="9" fill="#c05621">NO_SHOW</text>
            <text x="660" y="312" text-anchor="middle" font-size="8" fill="#c05621">(Did not arrive)</text>

            <!-- Status Transition Arrows -->
            <line x1="130" y1="300" x2="180" y2="300" stroke="#4a5568" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="155" y="293" font-size="7" fill="#276749">call</text>

            <line x1="280" y1="300" x2="330" y2="300" stroke="#4a5568" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="305" y="293" font-size="7" fill="#276749">done</text>

            <line x1="90" y1="325" x2="90" y2="340" stroke="#4a5568" stroke-width="1"/>
            <line x1="90" y1="340" x2="520" y2="340" stroke="#4a5568" stroke-width="1"/>
            <line x1="520" y1="340" x2="520" y2="325" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="305" y="337" font-size="7" fill="#c53030">cancel</text>

            <line x1="90" y1="275" x2="90" y2="265" stroke="#4a5568" stroke-width="1"/>
            <line x1="90" y1="265" x2="660" y2="265" stroke="#4a5568" stroke-width="1"/>
            <line x1="660" y1="265" x2="660" y2="275" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="375" y="262" font-size="7" fill="#c05621">timeout / no response</text>

            <!-- API Endpoints Section -->
            <rect x="20" y="365" width="710" height="105" rx="8" fill="#edf2f7" stroke="#a0aec0" stroke-width="1"/>
            <text x="375" y="385" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Queue Management API Endpoints</text>

            <rect x="35" y="400" width="210" height="60" rx="5" fill="#fff" stroke="#3182ce"/>
            <text x="140" y="418" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">Get Doctor Queue</text>
            <text x="140" y="432" text-anchor="middle" font-size="8" fill="#4a5568">GET /opd-visits/doctor/{id}/queue</text>
            <text x="140" y="446" text-anchor="middle" font-size="7" fill="#718096">Returns today's patient queue</text>

            <rect x="260" y="400" width="210" height="60" rx="5" fill="#fff" stroke="#48bb78"/>
            <text x="365" y="418" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Start Consultation</text>
            <text x="365" y="432" text-anchor="middle" font-size="8" fill="#4a5568">POST /opd-visits/{id}/start-consultation</text>
            <text x="365" y="446" text-anchor="middle" font-size="7" fill="#718096">Changes status to in_consultation</text>

            <rect x="485" y="400" width="230" height="60" rx="5" fill="#fff" stroke="#9f7aea"/>
            <text x="600" y="418" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Complete Consultation</text>
            <text x="600" y="432" text-anchor="middle" font-size="8" fill="#4a5568">POST /opd-visits/{id}/complete-consultation</text>
            <text x="600" y="446" text-anchor="middle" font-size="7" fill="#718096">Saves diagnosis, marks completed</text>
        </svg>
    </div>

    <!-- OPD Billing Flow -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">OPD Billing &amp; Payment Workflow</div>
        <svg width="750" height="450" viewBox="0 0 750 450">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="440" fill="#f8fafc" rx="10"/>

            <!-- Service Collection Section -->
            <rect x="20" y="20" width="350" height="180" rx="8" fill="#e9d8fd" stroke="#9f7aea" stroke-width="2"/>
            <text x="195" y="42" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">Billable Services Collection</text>

            <!-- Consultation Fee -->
            <rect x="35" y="55" width="150" height="55" rx="6" fill="#fff" stroke="#9f7aea"/>
            <text x="110" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Consultation Fee</text>
            <text x="110" y="90" text-anchor="middle" font-size="8" fill="#4a5568">Based on doctor rate</text>
            <text x="110" y="103" text-anchor="middle" font-size="8" fill="#276749">500.00</text>

            <!-- Services Added -->
            <rect x="200" y="55" width="155" height="55" rx="6" fill="#fff" stroke="#9f7aea"/>
            <text x="277" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">OPD Services</text>
            <text x="277" y="90" text-anchor="middle" font-size="8" fill="#4a5568">Dressing, Injection, etc.</text>
            <text x="277" y="103" text-anchor="middle" font-size="8" fill="#276749">350.00</text>

            <!-- Lab Tests -->
            <rect x="35" y="120" width="150" height="55" rx="6" fill="#fff" stroke="#38b2ac"/>
            <text x="110" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#234e52">Laboratory Tests</text>
            <text x="110" y="155" text-anchor="middle" font-size="8" fill="#4a5568">CBC, LFT, Blood Sugar</text>
            <text x="110" y="168" text-anchor="middle" font-size="8" fill="#276749">1,200.00</text>

            <!-- Radiology -->
            <rect x="200" y="120" width="155" height="55" rx="6" fill="#fff" stroke="#ed8936"/>
            <text x="277" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Radiology</text>
            <text x="277" y="155" text-anchor="middle" font-size="8" fill="#4a5568">X-Ray Chest PA</text>
            <text x="277" y="168" text-anchor="middle" font-size="8" fill="#276749">400.00</text>

            <!-- Pharmacy -->
            <rect x="100" y="180" width="170" height="15" rx="3" fill="#667eea" stroke="#553c9a"/>
            <text x="185" y="191" text-anchor="middle" font-size="8" fill="#fff">+ Pharmacy (Billed Separately)</text>

            <!-- Bill Generation Section -->
            <rect x="390" y="20" width="340" height="180" rx="8" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="560" y="42" text-anchor="middle" font-weight="bold" font-size="12" fill="#c05621">Bill Generation</text>

            <!-- Bill Summary -->
            <rect x="405" y="55" width="155" height="135" rx="6" fill="#fff" stroke="#a0aec0"/>
            <text x="482" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Bill Summary</text>

            <line x1="415" y1="82" x2="550" y2="82" stroke="#e2e8f0" stroke-width="1"/>

            <text x="420" y="98" font-size="8" fill="#4a5568">Consultation:</text>
            <text x="545" y="98" text-anchor="end" font-size="8" fill="#2d3748">500.00</text>

            <text x="420" y="113" font-size="8" fill="#4a5568">Services:</text>
            <text x="545" y="113" text-anchor="end" font-size="8" fill="#2d3748">350.00</text>

            <text x="420" y="128" font-size="8" fill="#4a5568">Lab Tests:</text>
            <text x="545" y="128" text-anchor="end" font-size="8" fill="#2d3748">1,200.00</text>

            <text x="420" y="143" font-size="8" fill="#4a5568">Radiology:</text>
            <text x="545" y="143" text-anchor="end" font-size="8" fill="#2d3748">400.00</text>

            <line x1="415" y1="150" x2="550" y2="150" stroke="#2d3748" stroke-width="1"/>

            <text x="420" y="165" font-weight="bold" font-size="9" fill="#2d3748">Subtotal:</text>
            <text x="545" y="165" text-anchor="end" font-weight="bold" font-size="9" fill="#2d3748">2,450.00</text>

            <text x="420" y="180" font-size="8" fill="#c53030">Discount (10%):</text>
            <text x="545" y="180" text-anchor="end" font-size="8" fill="#c53030">-245.00</text>

            <!-- Final Amount -->
            <rect x="575" y="55" width="140" height="135" rx="6" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="645" y="80" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">Final Amount</text>

            <text x="645" y="110" text-anchor="middle" font-size="24" font-weight="bold" fill="#276749">2,205</text>

            <text x="645" y="135" text-anchor="middle" font-size="8" fill="#4a5568">After Discount</text>

            <rect x="590" y="150" width="110" height="30" rx="5" fill="#48bb78"/>
            <text x="645" y="170" text-anchor="middle" font-size="10" fill="#fff" font-weight="bold">Generate Bill</text>

            <!-- Payment Section -->
            <rect x="20" y="215" width="710" height="105" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="375" y="237" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Payment Collection</text>

            <!-- Payment Modes -->
            <rect x="40" y="250" width="100" height="55" rx="6" fill="#fff" stroke="#48bb78"/>
            <text x="90" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Cash</text>
            <text x="90" y="290" text-anchor="middle" font-size="20" fill="#276749"></text>

            <rect x="155" y="250" width="100" height="55" rx="6" fill="#fff" stroke="#3182ce"/>
            <text x="205" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">Card</text>
            <text x="205" y="290" text-anchor="middle" font-size="20" fill="#2c5282"></text>

            <rect x="270" y="250" width="100" height="55" rx="6" fill="#fff" stroke="#9f7aea"/>
            <text x="320" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">UPI</text>
            <text x="320" y="290" text-anchor="middle" font-size="20" fill="#553c9a"></text>

            <rect x="385" y="250" width="100" height="55" rx="6" fill="#fff" stroke="#ed8936"/>
            <text x="435" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Insurance</text>
            <text x="435" y="290" text-anchor="middle" font-size="20" fill="#c05621"></text>

            <rect x="500" y="250" width="100" height="55" rx="6" fill="#fff" stroke="#f56565"/>
            <text x="550" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Credit</text>
            <text x="550" y="290" text-anchor="middle" font-size="20" fill="#c53030"></text>

            <!-- Payment Status -->
            <rect x="615" y="250" width="100" height="55" rx="6" fill="#276749"/>
            <text x="665" y="275" text-anchor="middle" font-weight="bold" font-size="10" fill="#fff">PAID</text>
            <text x="665" y="293" text-anchor="middle" font-size="8" fill="#9ae6b4">Receipt #12345</text>

            <!-- Documents Section -->
            <rect x="20" y="335" width="710" height="105" rx="8" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="375" y="357" text-anchor="middle" font-weight="bold" font-size="12" fill="#2c5282">Print Documents &amp; Closure</text>

            <!-- Document Types -->
            <rect x="50" y="370" width="120" height="55" rx="6" fill="#fff" stroke="#3182ce"/>
            <text x="110" y="392" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">Bill/Receipt</text>
            <text x="110" y="410" text-anchor="middle" font-size="8" fill="#4a5568">Payment proof</text>

            <rect x="185" y="370" width="120" height="55" rx="6" fill="#fff" stroke="#9f7aea"/>
            <text x="245" y="392" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Prescription</text>
            <text x="245" y="410" text-anchor="middle" font-size="8" fill="#4a5568">Medications list</text>

            <rect x="320" y="370" width="120" height="55" rx="6" fill="#fff" stroke="#38b2ac"/>
            <text x="380" y="392" text-anchor="middle" font-weight="bold" font-size="9" fill="#234e52">Lab Orders</text>
            <text x="380" y="410" text-anchor="middle" font-size="8" fill="#4a5568">Sample collection</text>

            <rect x="455" y="370" width="120" height="55" rx="6" fill="#fff" stroke="#ed8936"/>
            <text x="515" y="392" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Case Paper</text>
            <text x="515" y="410" text-anchor="middle" font-size="8" fill="#4a5568">Visit summary</text>

            <rect x="590" y="370" width="120" height="55" rx="6" fill="#48bb78"/>
            <text x="650" y="392" text-anchor="middle" font-weight="bold" font-size="10" fill="#fff">Follow-up</text>
            <text x="650" y="410" text-anchor="middle" font-size="8" fill="#fff">Appointment</text>

            <!-- Arrow from collection to generation -->
            <line x1="370" y1="100" x2="390" y2="100" stroke="#4a5568" stroke-width="2" marker-end="url(#arrowhead)"/>
        </svg>
    </div>

    <div class="info-box">
        <h4>OPD Workflow Key Points</h4>
        <ul>
            <li><strong>Token System:</strong> Automatic token generation on OPD visit creation with configurable prefix per department</li>
            <li><strong>Queue Priority:</strong> Emergency and urgent cases automatically prioritized in doctor queue</li>
            <li><strong>Free Follow-up:</strong> System tracks follow-up validity based on skill-set configuration (typically 3-7 days)</li>
            <li><strong>Multi-Service:</strong> Single visit can include consultation, procedures, lab tests, radiology, and pharmacy</li>
            <li><strong>Real-time Updates:</strong> Queue status and patient flow visible on dashboards in real-time</li>
            <li><strong>Insurance Integration:</strong> TPA pre-authorization and claim submission workflow supported</li>
        </ul>
    </div>

    <h2>4.3 IPD Module (Inpatient Department)</h2>

    <div class="diagram">
        <div class="diagram-title">IPD Admission Workflow</div>
        <svg width="750" height="200" viewBox="0 0 750 200">
            <!-- Main flow -->
            <rect x="10" y="70" width="85" height="60" rx="8" class="arch-box"/>
            <text x="52" y="95" class="arch-text" font-size="8">Admission</text>
            <text x="52" y="110" class="arch-text" font-size="8">Request</text>

            <rect x="110" y="70" width="85" height="60" rx="8" class="arch-box"/>
            <text x="152" y="95" class="arch-text" font-size="8">Bed</text>
            <text x="152" y="110" class="arch-text" font-size="8">Allocation</text>

            <rect x="210" y="70" width="85" height="60" rx="8" class="arch-box-green"/>
            <text x="252" y="95" class="arch-text" font-size="8">Admitted</text>
            <text x="252" y="110" class="arch-text" font-size="8">Status</text>

            <rect x="310" y="70" width="85" height="60" rx="8" class="arch-box-green"/>
            <text x="352" y="95" class="arch-text" font-size="8">Daily</text>
            <text x="352" y="110" class="arch-text" font-size="8">Care</text>

            <rect x="410" y="70" width="85" height="60" rx="8" class="arch-box-orange"/>
            <text x="452" y="95" class="arch-text" font-size="8">Running</text>
            <text x="452" y="110" class="arch-text" font-size="8">Bill</text>

            <rect x="510" y="70" width="85" height="60" rx="8" class="arch-box-orange"/>
            <text x="552" y="95" class="arch-text" font-size="8">Initiate</text>
            <text x="552" y="110" class="arch-text" font-size="8">Discharge</text>

            <rect x="610" y="70" width="85" height="60" rx="8" class="arch-box-purple"/>
            <text x="652" y="95" class="arch-text" font-size="8">Final Bill</text>
            <text x="652" y="110" class="arch-text" font-size="8">& Discharge</text>

            <!-- Arrows -->
            <line x1="95" y1="100" x2="110" y2="100" class="arch-arrow"/>
            <line x1="195" y1="100" x2="210" y2="100" class="arch-arrow"/>
            <line x1="295" y1="100" x2="310" y2="100" class="arch-arrow"/>
            <line x1="395" y1="100" x2="410" y2="100" class="arch-arrow"/>
            <line x1="495" y1="100" x2="510" y2="100" class="arch-arrow"/>
            <line x1="595" y1="100" x2="610" y2="100" class="arch-arrow"/>

            <!-- Sub-components for Daily Care -->
            <rect x="270" y="150" width="60" height="35" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="300" y="172" class="arch-text-dark" font-size="7">Progress</text>

            <rect x="340" y="150" width="60" height="35" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="370" y="172" class="arch-text-dark" font-size="7">Nursing</text>

            <rect x="410" y="150" width="60" height="35" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="440" y="172" class="arch-text-dark" font-size="7">Meds</text>

            <line x1="352" y1="130" x2="300" y2="150" stroke="#48bb78"/>
            <line x1="352" y1="130" x2="370" y2="150" stroke="#48bb78"/>
            <line x1="352" y1="130" x2="440" y2="150" stroke="#48bb78"/>
        </svg>
    </div>

    <p><strong>Key Features:</strong></p>
    <ul>
        <li>Bed availability tracking across wards</li>
        <li>Progress notes by doctors</li>
        <li>Nursing charts with vital monitoring</li>
        <li>Medication administration tracking</li>
        <li>Running bill calculation</li>
        <li>Bed transfer management</li>
        <li>Discharge workflow with summary</li>
    </ul>

    <h3>4.3.1 Detailed IPD Admission Flow Diagrams</h3>

    <!-- Complete IPD Patient Journey -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Complete IPD Patient Journey</div>
        <svg width="750" height="700" viewBox="0 0 750 700">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="690" fill="#f8fafc" rx="10"/>

            <!-- Title -->
            <text x="375" y="30" text-anchor="middle" font-weight="bold" font-size="14" fill="#1a365d">End-to-End IPD Admission Flow</text>

            <!-- PHASE 1: Admission Request -->
            <rect x="20" y="45" width="710" height="95" rx="8" fill="#ebf8ff" stroke="#3182ce" stroke-width="1"/>
            <text x="35" y="65" font-weight="bold" font-size="11" fill="#2c5282">PHASE 1: Admission Request &amp; Bed Allocation</text>

            <!-- Start -->
            <circle cx="60" cy="100" r="20" fill="#3182ce" stroke="#2c5282" stroke-width="2"/>
            <text x="60" y="105" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">START</text>

            <!-- Admission Source -->
            <polygon points="140,80 180,100 140,120 100,100" fill="#fef3c7" stroke="#d69e2e" stroke-width="2"/>
            <text x="140" y="104" text-anchor="middle" font-size="7" fill="#744210">Source?</text>

            <!-- OPD Referral -->
            <rect x="200" y="75" width="80" height="35" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="240" y="97" text-anchor="middle" font-size="8" fill="#276749">OPD Referral</text>

            <!-- Emergency -->
            <rect x="200" y="115" width="80" height="20" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="240" y="129" text-anchor="middle" font-size="7" fill="#c53030">Emergency</text>

            <!-- Check Bed Availability -->
            <rect x="310" y="75" width="100" height="50" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <text x="360" y="95" text-anchor="middle" font-size="9" fill="#2c5282">Check Bed</text>
            <text x="360" y="108" text-anchor="middle" font-size="9" fill="#2c5282">Availability</text>

            <!-- Bed Available Decision -->
            <polygon points="470,80 510,100 470,120 430,100" fill="#fef3c7" stroke="#d69e2e" stroke-width="2"/>
            <text x="470" y="97" text-anchor="middle" font-size="7" fill="#744210">Bed</text>
            <text x="470" y="107" text-anchor="middle" font-size="7" fill="#744210">Avail?</text>

            <!-- Allocate Bed -->
            <rect x="540" y="75" width="90" height="50" rx="6" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="585" y="95" text-anchor="middle" font-size="9" fill="#276749">Allocate Bed</text>
            <text x="585" y="108" text-anchor="middle" font-size="8" fill="#276749">&amp; Ward</text>

            <!-- Create Admission -->
            <rect x="650" y="75" width="70" height="50" rx="6" fill="#3182ce"/>
            <text x="685" y="95" text-anchor="middle" font-size="8" fill="#fff">Create</text>
            <text x="685" y="108" text-anchor="middle" font-size="8" fill="#fff">Admission</text>

            <!-- Waitlist -->
            <rect x="470" y="45" width="70" height="25" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="505" y="62" text-anchor="middle" font-size="7" fill="#c05621">Waitlist</text>

            <!-- Arrows Phase 1 -->
            <line x1="80" y1="100" x2="100" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="180" y1="92" x2="200" y2="92" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="180" y1="108" x2="200" y2="125" stroke="#4a5568" stroke-width="1"/>
            <line x1="280" y1="92" x2="310" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="280" y1="125" x2="310" y2="100" stroke="#4a5568" stroke-width="1"/>
            <line x1="410" y1="100" x2="430" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="510" y1="100" x2="540" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="525" y="95" font-size="6" fill="#276749">Yes</text>
            <line x1="470" y1="80" x2="470" y2="70" stroke="#4a5568" stroke-width="1"/>
            <line x1="470" y1="70" x2="505" y2="70" stroke="#4a5568" stroke-width="1"/>
            <text x="488" y="78" font-size="6" fill="#c53030">No</text>
            <line x1="630" y1="100" x2="650" y2="100" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>

            <!-- PHASE 2: Initial Assessment -->
            <rect x="20" y="150" width="710" height="90" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="1"/>
            <text x="35" y="170" font-weight="bold" font-size="11" fill="#276749">PHASE 2: Initial Assessment &amp; Documentation</text>

            <!-- Admission Documentation -->
            <rect x="50" y="185" width="100" height="45" rx="6" fill="#fff" stroke="#48bb78" stroke-width="2"/>
            <text x="100" y="203" text-anchor="middle" font-size="9" fill="#276749">Admission</text>
            <text x="100" y="218" text-anchor="middle" font-size="8" fill="#276749">Documentation</text>

            <!-- Consent Forms -->
            <rect x="170" y="185" width="90" height="45" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <text x="215" y="203" text-anchor="middle" font-size="9" fill="#553c9a">Consent</text>
            <text x="215" y="218" text-anchor="middle" font-size="8" fill="#553c9a">Forms</text>

            <!-- Initial Vitals -->
            <rect x="280" y="185" width="90" height="45" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <text x="325" y="203" text-anchor="middle" font-size="9" fill="#234e52">Initial Vitals</text>
            <text x="325" y="218" text-anchor="middle" font-size="8" fill="#234e52">Recording</text>

            <!-- Nursing Assessment -->
            <rect x="390" y="185" width="100" height="45" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <text x="440" y="203" text-anchor="middle" font-size="9" fill="#553c9a">Nursing</text>
            <text x="440" y="218" text-anchor="middle" font-size="8" fill="#553c9a">Assessment</text>

            <!-- Doctor's Initial Orders -->
            <rect x="510" y="185" width="100" height="45" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <text x="560" y="203" text-anchor="middle" font-size="9" fill="#2c5282">Doctor's Initial</text>
            <text x="560" y="218" text-anchor="middle" font-size="8" fill="#2c5282">Orders</text>

            <!-- Patient Admitted -->
            <rect x="630" y="185" width="90" height="45" rx="6" fill="#48bb78"/>
            <text x="675" y="203" text-anchor="middle" font-size="9" fill="#fff">Patient</text>
            <text x="675" y="218" text-anchor="middle" font-size="8" fill="#fff">ADMITTED</text>

            <!-- Arrows Phase 2 -->
            <line x1="685" y1="125" x2="685" y2="145" stroke="#4a5568" stroke-width="1"/>
            <line x1="685" y1="145" x2="100" y2="145" stroke="#4a5568" stroke-width="1"/>
            <line x1="100" y1="145" x2="100" y2="185" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="150" y1="207" x2="170" y2="207" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="260" y1="207" x2="280" y2="207" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="370" y1="207" x2="390" y2="207" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="490" y1="207" x2="510" y2="207" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="610" y1="207" x2="630" y2="207" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>

            <!-- PHASE 3: Daily Care (Main Phase) -->
            <rect x="20" y="250" width="710" height="160" rx="8" fill="#fef3c7" stroke="#d69e2e" stroke-width="1"/>
            <text x="35" y="270" font-weight="bold" font-size="11" fill="#744210">PHASE 3: Daily Inpatient Care (Continuous)</text>

            <!-- Doctor Rounds -->
            <rect x="40" y="285" width="100" height="55" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <text x="90" y="305" text-anchor="middle" font-size="9" fill="#2c5282">Doctor Rounds</text>
            <text x="90" y="320" text-anchor="middle" font-size="8" fill="#4a5568">Progress Notes</text>
            <text x="90" y="333" text-anchor="middle" font-size="7" fill="#718096">Daily assessment</text>

            <!-- Nursing Care -->
            <rect x="160" y="285" width="100" height="55" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <text x="210" y="305" text-anchor="middle" font-size="9" fill="#553c9a">Nursing Care</text>
            <text x="210" y="320" text-anchor="middle" font-size="8" fill="#4a5568">Shift Handover</text>
            <text x="210" y="333" text-anchor="middle" font-size="7" fill="#718096">8-hour shifts</text>

            <!-- Medication Admin -->
            <rect x="280" y="285" width="100" height="55" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <text x="330" y="305" text-anchor="middle" font-size="9" fill="#553c9a">Medication</text>
            <text x="330" y="320" text-anchor="middle" font-size="8" fill="#4a5568">Administration</text>
            <text x="330" y="333" text-anchor="middle" font-size="7" fill="#718096">MAR tracking</text>

            <!-- Vitals Monitoring -->
            <rect x="400" y="285" width="100" height="55" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <text x="450" y="305" text-anchor="middle" font-size="9" fill="#234e52">Vitals</text>
            <text x="450" y="320" text-anchor="middle" font-size="8" fill="#4a5568">Monitoring</text>
            <text x="450" y="333" text-anchor="middle" font-size="7" fill="#718096">Scheduled checks</text>

            <!-- Investigations -->
            <rect x="520" y="285" width="90" height="55" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <text x="565" y="305" text-anchor="middle" font-size="9" fill="#c05621">Lab/Radiology</text>
            <text x="565" y="320" text-anchor="middle" font-size="8" fill="#4a5568">Orders</text>
            <text x="565" y="333" text-anchor="middle" font-size="7" fill="#718096">As needed</text>

            <!-- Procedures -->
            <rect x="630" y="285" width="90" height="55" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <text x="675" y="305" text-anchor="middle" font-size="9" fill="#c53030">Procedures</text>
            <text x="675" y="320" text-anchor="middle" font-size="8" fill="#4a5568">&amp; OT</text>
            <text x="675" y="333" text-anchor="middle" font-size="7" fill="#718096">If scheduled</text>

            <!-- Daily Cycle Arrow -->
            <path d="M 90 340 Q 90 370, 130 370 L 630 370 Q 680 370, 680 340" fill="none" stroke="#d69e2e" stroke-width="2" stroke-dasharray="5"/>
            <text x="375" y="385" text-anchor="middle" font-size="9" font-style="italic" fill="#744210">Repeat daily until discharge decision</text>

            <!-- Running Bill Section -->
            <rect x="40" y="355" width="180" height="45" rx="6" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="130" y="375" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Running Bill Updated</text>
            <text x="130" y="390" text-anchor="middle" font-size="8" fill="#4a5568">Bed + Services + Meds + Tests</text>

            <!-- Consultant Visits -->
            <rect x="240" y="355" width="140" height="45" rx="6" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="310" y="375" text-anchor="middle" font-size="9" fill="#553c9a">Consultant Visits</text>
            <text x="310" y="390" text-anchor="middle" font-size="8" fill="#4a5568">Multi-specialty care</text>

            <!-- Diet & Nutrition -->
            <rect x="400" y="355" width="110" height="45" rx="6" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="455" y="375" text-anchor="middle" font-size="9" fill="#276749">Diet Orders</text>
            <text x="455" y="390" text-anchor="middle" font-size="8" fill="#4a5568">Nutrition plan</text>

            <!-- Arrows from Phase 2 -->
            <line x1="675" y1="230" x2="675" y2="245" stroke="#4a5568" stroke-width="1"/>
            <line x1="675" y1="245" x2="90" y2="245" stroke="#4a5568" stroke-width="1"/>
            <line x1="90" y1="245" x2="90" y2="285" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>

            <!-- PHASE 4: Discharge Process -->
            <rect x="20" y="420" width="710" height="130" rx="8" fill="#e9d8fd" stroke="#9f7aea" stroke-width="1"/>
            <text x="35" y="440" font-weight="bold" font-size="11" fill="#553c9a">PHASE 4: Discharge Process</text>

            <!-- Discharge Decision -->
            <polygon points="80,470 120,490 80,510 40,490" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="80" y="487" text-anchor="middle" font-size="7" fill="#276749">Ready</text>
            <text x="80" y="497" text-anchor="middle" font-size="7" fill="#276749">to DC?</text>

            <!-- Initiate Discharge -->
            <rect x="150" y="465" width="90" height="50" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <text x="195" y="485" text-anchor="middle" font-size="9" fill="#553c9a">Initiate</text>
            <text x="195" y="500" text-anchor="middle" font-size="8" fill="#553c9a">Discharge</text>

            <!-- Clearances -->
            <rect x="260" y="460" width="100" height="60" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <text x="310" y="480" text-anchor="middle" font-size="9" fill="#2c5282">Clearances</text>
            <text x="310" y="495" text-anchor="middle" font-size="7" fill="#4a5568"> Pharmacy</text>
            <text x="310" y="508" text-anchor="middle" font-size="7" fill="#4a5568"> Lab  Accounts</text>

            <!-- Discharge Summary -->
            <rect x="380" y="465" width="100" height="50" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <text x="430" y="485" text-anchor="middle" font-size="9" fill="#553c9a">Discharge</text>
            <text x="430" y="500" text-anchor="middle" font-size="8" fill="#553c9a">Summary</text>

            <!-- Final Bill -->
            <rect x="500" y="465" width="90" height="50" rx="6" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="545" y="485" text-anchor="middle" font-size="9" fill="#c05621">Final Bill</text>
            <text x="545" y="500" text-anchor="middle" font-size="8" fill="#c05621">Settlement</text>

            <!-- Release Patient -->
            <rect x="610" y="465" width="100" height="50" rx="6" fill="#48bb78"/>
            <text x="660" y="485" text-anchor="middle" font-size="9" fill="#fff">Release</text>
            <text x="660" y="500" text-anchor="middle" font-size="8" fill="#fff">Patient</text>

            <!-- End -->
            <circle cx="660" cy="540" r="18" fill="#f56565" stroke="#c53030" stroke-width="2"/>
            <text x="660" y="545" text-anchor="middle" fill="#fff" font-size="9" font-weight="bold">END</text>

            <!-- Arrows Phase 4 -->
            <line x1="375" y1="400" x2="375" y2="415" stroke="#4a5568" stroke-width="1"/>
            <line x1="375" y1="415" x2="80" y2="415" stroke="#4a5568" stroke-width="1"/>
            <line x1="80" y1="415" x2="80" y2="470" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="120" y1="490" x2="150" y2="490" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="135" y="485" font-size="6" fill="#276749">Yes</text>
            <line x1="240" y1="490" x2="260" y2="490" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="360" y1="490" x2="380" y2="490" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="480" y1="490" x2="500" y2="490" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="590" y1="490" x2="610" y2="490" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <line x1="660" y1="515" x2="660" y2="522" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>

            <!-- Continue Care Loop -->
            <line x1="80" y1="510" x2="80" y2="530" stroke="#4a5568" stroke-width="1"/>
            <line x1="80" y1="530" x2="20" y2="530" stroke="#4a5568" stroke-width="1"/>
            <line x1="20" y1="530" x2="20" y2="310" stroke="#4a5568" stroke-width="1"/>
            <line x1="20" y1="310" x2="40" y2="310" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrowhead)"/>
            <text x="30" y="420" font-size="7" fill="#c53030" transform="rotate(-90,30,420)">Continue Care</text>

            <!-- PHASE 5: Post-Discharge -->
            <rect x="20" y="560" width="710" height="80" rx="8" fill="#ebf8ff" stroke="#3182ce" stroke-width="1"/>
            <text x="35" y="580" font-weight="bold" font-size="11" fill="#2c5282">PHASE 5: Post-Discharge</text>

            <!-- Bed Release -->
            <rect x="50" y="595" width="90" height="35" rx="5" fill="#fff" stroke="#48bb78"/>
            <text x="95" y="617" text-anchor="middle" font-size="8" fill="#276749">Bed Released</text>

            <!-- Follow-up Scheduling -->
            <rect x="160" y="595" width="100" height="35" rx="5" fill="#fff" stroke="#9f7aea"/>
            <text x="210" y="617" text-anchor="middle" font-size="8" fill="#553c9a">Follow-up OPD</text>

            <!-- Medications -->
            <rect x="280" y="595" width="100" height="35" rx="5" fill="#fff" stroke="#667eea"/>
            <text x="330" y="617" text-anchor="middle" font-size="8" fill="#553c9a">Discharge Meds</text>

            <!-- Instructions -->
            <rect x="400" y="595" width="100" height="35" rx="5" fill="#fff" stroke="#ed8936"/>
            <text x="450" y="617" text-anchor="middle" font-size="8" fill="#c05621">Home Care Tips</text>

            <!-- MRD Update -->
            <rect x="520" y="595" width="90" height="35" rx="5" fill="#fff" stroke="#3182ce"/>
            <text x="565" y="617" text-anchor="middle" font-size="8" fill="#2c5282">MRD Update</text>

            <!-- Insurance Claim -->
            <rect x="630" y="595" width="90" height="35" rx="5" fill="#feebc8" stroke="#ed8936"/>
            <text x="675" y="617" text-anchor="middle" font-size="8" fill="#c05621">TPA Claim</text>

            <!-- Legend -->
            <rect x="20" y="650" width="710" height="40" rx="6" fill="#edf2f7" stroke="#a0aec0"/>
            <text x="35" y="670" font-weight="bold" font-size="9" fill="#2d3748">API Flow:</text>
            <text x="95" y="670" font-size="8" fill="#4a5568">POST /ipd-admissions  GET /bed-availability  POST /assign-bed  POST /progress-notes  POST /nursing-notes  POST /initiate-discharge  POST /complete-discharge</text>

            <!-- Arrow marker definition -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#4a5568"/>
                </marker>
            </defs>
        </svg>
    </div>

    <!-- IPD Admission Types -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">IPD Admission Types &amp; Sources</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="470" fill="#f8fafc" rx="10"/>

            <!-- Central Hub -->
            <circle cx="375" cy="120" r="50" fill="#3182ce" stroke="#2c5282" stroke-width="3"/>
            <text x="375" y="115" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">IPD</text>
            <text x="375" y="130" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">Admission</text>

            <!-- Admission Sources -->
            <!-- 1. OPD Referral -->
            <rect x="50" y="50" width="140" height="80" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <rect x="50" y="50" width="140" height="25" rx="8" fill="#48bb78"/>
            <text x="120" y="68" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">OPD REFERRAL</text>
            <text x="120" y="90" text-anchor="middle" font-size="8" fill="#276749">Doctor-referred</text>
            <text x="120" y="103" text-anchor="middle" font-size="8" fill="#276749">from consultation</text>
            <text x="120" y="116" text-anchor="middle" font-size="7" fill="#4a5568">Planned admission</text>

            <!-- 2. Emergency -->
            <rect x="50" y="150" width="140" height="80" rx="8" fill="#fed7d7" stroke="#f56565" stroke-width="2"/>
            <rect x="50" y="150" width="140" height="25" rx="8" fill="#f56565"/>
            <text x="120" y="168" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">EMERGENCY</text>
            <text x="120" y="190" text-anchor="middle" font-size="8" fill="#c53030">Casualty/ER cases</text>
            <text x="120" y="203" text-anchor="middle" font-size="8" fill="#c53030">Immediate care</text>
            <text x="120" y="216" text-anchor="middle" font-size="7" fill="#4a5568">Priority admission</text>

            <!-- 3. Elective Surgery -->
            <rect x="560" y="50" width="140" height="80" rx="8" fill="#e9d8fd" stroke="#9f7aea" stroke-width="2"/>
            <rect x="560" y="50" width="140" height="25" rx="8" fill="#9f7aea"/>
            <text x="630" y="68" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">ELECTIVE</text>
            <text x="630" y="90" text-anchor="middle" font-size="8" fill="#553c9a">Pre-scheduled</text>
            <text x="630" y="103" text-anchor="middle" font-size="8" fill="#553c9a">surgery/procedures</text>
            <text x="630" y="116" text-anchor="middle" font-size="7" fill="#4a5568">Pre-authorized</text>

            <!-- 4. Transfer -->
            <rect x="560" y="150" width="140" height="80" rx="8" fill="#bee3f8" stroke="#3182ce" stroke-width="2"/>
            <rect x="560" y="150" width="140" height="25" rx="8" fill="#3182ce"/>
            <text x="630" y="168" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">TRANSFER</text>
            <text x="630" y="190" text-anchor="middle" font-size="8" fill="#2c5282">From other hospital</text>
            <text x="630" y="203" text-anchor="middle" font-size="8" fill="#2c5282">or department</text>
            <text x="630" y="216" text-anchor="middle" font-size="7" fill="#4a5568">Referral-based</text>

            <!-- Connecting Lines to Central Hub -->
            <line x1="190" y1="90" x2="325" y2="105" stroke="#48bb78" stroke-width="2"/>
            <line x1="190" y1="190" x2="325" y2="130" stroke="#f56565" stroke-width="2"/>
            <line x1="560" y1="90" x2="425" y2="105" stroke="#9f7aea" stroke-width="2"/>
            <line x1="560" y1="190" x2="425" y2="130" stroke="#3182ce" stroke-width="2"/>

            <!-- Ward Selection Section -->
            <rect x="200" y="200" width="350" height="100" rx="8" fill="#fef3c7" stroke="#d69e2e" stroke-width="2"/>
            <text x="375" y="222" text-anchor="middle" font-weight="bold" font-size="11" fill="#744210">Ward &amp; Bed Selection</text>

            <!-- Ward Types -->
            <rect x="220" y="235" width="70" height="55" rx="5" fill="#fff" stroke="#48bb78"/>
            <text x="255" y="255" text-anchor="middle" font-size="8" fill="#276749">General</text>
            <text x="255" y="268" text-anchor="middle" font-size="8" fill="#276749">Ward</text>
            <text x="255" y="282" text-anchor="middle" font-size="7" fill="#4a5568">Multi-bed</text>

            <rect x="300" y="235" width="70" height="55" rx="5" fill="#fff" stroke="#3182ce"/>
            <text x="335" y="255" text-anchor="middle" font-size="8" fill="#2c5282">Semi</text>
            <text x="335" y="268" text-anchor="middle" font-size="8" fill="#2c5282">Private</text>
            <text x="335" y="282" text-anchor="middle" font-size="7" fill="#4a5568">2-bed</text>

            <rect x="380" y="235" width="70" height="55" rx="5" fill="#fff" stroke="#9f7aea"/>
            <text x="415" y="255" text-anchor="middle" font-size="8" fill="#553c9a">Private</text>
            <text x="415" y="268" text-anchor="middle" font-size="8" fill="#553c9a">Room</text>
            <text x="415" y="282" text-anchor="middle" font-size="7" fill="#4a5568">Single</text>

            <rect x="460" y="235" width="70" height="55" rx="5" fill="#fed7d7" stroke="#f56565"/>
            <text x="495" y="255" text-anchor="middle" font-size="8" fill="#c53030">ICU/</text>
            <text x="495" y="268" text-anchor="middle" font-size="8" fill="#c53030">CCU</text>
            <text x="495" y="282" text-anchor="middle" font-size="7" fill="#4a5568">Critical</text>

            <!-- Arrow from hub to ward selection -->
            <line x1="375" y1="170" x2="375" y2="200" stroke="#4a5568" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Admission Record Created -->
            <rect x="250" y="320" width="250" height="50" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="375" y="340" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Admission Record Created</text>
            <text x="375" y="358" text-anchor="middle" font-size="9" fill="#276749">IPD Number Generated</text>

            <line x1="375" y1="300" x2="375" y2="320" stroke="#4a5568" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Parallel Processes -->
            <rect x="50" y="390" width="200" height="75" rx="6" fill="#ebf8ff" stroke="#3182ce"/>
            <text x="150" y="412" text-anchor="middle" font-weight="bold" font-size="10" fill="#2c5282">Insurance/TPA</text>
            <text x="150" y="428" text-anchor="middle" font-size="8" fill="#4a5568">Pre-authorization request</text>
            <text x="150" y="443" text-anchor="middle" font-size="8" fill="#4a5568">Cashless approval</text>
            <text x="150" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Advance deposit</text>

            <rect x="275" y="390" width="200" height="75" rx="6" fill="#fef3c7" stroke="#d69e2e"/>
            <text x="375" y="412" text-anchor="middle" font-weight="bold" font-size="10" fill="#744210">Case Management</text>
            <text x="375" y="428" text-anchor="middle" font-size="8" fill="#4a5568">Treatment plan created</text>
            <text x="375" y="443" text-anchor="middle" font-size="8" fill="#4a5568">Doctor team assigned</text>
            <text x="375" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Estimated stay duration</text>

            <rect x="500" y="390" width="200" height="75" rx="6" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="600" y="412" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">Notifications</text>
            <text x="600" y="428" text-anchor="middle" font-size="8" fill="#4a5568">Patient/family SMS</text>
            <text x="600" y="443" text-anchor="middle" font-size="8" fill="#4a5568">Assigned doctor alert</text>
            <text x="600" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Nursing station update</text>

            <!-- Arrows to parallel processes -->
            <line x1="300" y1="370" x2="150" y2="390" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="375" y1="370" x2="375" y2="390" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="450" y1="370" x2="600" y2="390" stroke="#4a5568" stroke-width="1.5"/>
        </svg>
    </div>

    <!-- Daily Care & Clinical Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Daily Inpatient Care &amp; Clinical Management</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="510" fill="#f8fafc" rx="10"/>

            <!-- Time-based Schedule Header -->
            <rect x="20" y="20" width="710" height="40" rx="8" fill="#1a365d"/>
            <text x="375" y="45" text-anchor="middle" fill="#fff" font-weight="bold" font-size="12">24-Hour Inpatient Care Cycle</text>

            <!-- Morning Shift (6 AM - 2 PM) -->
            <rect x="20" y="70" width="230" height="200" rx="8" fill="#fef3c7" stroke="#d69e2e" stroke-width="2"/>
            <rect x="20" y="70" width="230" height="30" rx="8" fill="#d69e2e"/>
            <text x="135" y="90" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">MORNING SHIFT (6 AM - 2 PM)</text>

            <rect x="35" y="110" width="200" height="25" rx="4" fill="#fff" stroke="#48bb78"/>
            <text x="135" y="127" text-anchor="middle" font-size="9" fill="#276749">6:00 AM - Morning Vitals</text>

            <rect x="35" y="140" width="200" height="25" rx="4" fill="#fff" stroke="#3182ce"/>
            <text x="135" y="157" text-anchor="middle" font-size="9" fill="#2c5282">7:00 AM - Medication Round</text>

            <rect x="35" y="170" width="200" height="25" rx="4" fill="#fff" stroke="#9f7aea"/>
            <text x="135" y="187" text-anchor="middle" font-size="9" fill="#553c9a">8:00 AM - Doctor Rounds</text>

            <rect x="35" y="200" width="200" height="25" rx="4" fill="#fff" stroke="#ed8936"/>
            <text x="135" y="217" text-anchor="middle" font-size="9" fill="#c05621">10:00 AM - Procedures/Lab</text>

            <rect x="35" y="230" width="200" height="25" rx="4" fill="#fff" stroke="#667eea"/>
            <text x="135" y="247" text-anchor="middle" font-size="9" fill="#553c9a">12:00 PM - Shift Handover</text>

            <!-- Afternoon Shift (2 PM - 10 PM) -->
            <rect x="260" y="70" width="230" height="200" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <rect x="260" y="70" width="230" height="30" rx="8" fill="#48bb78"/>
            <text x="375" y="90" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">AFTERNOON SHIFT (2 PM - 10 PM)</text>

            <rect x="275" y="110" width="200" height="25" rx="4" fill="#fff" stroke="#48bb78"/>
            <text x="375" y="127" text-anchor="middle" font-size="9" fill="#276749">2:00 PM - Afternoon Vitals</text>

            <rect x="275" y="140" width="200" height="25" rx="4" fill="#fff" stroke="#3182ce"/>
            <text x="375" y="157" text-anchor="middle" font-size="9" fill="#2c5282">3:00 PM - Medication Round</text>

            <rect x="275" y="170" width="200" height="25" rx="4" fill="#fff" stroke="#9f7aea"/>
            <text x="375" y="187" text-anchor="middle" font-size="9" fill="#553c9a">5:00 PM - Evening Rounds</text>

            <rect x="275" y="200" width="200" height="25" rx="4" fill="#fff" stroke="#ed8936"/>
            <text x="375" y="217" text-anchor="middle" font-size="9" fill="#c05621">7:00 PM - Visitor Hours</text>

            <rect x="275" y="230" width="200" height="25" rx="4" fill="#fff" stroke="#667eea"/>
            <text x="375" y="247" text-anchor="middle" font-size="9" fill="#553c9a">9:30 PM - Shift Handover</text>

            <!-- Night Shift (10 PM - 6 AM) -->
            <rect x="500" y="70" width="230" height="200" rx="8" fill="#bee3f8" stroke="#3182ce" stroke-width="2"/>
            <rect x="500" y="70" width="230" height="30" rx="8" fill="#3182ce"/>
            <text x="615" y="90" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">NIGHT SHIFT (10 PM - 6 AM)</text>

            <rect x="515" y="110" width="200" height="25" rx="4" fill="#fff" stroke="#48bb78"/>
            <text x="615" y="127" text-anchor="middle" font-size="9" fill="#276749">10:00 PM - Night Vitals</text>

            <rect x="515" y="140" width="200" height="25" rx="4" fill="#fff" stroke="#3182ce"/>
            <text x="615" y="157" text-anchor="middle" font-size="9" fill="#2c5282">11:00 PM - Night Medication</text>

            <rect x="515" y="170" width="200" height="25" rx="4" fill="#fff" stroke="#f56565"/>
            <text x="615" y="187" text-anchor="middle" font-size="9" fill="#c53030">Hourly - Critical Monitoring</text>

            <rect x="515" y="200" width="200" height="25" rx="4" fill="#fff" stroke="#9f7aea"/>
            <text x="615" y="217" text-anchor="middle" font-size="9" fill="#553c9a">4:00 AM - Early Vitals</text>

            <rect x="515" y="230" width="200" height="25" rx="4" fill="#fff" stroke="#667eea"/>
            <text x="615" y="247" text-anchor="middle" font-size="9" fill="#553c9a">5:30 AM - Shift Handover</text>

            <!-- Clinical Documentation Section -->
            <rect x="20" y="285" width="710" height="110" rx="8" fill="#e9d8fd" stroke="#9f7aea" stroke-width="1"/>
            <text x="375" y="305" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">Clinical Documentation (Continuous)</text>

            <!-- Progress Notes -->
            <rect x="40" y="320" width="130" height="65" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <text x="105" y="340" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">Progress Notes</text>
            <text x="105" y="355" text-anchor="middle" font-size="7" fill="#4a5568">Doctor observations</text>
            <text x="105" y="368" text-anchor="middle" font-size="7" fill="#4a5568">Treatment updates</text>
            <text x="105" y="381" text-anchor="middle" font-size="7" fill="#718096">POST /progress-notes</text>

            <!-- Nursing Charts -->
            <rect x="185" y="320" width="130" height="65" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <text x="250" y="340" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Nursing Charts</text>
            <text x="250" y="355" text-anchor="middle" font-size="7" fill="#4a5568">Care activities</text>
            <text x="250" y="368" text-anchor="middle" font-size="7" fill="#4a5568">Patient status</text>
            <text x="250" y="381" text-anchor="middle" font-size="7" fill="#718096">POST /nursing-notes</text>

            <!-- Vitals Log -->
            <rect x="330" y="320" width="130" height="65" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <text x="395" y="340" text-anchor="middle" font-weight="bold" font-size="9" fill="#234e52">Vitals Log</text>
            <text x="395" y="355" text-anchor="middle" font-size="7" fill="#4a5568">BP, Pulse, Temp</text>
            <text x="395" y="368" text-anchor="middle" font-size="7" fill="#4a5568">SpO2, Weight</text>
            <text x="395" y="381" text-anchor="middle" font-size="7" fill="#718096">POST /patient-vitals</text>

            <!-- MAR -->
            <rect x="475" y="320" width="130" height="65" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <text x="540" y="340" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">MAR</text>
            <text x="540" y="355" text-anchor="middle" font-size="7" fill="#4a5568">Medication given</text>
            <text x="540" y="368" text-anchor="middle" font-size="7" fill="#4a5568">Time, dose, route</text>
            <text x="540" y="381" text-anchor="middle" font-size="7" fill="#718096">POST /ipd-medications</text>

            <!-- I/O Chart -->
            <rect x="620" y="320" width="100" height="65" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <text x="670" y="340" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">I/O Chart</text>
            <text x="670" y="355" text-anchor="middle" font-size="7" fill="#4a5568">Intake/Output</text>
            <text x="670" y="368" text-anchor="middle" font-size="7" fill="#4a5568">Fluid balance</text>
            <text x="670" y="381" text-anchor="middle" font-size="7" fill="#718096">POST /io-chart</text>

            <!-- Billing Updates Section -->
            <rect x="20" y="405" width="350" height="100" rx="8" fill="#feebc8" stroke="#ed8936" stroke-width="1"/>
            <text x="195" y="425" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Running Bill Updates</text>

            <rect x="35" y="440" width="100" height="55" rx="5" fill="#fff" stroke="#ed8936"/>
            <text x="85" y="460" text-anchor="middle" font-size="8" fill="#c05621">Bed Charges</text>
            <text x="85" y="475" text-anchor="middle" font-size="7" fill="#4a5568">Daily rate auto-added</text>
            <text x="85" y="488" text-anchor="middle" font-size="7" fill="#276749"> Per day</text>

            <rect x="145" y="440" width="100" height="55" rx="5" fill="#fff" stroke="#9f7aea"/>
            <text x="195" y="460" text-anchor="middle" font-size="8" fill="#553c9a">Services</text>
            <text x="195" y="475" text-anchor="middle" font-size="7" fill="#4a5568">Nursing, procedures</text>
            <text x="195" y="488" text-anchor="middle" font-size="7" fill="#276749"> Per service</text>

            <rect x="255" y="440" width="100" height="55" rx="5" fill="#fff" stroke="#3182ce"/>
            <text x="305" y="460" text-anchor="middle" font-size="8" fill="#2c5282">Consumables</text>
            <text x="305" y="475" text-anchor="middle" font-size="7" fill="#4a5568">Meds, supplies</text>
            <text x="305" y="488" text-anchor="middle" font-size="7" fill="#276749"> Per item</text>

            <!-- Alerts & Notifications -->
            <rect x="380" y="405" width="350" height="100" rx="8" fill="#fed7d7" stroke="#f56565" stroke-width="1"/>
            <text x="555" y="425" text-anchor="middle" font-weight="bold" font-size="11" fill="#c53030">Alerts &amp; Notifications</text>

            <rect x="395" y="440" width="100" height="55" rx="5" fill="#fff" stroke="#f56565"/>
            <text x="445" y="460" text-anchor="middle" font-size="8" fill="#c53030">Critical Vitals</text>
            <text x="445" y="475" text-anchor="middle" font-size="7" fill="#4a5568">Abnormal values</text>
            <text x="445" y="488" text-anchor="middle" font-size="7" fill="#c53030">Immediate alert</text>

            <rect x="505" y="440" width="100" height="55" rx="5" fill="#fff" stroke="#ed8936"/>
            <text x="555" y="460" text-anchor="middle" font-size="8" fill="#c05621">Med Due</text>
            <text x="555" y="475" text-anchor="middle" font-size="7" fill="#4a5568">Scheduled meds</text>
            <text x="555" y="488" text-anchor="middle" font-size="7" fill="#c05621">30 min before</text>

            <rect x="615" y="440" width="100" height="55" rx="5" fill="#fff" stroke="#9f7aea"/>
            <text x="665" y="460" text-anchor="middle" font-size="8" fill="#553c9a">Lab Results</text>
            <text x="665" y="475" text-anchor="middle" font-size="7" fill="#4a5568">New results ready</text>
            <text x="665" y="488" text-anchor="middle" font-size="7" fill="#553c9a">Doctor notified</text>
        </svg>
    </div>

    <!-- Discharge Workflow -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">IPD Discharge Workflow</div>
        <svg width="750" height="550" viewBox="0 0 750 550">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="540" fill="#f8fafc" rx="10"/>

            <!-- Discharge Decision Section -->
            <rect x="20" y="20" width="710" height="90" rx="8" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="375" y="42" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Discharge Decision</text>

            <!-- Discharge Types -->
            <rect x="40" y="55" width="130" height="45" rx="6" fill="#fff" stroke="#48bb78"/>
            <text x="105" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Normal</text>
            <text x="105" y="90" text-anchor="middle" font-size="8" fill="#4a5568">Treatment complete</text>

            <rect x="185" y="55" width="130" height="45" rx="6" fill="#fff" stroke="#3182ce"/>
            <text x="250" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">Transfer</text>
            <text x="250" y="90" text-anchor="middle" font-size="8" fill="#4a5568">To other facility</text>

            <rect x="330" y="55" width="130" height="45" rx="6" fill="#fff" stroke="#ed8936"/>
            <text x="395" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">LAMA</text>
            <text x="395" y="90" text-anchor="middle" font-size="8" fill="#4a5568">Against advice</text>

            <rect x="475" y="55" width="130" height="45" rx="6" fill="#fff" stroke="#f56565"/>
            <text x="540" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Absconded</text>
            <text x="540" y="90" text-anchor="middle" font-size="8" fill="#4a5568">Left without notice</text>

            <rect x="620" y="55" width="100" height="45" rx="6" fill="#2d3748"/>
            <text x="670" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#fff">Expired</text>
            <text x="670" y="90" text-anchor="middle" font-size="8" fill="#e2e8f0">Death case</text>

            <!-- Initiate Discharge -->
            <rect x="275" y="130" width="200" height="50" rx="8" fill="#9f7aea"/>
            <text x="375" y="152" text-anchor="middle" font-weight="bold" font-size="11" fill="#fff">Initiate Discharge</text>
            <text x="375" y="168" text-anchor="middle" font-size="9" fill="#fff">POST /ipd/{id}/initiate-discharge</text>

            <line x1="375" y1="100" x2="375" y2="130" stroke="#4a5568" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Clearance Section -->
            <rect x="20" y="200" width="710" height="110" rx="8" fill="#fef3c7" stroke="#d69e2e" stroke-width="1"/>
            <text x="375" y="220" text-anchor="middle" font-weight="bold" font-size="12" fill="#744210">Department Clearances</text>

            <!-- Pharmacy Clearance -->
            <rect x="45" y="235" width="130" height="65" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <text x="110" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Pharmacy</text>
            <text x="110" y="270" text-anchor="middle" font-size="7" fill="#4a5568">Pending medications</text>
            <text x="110" y="283" text-anchor="middle" font-size="7" fill="#4a5568">Return unused drugs</text>
            <circle cx="125" cy="290" r="8" fill="#48bb78"/>
            <text x="125" y="294" text-anchor="middle" font-size="8" fill="#fff"></text>

            <!-- Lab Clearance -->
            <rect x="190" y="235" width="130" height="65" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <text x="255" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#234e52">Laboratory</text>
            <text x="255" y="270" text-anchor="middle" font-size="7" fill="#4a5568">Pending reports</text>
            <text x="255" y="283" text-anchor="middle" font-size="7" fill="#4a5568">Final lab summary</text>
            <circle cx="270" cy="290" r="8" fill="#48bb78"/>
            <text x="270" y="294" text-anchor="middle" font-size="8" fill="#fff"></text>

            <!-- Radiology Clearance -->
            <rect x="335" y="235" width="130" height="65" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <text x="400" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Radiology</text>
            <text x="400" y="270" text-anchor="middle" font-size="7" fill="#4a5568">Pending studies</text>
            <text x="400" y="283" text-anchor="middle" font-size="7" fill="#4a5568">Reports collected</text>
            <circle cx="415" cy="290" r="8" fill="#48bb78"/>
            <text x="415" y="294" text-anchor="middle" font-size="8" fill="#fff"></text>

            <!-- Nursing Clearance -->
            <rect x="480" y="235" width="130" height="65" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <text x="545" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Nursing</text>
            <text x="545" y="270" text-anchor="middle" font-size="7" fill="#4a5568">Property return</text>
            <text x="545" y="283" text-anchor="middle" font-size="7" fill="#4a5568">Final assessment</text>
            <circle cx="560" cy="290" r="8" fill="#48bb78"/>
            <text x="560" y="294" text-anchor="middle" font-size="8" fill="#fff"></text>

            <!-- Accounts Clearance -->
            <rect x="625" y="235" width="95" height="65" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <text x="672" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Accounts</text>
            <text x="672" y="270" text-anchor="middle" font-size="7" fill="#4a5568">Payment status</text>
            <text x="672" y="283" text-anchor="middle" font-size="7" fill="#4a5568">Final clearance</text>
            <circle cx="687" cy="290" r="8" fill="#feebc8" stroke="#ed8936"/>
            <text x="687" y="294" text-anchor="middle" font-size="8" fill="#c05621">!</text>

            <line x1="375" y1="180" x2="375" y2="200" stroke="#4a5568" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Final Bill Section -->
            <rect x="20" y="325" width="350" height="120" rx="8" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="195" y="347" text-anchor="middle" font-weight="bold" font-size="12" fill="#c05621">Final Bill Generation</text>

            <rect x="35" y="360" width="150" height="75" rx="6" fill="#fff" stroke="#ed8936"/>
            <text x="110" y="380" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Bill Summary</text>
            <text x="45" y="398" font-size="8" fill="#4a5568">Bed Charges:</text>
            <text x="175" y="398" text-anchor="end" font-size="8" fill="#2d3748">24,000</text>
            <text x="45" y="412" font-size="8" fill="#4a5568">Services:</text>
            <text x="175" y="412" text-anchor="end" font-size="8" fill="#2d3748">8,500</text>
            <text x="45" y="426" font-size="8" fill="#4a5568">Pharmacy:</text>
            <text x="175" y="426" text-anchor="end" font-size="8" fill="#2d3748">12,350</text>

            <rect x="200" y="360" width="155" height="75" rx="6" fill="#c6f6d5" stroke="#48bb78" stroke-width="2"/>
            <text x="277" y="380" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Payment</text>
            <text x="277" y="400" text-anchor="middle" font-size="16" font-weight="bold" fill="#276749">44,850</text>
            <text x="277" y="418" text-anchor="middle" font-size="8" fill="#4a5568">After discount: 40,365</text>
            <rect x="215" y="425" width="125" height="25" rx="4" fill="#48bb78"/>
            <text x="277" y="442" text-anchor="middle" font-size="9" fill="#fff">Collect Payment</text>

            <!-- Discharge Summary Section -->
            <rect x="380" y="325" width="350" height="120" rx="8" fill="#e9d8fd" stroke="#9f7aea" stroke-width="2"/>
            <text x="555" y="347" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">Discharge Documentation</text>

            <rect x="395" y="360" width="155" height="75" rx="6" fill="#fff" stroke="#9f7aea"/>
            <text x="472" y="380" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Discharge Summary</text>
            <text x="472" y="398" text-anchor="middle" font-size="7" fill="#4a5568"> Final diagnosis</text>
            <text x="472" y="412" text-anchor="middle" font-size="7" fill="#4a5568"> Treatment given</text>
            <text x="472" y="426" text-anchor="middle" font-size="7" fill="#4a5568"> Home instructions</text>

            <rect x="565" y="360" width="150" height="75" rx="6" fill="#fff" stroke="#667eea"/>
            <text x="640" y="380" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Documents</text>
            <text x="640" y="398" text-anchor="middle" font-size="7" fill="#4a5568"> Prescription</text>
            <text x="640" y="412" text-anchor="middle" font-size="7" fill="#4a5568"> Follow-up card</text>
            <text x="640" y="426" text-anchor="middle" font-size="7" fill="#4a5568"> Reports copy</text>

            <line x1="375" y1="310" x2="195" y2="325" stroke="#4a5568" stroke-width="1.5"/>
            <line x1="375" y1="310" x2="555" y2="325" stroke="#4a5568" stroke-width="1.5"/>

            <!-- Complete Discharge -->
            <rect x="250" y="460" width="250" height="50" rx="8" fill="#48bb78"/>
            <text x="375" y="482" text-anchor="middle" font-weight="bold" font-size="12" fill="#fff">Complete Discharge</text>
            <text x="375" y="498" text-anchor="middle" font-size="9" fill="#fff">POST /ipd/{id}/complete-discharge</text>

            <line x1="195" y1="445" x2="300" y2="460" stroke="#4a5568" stroke-width="2"/>
            <line x1="555" y1="445" x2="450" y2="460" stroke="#4a5568" stroke-width="2"/>

            <!-- End -->
            <circle cx="375" cy="530" r="18" fill="#f56565" stroke="#c53030" stroke-width="2"/>
            <text x="375" y="535" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">END</text>

            <line x1="375" y1="510" x2="375" y2="512" stroke="#4a5568" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Bed Released Note -->
            <rect x="520" y="510" width="200" height="30" rx="5" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="620" y="530" text-anchor="middle" font-size="9" fill="#276749">Bed automatically released</text>

            <line x1="500" y1="485" x2="520" y2="510" stroke="#48bb78" stroke-width="1.5"/>
        </svg>
    </div>

    <div class="info-box">
        <h4>IPD Workflow Key Points</h4>
        <ul>
            <li><strong>Admission Types:</strong> OPD referral, Emergency, Elective (scheduled surgery), Transfer from other facility</li>
            <li><strong>Bed Management:</strong> Real-time availability tracking, automatic bed release on discharge, transfer between wards</li>
            <li><strong>Running Bill:</strong> Automatic daily bed charges, service-wise billing, pharmacy charges linked to dispensing</li>
            <li><strong>Clinical Documentation:</strong> Progress notes, nursing charts, vitals monitoring, medication administration records (MAR)</li>
            <li><strong>Shift Handover:</strong> 8-hour nursing shifts with mandatory handover documentation</li>
            <li><strong>Discharge Types:</strong> Normal, Transfer, LAMA (Leave Against Medical Advice), Absconded, Expired</li>
            <li><strong>Clearance Workflow:</strong> Multi-department clearance required before final discharge (Pharmacy, Lab, Radiology, Nursing, Accounts)</li>
            <li><strong>Insurance:</strong> Pre-authorization on admission, interim bills for long stays, final TPA claim on discharge</li>
        </ul>
    </div>
</div>

<!-- Section 4.4: Laboratory Module with Workflow Diagrams -->
<div class="section">
    <h2>4.4 Laboratory Module</h2>
    <p>The Laboratory module manages the complete lifecycle of diagnostic tests from order to report delivery, supporting multiple test categories, sample types, and integration with clinical workflows.</p>

    <h3>4.4.1 Laboratory Workflow Diagrams</h3>

    <!-- Diagram 1: Complete Laboratory Test Journey -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Complete Laboratory Test Journey</div>
        <svg width="700" height="580" viewBox="0 0 700 580">
            <defs>
                <marker id="labArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="labArrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
                <marker id="labArrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#e53e3e"/>
                </marker>
            </defs>

            <!-- Phase Labels -->
            <rect x="10" y="10" width="130" height="25" rx="4" fill="#2b6cb0"/>
            <text x="75" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 1: Order</text>

            <rect x="150" y="10" width="130" height="25" rx="4" fill="#38a169"/>
            <text x="215" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 2: Collection</text>

            <rect x="290" y="10" width="130" height="25" rx="4" fill="#d69e2e"/>
            <text x="355" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 3: Processing</text>

            <rect x="430" y="10" width="130" height="25" rx="4" fill="#805ad5"/>
            <text x="495" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 4: Results</text>

            <rect x="570" y="10" width="120" height="25" rx="4" fill="#e53e3e"/>
            <text x="630" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 5: Delivery</text>

            <!-- Phase 1: Order Creation -->
            <rect x="20" y="50" width="110" height="45" rx="6" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="75" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Doctor Orders</text>
            <text x="75" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Tests from EMR</text>

            <rect x="20" y="105" width="110" height="40" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="1.5"/>
            <text x="75" y="122" text-anchor="middle" font-size="8" fill="#c53030">POST /api/lab-orders</text>
            <text x="75" y="135" text-anchor="middle" font-size="7" fill="#718096">Create order with tests</text>

            <line x1="75" y1="95" x2="75" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <rect x="20" y="155" width="110" height="35" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="1"/>
            <text x="75" y="170" text-anchor="middle" font-size="8" fill="#276749">Status: ORDERED</text>
            <text x="75" y="182" text-anchor="middle" font-size="7" fill="#718096">Pending collection</text>

            <line x1="75" y1="145" x2="75" y2="155" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <!-- Phase 2: Sample Collection -->
            <rect x="160" y="50" width="110" height="45" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="215" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Phlebotomy</text>
            <text x="215" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Sample collection</text>

            <rect x="160" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="215" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Verify patient ID</text>
            <text x="215" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Collect sample</text>
            <text x="215" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Label barcode</text>

            <rect x="160" y="165" width="110" height="35" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="1.5"/>
            <text x="215" y="180" text-anchor="middle" font-size="8" fill="#c53030">PUT /collect-sample</text>
            <text x="215" y="192" text-anchor="middle" font-size="7" fill="#718096">Update status</text>

            <line x1="130" y1="72" x2="160" y2="72" stroke="#38a169" stroke-width="2" marker-end="url(#labArrowGreen)"/>
            <line x1="215" y1="95" x2="215" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="215" y1="155" x2="215" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <!-- Phase 3: Processing -->
            <rect x="300" y="50" width="110" height="45" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="355" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Lab Reception</text>
            <text x="355" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Sample received</text>

            <rect x="300" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="355" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Accessioning</text>
            <text x="355" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Quality check</text>
            <text x="355" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Route to analyzer</text>

            <rect x="300" y="165" width="110" height="45" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="355" y="182" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Analysis</text>
            <text x="355" y="197" text-anchor="middle" font-size="8" fill="#4a5568">Run on analyzer</text>

            <line x1="270" y1="182" x2="300" y2="182" stroke="#d69e2e" stroke-width="2" marker-end="url(#labArrow)"/>
            <line x1="355" y1="95" x2="355" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="355" y1="155" x2="355" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <!-- Phase 4: Results Entry -->
            <rect x="440" y="50" width="110" height="45" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="495" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Result Entry</text>
            <text x="495" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Technician input</text>

            <rect x="440" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="495" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Enter values</text>
            <text x="495" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Flag abnormals</text>
            <text x="495" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Add comments</text>

            <rect x="440" y="165" width="110" height="45" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="495" y="182" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Validation</text>
            <text x="495" y="197" text-anchor="middle" font-size="8" fill="#4a5568">Pathologist review</text>

            <line x1="410" y1="72" x2="440" y2="72" stroke="#805ad5" stroke-width="2" marker-end="url(#labArrow)"/>
            <line x1="495" y1="95" x2="495" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="495" y1="155" x2="495" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <!-- Phase 5: Report Delivery -->
            <rect x="580" y="50" width="110" height="45" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="635" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Report Generated</text>
            <text x="635" y="85" text-anchor="middle" font-size="8" fill="#4a5568">PDF created</text>

            <rect x="580" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="635" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Print report</text>
            <text x="635" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> SMS notification</text>
            <text x="635" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Patient portal</text>

            <rect x="580" y="165" width="110" height="35" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="1"/>
            <text x="635" y="180" text-anchor="middle" font-size="8" fill="#276749">Status: COMPLETED</text>
            <text x="635" y="192" text-anchor="middle" font-size="7" fill="#718096">Report delivered</text>

            <line x1="550" y1="187" x2="580" y2="187" stroke="#e53e3e" stroke-width="2" marker-end="url(#labArrowRed)"/>
            <line x1="635" y1="95" x2="635" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="635" y1="155" x2="635" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <!-- Sample Status Flow (Bottom section) -->
            <rect x="20" y="230" width="670" height="150" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="355" y="250" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Order Status Transitions</text>

            <!-- Status boxes -->
            <rect x="40" y="270" width="80" height="35" rx="5" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="80" y="292" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">ORDERED</text>

            <rect x="150" y="270" width="80" height="35" rx="5" fill="#fefcbf" stroke="#d69e2e" stroke-width="2"/>
            <text x="190" y="292" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">COLLECTED</text>

            <rect x="260" y="270" width="80" height="35" rx="5" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="300" y="292" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">RECEIVED</text>

            <rect x="370" y="270" width="80" height="35" rx="5" fill="#e9d8fd" stroke="#805ad5" stroke-width="2"/>
            <text x="410" y="292" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">PROCESSING</text>

            <rect x="480" y="270" width="80" height="35" rx="5" fill="#bee3f8" stroke="#3182ce" stroke-width="2"/>
            <text x="520" y="292" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">RESULTED</text>

            <rect x="590" y="270" width="80" height="35" rx="5" fill="#c6f6d5" stroke="#38a169" stroke-width="2"/>
            <text x="630" y="292" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">COMPLETED</text>

            <!-- Arrows between statuses -->
            <line x1="120" y1="287" x2="150" y2="287" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="230" y1="287" x2="260" y2="287" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="340" y1="287" x2="370" y2="287" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="450" y1="287" x2="480" y2="287" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="560" y1="287" x2="590" y2="287" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <!-- Rejection path -->
            <rect x="260" y="330" width="80" height="30" rx="5" fill="#fed7d7" stroke="#e53e3e" stroke-width="2"/>
            <text x="300" y="349" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">REJECTED</text>

            <path d="M300,305 L300,330" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#labArrowRed)"/>
            <text x="312" y="320" font-size="7" fill="#c53030">QC fail</text>

            <!-- Recollect path -->
            <path d="M260,345 C180,345 150,320 80,305" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#labArrowRed)"/>
            <text x="160" y="340" font-size="7" fill="#c53030">Recollect</text>

            <!-- Critical Value Alert Box -->
            <rect x="20" y="400" width="330" height="95" rx="8" fill="#fff5f5" stroke="#fc8181" stroke-width="2"/>
            <text x="185" y="420" text-anchor="middle" font-weight="bold" font-size="10" fill="#c53030">Critical Value Alert Workflow</text>

            <rect x="35" y="435" width="90" height="30" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="80" y="454" text-anchor="middle" font-size="8" fill="#c53030">Critical Detected</text>

            <rect x="140" y="435" width="90" height="30" rx="4" fill="#feebc8" stroke="#ed8936" stroke-width="1"/>
            <text x="185" y="454" text-anchor="middle" font-size="8" fill="#c05621">Page Doctor</text>

            <rect x="245" y="435" width="90" height="30" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="290" y="454" text-anchor="middle" font-size="8" fill="#276749">Acknowledged</text>

            <line x1="125" y1="450" x2="140" y2="450" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <line x1="230" y1="450" x2="245" y2="450" stroke="#4a5568" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <text x="185" y="485" text-anchor="middle" font-size="7" fill="#718096">Critical values require immediate physician notification</text>

            <!-- TAT Monitoring Box -->
            <rect x="360" y="400" width="330" height="95" rx="8" fill="#ebf8ff" stroke="#63b3ed" stroke-width="2"/>
            <text x="525" y="420" text-anchor="middle" font-weight="bold" font-size="10" fill="#2b6cb0">Turnaround Time (TAT) Monitoring</text>

            <rect x="375" y="435" width="70" height="45" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="410" y="455" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Routine</text>
            <text x="410" y="470" text-anchor="middle" font-size="7" fill="#4a5568">24-48 hrs</text>

            <rect x="455" y="435" width="70" height="45" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="490" y="455" text-anchor="middle" font-weight="bold" font-size="8" fill="#975a16">Urgent</text>
            <text x="490" y="470" text-anchor="middle" font-size="7" fill="#4a5568">4-6 hrs</text>

            <rect x="535" y="435" width="70" height="45" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="570" y="455" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">STAT</text>
            <text x="570" y="470" text-anchor="middle" font-size="7" fill="#4a5568">1-2 hrs</text>

            <rect x="615" y="435" width="65" height="45" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="647" y="455" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">ASAP</text>
            <text x="647" y="470" text-anchor="middle" font-size="7" fill="#4a5568">< 1 hr</text>

            <text x="525" y="495" text-anchor="middle" font-size="7" fill="#718096">TAT defined per test in lab_tests.tat_hours</text>

            <!-- API Endpoints Summary -->
            <rect x="20" y="510" width="670" height="60" rx="8" fill="#f0fff4" stroke="#9ae6b4" stroke-width="1"/>
            <text x="355" y="530" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">Key API Endpoints</text>
            <text x="120" y="550" text-anchor="middle" font-size="8" fill="#4a5568">POST /api/lab-orders</text>
            <text x="270" y="550" text-anchor="middle" font-size="8" fill="#4a5568">PUT /api/lab-orders/{id}/collect</text>
            <text x="440" y="550" text-anchor="middle" font-size="8" fill="#4a5568">PUT /api/lab-orders/{id}/result</text>
            <text x="600" y="550" text-anchor="middle" font-size="8" fill="#4a5568">GET /api/lab-orders/{id}/report</text>
        </svg>
    </div>

    <!-- Diagram 2: Laboratory Order Sources & Pathways -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Laboratory Order Sources & Pathways</div>
        <svg width="700" height="480" viewBox="0 0 700 480">
            <defs>
                <marker id="labPathArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Central Lab Hub -->
            <ellipse cx="350" cy="240" rx="70" ry="50" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="3"/>
            <text x="350" y="235" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Laboratory</text>
            <text x="350" y="252" text-anchor="middle" font-size="9" fill="#4a5568">Central Hub</text>

            <!-- Source 1: OPD Orders -->
            <rect x="30" y="50" width="140" height="80" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="100" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">OPD Orders</text>
            <text x="100" y="92" text-anchor="middle" font-size="8" fill="#4a5568">From consultation</text>
            <text x="100" y="105" text-anchor="middle" font-size="8" fill="#4a5568">Linked to visit_id</text>
            <text x="100" y="118" text-anchor="middle" font-size="7" fill="#718096">Priority: Routine</text>

            <path d="M170,90 Q260,90 280,200" stroke="#38a169" stroke-width="2" fill="none" marker-end="url(#labPathArrow)"/>

            <!-- Source 2: IPD Orders -->
            <rect x="30" y="180" width="140" height="80" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="100" y="205" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">IPD Orders</text>
            <text x="100" y="222" text-anchor="middle" font-size="8" fill="#4a5568">From ward rounds</text>
            <text x="100" y="235" text-anchor="middle" font-size="8" fill="#4a5568">Linked to admission_id</text>
            <text x="100" y="248" text-anchor="middle" font-size="7" fill="#718096">Priority: Varies</text>

            <line x1="170" y1="220" x2="280" y2="235" stroke="#805ad5" stroke-width="2" marker-end="url(#labPathArrow)"/>

            <!-- Source 3: Emergency Orders -->
            <rect x="30" y="310" width="140" height="80" rx="8" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="100" y="335" text-anchor="middle" font-weight="bold" font-size="10" fill="#c53030">Emergency Orders</text>
            <text x="100" y="352" text-anchor="middle" font-size="8" fill="#4a5568">STAT/Critical</text>
            <text x="100" y="365" text-anchor="middle" font-size="8" fill="#4a5568">Immediate processing</text>
            <text x="100" y="378" text-anchor="middle" font-size="7" fill="#718096">Priority: STAT</text>

            <path d="M170,350 Q260,350 280,270" stroke="#e53e3e" stroke-width="2" fill="none" marker-end="url(#labPathArrow)"/>

            <!-- Source 4: Health Checkup -->
            <rect x="530" y="50" width="140" height="80" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="600" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#975a16">Health Checkup</text>
            <text x="600" y="92" text-anchor="middle" font-size="8" fill="#4a5568">Pre-defined packages</text>
            <text x="600" y="105" text-anchor="middle" font-size="8" fill="#4a5568">Multiple tests/panels</text>
            <text x="600" y="118" text-anchor="middle" font-size="7" fill="#718096">Priority: Scheduled</text>

            <path d="M530,90 Q440,90 420,200" stroke="#d69e2e" stroke-width="2" fill="none" marker-end="url(#labPathArrow)"/>

            <!-- Source 5: External/Walk-in -->
            <rect x="530" y="180" width="140" height="80" rx="8" fill="#e6fffa" stroke="#319795" stroke-width="2"/>
            <text x="600" y="205" text-anchor="middle" font-weight="bold" font-size="10" fill="#234e52">External/Walk-in</text>
            <text x="600" y="222" text-anchor="middle" font-size="8" fill="#4a5568">Direct registration</text>
            <text x="600" y="235" text-anchor="middle" font-size="8" fill="#4a5568">Cash payment</text>
            <text x="600" y="248" text-anchor="middle" font-size="7" fill="#718096">Priority: Routine</text>

            <line x1="530" y1="220" x2="420" y2="235" stroke="#319795" stroke-width="2" marker-end="url(#labPathArrow)"/>

            <!-- Source 6: Pre-op Orders -->
            <rect x="530" y="310" width="140" height="80" rx="8" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="600" y="335" text-anchor="middle" font-weight="bold" font-size="10" fill="#97266d">Pre-operative</text>
            <text x="600" y="352" text-anchor="middle" font-size="8" fill="#4a5568">Surgery clearance</text>
            <text x="600" y="365" text-anchor="middle" font-size="8" fill="#4a5568">Standard panel</text>
            <text x="600" y="378" text-anchor="middle" font-size="7" fill="#718096">Priority: Urgent</text>

            <path d="M530,350 Q440,350 420,270" stroke="#d53f8c" stroke-width="2" fill="none" marker-end="url(#labPathArrow)"/>

            <!-- Test Categories (Bottom Section) -->
            <rect x="30" y="420" width="640" height="50" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="350" y="440" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Test Categories (lab_categories)</text>

            <text x="90" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Hematology</text>
            <text x="190" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Biochemistry</text>
            <text x="290" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Microbiology</text>
            <text x="390" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Serology</text>
            <text x="490" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Histopathology</text>
            <text x="600" y="458" text-anchor="middle" font-size="8" fill="#4a5568">Clinical Path</text>
        </svg>
    </div>

    <!-- Diagram 3: Sample Collection & Processing Workflow -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Sample Collection & Processing Workflow</div>
        <svg width="700" height="520" viewBox="0 0 700 520">
            <defs>
                <marker id="sampleArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Sample Types Section -->
            <rect x="20" y="20" width="200" height="200" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="120" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">Sample Types</text>
            <text x="120" y="60" text-anchor="middle" font-size="8" fill="#718096">(lab_tests.sample_type)</text>

            <rect x="35" y="75" width="75" height="30" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="72" y="94" text-anchor="middle" font-size="8" fill="#c53030">Blood</text>

            <rect x="120" y="75" width="75" height="30" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="157" y="94" text-anchor="middle" font-size="8" fill="#975a16">Urine</text>

            <rect x="35" y="115" width="75" height="30" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="72" y="134" text-anchor="middle" font-size="8" fill="#276749">Stool</text>

            <rect x="120" y="115" width="75" height="30" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="157" y="134" text-anchor="middle" font-size="8" fill="#553c9a">Sputum</text>

            <rect x="35" y="155" width="75" height="30" rx="4" fill="#bee3f8" stroke="#3182ce" stroke-width="1"/>
            <text x="72" y="174" text-anchor="middle" font-size="8" fill="#2b6cb0">CSF</text>

            <rect x="120" y="155" width="75" height="30" rx="4" fill="#fed7e2" stroke="#d53f8c" stroke-width="1"/>
            <text x="157" y="174" text-anchor="middle" font-size="8" fill="#97266d">Tissue</text>

            <rect x="77" y="195" width="75" height="20" rx="4" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="115" y="209" text-anchor="middle" font-size="7" fill="#4a5568">Swabs, Fluids...</text>

            <!-- Collection Process -->
            <rect x="250" y="20" width="200" height="200" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="350" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Collection Process</text>

            <rect x="265" y="65" width="170" height="35" rx="4" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="350" y="80" text-anchor="middle" font-size="8" fill="#276749">1. Verify Patient Identity</text>
            <text x="350" y="93" text-anchor="middle" font-size="7" fill="#718096">Photo ID + MRN match</text>

            <rect x="265" y="110" width="170" height="35" rx="4" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="350" y="125" text-anchor="middle" font-size="8" fill="#276749">2. Check Order Details</text>
            <text x="350" y="138" text-anchor="middle" font-size="7" fill="#718096">Tests, fasting status</text>

            <rect x="265" y="155" width="170" height="35" rx="4" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="350" y="170" text-anchor="middle" font-size="8" fill="#276749">3. Collect Sample</text>
            <text x="350" y="183" text-anchor="middle" font-size="7" fill="#718096">Correct tube/container</text>

            <rect x="265" y="200" width="170" height="20" rx="4" fill="#c6f6d5" stroke="#276749" stroke-width="1"/>
            <text x="350" y="214" text-anchor="middle" font-size="8" fill="#276749">4. Label with Barcode</text>

            <!-- Barcode & Labeling -->
            <rect x="480" y="20" width="200" height="200" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="580" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#975a16">Barcode Labeling</text>

            <rect x="510" y="65" width="140" height="55" rx="4" fill="#fff" stroke="#d69e2e" stroke-width="1"/>
            <text x="580" y="82" text-anchor="middle" font-size="8" fill="#4a5568">Sample Label Contains:</text>
            <text x="580" y="96" text-anchor="middle" font-size="7" fill="#718096"> Patient MRN & Name</text>
            <text x="580" y="108" text-anchor="middle" font-size="7" fill="#718096"> Order ID & Test codes</text>

            <rect x="510" y="130" width="140" height="40" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="580" y="150" text-anchor="middle" font-size="8" fill="#975a16">Unique Barcode ID</text>
            <text x="580" y="163" text-anchor="middle" font-size="7" fill="#718096">Scannable at each step</text>

            <rect x="510" y="180" width="140" height="35" rx="4" fill="#fff" stroke="#d69e2e" stroke-width="1"/>
            <text x="580" y="197" text-anchor="middle" font-size="8" fill="#4a5568">Collection timestamp</text>
            <text x="580" y="208" text-anchor="middle" font-size="7" fill="#718096">Auto-logged in system</text>

            <!-- Arrows from left sections to center -->
            <line x1="220" y1="120" x2="250" y2="120" stroke="#4a5568" stroke-width="2" marker-end="url(#sampleArrow)"/>
            <line x1="450" y1="120" x2="480" y2="120" stroke="#4a5568" stroke-width="2" marker-end="url(#sampleArrow)"/>

            <!-- Lab Reception Section -->
            <rect x="20" y="250" width="320" height="130" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="180" y="275" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Lab Reception & Accessioning</text>

            <rect x="35" y="295" width="90" height="40" rx="4" fill="#fff" stroke="#805ad5" stroke-width="1"/>
            <text x="80" y="312" text-anchor="middle" font-size="8" fill="#553c9a">Receive Sample</text>
            <text x="80" y="325" text-anchor="middle" font-size="7" fill="#718096">Scan barcode</text>

            <rect x="140" y="295" width="90" height="40" rx="4" fill="#fff" stroke="#805ad5" stroke-width="1"/>
            <text x="185" y="312" text-anchor="middle" font-size="8" fill="#553c9a">Verify Condition</text>
            <text x="185" y="325" text-anchor="middle" font-size="7" fill="#718096">Check quality</text>

            <rect x="245" y="295" width="85" height="40" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="287" y="312" text-anchor="middle" font-size="8" fill="#553c9a">Accession</text>
            <text x="287" y="325" text-anchor="middle" font-size="7" fill="#718096">Assign work#</text>

            <line x1="125" y1="315" x2="140" y2="315" stroke="#4a5568" stroke-width="1.5" marker-end="url(#sampleArrow)"/>
            <line x1="230" y1="315" x2="245" y2="315" stroke="#4a5568" stroke-width="1.5" marker-end="url(#sampleArrow)"/>

            <text x="180" y="365" text-anchor="middle" font-size="8" fill="#718096">Status updated to RECEIVED  logs collection_time</text>

            <!-- Quality Control Section -->
            <rect x="360" y="250" width="320" height="130" rx="8" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="520" y="275" text-anchor="middle" font-weight="bold" font-size="11" fill="#c53030">Quality Control Checks</text>

            <rect x="375" y="295" width="140" height="70" rx="4" fill="#fff" stroke="#fc8181" stroke-width="1"/>
            <text x="445" y="312" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Rejection Criteria</text>
            <text x="445" y="328" text-anchor="middle" font-size="7" fill="#4a5568"> Hemolyzed blood sample</text>
            <text x="445" y="340" text-anchor="middle" font-size="7" fill="#4a5568"> Incorrect container</text>
            <text x="445" y="352" text-anchor="middle" font-size="7" fill="#4a5568"> Insufficient quantity</text>

            <rect x="525" y="295" width="140" height="70" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="595" y="312" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Acceptance Criteria</text>
            <text x="595" y="328" text-anchor="middle" font-size="7" fill="#4a5568"> Proper labeling</text>
            <text x="595" y="340" text-anchor="middle" font-size="7" fill="#4a5568"> Adequate volume</text>
            <text x="595" y="352" text-anchor="middle" font-size="7" fill="#4a5568"> Within stability window</text>

            <!-- Processing Section -->
            <rect x="20" y="400" width="660" height="110" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="2"/>
            <text x="350" y="425" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Sample Processing by Department</text>

            <rect x="40" y="445" width="100" height="50" rx="6" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="90" y="465" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Hematology</text>
            <text x="90" y="480" text-anchor="middle" font-size="7" fill="#4a5568">CBC, ESR, PT/INR</text>

            <rect x="155" y="445" width="100" height="50" rx="6" fill="#bee3f8" stroke="#3182ce" stroke-width="1"/>
            <text x="205" y="465" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Biochemistry</text>
            <text x="205" y="480" text-anchor="middle" font-size="7" fill="#4a5568">LFT, RFT, Lipids</text>

            <rect x="270" y="445" width="100" height="50" rx="6" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="320" y="465" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Microbiology</text>
            <text x="320" y="480" text-anchor="middle" font-size="7" fill="#4a5568">Culture, Gram stain</text>

            <rect x="385" y="445" width="100" height="50" rx="6" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="435" y="465" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Serology</text>
            <text x="435" y="480" text-anchor="middle" font-size="7" fill="#4a5568">HIV, HBV, VDRL</text>

            <rect x="500" y="445" width="100" height="50" rx="6" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="550" y="465" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Histopathology</text>
            <text x="550" y="480" text-anchor="middle" font-size="7" fill="#4a5568">Biopsy, FNAC</text>

            <!-- Processing Arrow -->
            <line x1="350" y1="380" x2="350" y2="400" stroke="#4a5568" stroke-width="2" marker-end="url(#sampleArrow)"/>
        </svg>
    </div>

    <!-- Diagram 4: Results Entry & Report Generation -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Results Entry & Report Generation Workflow</div>
        <svg width="700" height="550" viewBox="0 0 700 550">
            <defs>
                <marker id="resultArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="resultArrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
            </defs>

            <!-- Results Entry Section -->
            <rect x="20" y="20" width="320" height="180" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="180" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">Results Entry (Lab Technician)</text>

            <rect x="35" y="60" width="130" height="50" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="100" y="80" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Manual Entry</text>
            <text x="100" y="95" text-anchor="middle" font-size="7" fill="#718096">Enter test values</text>
            <text x="100" y="105" text-anchor="middle" font-size="7" fill="#718096">from worksheets</text>

            <rect x="175" y="60" width="155" height="50" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="252" y="80" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Analyzer Interface</text>
            <text x="252" y="95" text-anchor="middle" font-size="7" fill="#718096">Auto-import from LIS</text>
            <text x="252" y="105" text-anchor="middle" font-size="7" fill="#718096">via HL7/ASTM</text>

            <rect x="35" y="120" width="290" height="70" rx="4" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="180" y="138" text-anchor="middle" font-weight="bold" font-size="8" fill="#4a5568">Result Data Fields (lab_order_details)</text>
            <text x="110" y="155" text-anchor="middle" font-size="7" fill="#718096"> result (value)</text>
            <text x="110" y="167" text-anchor="middle" font-size="7" fill="#718096"> result_date</text>
            <text x="110" y="179" text-anchor="middle" font-size="7" fill="#718096"> status</text>
            <text x="250" y="155" text-anchor="middle" font-size="7" fill="#718096"> performed_by</text>
            <text x="250" y="167" text-anchor="middle" font-size="7" fill="#718096"> notes/comments</text>
            <text x="250" y="179" text-anchor="middle" font-size="7" fill="#718096"> abnormal_flag</text>

            <!-- Abnormal Value Detection -->
            <rect x="360" y="20" width="320" height="180" rx="8" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="520" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#c53030">Abnormal Value Detection</text>

            <rect x="375" y="60" width="140" height="60" rx="4" fill="#fff" stroke="#fc8181" stroke-width="1"/>
            <text x="445" y="78" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Reference Ranges</text>
            <text x="445" y="93" text-anchor="middle" font-size="7" fill="#4a5568">lab_tests.normal_range</text>
            <text x="445" y="105" text-anchor="middle" font-size="7" fill="#718096">Age/Gender specific</text>
            <text x="445" y="115" text-anchor="middle" font-size="7" fill="#718096">Unit: lab_tests.unit</text>

            <rect x="525" y="60" width="145" height="60" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="597" y="78" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Flagging System</text>
            <text x="597" y="95" text-anchor="middle" font-size="7" fill="#4a5568">L = Low</text>
            <text x="597" y="107" text-anchor="middle" font-size="7" fill="#4a5568">H = High</text>
            <text x="597" y="119" text-anchor="middle" font-size="7" fill="#4a5568">C = Critical</text>

            <rect x="375" y="130" width="295" height="60" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="522" y="150" text-anchor="middle" font-weight="bold" font-size="8" fill="#975a16">Critical Value Alert (auto-trigger)</text>
            <text x="522" y="168" text-anchor="middle" font-size="7" fill="#4a5568">If value outside critical range  Page ordering physician immediately</text>
            <text x="522" y="180" text-anchor="middle" font-size="7" fill="#718096">SendLabResultNotification Job dispatched</text>

            <!-- Validation Section -->
            <rect x="20" y="220" width="320" height="150" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="180" y="245" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Pathologist Validation</text>

            <rect x="35" y="260" width="140" height="50" rx="4" fill="#fff" stroke="#805ad5" stroke-width="1"/>
            <text x="105" y="280" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Review Results</text>
            <text x="105" y="295" text-anchor="middle" font-size="7" fill="#718096">Check for errors</text>
            <text x="105" y="305" text-anchor="middle" font-size="7" fill="#718096">Review deltas</text>

            <rect x="190" y="260" width="140" height="50" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="260" y="280" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Authorize</text>
            <text x="260" y="295" text-anchor="middle" font-size="7" fill="#718096">Digital signature</text>
            <text x="260" y="305" text-anchor="middle" font-size="7" fill="#718096">Release for report</text>

            <line x1="175" y1="285" x2="190" y2="285" stroke="#805ad5" stroke-width="1.5" marker-end="url(#resultArrow)"/>

            <rect x="35" y="320" width="295" height="40" rx="4" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="182" y="340" text-anchor="middle" font-size="8" fill="#4a5568">PUT /api/lab-orders/{id}/validate</text>
            <text x="182" y="352" text-anchor="middle" font-size="7" fill="#718096">Updates status to VALIDATED, logs pathologist ID</text>

            <!-- Report Generation Section -->
            <rect x="360" y="220" width="320" height="150" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="520" y="245" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Report Generation</text>

            <rect x="375" y="260" width="140" height="55" rx="4" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="445" y="280" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">PDF Report</text>
            <text x="445" y="295" text-anchor="middle" font-size="7" fill="#4a5568"> Patient details</text>
            <text x="445" y="307" text-anchor="middle" font-size="7" fill="#4a5568"> Test results table</text>

            <rect x="525" y="260" width="145" height="55" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="597" y="280" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Report Contains</text>
            <text x="597" y="295" text-anchor="middle" font-size="7" fill="#4a5568"> Reference ranges</text>
            <text x="597" y="307" text-anchor="middle" font-size="7" fill="#4a5568"> Abnormal flags</text>

            <rect x="375" y="325" width="295" height="35" rx="4" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="522" y="343" text-anchor="middle" font-size="8" fill="#4a5568">GET /api/lab-orders/{id}/report</text>
            <text x="522" y="355" text-anchor="middle" font-size="7" fill="#718096">Returns PDF with all test results</text>

            <!-- Report Delivery Section -->
            <rect x="20" y="390" width="660" height="150" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="350" y="415" text-anchor="middle" font-weight="bold" font-size="11" fill="#975a16">Report Delivery Channels</text>

            <rect x="40" y="435" width="120" height="70" rx="6" fill="#fff" stroke="#d69e2e" stroke-width="1"/>
            <text x="100" y="455" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Print</text>
            <text x="100" y="472" text-anchor="middle" font-size="7" fill="#4a5568">Physical copy</text>
            <text x="100" y="484" text-anchor="middle" font-size="7" fill="#4a5568">at lab counter</text>
            <text x="100" y="496" text-anchor="middle" font-size="7" fill="#718096">Token number</text>

            <rect x="175" y="435" width="120" height="70" rx="6" fill="#fff" stroke="#d69e2e" stroke-width="1"/>
            <text x="235" y="455" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">SMS</text>
            <text x="235" y="472" text-anchor="middle" font-size="7" fill="#4a5568">Report ready</text>
            <text x="235" y="484" text-anchor="middle" font-size="7" fill="#4a5568">notification</text>
            <text x="235" y="496" text-anchor="middle" font-size="7" fill="#718096">+ Portal link</text>

            <rect x="310" y="435" width="120" height="70" rx="6" fill="#fff" stroke="#d69e2e" stroke-width="1"/>
            <text x="370" y="455" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Email</text>
            <text x="370" y="472" text-anchor="middle" font-size="7" fill="#4a5568">PDF attachment</text>
            <text x="370" y="484" text-anchor="middle" font-size="7" fill="#4a5568">or secure link</text>
            <text x="370" y="496" text-anchor="middle" font-size="7" fill="#718096">Encrypted</text>

            <rect x="445" y="435" width="120" height="70" rx="6" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="505" y="455" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Patient Portal</text>
            <text x="505" y="472" text-anchor="middle" font-size="7" fill="#4a5568">Self-service</text>
            <text x="505" y="484" text-anchor="middle" font-size="7" fill="#4a5568">download</text>
            <text x="505" y="496" text-anchor="middle" font-size="7" fill="#718096">24/7 access</text>

            <rect x="580" y="435" width="90" height="70" rx="6" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="1"/>
            <text x="625" y="455" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">EMR</text>
            <text x="625" y="472" text-anchor="middle" font-size="7" fill="#4a5568">Auto-filed</text>
            <text x="625" y="484" text-anchor="middle" font-size="7" fill="#4a5568">in patient</text>
            <text x="625" y="496" text-anchor="middle" font-size="7" fill="#718096">record</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>Laboratory Workflow Key Points</h4>
        <ul>
            <li><strong>Order Sources:</strong> OPD consultation, IPD ward rounds, Emergency STAT orders, Health checkup packages, External walk-ins</li>
            <li><strong>Sample Types:</strong> Blood (serum, plasma, whole blood), Urine, Stool, Sputum, CSF, Tissue biopsies, Swabs</li>
            <li><strong>Turnaround Time (TAT):</strong> Routine (24-48 hrs), Urgent (4-6 hrs), STAT (1-2 hrs), ASAP (&lt;1 hr) - defined in lab_tests.tat_hours</li>
            <li><strong>Quality Control:</strong> Sample rejection for hemolysis, insufficient quantity, improper labeling, expired stability</li>
            <li><strong>Barcode Tracking:</strong> Unique barcode per sample, scanned at collection  reception  processing  result entry</li>
            <li><strong>Critical Values:</strong> Auto-alert to ordering physician via SendLabResultNotification Job, requires acknowledgment</li>
            <li><strong>Validation:</strong> Two-tier validation - Technician entry  Pathologist review and authorization</li>
            <li><strong>Report Delivery:</strong> Print, SMS, Email, Patient portal, Auto-filed in EMR</li>
        </ul>
    </div>
</div>

<!-- Section 4.5: Radiology Module with Workflow Diagrams -->
<div class="section">
    <h2>4.5 Radiology Module</h2>
    <p>The Radiology module manages diagnostic imaging from order to report, supporting multiple modalities (X-Ray, CT, MRI, Ultrasound), PACS integration, and critical finding alerts.</p>

    <h3>4.5.1 Radiology Workflow Diagrams</h3>

    <!-- Diagram 1: Complete Radiology Imaging Journey -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Complete Radiology Imaging Journey</div>
        <svg width="700" height="580" viewBox="0 0 700 580">
            <defs>
                <marker id="radArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="radArrowBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#3182ce"/>
                </marker>
                <marker id="radArrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#e53e3e"/>
                </marker>
            </defs>

            <!-- Phase Labels -->
            <rect x="10" y="10" width="130" height="25" rx="4" fill="#2b6cb0"/>
            <text x="75" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 1: Order</text>

            <rect x="150" y="10" width="130" height="25" rx="4" fill="#38a169"/>
            <text x="215" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 2: Scheduling</text>

            <rect x="290" y="10" width="130" height="25" rx="4" fill="#d69e2e"/>
            <text x="355" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 3: Imaging</text>

            <rect x="430" y="10" width="130" height="25" rx="4" fill="#805ad5"/>
            <text x="495" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 4: Reporting</text>

            <rect x="570" y="10" width="120" height="25" rx="4" fill="#e53e3e"/>
            <text x="630" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 5: Delivery</text>

            <!-- Phase 1: Order Creation -->
            <rect x="20" y="50" width="110" height="45" rx="6" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="75" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Doctor Orders</text>
            <text x="75" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Imaging Request</text>

            <rect x="20" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="75" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Clinical indication</text>
            <text x="75" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Priority level</text>
            <text x="75" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Pregnancy check</text>

            <rect x="20" y="165" width="110" height="35" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="1.5"/>
            <text x="75" y="180" text-anchor="middle" font-size="8" fill="#c53030">POST /radiology/orders</text>
            <text x="75" y="192" text-anchor="middle" font-size="7" fill="#718096">Create order</text>

            <line x1="75" y1="95" x2="75" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="75" y1="155" x2="75" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>

            <!-- Phase 2: Scheduling -->
            <rect x="160" y="50" width="110" height="45" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="215" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Schedule Exam</text>
            <text x="215" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Assign slot</text>

            <rect x="160" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="215" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Check availability</text>
            <text x="215" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Patient prep</text>
            <text x="215" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Consent if needed</text>

            <rect x="160" y="165" width="110" height="35" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="1"/>
            <text x="215" y="180" text-anchor="middle" font-size="8" fill="#276749">Status: SCHEDULED</text>
            <text x="215" y="192" text-anchor="middle" font-size="7" fill="#718096">scheduled_datetime</text>

            <line x1="130" y1="72" x2="160" y2="72" stroke="#38a169" stroke-width="2" marker-end="url(#radArrow)"/>
            <line x1="215" y1="95" x2="215" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="215" y1="155" x2="215" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>

            <!-- Phase 3: Image Acquisition -->
            <rect x="300" y="50" width="110" height="45" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="355" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Image Capture</text>
            <text x="355" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Technologist</text>

            <rect x="300" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="355" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Patient positioning</text>
            <text x="355" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Contrast admin</text>
            <text x="355" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Acquire images</text>

            <rect x="300" y="165" width="110" height="45" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="355" y="182" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">PACS Upload</text>
            <text x="355" y="197" text-anchor="middle" font-size="8" fill="#4a5568">DICOM archive</text>

            <line x1="270" y1="182" x2="300" y2="182" stroke="#d69e2e" stroke-width="2" marker-end="url(#radArrow)"/>
            <line x1="355" y1="95" x2="355" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="355" y1="155" x2="355" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>

            <!-- Phase 4: Reporting -->
            <rect x="440" y="50" width="110" height="45" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="495" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Interpretation</text>
            <text x="495" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Radiologist</text>

            <rect x="440" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="495" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Review images</text>
            <text x="495" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Findings</text>
            <text x="495" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Impression</text>

            <rect x="440" y="165" width="110" height="45" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="495" y="182" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Verification</text>
            <text x="495" y="197" text-anchor="middle" font-size="8" fill="#4a5568">Sign-off</text>

            <line x1="410" y1="72" x2="440" y2="72" stroke="#805ad5" stroke-width="2" marker-end="url(#radArrow)"/>
            <line x1="495" y1="95" x2="495" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="495" y1="155" x2="495" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>

            <!-- Phase 5: Report Delivery -->
            <rect x="580" y="50" width="110" height="45" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="635" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Report Ready</text>
            <text x="635" y="85" text-anchor="middle" font-size="8" fill="#4a5568">PDF + Images</text>

            <rect x="580" y="105" width="110" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="635" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Print report</text>
            <text x="635" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> CD/USB images</text>
            <text x="635" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Portal access</text>

            <rect x="580" y="165" width="110" height="35" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="1"/>
            <text x="635" y="180" text-anchor="middle" font-size="8" fill="#276749">Status: COMPLETED</text>
            <text x="635" y="192" text-anchor="middle" font-size="7" fill="#718096">Filed in EMR</text>

            <line x1="550" y1="187" x2="580" y2="187" stroke="#e53e3e" stroke-width="2" marker-end="url(#radArrowRed)"/>
            <line x1="635" y1="95" x2="635" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="635" y1="155" x2="635" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>

            <!-- Order Status Flow -->
            <rect x="20" y="230" width="670" height="130" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="355" y="250" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Radiology Order Status Transitions</text>

            <!-- Status boxes -->
            <rect x="40" y="275" width="80" height="35" rx="5" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="80" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">ORDERED</text>

            <rect x="140" y="275" width="80" height="35" rx="5" fill="#c6f6d5" stroke="#38a169" stroke-width="2"/>
            <text x="180" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">SCHEDULED</text>

            <rect x="240" y="275" width="80" height="35" rx="5" fill="#fefcbf" stroke="#d69e2e" stroke-width="2"/>
            <text x="280" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">IN PROGRESS</text>

            <rect x="340" y="275" width="80" height="35" rx="5" fill="#bee3f8" stroke="#3182ce" stroke-width="2"/>
            <text x="380" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">IMAGED</text>

            <rect x="440" y="275" width="80" height="35" rx="5" fill="#e9d8fd" stroke="#805ad5" stroke-width="2"/>
            <text x="480" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">REPORTED</text>

            <rect x="540" y="275" width="80" height="35" rx="5" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="580" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">VERIFIED</text>

            <!-- Arrows between statuses -->
            <line x1="120" y1="292" x2="140" y2="292" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="220" y1="292" x2="240" y2="292" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="320" y1="292" x2="340" y2="292" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="420" y1="292" x2="440" y2="292" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="520" y1="292" x2="540" y2="292" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>

            <!-- Cancelled path -->
            <rect x="290" y="325" width="80" height="25" rx="5" fill="#fed7d7" stroke="#e53e3e" stroke-width="2"/>
            <text x="330" y="342" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">CANCELLED</text>

            <path d="M80,310 L80,337 L290,337" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#radArrowRed)"/>

            <!-- Critical Finding Alert Box -->
            <rect x="20" y="380" width="330" height="100" rx="8" fill="#fff5f5" stroke="#fc8181" stroke-width="2"/>
            <text x="185" y="400" text-anchor="middle" font-weight="bold" font-size="10" fill="#c53030">Critical Finding Workflow</text>

            <rect x="35" y="415" width="90" height="30" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="80" y="434" text-anchor="middle" font-size="8" fill="#c53030">Critical Found</text>

            <rect x="140" y="415" width="90" height="30" rx="4" fill="#feebc8" stroke="#ed8936" stroke-width="1"/>
            <text x="185" y="434" text-anchor="middle" font-size="8" fill="#c05621">Call Physician</text>

            <rect x="245" y="415" width="90" height="30" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="290" y="434" text-anchor="middle" font-size="8" fill="#276749">Documented</text>

            <line x1="125" y1="430" x2="140" y2="430" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <line x1="230" y1="430" x2="245" y2="430" stroke="#4a5568" stroke-width="1.5" marker-end="url(#radArrow)"/>

            <text x="185" y="465" text-anchor="middle" font-size="7" fill="#718096">critical_finding_communicated = true, communicated_to, communicated_at</text>

            <!-- Priority Levels Box -->
            <rect x="360" y="380" width="330" height="100" rx="8" fill="#ebf8ff" stroke="#63b3ed" stroke-width="2"/>
            <text x="525" y="400" text-anchor="middle" font-weight="bold" font-size="10" fill="#2b6cb0">Order Priority Levels</text>

            <rect x="375" y="420" width="70" height="45" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="410" y="440" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Routine</text>
            <text x="410" y="455" text-anchor="middle" font-size="7" fill="#4a5568">24-48 hrs</text>

            <rect x="455" y="420" width="70" height="45" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="490" y="440" text-anchor="middle" font-weight="bold" font-size="8" fill="#975a16">Urgent</text>
            <text x="490" y="455" text-anchor="middle" font-size="7" fill="#4a5568">4-6 hrs</text>

            <rect x="535" y="420" width="70" height="45" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="570" y="440" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">STAT</text>
            <text x="570" y="455" text-anchor="middle" font-size="7" fill="#4a5568">1-2 hrs</text>

            <rect x="615" y="420" width="65" height="45" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="647" y="440" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Emergent</text>
            <text x="647" y="455" text-anchor="middle" font-size="7" fill="#4a5568">< 1 hr</text>

            <!-- API Endpoints -->
            <rect x="20" y="500" width="670" height="70" rx="8" fill="#f0fff4" stroke="#9ae6b4" stroke-width="1"/>
            <text x="355" y="520" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">Key API Endpoints</text>
            <text x="110" y="540" text-anchor="middle" font-size="8" fill="#4a5568">POST /radiology/orders</text>
            <text x="260" y="540" text-anchor="middle" font-size="8" fill="#4a5568">GET /radiology/orders/{id}</text>
            <text x="420" y="540" text-anchor="middle" font-size="8" fill="#4a5568">POST /radiology/reports</text>
            <text x="580" y="540" text-anchor="middle" font-size="8" fill="#4a5568">GET /radiology/reports/{id}</text>
            <text x="180" y="558" text-anchor="middle" font-size="8" fill="#4a5568">GET /radiology/modalities</text>
            <text x="355" y="558" text-anchor="middle" font-size="8" fill="#4a5568">GET /radiology/tests</text>
            <text x="530" y="558" text-anchor="middle" font-size="8" fill="#4a5568">PUT /radiology/orders/{id}/status</text>
        </svg>
    </div>

    <!-- Diagram 2: Radiology Modalities & Order Sources -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Radiology Modalities & Order Sources</div>
        <svg width="700" height="520" viewBox="0 0 700 520">
            <defs>
                <marker id="modArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Central Radiology Department -->
            <ellipse cx="350" cy="200" rx="80" ry="55" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="3"/>
            <text x="350" y="190" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Radiology</text>
            <text x="350" y="207" text-anchor="middle" font-size="9" fill="#4a5568">Department</text>
            <text x="350" y="220" text-anchor="middle" font-size="8" fill="#718096">Worklist Management</text>

            <!-- Order Sources (Left Side) -->
            <text x="100" y="30" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Order Sources</text>

            <rect x="30" y="50" width="140" height="60" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="100" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">OPD Orders</text>
            <text x="100" y="92" text-anchor="middle" font-size="8" fill="#4a5568">Linked to opd_id</text>

            <rect x="30" y="130" width="140" height="60" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="100" y="155" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">IPD Orders</text>
            <text x="100" y="172" text-anchor="middle" font-size="8" fill="#4a5568">Linked to ipd_id</text>

            <rect x="30" y="210" width="140" height="60" rx="8" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="100" y="235" text-anchor="middle" font-weight="bold" font-size="10" fill="#c53030">Emergency</text>
            <text x="100" y="252" text-anchor="middle" font-size="8" fill="#4a5568">STAT priority</text>

            <rect x="30" y="290" width="140" height="60" rx="8" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="100" y="315" text-anchor="middle" font-weight="bold" font-size="10" fill="#97266d">Pre-operative</text>
            <text x="100" y="332" text-anchor="middle" font-size="8" fill="#4a5568">Surgery clearance</text>

            <!-- Arrows from sources to center -->
            <path d="M170,80 Q230,80 270,170" stroke="#38a169" stroke-width="2" fill="none" marker-end="url(#modArrow)"/>
            <path d="M170,160 Q220,160 270,190" stroke="#805ad5" stroke-width="2" fill="none" marker-end="url(#modArrow)"/>
            <path d="M170,240 Q220,240 270,210" stroke="#e53e3e" stroke-width="2" fill="none" marker-end="url(#modArrow)"/>
            <path d="M170,320 Q230,320 270,230" stroke="#d53f8c" stroke-width="2" fill="none" marker-end="url(#modArrow)"/>

            <!-- Modalities (Right Side) -->
            <text x="600" y="30" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Modalities</text>

            <rect x="530" y="50" width="140" height="55" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="600" y="72" text-anchor="middle" font-weight="bold" font-size="10" fill="#2b6cb0">X-Ray</text>
            <text x="600" y="88" text-anchor="middle" font-size="8" fill="#4a5568">General Radiography</text>

            <rect x="530" y="115" width="140" height="55" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="600" y="137" text-anchor="middle" font-weight="bold" font-size="10" fill="#975a16">CT Scan</text>
            <text x="600" y="153" text-anchor="middle" font-size="8" fill="#4a5568">Computed Tomography</text>

            <rect x="530" y="180" width="140" height="55" rx="8" fill="#e6fffa" stroke="#319795" stroke-width="2"/>
            <text x="600" y="202" text-anchor="middle" font-weight="bold" font-size="10" fill="#234e52">MRI</text>
            <text x="600" y="218" text-anchor="middle" font-size="8" fill="#4a5568">Magnetic Resonance</text>

            <rect x="530" y="245" width="140" height="55" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="600" y="267" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">Ultrasound</text>
            <text x="600" y="283" text-anchor="middle" font-size="8" fill="#4a5568">Sonography</text>

            <rect x="530" y="310" width="140" height="55" rx="8" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="600" y="332" text-anchor="middle" font-weight="bold" font-size="10" fill="#97266d">Mammography</text>
            <text x="600" y="348" text-anchor="middle" font-size="8" fill="#4a5568">Breast imaging</text>

            <!-- Arrows from center to modalities -->
            <path d="M430,170 Q480,80 530,77" stroke="#2b6cb0" stroke-width="2" fill="none" marker-end="url(#modArrow)"/>
            <path d="M430,185 Q480,142 530,142" stroke="#d69e2e" stroke-width="2" fill="none" marker-end="url(#modArrow)"/>
            <line x1="430" y1="200" x2="530" y2="207" stroke="#319795" stroke-width="2" marker-end="url(#modArrow)"/>
            <path d="M430,215 Q480,270 530,272" stroke="#805ad5" stroke-width="2" fill="none" marker-end="url(#modArrow)"/>
            <path d="M430,230 Q480,330 530,337" stroke="#d53f8c" stroke-width="2" fill="none" marker-end="url(#modArrow)"/>

            <!-- Modality Configuration Box -->
            <rect x="30" y="380" width="300" height="130" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="2"/>
            <text x="180" y="405" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Modality Configuration (radiology_modalities)</text>

            <text x="50" y="430" font-size="8" fill="#4a5568"> modality_code: XR, CT, MR, US, MG</text>
            <text x="50" y="445" font-size="8" fill="#4a5568"> modality_name: Display name</text>
            <text x="50" y="460" font-size="8" fill="#4a5568"> room_number: Physical location</text>
            <text x="50" y="475" font-size="8" fill="#4a5568"> is_contrast_available: Boolean</text>
            <text x="50" y="490" font-size="8" fill="#4a5568"> default_tat_hours: Turnaround time</text>

            <!-- Test Configuration Box -->
            <rect x="350" y="380" width="320" height="130" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="2"/>
            <text x="510" y="405" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Test Configuration (radiology_tests)</text>

            <text x="370" y="430" font-size="8" fill="#4a5568"> test_code, test_name: Procedure ID</text>
            <text x="370" y="445" font-size="8" fill="#4a5568"> body_part: Chest, Abdomen, Brain...</text>
            <text x="370" y="460" font-size="8" fill="#4a5568"> laterality: Left, Right, Bilateral</text>
            <text x="370" y="475" font-size="8" fill="#4a5568"> contrast_required, consent_required</text>
            <text x="370" y="490" font-size="8" fill="#4a5568"> preparation_instructions, tat_hours</text>
        </svg>
    </div>

    <!-- Diagram 3: Image Acquisition & PACS Integration -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Image Acquisition & PACS Integration Workflow</div>
        <svg width="700" height="520" viewBox="0 0 700 520">
            <defs>
                <marker id="pacsArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Patient Preparation Section -->
            <rect x="20" y="20" width="200" height="180" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="120" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Patient Preparation</text>

            <rect x="35" y="60" width="170" height="30" rx="4" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="120" y="79" text-anchor="middle" font-size="8" fill="#276749">1. Verify patient identity</text>

            <rect x="35" y="95" width="170" height="30" rx="4" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="120" y="114" text-anchor="middle" font-size="8" fill="#276749">2. Check preparation status</text>

            <rect x="35" y="130" width="170" height="30" rx="4" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="120" y="149" text-anchor="middle" font-size="8" fill="#276749">3. Obtain consent (if required)</text>

            <rect x="35" y="165" width="170" height="30" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="120" y="184" text-anchor="middle" font-size="8" fill="#276749">4. Pregnancy screening</text>

            <!-- Image Acquisition Section -->
            <rect x="250" y="20" width="200" height="180" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="350" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#975a16">Image Acquisition</text>

            <rect x="265" y="60" width="170" height="30" rx="4" fill="#fff" stroke="#d69e2e" stroke-width="1"/>
            <text x="350" y="79" text-anchor="middle" font-size="8" fill="#975a16">1. Patient positioning</text>

            <rect x="265" y="95" width="170" height="30" rx="4" fill="#fff" stroke="#d69e2e" stroke-width="1"/>
            <text x="350" y="114" text-anchor="middle" font-size="8" fill="#975a16">2. Contrast admin (if needed)</text>

            <rect x="265" y="130" width="170" height="30" rx="4" fill="#fff" stroke="#d69e2e" stroke-width="1"/>
            <text x="350" y="149" text-anchor="middle" font-size="8" fill="#975a16">3. Acquire images</text>

            <rect x="265" y="165" width="170" height="30" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="350" y="184" text-anchor="middle" font-size="8" fill="#975a16">4. Tech quality check</text>

            <!-- PACS/DICOM Section -->
            <rect x="480" y="20" width="200" height="180" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="580" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">PACS / DICOM</text>

            <rect x="495" y="60" width="170" height="35" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="580" y="78" text-anchor="middle" font-size="8" fill="#2b6cb0">DICOM Modality Worklist</text>
            <text x="580" y="90" text-anchor="middle" font-size="7" fill="#718096">Patient/Order data to modality</text>

            <rect x="495" y="105" width="170" height="35" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="580" y="123" text-anchor="middle" font-size="8" fill="#2b6cb0">DICOM Storage</text>
            <text x="580" y="135" text-anchor="middle" font-size="7" fill="#718096">Images sent to PACS</text>

            <rect x="495" y="150" width="170" height="45" rx="4" fill="#bee3f8" stroke="#2b6cb0" stroke-width="1"/>
            <text x="580" y="168" text-anchor="middle" font-size="8" fill="#2b6cb0">Archive & Retrieve</text>
            <text x="580" y="183" text-anchor="middle" font-size="7" fill="#718096">Long-term storage</text>
            <text x="580" y="193" text-anchor="middle" font-size="7" fill="#718096">Viewer access</text>

            <!-- Arrows between sections -->
            <line x1="220" y1="110" x2="250" y2="110" stroke="#4a5568" stroke-width="2" marker-end="url(#pacsArrow)"/>
            <line x1="450" y1="110" x2="480" y2="110" stroke="#4a5568" stroke-width="2" marker-end="url(#pacsArrow)"/>

            <!-- Technologist Workstation -->
            <rect x="20" y="230" width="320" height="130" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="180" y="255" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Technologist Workstation</text>

            <rect x="35" y="275" width="140" height="70" rx="4" fill="#fff" stroke="#805ad5" stroke-width="1"/>
            <text x="105" y="295" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Worklist Management</text>
            <text x="105" y="312" text-anchor="middle" font-size="7" fill="#4a5568"> Today's scheduled exams</text>
            <text x="105" y="325" text-anchor="middle" font-size="7" fill="#4a5568"> Patient queue</text>
            <text x="105" y="338" text-anchor="middle" font-size="7" fill="#4a5568"> Priority ordering</text>

            <rect x="185" y="275" width="140" height="70" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="255" y="295" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Image Review</text>
            <text x="255" y="312" text-anchor="middle" font-size="7" fill="#4a5568"> Quality assessment</text>
            <text x="255" y="325" text-anchor="middle" font-size="7" fill="#4a5568"> Repeat if needed</text>
            <text x="255" y="338" text-anchor="middle" font-size="7" fill="#4a5568"> Mark complete</text>

            <!-- Radiologist Workstation -->
            <rect x="360" y="230" width="320" height="130" rx="8" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="520" y="255" text-anchor="middle" font-weight="bold" font-size="11" fill="#c53030">Radiologist Workstation (PACS Viewer)</text>

            <rect x="375" y="275" width="140" height="70" rx="4" fill="#fff" stroke="#fc8181" stroke-width="1"/>
            <text x="445" y="295" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Image Viewing</text>
            <text x="445" y="312" text-anchor="middle" font-size="7" fill="#4a5568"> Multi-monitor display</text>
            <text x="445" y="325" text-anchor="middle" font-size="7" fill="#4a5568"> Window/level adjust</text>
            <text x="445" y="338" text-anchor="middle" font-size="7" fill="#4a5568"> Compare priors</text>

            <rect x="525" y="275" width="140" height="70" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="595" y="295" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Reporting Tools</text>
            <text x="595" y="312" text-anchor="middle" font-size="7" fill="#4a5568"> Voice dictation</text>
            <text x="595" y="325" text-anchor="middle" font-size="7" fill="#4a5568"> Template library</text>
            <text x="595" y="338" text-anchor="middle" font-size="7" fill="#4a5568"> Measurement tools</text>

            <!-- DICOM Standards Box -->
            <rect x="20" y="380" width="320" height="130" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="2"/>
            <text x="180" y="405" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">DICOM Integration Standards</text>

            <rect x="35" y="420" width="90" height="40" rx="4" fill="#ebf8ff" stroke="#3182ce" stroke-width="1"/>
            <text x="80" y="438" text-anchor="middle" font-size="8" fill="#2b6cb0">MWL</text>
            <text x="80" y="452" text-anchor="middle" font-size="7" fill="#718096">Modality Worklist</text>

            <rect x="135" y="420" width="90" height="40" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="180" y="438" text-anchor="middle" font-size="8" fill="#276749">MPPS</text>
            <text x="180" y="452" text-anchor="middle" font-size="7" fill="#718096">Procedure Step</text>

            <rect x="235" y="420" width="90" height="40" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="280" y="438" text-anchor="middle" font-size="8" fill="#975a16">Storage</text>
            <text x="280" y="452" text-anchor="middle" font-size="7" fill="#718096">C-STORE</text>

            <text x="180" y="485" text-anchor="middle" font-size="8" fill="#4a5568">IHE Profiles: SWF (Scheduled Workflow), PIR (Patient Info Reconciliation)</text>
            <text x="180" y="500" text-anchor="middle" font-size="7" fill="#718096">Supports HL7 integration for order status updates</text>

            <!-- Image Storage Box -->
            <rect x="360" y="380" width="320" height="130" rx="8" fill="#e6fffa" stroke="#319795" stroke-width="2"/>
            <text x="520" y="405" text-anchor="middle" font-weight="bold" font-size="10" fill="#234e52">Image Storage & Access</text>

            <rect x="375" y="420" width="90" height="50" rx="4" fill="#fff" stroke="#319795" stroke-width="1"/>
            <text x="420" y="440" text-anchor="middle" font-weight="bold" font-size="8" fill="#234e52">PACS</text>
            <text x="420" y="455" text-anchor="middle" font-size="7" fill="#4a5568">Primary archive</text>

            <rect x="475" y="420" width="90" height="50" rx="4" fill="#fff" stroke="#319795" stroke-width="1"/>
            <text x="520" y="440" text-anchor="middle" font-weight="bold" font-size="8" fill="#234e52">VNA</text>
            <text x="520" y="455" text-anchor="middle" font-size="7" fill="#4a5568">Vendor neutral</text>

            <rect x="575" y="420" width="90" height="50" rx="4" fill="#b2f5ea" stroke="#319795" stroke-width="1"/>
            <text x="620" y="440" text-anchor="middle" font-weight="bold" font-size="8" fill="#234e52">Cloud</text>
            <text x="620" y="455" text-anchor="middle" font-size="7" fill="#4a5568">Disaster recovery</text>

            <text x="520" y="490" text-anchor="middle" font-size="8" fill="#4a5568">radiology_images: report_id, image_path, image_type, sequence_number</text>
        </svg>
    </div>

    <!-- Diagram 4: Radiology Reporting Workflow -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Radiology Reporting & Verification Workflow</div>
        <svg width="700" height="550" viewBox="0 0 700 550">
            <defs>
                <marker id="reportArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Report Creation Section -->
            <rect x="20" y="20" width="320" height="180" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="180" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">Report Creation (Radiologist)</text>

            <rect x="35" y="60" width="140" height="60" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="105" y="80" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Technique</text>
            <text x="105" y="95" text-anchor="middle" font-size="7" fill="#4a5568">Protocol used</text>
            <text x="105" y="107" text-anchor="middle" font-size="7" fill="#718096">Contrast details</text>

            <rect x="185" y="60" width="140" height="60" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="255" y="80" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Findings</text>
            <text x="255" y="95" text-anchor="middle" font-size="7" fill="#4a5568">Observations</text>
            <text x="255" y="107" text-anchor="middle" font-size="7" fill="#718096">Measurements</text>

            <rect x="35" y="130" width="140" height="60" rx="4" fill="#bee3f8" stroke="#2b6cb0" stroke-width="1"/>
            <text x="105" y="150" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Impression</text>
            <text x="105" y="165" text-anchor="middle" font-size="7" fill="#4a5568">Diagnosis summary</text>
            <text x="105" y="177" text-anchor="middle" font-size="7" fill="#718096">Key conclusions</text>

            <rect x="185" y="130" width="140" height="60" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="255" y="150" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Recommendations</text>
            <text x="255" y="165" text-anchor="middle" font-size="7" fill="#4a5568">Follow-up exams</text>
            <text x="255" y="177" text-anchor="middle" font-size="7" fill="#718096">Clinical correlation</text>

            <!-- Report Status Flow -->
            <rect x="360" y="20" width="320" height="180" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="520" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Report Status & Verification</text>

            <rect x="380" y="65" width="100" height="40" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="2"/>
            <text x="430" y="89" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">DRAFT</text>

            <rect x="500" y="65" width="100" height="40" rx="4" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="550" y="89" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">PRELIMINARY</text>

            <rect x="380" y="130" width="100" height="40" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="2"/>
            <text x="430" y="154" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">FINAL</text>

            <rect x="500" y="130" width="100" height="40" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="2"/>
            <text x="550" y="154" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">ADDENDUM</text>

            <line x1="480" y1="85" x2="500" y2="85" stroke="#4a5568" stroke-width="1.5" marker-end="url(#reportArrow)"/>
            <line x1="550" y1="105" x2="550" y2="130" stroke="#4a5568" stroke-width="1.5" marker-end="url(#reportArrow)"/>
            <line x1="480" y1="150" x2="500" y2="150" stroke="#4a5568" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#reportArrow)"/>
            <path d="M600,150 L620,150 L620,85 L600,85" stroke="#4a5568" stroke-width="1" stroke-dasharray="4,2" fill="none"/>

            <text x="520" y="190" text-anchor="middle" font-size="7" fill="#718096">verified_by, verified_at tracked for audit</text>

            <!-- Critical Finding Workflow -->
            <rect x="20" y="220" width="320" height="150" rx="8" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="180" y="245" text-anchor="middle" font-weight="bold" font-size="11" fill="#c53030">Critical Finding Communication</text>

            <rect x="35" y="265" width="90" height="50" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="80" y="285" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Identify</text>
            <text x="80" y="300" text-anchor="middle" font-size="7" fill="#4a5568">Critical finding</text>
            <text x="80" y="310" text-anchor="middle" font-size="7" fill="#718096">detected</text>

            <rect x="140" y="265" width="90" height="50" rx="4" fill="#feebc8" stroke="#ed8936" stroke-width="1"/>
            <text x="185" y="285" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Contact</text>
            <text x="185" y="300" text-anchor="middle" font-size="7" fill="#4a5568">Call referring</text>
            <text x="185" y="310" text-anchor="middle" font-size="7" fill="#718096">physician</text>

            <rect x="245" y="265" width="80" height="50" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="285" y="285" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Document</text>
            <text x="285" y="300" text-anchor="middle" font-size="7" fill="#4a5568">Log contact</text>
            <text x="285" y="310" text-anchor="middle" font-size="7" fill="#718096">details</text>

            <line x1="125" y1="290" x2="140" y2="290" stroke="#4a5568" stroke-width="1.5" marker-end="url(#reportArrow)"/>
            <line x1="230" y1="290" x2="245" y2="290" stroke="#4a5568" stroke-width="1.5" marker-end="url(#reportArrow)"/>

            <text x="180" y="340" text-anchor="middle" font-size="7" fill="#718096">critical_finding: boolean, critical_finding_communicated: boolean</text>
            <text x="180" y="355" text-anchor="middle" font-size="7" fill="#718096">communicated_to, communicated_at: timestamp</text>

            <!-- Report Data Model -->
            <rect x="360" y="220" width="320" height="150" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="2"/>
            <text x="520" y="245" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Report Data Model (radiology_reports)</text>

            <text x="380" y="270" font-size="8" fill="#4a5568"> radiology_order_id: Link to order</text>
            <text x="380" y="285" font-size="8" fill="#4a5568"> reporting_radiologist_id: Doctor ID</text>
            <text x="380" y="300" font-size="8" fill="#4a5568"> report_date, report_time: Timestamps</text>
            <text x="380" y="315" font-size="8" fill="#4a5568"> technique, findings, impression</text>
            <text x="380" y="330" font-size="8" fill="#4a5568"> recommendations: Follow-up advice</text>
            <text x="380" y="345" font-size="8" fill="#4a5568"> report_status: DRAFT/PRELIM/FINAL</text>
            <text x="380" y="360" font-size="8" fill="#4a5568"> report_pdf_path: Generated PDF</text>

            <!-- Report Delivery Section -->
            <rect x="20" y="390" width="660" height="150" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="350" y="415" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Report Delivery & Distribution</text>

            <rect x="40" y="440" width="120" height="70" rx="6" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="100" y="460" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Print</text>
            <text x="100" y="477" text-anchor="middle" font-size="7" fill="#4a5568">Paper report</text>
            <text x="100" y="489" text-anchor="middle" font-size="7" fill="#4a5568">with key images</text>
            <text x="100" y="501" text-anchor="middle" font-size="7" fill="#718096">Film printing</text>

            <rect x="175" y="440" width="120" height="70" rx="6" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="235" y="460" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">CD/USB</text>
            <text x="235" y="477" text-anchor="middle" font-size="7" fill="#4a5568">DICOM images</text>
            <text x="235" y="489" text-anchor="middle" font-size="7" fill="#4a5568">+ PDF report</text>
            <text x="235" y="501" text-anchor="middle" font-size="7" fill="#718096">With viewer</text>

            <rect x="310" y="440" width="120" height="70" rx="6" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="370" y="460" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Portal</text>
            <text x="370" y="477" text-anchor="middle" font-size="7" fill="#4a5568">Patient access</text>
            <text x="370" y="489" text-anchor="middle" font-size="7" fill="#4a5568">Web PACS viewer</text>
            <text x="370" y="501" text-anchor="middle" font-size="7" fill="#718096">24/7 available</text>

            <rect x="445" y="440" width="120" height="70" rx="6" fill="#c6f6d5" stroke="#276749" stroke-width="1"/>
            <text x="505" y="460" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">EMR</text>
            <text x="505" y="477" text-anchor="middle" font-size="7" fill="#4a5568">Auto-filed</text>
            <text x="505" y="489" text-anchor="middle" font-size="7" fill="#4a5568">in patient record</text>
            <text x="505" y="501" text-anchor="middle" font-size="7" fill="#718096">Linked to order</text>

            <rect x="580" y="440" width="90" height="70" rx="6" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="1"/>
            <text x="625" y="460" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">HL7</text>
            <text x="625" y="477" text-anchor="middle" font-size="7" fill="#4a5568">Result message</text>
            <text x="625" y="489" text-anchor="middle" font-size="7" fill="#4a5568">ORU^R01</text>
            <text x="625" y="501" text-anchor="middle" font-size="7" fill="#718096">Integration</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>Radiology Workflow Key Points</h4>
        <ul>
            <li><strong>Modalities:</strong> X-Ray, CT, MRI, Ultrasound, Mammography, Fluoroscopy - each with room assignment and TAT configuration</li>
            <li><strong>Order Sources:</strong> OPD (opd_id), IPD (ipd_id), Emergency, Pre-operative clearance</li>
            <li><strong>Priority Levels:</strong> Routine (24-48 hrs), Urgent (4-6 hrs), STAT (1-2 hrs), Emergent (&lt;1 hr)</li>
            <li><strong>PACS Integration:</strong> DICOM MWL for worklist, MPPS for procedure status, C-STORE for image archival</li>
            <li><strong>Contrast Handling:</strong> contrast_required per test, with_contrast per order detail, contrast_rate billing</li>
            <li><strong>Critical Findings:</strong> Immediate physician notification with mandatory documentation (communicated_to, communicated_at)</li>
            <li><strong>Report Status:</strong> DRAFT  PRELIMINARY  FINAL, with ADDENDUM support for amendments</li>
            <li><strong>Verification:</strong> Two-level sign-off - Reporting radiologist + Verifying radiologist (verified_by, verified_at)</li>
        </ul>
    </div>
</div>

<!-- Section 4.6: Operation Theater Module with Workflow Diagrams -->
<div class="section">
    <h2>4.6 Operation Theater Module</h2>
    <p>The Operation Theater module manages the complete surgical workflow from scheduling to post-operative care, including WHO surgical safety checklist compliance, anesthesia records, and consumables tracking.</p>

    <h3>4.6.1 Operation Theater Workflow Diagrams</h3>

    <!-- Diagram 1: Complete Surgery Journey -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Complete Surgical Journey</div>
        <svg width="700" height="580" viewBox="0 0 700 580">
            <defs>
                <marker id="otArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="otArrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
                <marker id="otArrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#e53e3e"/>
                </marker>
            </defs>

            <!-- Phase Labels -->
            <rect x="10" y="10" width="165" height="25" rx="4" fill="#2b6cb0"/>
            <text x="92" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 1: Scheduling</text>

            <rect x="185" y="10" width="165" height="25" rx="4" fill="#38a169"/>
            <text x="267" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 2: Pre-Op</text>

            <rect x="360" y="10" width="165" height="25" rx="4" fill="#d69e2e"/>
            <text x="442" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 3: Intra-Op</text>

            <rect x="535" y="10" width="155" height="25" rx="4" fill="#805ad5"/>
            <text x="612" y="27" text-anchor="middle" font-weight="bold" font-size="10" fill="white">Phase 4: Post-Op</text>

            <!-- Phase 1: Scheduling -->
            <rect x="20" y="50" width="150" height="45" rx="6" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="95" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Surgery Request</text>
            <text x="95" y="85" text-anchor="middle" font-size="8" fill="#4a5568">From IPD admission</text>

            <rect x="20" y="105" width="150" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="95" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Select surgery type</text>
            <text x="95" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Assign OT room</text>
            <text x="95" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Book surgical team</text>

            <rect x="20" y="165" width="150" height="35" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="1.5"/>
            <text x="95" y="180" text-anchor="middle" font-size="8" fill="#c53030">POST /ot/schedules</text>
            <text x="95" y="192" text-anchor="middle" font-size="7" fill="#718096">Create schedule</text>

            <line x1="95" y1="95" x2="95" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>
            <line x1="95" y1="155" x2="95" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>

            <!-- Phase 2: Pre-operative -->
            <rect x="195" y="50" width="150" height="45" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="270" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Pre-Op Assessment</text>
            <text x="270" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Day before surgery</text>

            <rect x="195" y="105" width="150" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="270" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Anesthesia evaluation</text>
            <text x="270" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Lab investigations</text>
            <text x="270" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Consent forms</text>

            <rect x="195" y="165" width="150" height="45" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="270" y="182" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Pre-Op Checklist</text>
            <text x="270" y="197" text-anchor="middle" font-size="8" fill="#4a5568">WHO Safety Checklist</text>

            <line x1="170" y1="72" x2="195" y2="72" stroke="#38a169" stroke-width="2" marker-end="url(#otArrowGreen)"/>
            <line x1="270" y1="95" x2="270" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>
            <line x1="270" y1="155" x2="270" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>

            <!-- Phase 3: Intra-operative -->
            <rect x="370" y="50" width="150" height="45" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="445" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Patient to OT</text>
            <text x="445" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Sign In complete</text>

            <rect x="370" y="105" width="150" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="445" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> Anesthesia induction</text>
            <text x="445" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Time Out verification</text>
            <text x="445" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Surgical procedure</text>

            <rect x="370" y="165" width="150" height="45" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="445" y="182" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Procedure Record</text>
            <text x="445" y="197" text-anchor="middle" font-size="8" fill="#4a5568">OT notes, consumables</text>

            <line x1="345" y1="187" x2="370" y2="187" stroke="#d69e2e" stroke-width="2" marker-end="url(#otArrow)"/>
            <line x1="445" y1="95" x2="445" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>
            <line x1="445" y1="155" x2="445" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>

            <!-- Phase 4: Post-operative -->
            <rect x="545" y="50" width="145" height="45" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="617" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Sign Out</text>
            <text x="617" y="85" text-anchor="middle" font-size="8" fill="#4a5568">Count verification</text>

            <rect x="545" y="105" width="145" height="50" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="1"/>
            <text x="617" y="120" text-anchor="middle" font-size="8" fill="#4a5568"> PACU recovery</text>
            <text x="617" y="132" text-anchor="middle" font-size="8" fill="#4a5568"> Pain management</text>
            <text x="617" y="144" text-anchor="middle" font-size="8" fill="#4a5568"> Transfer to ward/ICU</text>

            <rect x="545" y="165" width="145" height="35" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="1"/>
            <text x="617" y="180" text-anchor="middle" font-size="8" fill="#276749">Status: COMPLETED</text>
            <text x="617" y="192" text-anchor="middle" font-size="7" fill="#718096">Post-op instructions</text>

            <line x1="520" y1="72" x2="545" y2="72" stroke="#805ad5" stroke-width="2" marker-end="url(#otArrow)"/>
            <line x1="617" y1="95" x2="617" y2="105" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>
            <line x1="617" y1="155" x2="617" y2="165" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>

            <!-- Schedule Status Flow -->
            <rect x="20" y="230" width="670" height="120" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="355" y="250" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Surgery Schedule Status Transitions</text>

            <!-- Status boxes -->
            <rect x="40" y="275" width="90" height="35" rx="5" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="85" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">SCHEDULED</text>

            <rect x="155" y="275" width="90" height="35" rx="5" fill="#c6f6d5" stroke="#38a169" stroke-width="2"/>
            <text x="200" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">PRE-OP DONE</text>

            <rect x="270" y="275" width="90" height="35" rx="5" fill="#fefcbf" stroke="#d69e2e" stroke-width="2"/>
            <text x="315" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">IN PROGRESS</text>

            <rect x="385" y="275" width="90" height="35" rx="5" fill="#e9d8fd" stroke="#805ad5" stroke-width="2"/>
            <text x="430" y="297" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">COMPLETED</text>

            <rect x="500" y="275" width="80" height="35" rx="5" fill="#fed7d7" stroke="#e53e3e" stroke-width="2"/>
            <text x="540" y="297" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">CANCELLED</text>

            <rect x="600" y="275" width="80" height="35" rx="5" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="640" y="297" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">POSTPONED</text>

            <!-- Arrows between statuses -->
            <line x1="130" y1="292" x2="155" y2="292" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>
            <line x1="245" y1="292" x2="270" y2="292" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>
            <line x1="360" y1="292" x2="385" y2="292" stroke="#4a5568" stroke-width="1.5" marker-end="url(#otArrow)"/>

            <path d="M85,310 L85,330 L540,330 L540,310" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#otArrowRed)"/>
            <path d="M200,310 L200,340 L640,340 L640,310" stroke="#ed8936" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#otArrow)"/>

            <!-- Surgical Team Box -->
            <rect x="20" y="370" width="320" height="110" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="180" y="395" text-anchor="middle" font-weight="bold" font-size="10" fill="#2b6cb0">Surgical Team Assignment</text>

            <rect x="35" y="410" width="90" height="55" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="80" y="430" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Surgeon</text>
            <text x="80" y="445" text-anchor="middle" font-size="7" fill="#4a5568">surgeon_id</text>
            <text x="80" y="457" text-anchor="middle" font-size="7" fill="#718096">+ assistant</text>

            <rect x="135" y="410" width="90" height="55" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="180" y="430" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Anesthetist</text>
            <text x="180" y="445" text-anchor="middle" font-size="7" fill="#4a5568">anesthetist_id</text>
            <text x="180" y="457" text-anchor="middle" font-size="7" fill="#718096">ASA grade</text>

            <rect x="235" y="410" width="90" height="55" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="280" y="430" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Nursing</text>
            <text x="280" y="445" text-anchor="middle" font-size="7" fill="#4a5568">Scrub nurse</text>
            <text x="280" y="457" text-anchor="middle" font-size="7" fill="#718096">Circulating</text>

            <!-- OT Room Configuration Box -->
            <rect x="360" y="370" width="330" height="110" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="525" y="395" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">OT Room Configuration (operation_theaters)</text>

            <text x="380" y="420" font-size="8" fill="#4a5568"> ot_code, ot_name, ot_type (Major/Minor/Emergency)</text>
            <text x="380" y="435" font-size="8" fill="#4a5568"> floor, capacity: Physical location & size</text>
            <text x="380" y="450" font-size="8" fill="#4a5568"> has_laminar_flow, has_c_arm, has_laparoscopy</text>
            <text x="380" y="465" font-size="8" fill="#4a5568"> charges_per_hour: Billing rate</text>

            <!-- API Endpoints -->
            <rect x="20" y="500" width="670" height="70" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="1"/>
            <text x="355" y="520" text-anchor="middle" font-weight="bold" font-size="10" fill="#975a16">Key API Endpoints</text>
            <text x="110" y="540" text-anchor="middle" font-size="8" fill="#4a5568">POST /ot/schedules</text>
            <text x="260" y="540" text-anchor="middle" font-size="8" fill="#4a5568">GET /ot/schedules/today</text>
            <text x="420" y="540" text-anchor="middle" font-size="8" fill="#4a5568">POST /ot/procedures</text>
            <text x="580" y="540" text-anchor="middle" font-size="8" fill="#4a5568">PUT /ot/schedules/{id}/status</text>
            <text x="180" y="558" text-anchor="middle" font-size="8" fill="#4a5568">POST /ot/pre-op-checklists</text>
            <text x="355" y="558" text-anchor="middle" font-size="8" fill="#4a5568">POST /ot/anesthesia-records</text>
            <text x="530" y="558" text-anchor="middle" font-size="8" fill="#4a5568">GET /ot/rooms/availability</text>
        </svg>
    </div>

    <!-- Diagram 2: Pre-Operative Checklist (WHO Surgical Safety) -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">WHO Surgical Safety Checklist Workflow</div>
        <svg width="700" height="520" viewBox="0 0 700 520">
            <defs>
                <marker id="whoArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Sign In Section -->
            <rect x="20" y="20" width="210" height="280" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="125" y="45" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">SIGN IN</text>
            <text x="125" y="60" text-anchor="middle" font-size="9" fill="#4a5568">Before Induction of Anesthesia</text>

            <rect x="35" y="75" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="125" y="92" text-anchor="middle" font-size="8" fill="#276749"> patient_identity_confirmed</text>

            <rect x="35" y="105" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="125" y="122" text-anchor="middle" font-size="8" fill="#276749"> site_marked (if applicable)</text>

            <rect x="35" y="135" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="125" y="152" text-anchor="middle" font-size="8" fill="#276749"> consent_surgical</text>

            <rect x="35" y="165" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="125" y="182" text-anchor="middle" font-size="8" fill="#276749"> consent_anesthesia</text>

            <rect x="35" y="195" width="180" height="25" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="125" y="212" text-anchor="middle" font-size="8" fill="#975a16">allergies_noted / allergies_details</text>

            <rect x="35" y="225" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="125" y="242" text-anchor="middle" font-size="8" fill="#276749"> airway_assessment done</text>

            <rect x="35" y="255" width="180" height="35" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="125" y="270" text-anchor="middle" font-size="8" fill="#c53030">blood_available if needed</text>
            <text x="125" y="283" text-anchor="middle" font-size="7" fill="#718096">blood_type_crossmatched</text>

            <!-- Time Out Section -->
            <rect x="245" y="20" width="210" height="280" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="350" y="45" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">TIME OUT</text>
            <text x="350" y="60" text-anchor="middle" font-size="9" fill="#4a5568">Before Skin Incision</text>

            <rect x="260" y="75" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="350" y="92" text-anchor="middle" font-size="8" fill="#276749"> Team introduction</text>

            <rect x="260" y="105" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="350" y="122" text-anchor="middle" font-size="8" fill="#276749"> Patient/Procedure confirmed</text>

            <rect x="260" y="135" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="350" y="152" text-anchor="middle" font-size="8" fill="#276749"> site_marked verified</text>

            <rect x="260" y="165" width="180" height="25" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="350" y="182" text-anchor="middle" font-size="8" fill="#975a16">Antibiotic prophylaxis given?</text>

            <rect x="260" y="195" width="180" height="35" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="350" y="210" text-anchor="middle" font-size="8" fill="#276749"> special_equipment_verified</text>
            <text x="350" y="223" text-anchor="middle" font-size="7" fill="#718096">Imaging displayed</text>

            <rect x="260" y="235" width="180" height="25" rx="4" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="1"/>
            <text x="350" y="252" text-anchor="middle" font-size="8" fill="#2b6cb0">Anticipated critical events?</text>

            <rect x="260" y="265" width="180" height="30" rx="4" fill="#fed7e2" stroke="#d53f8c" stroke-width="1"/>
            <text x="350" y="285" text-anchor="middle" font-size="8" fill="#97266d">Sterility confirmed</text>

            <!-- Sign Out Section -->
            <rect x="470" y="20" width="210" height="280" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="575" y="45" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">SIGN OUT</text>
            <text x="575" y="60" text-anchor="middle" font-size="9" fill="#4a5568">Before Patient Leaves OT</text>

            <rect x="485" y="75" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="575" y="92" text-anchor="middle" font-size="8" fill="#276749"> Procedure recorded</text>

            <rect x="485" y="105" width="180" height="35" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="575" y="120" text-anchor="middle" font-size="8" fill="#c53030">Instrument count correct</text>
            <text x="575" y="133" text-anchor="middle" font-size="7" fill="#718096">Sponge & needle count</text>

            <rect x="485" y="145" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="575" y="162" text-anchor="middle" font-size="8" fill="#276749"> specimens_collected labeled</text>

            <rect x="485" y="175" width="180" height="25" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="575" y="192" text-anchor="middle" font-size="8" fill="#975a16">Equipment issues noted?</text>

            <rect x="485" y="205" width="180" height="35" rx="4" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="1"/>
            <text x="575" y="220" text-anchor="middle" font-size="8" fill="#2b6cb0">post_op_instructions</text>
            <text x="575" y="233" text-anchor="middle" font-size="7" fill="#718096">Key concerns for recovery</text>

            <rect x="485" y="245" width="180" height="25" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="575" y="262" text-anchor="middle" font-size="8" fill="#276749"> Recovery destination noted</text>

            <rect x="485" y="275" width="180" height="20" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="575" y="289" text-anchor="middle" font-size="8" fill="#553c9a">icu_required: boolean</text>

            <!-- Arrows between phases -->
            <line x1="230" y1="160" x2="245" y2="160" stroke="#4a5568" stroke-width="2" marker-end="url(#whoArrow)"/>
            <line x1="455" y1="160" x2="470" y2="160" stroke="#4a5568" stroke-width="2" marker-end="url(#whoArrow)"/>

            <!-- Pre-Op Checklist Data Model -->
            <rect x="20" y="320" width="330" height="190" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="2"/>
            <text x="185" y="345" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Pre-Op Checklist (ot_pre_op_checklists)</text>

            <text x="40" y="370" font-size="8" fill="#4a5568">Consents:</text>
            <text x="50" y="385" font-size="7" fill="#718096"> consent_surgical, consent_anesthesia</text>
            <text x="50" y="397" font-size="7" fill="#718096"> consent_blood_transfusion</text>

            <text x="40" y="415" font-size="8" fill="#4a5568">Patient Preparation:</text>
            <text x="50" y="430" font-size="7" fill="#718096"> nil_by_mouth_confirmed, npo_hours</text>
            <text x="50" y="442" font-size="7" fill="#718096"> jewelry_removed, dentures_removed</text>
            <text x="50" y="454" font-size="7" fill="#718096"> iv_line_secured, foley_catheter</text>
            <text x="50" y="466" font-size="7" fill="#718096"> skin_prep_done</text>

            <text x="40" y="485" font-size="8" fill="#4a5568">Verification:</text>
            <text x="50" y="500" font-size="7" fill="#718096"> checked_by, checked_at: Audit trail</text>

            <!-- Anesthesia Assessment Box -->
            <rect x="360" y="320" width="330" height="190" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="525" y="345" text-anchor="middle" font-weight="bold" font-size="10" fill="#975a16">Anesthesia Assessment (ot_anesthesia_records)</text>

            <text x="380" y="370" font-size="8" fill="#4a5568">Pre-Op Assessment:</text>
            <text x="390" y="385" font-size="7" fill="#718096"> asa_grade: I, II, III, IV, V, VI</text>
            <text x="390" y="397" font-size="7" fill="#718096"> airway_assessment, mallampati_score</text>

            <text x="380" y="415" font-size="8" fill="#4a5568">Anesthesia Details:</text>
            <text x="390" y="430" font-size="7" fill="#718096"> anesthesia_type: General/Regional/Local</text>
            <text x="390" y="442" font-size="7" fill="#718096"> anesthesia_technique: Specific method</text>
            <text x="390" y="454" font-size="7" fill="#718096"> agents_used: JSON array of drugs</text>

            <text x="380" y="472" font-size="8" fill="#4a5568">Monitoring & Recovery:</text>
            <text x="390" y="487" font-size="7" fill="#718096"> monitoring_data: Vitals during procedure</text>
            <text x="390" y="499" font-size="7" fill="#718096"> recovery_score: Aldrete score for PACU</text>
        </svg>
    </div>

    <!-- Diagram 3: Intra-Operative Documentation -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Intra-Operative Documentation & Procedure Record</div>
        <svg width="700" height="550" viewBox="0 0 700 550">
            <defs>
                <marker id="procArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Timeline Section -->
            <rect x="20" y="20" width="660" height="130" rx="8" fill="#f7fafc" stroke="#cbd5e0" stroke-width="2"/>
            <text x="350" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Surgical Procedure Timeline</text>

            <!-- Timeline boxes -->
            <rect x="40" y="65" width="100" height="60" rx="4" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="90" y="85" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Anesthesia Start</text>
            <text x="90" y="100" text-anchor="middle" font-size="7" fill="#4a5568">anesthesia_start_time</text>
            <text x="90" y="115" text-anchor="middle" font-size="7" fill="#718096">Patient under</text>

            <rect x="160" y="65" width="100" height="60" rx="4" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="210" y="85" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Incision</text>
            <text x="210" y="100" text-anchor="middle" font-size="7" fill="#4a5568">incision_time</text>
            <text x="210" y="115" text-anchor="middle" font-size="7" fill="#718096">Surgery begins</text>

            <rect x="280" y="65" width="100" height="60" rx="4" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="330" y="85" text-anchor="middle" font-weight="bold" font-size="8" fill="#975a16">Procedure</text>
            <text x="330" y="100" text-anchor="middle" font-size="7" fill="#4a5568">actual_start_time</text>
            <text x="330" y="115" text-anchor="middle" font-size="7" fill="#718096">actual_end_time</text>

            <rect x="400" y="65" width="100" height="60" rx="4" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="450" y="85" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Closure</text>
            <text x="450" y="100" text-anchor="middle" font-size="7" fill="#4a5568">closure_time</text>
            <text x="450" y="115" text-anchor="middle" font-size="7" fill="#718096">Wound closed</text>

            <rect x="520" y="65" width="100" height="60" rx="4" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="570" y="85" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">Anesthesia End</text>
            <text x="570" y="100" text-anchor="middle" font-size="7" fill="#4a5568">anesthesia_end_time</text>
            <text x="570" y="115" text-anchor="middle" font-size="7" fill="#718096">Patient awake</text>

            <!-- Arrows -->
            <line x1="140" y1="95" x2="160" y2="95" stroke="#4a5568" stroke-width="1.5" marker-end="url(#procArrow)"/>
            <line x1="260" y1="95" x2="280" y2="95" stroke="#4a5568" stroke-width="1.5" marker-end="url(#procArrow)"/>
            <line x1="380" y1="95" x2="400" y2="95" stroke="#4a5568" stroke-width="1.5" marker-end="url(#procArrow)"/>
            <line x1="500" y1="95" x2="520" y2="95" stroke="#4a5568" stroke-width="1.5" marker-end="url(#procArrow)"/>

            <!-- Procedure Record Section -->
            <rect x="20" y="170" width="320" height="180" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="180" y="195" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">Procedure Details (ot_procedures)</text>

            <rect x="35" y="210" width="140" height="60" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="105" y="230" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Diagnosis</text>
            <text x="105" y="245" text-anchor="middle" font-size="7" fill="#4a5568">pre_op_diagnosis</text>
            <text x="105" y="258" text-anchor="middle" font-size="7" fill="#718096">post_op_diagnosis</text>

            <rect x="185" y="210" width="140" height="60" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="255" y="230" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Procedure</text>
            <text x="255" y="245" text-anchor="middle" font-size="7" fill="#4a5568">procedure_performed</text>
            <text x="255" y="258" text-anchor="middle" font-size="7" fill="#718096">procedure_notes</text>

            <rect x="35" y="280" width="140" height="60" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="105" y="300" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Blood & Fluids</text>
            <text x="105" y="315" text-anchor="middle" font-size="7" fill="#4a5568">blood_loss_ml</text>
            <text x="105" y="328" text-anchor="middle" font-size="7" fill="#718096">blood_transfused</text>

            <rect x="185" y="280" width="140" height="60" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="255" y="300" text-anchor="middle" font-weight="bold" font-size="8" fill="#975a16">Complications</text>
            <text x="255" y="315" text-anchor="middle" font-size="7" fill="#4a5568">complications</text>
            <text x="255" y="328" text-anchor="middle" font-size="7" fill="#718096">wound_classification</text>

            <!-- Consumables & Specimens Section -->
            <rect x="360" y="170" width="320" height="180" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="520" y="195" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Consumables & Specimens</text>

            <rect x="375" y="210" width="140" height="65" rx="4" fill="#fff" stroke="#38a169" stroke-width="1"/>
            <text x="445" y="230" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Consumables</text>
            <text x="445" y="245" text-anchor="middle" font-size="7" fill="#4a5568">ot_consumables table</text>
            <text x="445" y="258" text-anchor="middle" font-size="7" fill="#718096">Linked to inventory</text>
            <text x="445" y="270" text-anchor="middle" font-size="7" fill="#718096">Auto-deducted stock</text>

            <rect x="525" y="210" width="140" height="65" rx="4" fill="#c6f6d5" stroke="#276749" stroke-width="1"/>
            <text x="595" y="230" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Specimens</text>
            <text x="595" y="245" text-anchor="middle" font-size="7" fill="#4a5568">specimens_collected</text>
            <text x="595" y="258" text-anchor="middle" font-size="7" fill="#718096">Sent to pathology</text>
            <text x="595" y="270" text-anchor="middle" font-size="7" fill="#718096">Labeled properly</text>

            <rect x="375" y="285" width="140" height="55" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="445" y="305" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Implants</text>
            <text x="445" y="320" text-anchor="middle" font-size="7" fill="#4a5568">implants_used</text>
            <text x="445" y="333" text-anchor="middle" font-size="7" fill="#718096">Serial numbers logged</text>

            <rect x="525" y="285" width="140" height="55" rx="4" fill="#fed7e2" stroke="#d53f8c" stroke-width="1"/>
            <text x="595" y="305" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">Drains</text>
            <text x="595" y="320" text-anchor="middle" font-size="7" fill="#4a5568">drain_placed: boolean</text>
            <text x="595" y="333" text-anchor="middle" font-size="7" fill="#718096">drain_details: type/site</text>

            <!-- Post-Op Section -->
            <rect x="20" y="370" width="660" height="170" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="350" y="395" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Post-Operative Disposition</text>

            <rect x="40" y="415" width="150" height="70" rx="4" fill="#fff" stroke="#805ad5" stroke-width="1"/>
            <text x="115" y="435" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Patient Condition</text>
            <text x="115" y="452" text-anchor="middle" font-size="7" fill="#4a5568">patient_condition_post_op</text>
            <text x="115" y="467" text-anchor="middle" font-size="7" fill="#718096">Stable/Guarded/Critical</text>
            <text x="115" y="480" text-anchor="middle" font-size="7" fill="#718096">Vitals recorded</text>

            <rect x="205" y="415" width="150" height="70" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="280" y="435" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Transfer to Ward</text>
            <text x="280" y="452" text-anchor="middle" font-size="7" fill="#4a5568">icu_required: false</text>
            <text x="280" y="467" text-anchor="middle" font-size="7" fill="#718096">Return to same bed</text>
            <text x="280" y="480" text-anchor="middle" font-size="7" fill="#718096">Post-op orders given</text>

            <rect x="370" y="415" width="150" height="70" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="445" y="435" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Transfer to ICU</text>
            <text x="445" y="452" text-anchor="middle" font-size="7" fill="#4a5568">icu_required: true</text>
            <text x="445" y="467" text-anchor="middle" font-size="7" fill="#718096">ICU bed allocated</text>
            <text x="445" y="480" text-anchor="middle" font-size="7" fill="#718096">Handover to ICU team</text>

            <rect x="535" y="415" width="130" height="70" rx="4" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="1"/>
            <text x="600" y="435" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">PACU Recovery</text>
            <text x="600" y="452" text-anchor="middle" font-size="7" fill="#4a5568">recovery_score</text>
            <text x="600" y="467" text-anchor="middle" font-size="7" fill="#718096">Aldrete score >= 9</text>
            <text x="600" y="480" text-anchor="middle" font-size="7" fill="#718096">before transfer</text>

            <text x="350" y="515" text-anchor="middle" font-size="8" fill="#718096">post_op_instructions: Pain management, activity restrictions, wound care, follow-up schedule</text>
        </svg>
    </div>

    <!-- Diagram 4: OT Resource Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">OT Resource Management & Scheduling</div>
        <svg width="700" height="520" viewBox="0 0 700 520">
            <defs>
                <marker id="resArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- OT Room Types -->
            <rect x="20" y="20" width="320" height="160" rx="8" fill="#ebf8ff" stroke="#2b6cb0" stroke-width="2"/>
            <text x="180" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">OT Room Types & Capabilities</text>

            <rect x="35" y="60" width="90" height="65" rx="4" fill="#fff" stroke="#3182ce" stroke-width="1"/>
            <text x="80" y="80" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Major OT</text>
            <text x="80" y="95" text-anchor="middle" font-size="7" fill="#4a5568">Complex surgeries</text>
            <text x="80" y="107" text-anchor="middle" font-size="7" fill="#718096">Cardiac, Neuro</text>
            <text x="80" y="119" text-anchor="middle" font-size="7" fill="#718096">Full equipment</text>

            <rect x="135" y="60" width="90" height="65" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="180" y="80" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Minor OT</text>
            <text x="180" y="95" text-anchor="middle" font-size="7" fill="#4a5568">Day surgeries</text>
            <text x="180" y="107" text-anchor="middle" font-size="7" fill="#718096">Local/Regional</text>
            <text x="180" y="119" text-anchor="middle" font-size="7" fill="#718096">Quick turnover</text>

            <rect x="235" y="60" width="90" height="65" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="280" y="80" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Emergency OT</text>
            <text x="280" y="95" text-anchor="middle" font-size="7" fill="#4a5568">24/7 available</text>
            <text x="280" y="107" text-anchor="middle" font-size="7" fill="#718096">Trauma cases</text>
            <text x="280" y="119" text-anchor="middle" font-size="7" fill="#718096">Priority access</text>

            <text x="180" y="150" text-anchor="middle" font-size="8" fill="#4a5568">Equipment flags: has_laminar_flow, has_c_arm, has_laparoscopy</text>
            <text x="180" y="165" text-anchor="middle" font-size="7" fill="#718096">charges_per_hour used for billing</text>

            <!-- Surgery Types -->
            <rect x="360" y="20" width="320" height="160" rx="8" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="520" y="45" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Surgery Type Configuration (surgery_types)</text>

            <text x="380" y="70" font-size="8" fill="#4a5568">Identification:</text>
            <text x="390" y="85" font-size="7" fill="#718096"> surgery_code, surgery_name</text>
            <text x="390" y="97" font-size="7" fill="#718096"> department_id, specialty, category</text>

            <text x="380" y="115" font-size="8" fill="#4a5568">Planning:</text>
            <text x="390" y="130" font-size="7" fill="#718096"> complexity: Minor/Moderate/Major/Complex</text>
            <text x="390" y="142" font-size="7" fill="#718096"> estimated_duration_mins: Scheduling guide</text>
            <text x="390" y="154" font-size="7" fill="#718096"> requires_icu, requires_blood: Resource flags</text>

            <text x="380" y="172" font-size="8" fill="#4a5568">Billing:</text>
            <text x="390" y="187" font-size="7" fill="#718096"> base_charges, surgeon_fee: Standard rates</text>

            <!-- Daily Schedule View -->
            <rect x="20" y="200" width="660" height="150" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="350" y="225" text-anchor="middle" font-weight="bold" font-size="11" fill="#975a16">Daily OT Schedule Board</text>

            <!-- Time slots -->
            <rect x="40" y="245" width="80" height="25" rx="4" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="80" y="262" text-anchor="middle" font-size="8" fill="#4a5568">8:00 AM</text>

            <rect x="130" y="245" width="80" height="25" rx="4" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="170" y="262" text-anchor="middle" font-size="8" fill="#4a5568">10:00 AM</text>

            <rect x="220" y="245" width="80" height="25" rx="4" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="260" y="262" text-anchor="middle" font-size="8" fill="#4a5568">12:00 PM</text>

            <rect x="310" y="245" width="80" height="25" rx="4" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="350" y="262" text-anchor="middle" font-size="8" fill="#4a5568">2:00 PM</text>

            <rect x="400" y="245" width="80" height="25" rx="4" fill="#f7fafc" stroke="#cbd5e0" stroke-width="1"/>
            <text x="440" y="262" text-anchor="middle" font-size="8" fill="#4a5568">4:00 PM</text>

            <!-- OT 1 Row -->
            <text x="40" y="295" font-weight="bold" font-size="8" fill="#2b6cb0">OT-1 (Major)</text>
            <rect x="90" y="280" width="150" height="30" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="165" y="300" text-anchor="middle" font-size="7" fill="#276749">Appendectomy - Dr. Smith</text>
            <rect x="250" y="280" width="200" height="30" rx="4" fill="#bee3f8" stroke="#3182ce" stroke-width="1"/>
            <text x="350" y="300" text-anchor="middle" font-size="7" fill="#2b6cb0">Cholecystectomy - Dr. Jones</text>

            <!-- OT 2 Row -->
            <text x="40" y="330" font-weight="bold" font-size="8" fill="#38a169">OT-2 (Minor)</text>
            <rect x="90" y="315" width="100" height="30" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="140" y="335" text-anchor="middle" font-size="7" fill="#975a16">Hernia Repair</text>
            <rect x="200" y="315" width="80" height="30" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="240" y="335" text-anchor="middle" font-size="7" fill="#553c9a">Cataract</text>
            <rect x="290" y="315" width="100" height="30" rx="4" fill="#fed7e2" stroke="#d53f8c" stroke-width="1"/>
            <text x="340" y="335" text-anchor="middle" font-size="7" fill="#97266d">Skin Grafting</text>

            <!-- Priority Levels -->
            <rect x="20" y="370" width="320" height="140" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="180" y="395" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">Surgery Priority Levels</text>

            <rect x="40" y="415" width="90" height="50" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="85" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Elective</text>
            <text x="85" y="450" text-anchor="middle" font-size="7" fill="#4a5568">Scheduled</text>
            <text x="85" y="462" text-anchor="middle" font-size="7" fill="#718096">days/weeks</text>

            <rect x="140" y="415" width="90" height="50" rx="4" fill="#fefcbf" stroke="#d69e2e" stroke-width="1"/>
            <text x="185" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#975a16">Urgent</text>
            <text x="185" y="450" text-anchor="middle" font-size="7" fill="#4a5568">Within 24-48h</text>
            <text x="185" y="462" text-anchor="middle" font-size="7" fill="#718096">Semi-emergency</text>

            <rect x="240" y="415" width="90" height="50" rx="4" fill="#fed7d7" stroke="#e53e3e" stroke-width="1"/>
            <text x="285" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Emergency</text>
            <text x="285" y="450" text-anchor="middle" font-size="7" fill="#4a5568">Immediate</text>
            <text x="285" y="462" text-anchor="middle" font-size="7" fill="#718096">Life-saving</text>

            <text x="180" y="490" text-anchor="middle" font-size="7" fill="#718096">priority field in ot_schedules determines slot allocation</text>

            <!-- Billing Integration -->
            <rect x="360" y="370" width="320" height="140" rx="8" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="520" y="395" text-anchor="middle" font-weight="bold" font-size="10" fill="#c53030">OT Billing Components</text>

            <rect x="380" y="415" width="140" height="80" rx="4" fill="#fff" stroke="#fc8181" stroke-width="1"/>
            <text x="450" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Fixed Charges</text>
            <text x="450" y="452" text-anchor="middle" font-size="7" fill="#4a5568"> OT room: charges_per_hour</text>
            <text x="450" y="464" text-anchor="middle" font-size="7" fill="#4a5568"> Surgeon fee</text>
            <text x="450" y="476" text-anchor="middle" font-size="7" fill="#4a5568"> Anesthesia fee</text>
            <text x="450" y="488" text-anchor="middle" font-size="7" fill="#718096">From surgery_types</text>

            <rect x="530" y="415" width="140" height="80" rx="4" fill="#feebc8" stroke="#ed8936" stroke-width="1"/>
            <text x="600" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Variable Charges</text>
            <text x="600" y="452" text-anchor="middle" font-size="7" fill="#4a5568"> Consumables used</text>
            <text x="600" y="464" text-anchor="middle" font-size="7" fill="#4a5568"> Implants</text>
            <text x="600" y="476" text-anchor="middle" font-size="7" fill="#4a5568"> Extra OT time</text>
            <text x="600" y="488" text-anchor="middle" font-size="7" fill="#718096">From ot_consumables</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>Operation Theater Workflow Key Points</h4>
        <ul>
            <li><strong>OT Types:</strong> Major (complex surgeries), Minor (day cases), Emergency (24/7 trauma) - each with specific equipment (laminar flow, C-arm, laparoscopy)</li>
            <li><strong>Scheduling:</strong> Linked to IPD admission (ipd_id), includes surgeon, assistant, anesthetist assignment, estimated duration</li>
            <li><strong>WHO Surgical Safety Checklist:</strong> Sign In (before anesthesia), Time Out (before incision), Sign Out (before leaving OT)</li>
            <li><strong>Pre-Op Checklist:</strong> Consents, NPO status, site marking, IV access, blood availability, investigations reviewed</li>
            <li><strong>Anesthesia Record:</strong> ASA grade, Mallampati score, agents used (JSON), monitoring data, recovery score (Aldrete)</li>
            <li><strong>Procedure Documentation:</strong> Incision/closure times, blood loss, specimens collected, implants used, drains placed</li>
            <li><strong>Post-Op Disposition:</strong> Ward transfer, ICU transfer (icu_required), PACU recovery with Aldrete scoring</li>
            <li><strong>Billing Integration:</strong> OT room charges per hour + surgery-specific fees + consumables from inventory</li>
        </ul>
    </div>
</div>

<!-- Section 4.7: Inventory Module -->
<div class="section">
    <h2>4.7 Inventory Module</h2>

    <div class="diagram">
        <div class="diagram-title">Procurement Workflow</div>
        <svg width="700" height="140" viewBox="0 0 700 140">
            <rect x="10" y="45" width="100" height="50" rx="8" class="arch-box"/>
            <text x="60" y="70" class="arch-text" font-size="8">Create</text>
            <text x="60" y="82" class="arch-text" font-size="8">Indent</text>

            <rect x="130" y="45" width="100" height="50" rx="8" class="arch-box"/>
            <text x="180" y="70" class="arch-text" font-size="8">Approve</text>
            <text x="180" y="82" class="arch-text" font-size="8">Indent</text>

            <rect x="250" y="45" width="100" height="50" rx="8" class="arch-box-green"/>
            <text x="300" y="70" class="arch-text" font-size="8">Create</text>
            <text x="300" y="82" class="arch-text" font-size="8">PO</text>

            <rect x="370" y="45" width="100" height="50" rx="8" class="arch-box-green"/>
            <text x="420" y="70" class="arch-text" font-size="8">Approve</text>
            <text x="420" y="82" class="arch-text" font-size="8">PO</text>

            <rect x="490" y="45" width="100" height="50" rx="8" class="arch-box-orange"/>
            <text x="540" y="70" class="arch-text" font-size="8">Receive</text>
            <text x="540" y="82" class="arch-text" font-size="8">GRN</text>

            <rect x="610" y="45" width="80" height="50" rx="8" class="arch-box-purple"/>
            <text x="650" y="70" class="arch-text" font-size="8">Stock</text>
            <text x="650" y="82" class="arch-text" font-size="8">Update</text>

            <line x1="110" y1="70" x2="130" y2="70" class="arch-arrow"/>
            <line x1="230" y1="70" x2="250" y2="70" class="arch-arrow"/>
            <line x1="350" y1="70" x2="370" y2="70" class="arch-arrow"/>
            <line x1="470" y1="70" x2="490" y2="70" class="arch-arrow"/>
            <line x1="590" y1="70" x2="610" y2="70" class="arch-arrow"/>
        </svg>
    </div>

    <p><strong>Key Features:</strong></p>
    <ul>
        <li>Multiple store/warehouse management</li>
        <li>Item categorization with hierarchy</li>
        <li>Supplier/vendor management</li>
        <li>Indent workflow with approvals</li>
        <li>Purchase order generation</li>
        <li>Goods receipt note (GRN) processing</li>
        <li>Low stock alerts</li>
        <li>Expiry tracking</li>
        <li>Stock movement history</li>
    </ul>
</div>

<!-- Section 4.8: Pharmacy Module with Workflow Diagrams -->
<div class="section" style="page-break-before: always;">
    <h2>4.8 Pharmacy Module</h2>

    <p>The Pharmacy Module provides comprehensive drug inventory management, prescription processing, and medication dispensing workflows with batch tracking, expiry management, and controlled substance handling.</p>

    <h3>4.8.1 Pharmacy Workflow Diagrams</h3>

    <!-- Diagram 1: Complete Pharmacy Journey -->
    <div class="diagram">
        <div class="diagram-title">Complete Pharmacy Journey - From Prescription to Dispensing</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="pharmaArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="pharmaArrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
            </defs>

            <!-- Phase Headers -->
            <rect x="10" y="10" width="145" height="30" rx="4" fill="#e53e3e"/>
            <text x="82" y="30" text-anchor="middle" fill="white" font-weight="bold" font-size="10">PHASE 1: PRESCRIPTION</text>

            <rect x="160" y="10" width="145" height="30" rx="4" fill="#dd6b20"/>
            <text x="232" y="30" text-anchor="middle" fill="white" font-weight="bold" font-size="10">PHASE 2: VERIFICATION</text>

            <rect x="310" y="10" width="145" height="30" rx="4" fill="#d69e2e"/>
            <text x="382" y="30" text-anchor="middle" fill="white" font-weight="bold" font-size="10">PHASE 3: PREPARATION</text>

            <rect x="460" y="10" width="145" height="30" rx="4" fill="#38a169"/>
            <text x="532" y="30" text-anchor="middle" fill="white" font-weight="bold" font-size="10">PHASE 4: DISPENSING</text>

            <rect x="610" y="10" width="130" height="30" rx="4" fill="#3182ce"/>
            <text x="675" y="30" text-anchor="middle" fill="white" font-weight="bold" font-size="10">PHASE 5: BILLING</text>

            <!-- Phase 1: Prescription Sources -->
            <rect x="15" y="50" width="135" height="180" rx="4" fill="#fff5f5" stroke="#fc8181" stroke-width="1"/>
            <text x="82" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Prescription Sources</text>

            <rect x="25" y="85" width="115" height="35" rx="3" fill="#feb2b2"/>
            <text x="82" y="100" text-anchor="middle" font-size="8" fill="#742a2a">OPD Consultation</text>
            <text x="82" y="112" text-anchor="middle" font-size="7" fill="#742a2a">visit_id  prescription</text>

            <rect x="25" y="125" width="115" height="35" rx="3" fill="#feb2b2"/>
            <text x="82" y="140" text-anchor="middle" font-size="8" fill="#742a2a">IPD Doctor Round</text>
            <text x="82" y="152" text-anchor="middle" font-size="7" fill="#742a2a">admission_id  prescription</text>

            <rect x="25" y="165" width="115" height="35" rx="3" fill="#feb2b2"/>
            <text x="82" y="180" text-anchor="middle" font-size="8" fill="#742a2a">Emergency Dept</text>
            <text x="82" y="192" text-anchor="middle" font-size="7" fill="#742a2a">Urgent medications</text>

            <rect x="25" y="205" width="115" height="20" rx="3" fill="#fc8181"/>
            <text x="82" y="218" text-anchor="middle" font-size="7" fill="white">status: 'pending'</text>

            <!-- Phase 2: Verification -->
            <rect x="165" y="50" width="135" height="180" rx="4" fill="#fffaf0" stroke="#ed8936" stroke-width="1"/>
            <text x="232" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Pharmacist Review</text>

            <rect x="175" y="85" width="115" height="30" rx="3" fill="#fbd38d"/>
            <text x="232" y="100" text-anchor="middle" font-size="8" fill="#744210">Drug Interaction Check</text>
            <text x="232" y="110" text-anchor="middle" font-size="7" fill="#744210">Contraindications</text>

            <rect x="175" y="120" width="115" height="30" rx="3" fill="#fbd38d"/>
            <text x="232" y="135" text-anchor="middle" font-size="8" fill="#744210">Dosage Verification</text>
            <text x="232" y="145" text-anchor="middle" font-size="7" fill="#744210">Age/weight appropriate</text>

            <rect x="175" y="155" width="115" height="30" rx="3" fill="#fbd38d"/>
            <text x="232" y="170" text-anchor="middle" font-size="8" fill="#744210">Allergy Check</text>
            <text x="232" y="180" text-anchor="middle" font-size="7" fill="#744210">Patient allergies list</text>

            <rect x="175" y="190" width="115" height="35" rx="3" fill="#ed8936"/>
            <text x="232" y="205" text-anchor="middle" font-size="8" fill="white">Schedule Check</text>
            <text x="232" y="217" text-anchor="middle" font-size="7" fill="white">Controlled substances</text>

            <!-- Phase 3: Preparation -->
            <rect x="315" y="50" width="135" height="180" rx="4" fill="#fffff0" stroke="#d69e2e" stroke-width="1"/>
            <text x="382" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Drug Preparation</text>

            <rect x="325" y="85" width="115" height="35" rx="3" fill="#faf089"/>
            <text x="382" y="100" text-anchor="middle" font-size="8" fill="#744210">Stock Check</text>
            <text x="382" y="112" text-anchor="middle" font-size="7" fill="#744210">current_quantity check</text>

            <rect x="325" y="125" width="115" height="35" rx="3" fill="#faf089"/>
            <text x="382" y="140" text-anchor="middle" font-size="8" fill="#744210">Batch Selection</text>
            <text x="382" y="152" text-anchor="middle" font-size="7" fill="#744210">FEFO: First Expiry First Out</text>

            <rect x="325" y="165" width="115" height="30" rx="3" fill="#faf089"/>
            <text x="382" y="180" text-anchor="middle" font-size="8" fill="#744210">Label Preparation</text>
            <text x="382" y="190" text-anchor="middle" font-size="7" fill="#744210">Dosage instructions</text>

            <rect x="325" y="200" width="115" height="25" rx="3" fill="#d69e2e"/>
            <text x="382" y="216" text-anchor="middle" font-size="8" fill="white">Quantity Reserved</text>

            <!-- Phase 4: Dispensing -->
            <rect x="465" y="50" width="135" height="180" rx="4" fill="#f0fff4" stroke="#48bb78" stroke-width="1"/>
            <text x="532" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Medication Dispensing</text>

            <rect x="475" y="85" width="115" height="30" rx="3" fill="#9ae6b4"/>
            <text x="532" y="100" text-anchor="middle" font-size="8" fill="#22543d">Patient Verification</text>
            <text x="532" y="110" text-anchor="middle" font-size="7" fill="#22543d">ID confirmation</text>

            <rect x="475" y="120" width="115" height="35" rx="3" fill="#9ae6b4"/>
            <text x="532" y="135" text-anchor="middle" font-size="8" fill="#22543d">Counseling</text>
            <text x="532" y="147" text-anchor="middle" font-size="7" fill="#22543d">Usage instructions</text>
            <text x="532" y="157" text-anchor="middle" font-size="7" fill="#22543d">Side effects warning</text>

            <rect x="475" y="160" width="115" height="30" rx="3" fill="#9ae6b4"/>
            <text x="532" y="175" text-anchor="middle" font-size="8" fill="#22543d">Handover</text>
            <text x="532" y="185" text-anchor="middle" font-size="7" fill="#22543d">Sign receipt</text>

            <rect x="475" y="195" width="115" height="30" rx="3" fill="#38a169"/>
            <text x="532" y="210" text-anchor="middle" font-size="8" fill="white">Stock Deducted</text>
            <text x="532" y="220" text-anchor="middle" font-size="7" fill="white">current_quantity--</text>

            <!-- Phase 5: Billing -->
            <rect x="615" y="50" width="120" height="180" rx="4" fill="#ebf8ff" stroke="#4299e1" stroke-width="1"/>
            <text x="675" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Billing & Payment</text>

            <rect x="625" y="85" width="100" height="30" rx="3" fill="#bee3f8"/>
            <text x="675" y="100" text-anchor="middle" font-size="8" fill="#2c5282">Sale Created</text>
            <text x="675" y="110" text-anchor="middle" font-size="7" fill="#2c5282">PharmacySale</text>

            <rect x="625" y="120" width="100" height="35" rx="3" fill="#bee3f8"/>
            <text x="675" y="135" text-anchor="middle" font-size="8" fill="#2c5282">Price Calculation</text>
            <text x="675" y="147" text-anchor="middle" font-size="7" fill="#2c5282">unit_price  qty</text>
            <text x="675" y="157" text-anchor="middle" font-size="7" fill="#2c5282">- discount + tax</text>

            <rect x="625" y="160" width="100" height="30" rx="3" fill="#bee3f8"/>
            <text x="675" y="175" text-anchor="middle" font-size="8" fill="#2c5282">Payment</text>
            <text x="675" y="185" text-anchor="middle" font-size="7" fill="#2c5282">Cash/Card/Insurance</text>

            <rect x="625" y="195" width="100" height="30" rx="3" fill="#3182ce"/>
            <text x="675" y="210" text-anchor="middle" font-size="8" fill="white">Receipt Generated</text>
            <text x="675" y="220" text-anchor="middle" font-size="7" fill="white">payment_status: 'paid'</text>

            <!-- Flow Arrows -->
            <path d="M150,140 L165,140" stroke="#4a5568" stroke-width="2" marker-end="url(#pharmaArrow)"/>
            <path d="M300,140 L315,140" stroke="#4a5568" stroke-width="2" marker-end="url(#pharmaArrow)"/>
            <path d="M450,140 L465,140" stroke="#4a5568" stroke-width="2" marker-end="url(#pharmaArrow)"/>
            <path d="M600,140 L615,140" stroke="#4a5568" stroke-width="2" marker-end="url(#pharmaArrow)"/>

            <!-- Data Models Section -->
            <rect x="15" y="250" width="720" height="260" rx="6" fill="#f7fafc" stroke="#a0aec0" stroke-width="1"/>
            <text x="375" y="275" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Pharmacy Data Models &amp; Relationships</text>

            <!-- Prescription Model -->
            <rect x="30" y="295" width="160" height="100" rx="4" fill="#fed7e2" stroke="#d53f8c" stroke-width="1"/>
            <text x="110" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Prescription</text>
            <text x="40" y="332" font-size="7" fill="#702459">prescription_id (PK)</text>
            <text x="40" y="344" font-size="7" fill="#702459">patient_id  Patient</text>
            <text x="40" y="356" font-size="7" fill="#702459">doctor_id  Doctor</text>
            <text x="40" y="368" font-size="7" fill="#702459">visit_id | admission_id</text>
            <text x="40" y="380" font-size="7" fill="#702459">diagnosis, status, notes</text>

            <!-- PrescriptionItem Model -->
            <rect x="210" y="295" width="160" height="100" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="290" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">PrescriptionItem</text>
            <text x="220" y="332" font-size="7" fill="#44337a">item_id (PK)</text>
            <text x="220" y="344" font-size="7" fill="#44337a">prescription_id  Prescription</text>
            <text x="220" y="356" font-size="7" fill="#44337a">drug_id  Drug</text>
            <text x="220" y="368" font-size="7" fill="#44337a">dosage, frequency, duration</text>
            <text x="220" y="380" font-size="7" fill="#44337a">quantity, instructions</text>

            <!-- Drug Model -->
            <rect x="390" y="295" width="160" height="100" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="470" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Drug</text>
            <text x="400" y="332" font-size="7" fill="#22543d">drug_id (PK)</text>
            <text x="400" y="344" font-size="7" fill="#22543d">drug_name, drug_code</text>
            <text x="400" y="356" font-size="7" fill="#22543d">generic_name, manufacturer</text>
            <text x="400" y="368" font-size="7" fill="#22543d">category_id  DrugCategory</text>
            <text x="400" y="380" font-size="7" fill="#22543d">schedule_id  DrugSchedule</text>

            <!-- DrugBatch Model -->
            <rect x="570" y="295" width="150" height="100" rx="4" fill="#feebc8" stroke="#dd6b20" stroke-width="1"/>
            <text x="645" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">DrugBatch</text>
            <text x="580" y="332" font-size="7" fill="#7b341e">batch_id (PK)</text>
            <text x="580" y="344" font-size="7" fill="#7b341e">drug_id  Drug</text>
            <text x="580" y="356" font-size="7" fill="#7b341e">batch_number, quantity</text>
            <text x="580" y="368" font-size="7" fill="#7b341e">current_quantity</text>
            <text x="580" y="380" font-size="7" fill="#7b341e">expiry_date, supplier</text>

            <!-- PharmacySale Model -->
            <rect x="120" y="410" width="160" height="90" rx="4" fill="#bee3f8" stroke="#3182ce" stroke-width="1"/>
            <text x="200" y="430" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">PharmacySale</text>
            <text x="130" y="447" font-size="7" fill="#2c5282">sale_id (PK)</text>
            <text x="130" y="459" font-size="7" fill="#2c5282">prescription_id  Prescription</text>
            <text x="130" y="471" font-size="7" fill="#2c5282">patient_id  Patient</text>
            <text x="130" y="483" font-size="7" fill="#2c5282">subtotal, discount, tax, total</text>

            <!-- PharmacySaleDetail Model -->
            <rect x="300" y="410" width="170" height="90" rx="4" fill="#c4f1f9" stroke="#00b5d8" stroke-width="1"/>
            <text x="385" y="430" text-anchor="middle" font-weight="bold" font-size="9" fill="#086f83">PharmacySaleDetail</text>
            <text x="310" y="447" font-size="7" fill="#065666">detail_id (PK)</text>
            <text x="310" y="459" font-size="7" fill="#065666">sale_id  PharmacySale</text>
            <text x="310" y="471" font-size="7" fill="#065666">drug_id, batch_id</text>
            <text x="310" y="483" font-size="7" fill="#065666">quantity, unit_price, total_price</text>

            <!-- DrugCategory & DrugSchedule -->
            <rect x="490" y="410" width="110" height="90" rx="4" fill="#faf5ff" stroke="#9f7aea" stroke-width="1"/>
            <text x="545" y="430" text-anchor="middle" font-weight="bold" font-size="8" fill="#6b46c1">DrugCategory</text>
            <text x="500" y="447" font-size="7" fill="#553c9a">category_id (PK)</text>
            <text x="500" y="459" font-size="7" fill="#553c9a">category_name</text>
            <text x="545" y="478" text-anchor="middle" font-weight="bold" font-size="8" fill="#6b46c1">DrugSchedule</text>
            <text x="500" y="491" font-size="7" fill="#553c9a">schedule_id, name</text>

            <!-- Relationship arrows -->
            <path d="M190,345 L210,345" stroke="#805ad5" stroke-width="1.5" marker-end="url(#pharmaArrow)"/>
            <path d="M370,345 L390,345" stroke="#38a169" stroke-width="1.5" marker-end="url(#pharmaArrow)"/>
            <path d="M550,345 L570,345" stroke="#dd6b20" stroke-width="1.5" marker-end="url(#pharmaArrow)"/>
            <path d="M110,395 L110,410 L120,430" stroke="#3182ce" stroke-width="1.5" stroke-dasharray="3,2"/>
            <path d="M280,455 L300,455" stroke="#00b5d8" stroke-width="1.5" marker-end="url(#pharmaArrow)"/>
        </svg>
    </div>

    <!-- Diagram 2: Drug Inventory Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Drug Inventory Management - Procurement, Batch Tracking &amp; Expiry Control</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <defs>
                <marker id="invArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Procurement Section -->
            <rect x="10" y="10" width="355" height="220" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Drug Procurement Workflow</text>

            <rect x="25" y="55" width="90" height="50" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="70" y="75" text-anchor="middle" font-size="8" fill="#2c5282">Reorder Alert</text>
            <text x="70" y="88" text-anchor="middle" font-size="7" fill="#2c5282">stock  reorder_level</text>

            <rect x="135" y="55" width="90" height="50" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="180" y="75" text-anchor="middle" font-size="8" fill="#2c5282">Create PO</text>
            <text x="180" y="88" text-anchor="middle" font-size="7" fill="#2c5282">Purchase Order</text>

            <rect x="245" y="55" width="100" height="50" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="295" y="75" text-anchor="middle" font-size="8" fill="#276749">Receive Stock</text>
            <text x="295" y="88" text-anchor="middle" font-size="7" fill="#276749">GRN Processing</text>

            <path d="M115,80 L135,80" stroke="#4a5568" stroke-width="1.5" marker-end="url(#invArrow)"/>
            <path d="M225,80 L245,80" stroke="#4a5568" stroke-width="1.5" marker-end="url(#invArrow)"/>

            <!-- Batch Creation -->
            <rect x="25" y="120" width="320" height="100" rx="4" fill="#f0fff4" stroke="#48bb78" stroke-width="1"/>
            <text x="185" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">New Batch Created (DrugBatch)</text>

            <text x="40" y="160" font-size="8" fill="#22543d">batch_number: Unique identifier</text>
            <text x="40" y="175" font-size="8" fill="#22543d">quantity: Initial stock received</text>
            <text x="40" y="190" font-size="8" fill="#22543d">current_quantity: Available stock</text>
            <text x="40" y="205" font-size="8" fill="#22543d">purchase_price / selling_price</text>

            <text x="200" y="160" font-size="8" fill="#22543d">manufacture_date</text>
            <text x="200" y="175" font-size="8" fill="#22543d">expiry_date</text>
            <text x="200" y="190" font-size="8" fill="#22543d">supplier</text>
            <text x="200" y="205" font-size="8" fill="#22543d">received_date</text>

            <!-- Batch Management Section -->
            <rect x="385" y="10" width="355" height="220" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#975a16">Batch Tracking &amp; FEFO</text>

            <!-- FEFO Explanation -->
            <rect x="400" y="55" width="160" height="80" rx="4" fill="#faf089" stroke="#ecc94b"/>
            <text x="480" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">FEFO Algorithm</text>
            <text x="410" y="92" font-size="7" fill="#744210">First Expiry First Out</text>
            <text x="410" y="105" font-size="7" fill="#744210">1. Sort batches by expiry_date</text>
            <text x="410" y="118" font-size="7" fill="#744210">2. Dispense from earliest</text>
            <text x="410" y="131" font-size="7" fill="#744210">3. Skip expired batches</text>

            <!-- Batch Queue -->
            <rect x="580" y="55" width="145" height="80" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="652" y="72" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Active Batches Queue</text>
            <rect x="590" y="82" width="125" height="15" rx="2" fill="#fc8181"/>
            <text x="652" y="93" text-anchor="middle" font-size="7" fill="white">Batch A - Exp: Jan 2026</text>
            <rect x="590" y="99" width="125" height="15" rx="2" fill="#fbd38d"/>
            <text x="652" y="110" text-anchor="middle" font-size="7" fill="#744210">Batch B - Exp: Mar 2026</text>
            <rect x="590" y="116" width="125" height="15" rx="2" fill="#9ae6b4"/>
            <text x="652" y="127" text-anchor="middle" font-size="7" fill="#22543d">Batch C - Exp: Dec 2026</text>

            <!-- Expiry Alerts -->
            <rect x="400" y="145" width="325" height="75" rx="4" fill="#fff5f5" stroke="#fc8181"/>
            <text x="562" y="165" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Expiry Management Alerts</text>

            <rect x="415" y="178" width="95" height="35" rx="3" fill="#feb2b2"/>
            <text x="462" y="193" text-anchor="middle" font-size="7" fill="#742a2a">EXPIRED</text>
            <text x="462" y="205" text-anchor="middle" font-size="6" fill="#742a2a">expiry_date &lt; today</text>

            <rect x="520" y="178" width="95" height="35" rx="3" fill="#fbd38d"/>
            <text x="567" y="193" text-anchor="middle" font-size="7" fill="#744210">EXPIRING SOON</text>
            <text x="567" y="205" text-anchor="middle" font-size="6" fill="#744210">within 30 days</text>

            <rect x="625" y="178" width="90" height="35" rx="3" fill="#9ae6b4"/>
            <text x="670" y="193" text-anchor="middle" font-size="7" fill="#22543d">VALID</text>
            <text x="670" y="205" text-anchor="middle" font-size="6" fill="#22543d">&gt; 30 days left</text>

            <!-- Drug Master Section -->
            <rect x="10" y="245" width="730" height="225" rx="6" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="375" y="270" text-anchor="middle" font-weight="bold" font-size="12" fill="#6b46c1">Drug Master Data Management</text>

            <!-- Drug Categories -->
            <rect x="25" y="290" width="170" height="170" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="110" y="310" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Drug Categories</text>
            <text x="35" y="330" font-size="8" fill="#44337a"> Antibiotics</text>
            <text x="35" y="345" font-size="8" fill="#44337a"> Analgesics</text>
            <text x="35" y="360" font-size="8" fill="#44337a"> Antihypertensives</text>
            <text x="35" y="375" font-size="8" fill="#44337a"> Antidiabetics</text>
            <text x="35" y="390" font-size="8" fill="#44337a"> Vitamins/Supplements</text>
            <text x="35" y="405" font-size="8" fill="#44337a"> Emergency Drugs</text>
            <text x="35" y="420" font-size="8" fill="#44337a"> Controlled Substances</text>
            <text x="35" y="440" font-size="7" fill="#553c9a">DrugCategory: category_id, name</text>

            <!-- Drug Schedules -->
            <rect x="210" y="290" width="170" height="170" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="295" y="310" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Drug Schedules (Legal)</text>
            <text x="220" y="330" font-size="8" fill="#702459"> Schedule H: Rx Only</text>
            <text x="220" y="345" font-size="8" fill="#702459"> Schedule H1: Special Rx</text>
            <text x="220" y="360" font-size="8" fill="#702459"> Schedule X: Narcotics</text>
            <text x="220" y="375" font-size="8" fill="#702459"> Schedule G: Hormones</text>
            <text x="220" y="390" font-size="8" fill="#702459"> OTC: Over-the-Counter</text>
            <text x="220" y="420" font-size="7" fill="#97266d">Requires special handling</text>
            <text x="220" y="435" font-size="7" fill="#97266d">and documentation</text>
            <text x="220" y="450" font-size="7" fill="#702459">DrugSchedule: schedule_id, name</text>

            <!-- Drug Details -->
            <rect x="395" y="290" width="165" height="170" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="477" y="310" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Drug Master (Drug)</text>
            <text x="405" y="330" font-size="7" fill="#22543d">drug_id (PK)</text>
            <text x="405" y="345" font-size="7" fill="#22543d">drug_code: Unique code</text>
            <text x="405" y="360" font-size="7" fill="#22543d">drug_name: Brand name</text>
            <text x="405" y="375" font-size="7" fill="#22543d">generic_name: Salt name</text>
            <text x="405" y="390" font-size="7" fill="#22543d">manufacturer</text>
            <text x="405" y="405" font-size="7" fill="#22543d">unit: Tablets/ML/Strips</text>
            <text x="405" y="420" font-size="7" fill="#22543d">purchase_price</text>
            <text x="405" y="435" font-size="7" fill="#22543d">selling_price</text>
            <text x="405" y="450" font-size="7" fill="#22543d">reorder_level, is_active</text>

            <!-- Stock Levels -->
            <rect x="575" y="290" width="150" height="170" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="650" y="310" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Stock Monitoring</text>

            <rect x="585" y="325" width="130" height="40" rx="3" fill="#fc8181"/>
            <text x="650" y="345" text-anchor="middle" font-size="8" fill="white">CRITICAL</text>
            <text x="650" y="358" text-anchor="middle" font-size="7" fill="white">stock = 0</text>

            <rect x="585" y="370" width="130" height="40" rx="3" fill="#fbd38d"/>
            <text x="650" y="390" text-anchor="middle" font-size="8" fill="#744210">REORDER</text>
            <text x="650" y="403" text-anchor="middle" font-size="7" fill="#744210">stock  reorder_level</text>

            <rect x="585" y="415" width="130" height="40" rx="3" fill="#9ae6b4"/>
            <text x="650" y="435" text-anchor="middle" font-size="8" fill="#22543d">ADEQUATE</text>
            <text x="650" y="448" text-anchor="middle" font-size="7" fill="#22543d">stock &gt; reorder_level</text>
        </svg>
    </div>

    <!-- Diagram 3: Prescription Processing Workflow -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Prescription Processing - OPD &amp; IPD Medication Workflows</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="rxArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="rxArrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#e53e3e"/>
                </marker>
            </defs>

            <!-- OPD Prescription Flow -->
            <rect x="10" y="10" width="355" height="235" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">OPD Prescription Flow</text>

            <!-- OPD Steps -->
            <rect x="25" y="55" width="100" height="55" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="75" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#2c5282">1. Doctor Creates</text>
            <text x="75" y="88" text-anchor="middle" font-size="7" fill="#2c5282">Prescription</text>
            <text x="75" y="100" text-anchor="middle" font-size="6" fill="#4299e1">visit_id linked</text>

            <rect x="140" y="55" width="100" height="55" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="190" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">2. Patient Goes</text>
            <text x="190" y="88" text-anchor="middle" font-size="7" fill="#276749">to Pharmacy</text>
            <text x="190" y="100" text-anchor="middle" font-size="6" fill="#48bb78">With prescription</text>

            <rect x="255" y="55" width="100" height="55" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="305" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">3. Pharmacist</text>
            <text x="305" y="88" text-anchor="middle" font-size="7" fill="#c05621">Dispenses</text>
            <text x="305" y="100" text-anchor="middle" font-size="6" fill="#ed8936">Creates sale</text>

            <path d="M125,82 L140,82" stroke="#4a5568" stroke-width="1.5" marker-end="url(#rxArrow)"/>
            <path d="M240,82 L255,82" stroke="#4a5568" stroke-width="1.5" marker-end="url(#rxArrow)"/>

            <!-- OPD Prescription Items -->
            <rect x="25" y="120" width="330" height="115" rx="4" fill="#f0fff4" stroke="#48bb78" stroke-width="1"/>
            <text x="190" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">PrescriptionItem Details</text>

            <text x="40" y="160" font-size="8" fill="#22543d"> drug_id: Selected medication</text>
            <text x="40" y="175" font-size="8" fill="#22543d"> dosage: "500mg", "10ml"</text>
            <text x="40" y="190" font-size="8" fill="#22543d"> frequency: "TDS", "BD", "OD"</text>
            <text x="40" y="205" font-size="8" fill="#22543d"> duration: "5 days", "1 week"</text>
            <text x="40" y="220" font-size="8" fill="#22543d"> quantity: Total units</text>

            <text x="200" y="160" font-size="8" fill="#22543d"> instructions: "After food"</text>
            <text x="200" y="175" font-size="8" fill="#22543d"> "Before bedtime"</text>
            <text x="200" y="190" font-size="8" fill="#22543d"> "Empty stomach"</text>
            <text x="200" y="205" font-size="8" fill="#22543d"> "With plenty of water"</text>

            <!-- IPD Prescription Flow -->
            <rect x="385" y="10" width="355" height="235" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">IPD Prescription Flow</text>

            <!-- IPD Steps -->
            <rect x="400" y="55" width="100" height="55" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="450" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#742a2a">1. Doctor Round</text>
            <text x="450" y="88" text-anchor="middle" font-size="7" fill="#742a2a">Orders Meds</text>
            <text x="450" y="100" text-anchor="middle" font-size="6" fill="#fc8181">admission_id linked</text>

            <rect x="515" y="55" width="100" height="55" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="565" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">2. Ward Indent</text>
            <text x="565" y="88" text-anchor="middle" font-size="7" fill="#744210">to Pharmacy</text>
            <text x="565" y="100" text-anchor="middle" font-size="6" fill="#ed8936">Batch request</text>

            <rect x="630" y="55" width="100" height="55" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="680" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">3. Nurse</text>
            <text x="680" y="88" text-anchor="middle" font-size="7" fill="#276749">Administers</text>
            <text x="680" y="100" text-anchor="middle" font-size="6" fill="#48bb78">MAR recorded</text>

            <path d="M500,82 L515,82" stroke="#4a5568" stroke-width="1.5" marker-end="url(#rxArrow)"/>
            <path d="M615,82 L630,82" stroke="#4a5568" stroke-width="1.5" marker-end="url(#rxArrow)"/>

            <!-- IPD Medication Administration -->
            <rect x="400" y="120" width="330" height="115" rx="4" fill="#fffaf0" stroke="#ed8936" stroke-width="1"/>
            <text x="565" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">IPD Medication Administration</text>

            <text x="415" y="160" font-size="8" fill="#7b341e"> Ward stock replenishment</text>
            <text x="415" y="175" font-size="8" fill="#7b341e"> Floor stock management</text>
            <text x="415" y="190" font-size="8" fill="#7b341e"> PRN (as needed) orders</text>
            <text x="415" y="205" font-size="8" fill="#7b341e"> STAT (urgent) medications</text>
            <text x="415" y="220" font-size="8" fill="#7b341e"> Controlled substance log</text>

            <text x="580" y="160" font-size="8" fill="#7b341e">Timing:</text>
            <text x="580" y="175" font-size="8" fill="#7b341e"> AM (Morning)</text>
            <text x="580" y="190" font-size="8" fill="#7b341e"> NN (Noon)</text>
            <text x="580" y="205" font-size="8" fill="#7b341e"> PM (Evening)</text>
            <text x="580" y="220" font-size="8" fill="#7b341e"> HS (Bedtime)</text>

            <!-- Prescription Status Flow -->
            <rect x="10" y="260" width="730" height="110" rx="6" fill="#f7fafc" stroke="#a0aec0" stroke-width="2"/>
            <text x="375" y="285" text-anchor="middle" font-weight="bold" font-size="12" fill="#2d3748">Prescription Status Transitions</text>

            <rect x="50" y="305" width="100" height="50" rx="4" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="100" y="330" text-anchor="middle" font-weight="bold" font-size="9" fill="#4a5568">PENDING</text>
            <text x="100" y="345" text-anchor="middle" font-size="7" fill="#718096">New prescription</text>

            <rect x="200" y="305" width="110" height="50" rx="4" fill="#faf089" stroke="#ecc94b"/>
            <text x="255" y="330" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">PROCESSING</text>
            <text x="255" y="345" text-anchor="middle" font-size="7" fill="#744210">At pharmacy</text>

            <rect x="360" y="305" width="100" height="50" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="410" y="330" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">DISPENSED</text>
            <text x="410" y="345" text-anchor="middle" font-size="7" fill="#276749">Fully issued</text>

            <rect x="510" y="305" width="110" height="50" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="565" y="330" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">PARTIAL</text>
            <text x="565" y="345" text-anchor="middle" font-size="7" fill="#2b6cb0">Some items OOS</text>

            <rect x="670" y="305" width="55" height="50" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="697" y="330" text-anchor="middle" font-weight="bold" font-size="8" fill="#742a2a">CANCEL</text>
            <text x="697" y="345" text-anchor="middle" font-size="6" fill="#742a2a">Voided</text>

            <path d="M150,330 L200,330" stroke="#4a5568" stroke-width="2" marker-end="url(#rxArrow)"/>
            <path d="M310,330 L360,330" stroke="#4a5568" stroke-width="2" marker-end="url(#rxArrow)"/>
            <path d="M310,340 L360,340 L360,330 L510,330" stroke="#4299e1" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#rxArrow)"/>
            <path d="M100,355 L100,370 L697,370 L697,355" stroke="#e53e3e" stroke-width="1" stroke-dasharray="3,2" marker-end="url(#rxArrowRed)"/>

            <!-- Pharmacist Verification Section -->
            <rect x="10" y="385" width="730" height="105" rx="6" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="375" y="410" text-anchor="middle" font-weight="bold" font-size="12" fill="#6b46c1">Pharmacist Verification Checklist</text>

            <rect x="30" y="425" width="165" height="55" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="112" y="445" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Drug Interactions</text>
            <text x="112" y="460" text-anchor="middle" font-size="7" fill="#44337a">Check all Rx items</text>
            <text x="112" y="472" text-anchor="middle" font-size="7" fill="#44337a">against each other</text>

            <rect x="210" y="425" width="165" height="55" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="292" y="445" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">Patient Allergies</text>
            <text x="292" y="460" text-anchor="middle" font-size="7" fill="#702459">Cross-ref patient record</text>
            <text x="292" y="472" text-anchor="middle" font-size="7" fill="#702459">Alert on match</text>

            <rect x="390" y="425" width="165" height="55" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="472" y="445" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Dosage Limits</text>
            <text x="472" y="460" text-anchor="middle" font-size="7" fill="#7b341e">Max daily dose check</text>
            <text x="472" y="472" text-anchor="middle" font-size="7" fill="#7b341e">Age/weight factors</text>

            <rect x="570" y="425" width="155" height="55" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="647" y="445" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Therapeutic Dup</text>
            <text x="647" y="460" text-anchor="middle" font-size="7" fill="#22543d">Same class drugs</text>
            <text x="647" y="472" text-anchor="middle" font-size="7" fill="#22543d">Duplicate therapy</text>
        </svg>
    </div>

    <!-- Diagram 4: Pharmacy Billing & Sales -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Pharmacy Billing &amp; Sales - Payment Processing &amp; Returns</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <defs>
                <marker id="billArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Sale Creation Section -->
            <rect x="10" y="10" width="355" height="230" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">PharmacySale Creation</text>

            <!-- Sale Types -->
            <rect x="25" y="55" width="155" height="90" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="102" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">Prescription Sale</text>
            <text x="35" y="95" font-size="7" fill="#2c5282"> prescription_id linked</text>
            <text x="35" y="108" font-size="7" fill="#2c5282"> patient_id from Rx</text>
            <text x="35" y="121" font-size="7" fill="#2c5282"> Items pre-populated</text>
            <text x="35" y="134" font-size="7" fill="#2c5282"> Doctor verification</text>

            <rect x="195" y="55" width="155" height="90" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="272" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">OTC Sale</text>
            <text x="205" y="95" font-size="7" fill="#276749"> No prescription needed</text>
            <text x="205" y="108" font-size="7" fill="#276749"> Direct customer walk-in</text>
            <text x="205" y="121" font-size="7" fill="#276749"> Schedule-free drugs</text>
            <text x="205" y="134" font-size="7" fill="#276749"> Optional patient link</text>

            <!-- Sale Details -->
            <rect x="25" y="155" width="325" height="75" rx="4" fill="#f0fff4" stroke="#48bb78" stroke-width="1"/>
            <text x="187" y="175" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">PharmacySaleDetail Line Items</text>
            <text x="40" y="195" font-size="7" fill="#22543d">drug_id + batch_id (FEFO selected)</text>
            <text x="40" y="210" font-size="7" fill="#22543d">quantity  unit_price = total_price</text>
            <text x="200" y="195" font-size="7" fill="#22543d">Batch: current_quantity--</text>
            <text x="200" y="210" font-size="7" fill="#22543d">Real-time stock deduction</text>

            <!-- Payment Section -->
            <rect x="385" y="10" width="355" height="230" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Payment Processing</text>

            <!-- Payment Methods -->
            <rect x="400" y="55" width="160" height="110" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="480" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">payment_method</text>

            <rect x="410" y="90" width="65" height="25" rx="3" fill="#9ae6b4"/>
            <text x="442" y="107" text-anchor="middle" font-size="8" fill="#22543d">Cash</text>

            <rect x="485" y="90" width="65" height="25" rx="3" fill="#9ae6b4"/>
            <text x="517" y="107" text-anchor="middle" font-size="8" fill="#22543d">Card</text>

            <rect x="410" y="120" width="65" height="25" rx="3" fill="#68d391"/>
            <text x="442" y="137" text-anchor="middle" font-size="8" fill="white">UPI</text>

            <rect x="485" y="120" width="65" height="25" rx="3" fill="#68d391"/>
            <text x="517" y="137" text-anchor="middle" font-size="8" fill="white">Insurance</text>

            <rect x="410" y="150" width="140" height="12" rx="2" fill="#276749"/>
            <text x="480" y="160" text-anchor="middle" font-size="7" fill="white">Credit (IPD Settlement)</text>

            <!-- Price Calculation -->
            <rect x="575" y="55" width="150" height="110" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="650" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Price Calculation</text>
            <text x="585" y="95" font-size="7" fill="#7b341e">subtotal: (unit  qty)</text>
            <text x="585" y="112" font-size="7" fill="#7b341e">discount: Amount/Percent</text>
            <text x="585" y="129" font-size="7" fill="#7b341e">tax: GST calculation</text>
            <text x="585" y="150" font-weight="bold" font-size="8" fill="#c05621">total = subtotal</text>
            <text x="600" y="162" font-weight="bold" font-size="8" fill="#c05621">- discount + tax</text>

            <!-- Payment Status -->
            <rect x="400" y="175" width="325" height="55" rx="4" fill="#fffff0" stroke="#d69e2e"/>
            <text x="562" y="195" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">payment_status Transitions</text>

            <rect x="420" y="205" width="70" height="20" rx="3" fill="#fbd38d"/>
            <text x="455" y="219" text-anchor="middle" font-size="7" fill="#744210">pending</text>

            <rect x="510" y="205" width="70" height="20" rx="3" fill="#9ae6b4"/>
            <text x="545" y="219" text-anchor="middle" font-size="7" fill="#22543d">paid</text>

            <rect x="600" y="205" width="70" height="20" rx="3" fill="#bee3f8"/>
            <text x="635" y="219" text-anchor="middle" font-size="7" fill="#2c5282">credit</text>

            <rect x="690" y="205" width="25" height="20" rx="3" fill="#feb2b2"/>
            <text x="702" y="218" text-anchor="middle" font-size="6" fill="#742a2a">void</text>

            <path d="M490,215 L510,215" stroke="#4a5568" stroke-width="1.5" marker-end="url(#billArrow)"/>
            <path d="M580,215 L600,215" stroke="#4a5568" stroke-width="1.5" marker-end="url(#billArrow)"/>

            <!-- Returns & Adjustments -->
            <rect x="10" y="255" width="355" height="215" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="187" y="280" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">Returns &amp; Adjustments</text>

            <!-- Return Conditions -->
            <rect x="25" y="300" width="155" height="100" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="102" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">Return Conditions</text>
            <text x="35" y="340" font-size="7" fill="#742a2a"> Within 24-48 hours</text>
            <text x="35" y="355" font-size="7" fill="#742a2a"> Sealed packaging</text>
            <text x="35" y="370" font-size="7" fill="#742a2a"> Not refrigerated items</text>
            <text x="35" y="385" font-size="7" fill="#742a2a"> Not controlled drugs</text>

            <!-- Return Process -->
            <rect x="195" y="300" width="155" height="100" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="272" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Return Process</text>
            <text x="205" y="340" font-size="7" fill="#7b341e">1. Verify original sale</text>
            <text x="205" y="355" font-size="7" fill="#7b341e">2. Check return eligibility</text>
            <text x="205" y="370" font-size="7" fill="#7b341e">3. Create return entry</text>
            <text x="205" y="385" font-size="7" fill="#7b341e">4. Restock to batch</text>

            <!-- Stock Reversal -->
            <rect x="25" y="410" width="325" height="50" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="187" y="430" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Stock Reversal</text>
            <text x="40" y="450" font-size="7" fill="#22543d">current_quantity += returned_qty | Refund processed | Sale voided/adjusted</text>

            <!-- Reports & Analytics -->
            <rect x="385" y="255" width="355" height="215" rx="6" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="562" y="280" text-anchor="middle" font-weight="bold" font-size="12" fill="#6b46c1">Reports &amp; Analytics</text>

            <!-- Daily Reports -->
            <rect x="400" y="300" width="160" height="80" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="480" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Daily Reports</text>
            <text x="410" y="340" font-size="7" fill="#44337a"> Sales summary</text>
            <text x="410" y="355" font-size="7" fill="#44337a"> Collection report</text>
            <text x="410" y="370" font-size="7" fill="#44337a"> Prescription count</text>

            <!-- Stock Reports -->
            <rect x="575" y="300" width="150" height="80" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="650" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Stock Reports</text>
            <text x="585" y="340" font-size="7" fill="#702459"> Expiry alerts</text>
            <text x="585" y="355" font-size="7" fill="#702459"> Reorder list</text>
            <text x="585" y="370" font-size="7" fill="#702459"> Movement register</text>

            <!-- Audit Reports -->
            <rect x="400" y="390" width="325" height="70" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="562" y="410" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Audit &amp; Compliance</text>
            <text x="415" y="430" font-size="7" fill="#22543d"> Controlled substance register</text>
            <text x="415" y="445" font-size="7" fill="#22543d"> Batch-wise stock audit</text>
            <text x="565" y="430" font-size="7" fill="#22543d"> Pharmacist activity log</text>
            <text x="565" y="445" font-size="7" fill="#22543d"> Tax compliance reports</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>Pharmacy Workflow Key Points</h4>
        <ul>
            <li><strong>Prescription Sources:</strong> OPD (visit_id), IPD (admission_id), Emergency - all create Prescription records with PrescriptionItems</li>
            <li><strong>Drug Master:</strong> Maintains drug_code, generic_name, manufacturer with category (Antibiotics, etc.) and schedule (H, H1, X, G, OTC)</li>
            <li><strong>Batch Management:</strong> DrugBatch tracks batch_number, quantity, current_quantity, expiry_date - uses FEFO (First Expiry First Out)</li>
            <li><strong>Stock Monitoring:</strong> Automatic reorder alerts when stock  reorder_level, expiry alerts for items expiring within 30 days</li>
            <li><strong>Pharmacist Verification:</strong> Drug interactions, patient allergies, dosage limits, therapeutic duplications checked before dispensing</li>
            <li><strong>Sales Processing:</strong> PharmacySale links prescription_id, calculates subtotal - discount + tax = total, supports multiple payment methods</li>
            <li><strong>Stock Deduction:</strong> Real-time current_quantity decrement on dispense, increment on returns (if eligible)</li>
            <li><strong>IPD Integration:</strong> Ward stock indents, floor stock management, Medication Administration Record (MAR)</li>
        </ul>
    </div>
</div>

<!-- Section 4.9: Billing Module with Workflow Diagrams -->
<div class="section" style="page-break-before: always;">
    <h2>4.9 Billing Module</h2>

    <p>The Billing Module manages comprehensive hospital revenue cycle including OPD/IPD billing, service charges, payment processing, insurance claims, and financial reporting with multi-mode payment support.</p>

    <h3>4.9.1 Billing Workflow Diagrams</h3>

    <!-- Diagram 1: Complete Billing Journey -->
    <div class="diagram">
        <div class="diagram-title">Complete Billing Journey - OPD &amp; IPD Revenue Cycle</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="billFlowArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="billFlowArrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
            </defs>

            <!-- OPD Billing Flow -->
            <rect x="10" y="10" width="355" height="245" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">OPD Billing Flow</text>

            <!-- OPD Steps -->
            <rect x="25" y="55" width="100" height="60" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="75" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#2c5282">1. Registration</text>
            <text x="75" y="88" text-anchor="middle" font-size="7" fill="#2c5282">OPD Visit Created</text>
            <text x="75" y="100" text-anchor="middle" font-size="6" fill="#4299e1">visit_id generated</text>

            <rect x="140" y="55" width="100" height="60" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="190" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">2. Consultation</text>
            <text x="190" y="88" text-anchor="middle" font-size="7" fill="#276749">Services Added</text>
            <text x="190" y="100" text-anchor="middle" font-size="6" fill="#48bb78">OpdVisitService</text>

            <rect x="255" y="55" width="100" height="60" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="305" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">3. Bill Generated</text>
            <text x="305" y="88" text-anchor="middle" font-size="7" fill="#c05621">Bill + BillDetails</text>
            <text x="305" y="100" text-anchor="middle" font-size="6" fill="#ed8936">bill_number</text>

            <path d="M125,85 L140,85" stroke="#4a5568" stroke-width="1.5" marker-end="url(#billFlowArrow)"/>
            <path d="M240,85 L255,85" stroke="#4a5568" stroke-width="1.5" marker-end="url(#billFlowArrow)"/>

            <!-- OPD Bill Components -->
            <rect x="25" y="125" width="330" height="120" rx="4" fill="#f0fff4" stroke="#48bb78" stroke-width="1"/>
            <text x="190" y="145" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">OPD Bill Components</text>

            <text x="40" y="165" font-size="7" fill="#22543d"> Registration fee (service_type: registration)</text>
            <text x="40" y="180" font-size="7" fill="#22543d"> Consultation fee (doctor-specific rate)</text>
            <text x="40" y="195" font-size="7" fill="#22543d"> Procedure charges (if any)</text>
            <text x="40" y="210" font-size="7" fill="#22543d"> Lab tests (from LabOrder)</text>
            <text x="40" y="225" font-size="7" fill="#22543d"> Radiology (from RadiologyOrder)</text>

            <text x="200" y="165" font-size="7" fill="#22543d"> Pharmacy (from PharmacySale)</text>
            <text x="200" y="180" font-size="7" fill="#22543d"> Emergency rates (day/night)</text>
            <text x="200" y="195" font-size="7" fill="#22543d"> Discount applied</text>
            <text x="200" y="210" font-size="7" fill="#22543d"> Tax calculation (GST)</text>
            <text x="200" y="225" font-size="7" fill="#22543d"> Total = subtotal - discount + tax</text>

            <!-- IPD Billing Flow -->
            <rect x="385" y="10" width="355" height="245" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">IPD Billing Flow</text>

            <!-- IPD Steps -->
            <rect x="400" y="55" width="100" height="60" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="450" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#742a2a">1. Admission</text>
            <text x="450" y="88" text-anchor="middle" font-size="7" fill="#742a2a">Advance Payment</text>
            <text x="450" y="100" text-anchor="middle" font-size="6" fill="#fc8181">IpdAdvancePayment</text>

            <rect x="515" y="55" width="100" height="60" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="565" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">2. Stay Period</text>
            <text x="565" y="88" text-anchor="middle" font-size="7" fill="#744210">Daily Charges</text>
            <text x="565" y="100" text-anchor="middle" font-size="6" fill="#ed8936">IpdService accrues</text>

            <rect x="630" y="55" width="100" height="60" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="680" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">3. Discharge</text>
            <text x="680" y="88" text-anchor="middle" font-size="7" fill="#276749">Final Bill</text>
            <text x="680" y="100" text-anchor="middle" font-size="6" fill="#48bb78">Settlement</text>

            <path d="M500,85 L515,85" stroke="#4a5568" stroke-width="1.5" marker-end="url(#billFlowArrow)"/>
            <path d="M615,85 L630,85" stroke="#4a5568" stroke-width="1.5" marker-end="url(#billFlowArrow)"/>

            <!-- IPD Bill Components -->
            <rect x="400" y="125" width="330" height="120" rx="4" fill="#fffaf0" stroke="#ed8936" stroke-width="1"/>
            <text x="565" y="145" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">IPD Bill Components (IpdService)</text>

            <text x="415" y="165" font-size="7" fill="#7b341e"> Bed charges (per day  stay)</text>
            <text x="415" y="180" font-size="7" fill="#7b341e"> Nursing charges</text>
            <text x="415" y="195" font-size="7" fill="#7b341e"> Doctor visit fees</text>
            <text x="415" y="210" font-size="7" fill="#7b341e"> Surgery/OT charges</text>
            <text x="415" y="225" font-size="7" fill="#7b341e"> ICU charges (if applicable)</text>

            <text x="575" y="165" font-size="7" fill="#7b341e"> Medications (Pharmacy)</text>
            <text x="575" y="180" font-size="7" fill="#7b341e"> Lab &amp; Radiology</text>
            <text x="575" y="195" font-size="7" fill="#7b341e"> Consumables/Implants</text>
            <text x="575" y="210" font-size="7" fill="#7b341e"> Misc services</text>
            <text x="575" y="225" font-size="7" fill="#7b341e"> Less: Advance payments</text>

            <!-- Bill Data Model -->
            <rect x="10" y="270" width="730" height="240" rx="6" fill="#f7fafc" stroke="#a0aec0" stroke-width="1"/>
            <text x="375" y="295" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Billing Data Models &amp; Relationships</text>

            <!-- Bill Model -->
            <rect x="25" y="315" width="165" height="115" rx="4" fill="#bee3f8" stroke="#3182ce" stroke-width="1"/>
            <text x="107" y="335" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Bill</text>
            <text x="35" y="352" font-size="7" fill="#2c5282">bill_id (PK)</text>
            <text x="35" y="364" font-size="7" fill="#2c5282">bill_number: Unique</text>
            <text x="35" y="376" font-size="7" fill="#2c5282">patient_id  Patient</text>
            <text x="35" y="388" font-size="7" fill="#2c5282">visit_id | admission_id</text>
            <text x="35" y="400" font-size="7" fill="#2c5282">subtotal, discount, tax, total</text>
            <text x="35" y="412" font-size="7" fill="#2c5282">paid_amount, due_amount</text>
            <text x="35" y="424" font-size="7" fill="#2c5282">payment_status</text>

            <!-- BillDetail Model -->
            <rect x="210" y="315" width="165" height="115" rx="4" fill="#c6f6d5" stroke="#38a169" stroke-width="1"/>
            <text x="292" y="335" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">BillDetail</text>
            <text x="220" y="352" font-size="7" fill="#22543d">detail_id (PK)</text>
            <text x="220" y="364" font-size="7" fill="#22543d">bill_id  Bill</text>
            <text x="220" y="376" font-size="7" fill="#22543d">service_id  Service</text>
            <text x="220" y="388" font-size="7" fill="#22543d">description</text>
            <text x="220" y="400" font-size="7" fill="#22543d">quantity</text>
            <text x="220" y="412" font-size="7" fill="#22543d">unit_price</text>
            <text x="220" y="424" font-size="7" fill="#22543d">total_price</text>

            <!-- Payment Model -->
            <rect x="395" y="315" width="165" height="115" rx="4" fill="#feebc8" stroke="#dd6b20" stroke-width="1"/>
            <text x="477" y="335" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Payment</text>
            <text x="405" y="352" font-size="7" fill="#7b341e">payment_id (PK)</text>
            <text x="405" y="364" font-size="7" fill="#7b341e">bill_id  Bill</text>
            <text x="405" y="376" font-size="7" fill="#7b341e">payment_date</text>
            <text x="405" y="388" font-size="7" fill="#7b341e">amount</text>
            <text x="405" y="400" font-size="7" fill="#7b341e">payment_method</text>
            <text x="405" y="412" font-size="7" fill="#7b341e">transaction_id</text>
            <text x="405" y="424" font-size="7" fill="#7b341e">received_by  User</text>

            <!-- Service Model -->
            <rect x="580" y="315" width="145" height="115" rx="4" fill="#e9d8fd" stroke="#805ad5" stroke-width="1"/>
            <text x="652" y="335" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Service</text>
            <text x="590" y="352" font-size="7" fill="#44337a">service_id (PK)</text>
            <text x="590" y="364" font-size="7" fill="#44337a">service_code</text>
            <text x="590" y="376" font-size="7" fill="#44337a">service_name</text>
            <text x="590" y="388" font-size="7" fill="#44337a">service_type</text>
            <text x="590" y="400" font-size="7" fill="#44337a">rate</text>
            <text x="590" y="412" font-size="7" fill="#44337a">night_emergency_rate</text>
            <text x="590" y="424" font-size="7" fill="#44337a">day_emergency_rate</text>

            <!-- Payment Status Legend -->
            <rect x="25" y="445" width="700" height="55" rx="4" fill="#fffff0" stroke="#d69e2e"/>
            <text x="375" y="465" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">payment_status Lifecycle</text>

            <rect x="55" y="478" width="80" height="18" rx="3" fill="#fbd38d"/>
            <text x="95" y="491" text-anchor="middle" font-size="7" fill="#744210">pending</text>

            <rect x="155" y="478" width="80" height="18" rx="3" fill="#bee3f8"/>
            <text x="195" y="491" text-anchor="middle" font-size="7" fill="#2c5282">partial</text>

            <rect x="255" y="478" width="80" height="18" rx="3" fill="#9ae6b4"/>
            <text x="295" y="491" text-anchor="middle" font-size="7" fill="#22543d">paid</text>

            <rect x="355" y="478" width="80" height="18" rx="3" fill="#feb2b2"/>
            <text x="395" y="491" text-anchor="middle" font-size="7" fill="#742a2a">overdue</text>

            <rect x="455" y="478" width="80" height="18" rx="3" fill="#e9d8fd"/>
            <text x="495" y="491" text-anchor="middle" font-size="7" fill="#553c9a">insurance</text>

            <rect x="555" y="478" width="80" height="18" rx="3" fill="#c4f1f9"/>
            <text x="595" y="491" text-anchor="middle" font-size="7" fill="#086f83">refunded</text>

            <rect x="655" y="478" width="60" height="18" rx="3" fill="#e2e8f0"/>
            <text x="685" y="491" text-anchor="middle" font-size="7" fill="#4a5568">cancelled</text>

            <!-- Relationship arrows -->
            <path d="M190,370 L210,370" stroke="#38a169" stroke-width="1.5" marker-end="url(#billFlowArrow)"/>
            <path d="M375,370 L395,370" stroke="#dd6b20" stroke-width="1.5" marker-end="url(#billFlowArrow)"/>
            <path d="M292,430 L292,445 L580,445 L580,430" stroke="#805ad5" stroke-width="1" stroke-dasharray="3,2"/>
        </svg>
    </div>

    <!-- Diagram 2: Service & Charges Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Service &amp; Charges Management - Pricing, Rates &amp; Categories</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <defs>
                <marker id="svcArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Service Master Section -->
            <rect x="10" y="10" width="355" height="230" rx="6" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#6b46c1">Service Master Configuration</text>

            <!-- Service Types -->
            <rect x="25" y="55" width="155" height="170" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="102" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Service Types</text>
            <text x="35" y="95" font-size="7" fill="#44337a"> Consultation</text>
            <text x="35" y="110" font-size="7" fill="#44337a"> Registration</text>
            <text x="35" y="125" font-size="7" fill="#44337a"> Procedure</text>
            <text x="35" y="140" font-size="7" fill="#44337a"> Investigation</text>
            <text x="35" y="155" font-size="7" fill="#44337a"> Surgery</text>
            <text x="35" y="170" font-size="7" fill="#44337a"> Bed Charges</text>
            <text x="35" y="185" font-size="7" fill="#44337a"> Nursing</text>
            <text x="35" y="200" font-size="7" fill="#44337a"> ICU/CCU</text>
            <text x="35" y="215" font-size="7" fill="#44337a"> Miscellaneous</text>

            <!-- Service Attributes -->
            <rect x="195" y="55" width="155" height="170" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="272" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Service Attributes</text>
            <text x="205" y="95" font-size="7" fill="#702459">service_code: Unique ID</text>
            <text x="205" y="110" font-size="7" fill="#702459">department_id: Link</text>
            <text x="205" y="125" font-size="7" fill="#702459">rate: Base price</text>
            <text x="205" y="140" font-size="7" fill="#702459">night_emergency_rate</text>
            <text x="205" y="155" font-size="7" fill="#702459">day_emergency_rate</text>
            <text x="205" y="170" font-size="7" fill="#702459">is_premium_service</text>
            <text x="205" y="185" font-size="7" fill="#702459">service_tax_applicable</text>
            <text x="205" y="200" font-size="7" fill="#702459">is_followup_service</text>
            <text x="205" y="215" font-size="7" fill="#702459">is_free_followup</text>

            <!-- Rate Configuration Section -->
            <rect x="385" y="10" width="355" height="230" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Rate Configuration &amp; Variations</text>

            <!-- Standard Rates -->
            <rect x="400" y="55" width="160" height="80" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="480" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Standard Rates</text>
            <text x="410" y="95" font-size="7" fill="#22543d"> Regular rate: Base price</text>
            <text x="410" y="110" font-size="7" fill="#22543d"> Premium rate: VIP wards</text>
            <text x="410" y="125" font-size="7" fill="#22543d"> Package rate: Bundles</text>

            <!-- Emergency Rates -->
            <rect x="575" y="55" width="150" height="80" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="650" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Emergency Rates</text>
            <text x="585" y="95" font-size="7" fill="#7b341e"> Day emergency (8AM-8PM)</text>
            <text x="585" y="110" font-size="7" fill="#7b341e"> Night emergency (8PM-8AM)</text>
            <text x="585" y="125" font-size="7" fill="#7b341e"> Multiplier applied</text>

            <!-- Ward-Wise Rates -->
            <rect x="400" y="145" width="325" height="85" rx="4" fill="#ebf8ff" stroke="#4299e1"/>
            <text x="562" y="165" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Ward-Wise Cost Additions (WardWiseCostAddition)</text>
            <text x="415" y="185" font-size="7" fill="#2c5282">General Ward: Base rate</text>
            <text x="415" y="200" font-size="7" fill="#2c5282">Semi-Private: +25%</text>
            <text x="415" y="215" font-size="7" fill="#2c5282">Private Room: +50%</text>
            <text x="560" y="185" font-size="7" fill="#2c5282">Deluxe: +75%</text>
            <text x="560" y="200" font-size="7" fill="#2c5282">Suite: +100%</text>
            <text x="560" y="215" font-size="7" fill="#2c5282">ICU/CCU: Special rates</text>

            <!-- IPD Service Tracking -->
            <rect x="10" y="255" width="355" height="215" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="187" y="280" text-anchor="middle" font-weight="bold" font-size="12" fill="#c05621">IPD Service Tracking (IpdService)</text>

            <!-- Daily Charges -->
            <rect x="25" y="300" width="155" height="160" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="102" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">Daily Accrual</text>
            <text x="35" y="340" font-size="7" fill="#744210">service_date: Each day</text>
            <text x="35" y="355" font-size="7" fill="#744210">service_type: Category</text>
            <text x="35" y="370" font-size="7" fill="#744210">quantity  rate = amount</text>
            <text x="35" y="385" font-size="7" fill="#744210">discount applied</text>
            <text x="35" y="400" font-size="7" fill="#744210">net_amount calculated</text>
            <text x="35" y="420" font-size="7" fill="#c05621">is_billed: false initially</text>
            <text x="35" y="435" font-size="7" fill="#c05621">bill_id: null until final</text>
            <text x="35" y="450" font-size="7" fill="#c05621"> marked billed on discharge</text>

            <!-- Service Categories -->
            <rect x="195" y="300" width="155" height="160" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="272" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">service_type Values</text>
            <text x="205" y="340" font-size="7" fill="#7b341e"> bed_charges</text>
            <text x="205" y="355" font-size="7" fill="#7b341e"> nursing_charges</text>
            <text x="205" y="370" font-size="7" fill="#7b341e"> doctor_visit</text>
            <text x="205" y="385" font-size="7" fill="#7b341e"> procedure</text>
            <text x="205" y="400" font-size="7" fill="#7b341e"> surgery</text>
            <text x="205" y="415" font-size="7" fill="#7b341e"> lab_test</text>
            <text x="205" y="430" font-size="7" fill="#7b341e"> radiology</text>
            <text x="205" y="445" font-size="7" fill="#7b341e"> pharmacy</text>
            <text x="205" y="460" font-size="7" fill="#7b341e"> consumables</text>

            <!-- Discount & Tax Section -->
            <rect x="385" y="255" width="355" height="215" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="280" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Discount &amp; Tax Calculation</text>

            <!-- Discount Types -->
            <rect x="400" y="300" width="160" height="80" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="480" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Discount Types</text>
            <text x="410" y="340" font-size="7" fill="#2c5282"> Percentage discount</text>
            <text x="410" y="355" font-size="7" fill="#2c5282"> Flat amount discount</text>
            <text x="410" y="370" font-size="7" fill="#2c5282"> Corporate discounts</text>

            <!-- Tax Calculation -->
            <rect x="575" y="300" width="150" height="80" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="650" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Tax (GST)</text>
            <text x="585" y="340" font-size="7" fill="#22543d"> service_tax_applicable</text>
            <text x="585" y="355" font-size="7" fill="#22543d"> Tax plan configuration</text>
            <text x="585" y="370" font-size="7" fill="#22543d"> CGST + SGST / IGST</text>

            <!-- Bill Calculation Formula -->
            <rect x="400" y="390" width="325" height="70" rx="4" fill="#fffff0" stroke="#d69e2e"/>
            <text x="562" y="410" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Bill Calculation Formula</text>
            <text x="420" y="430" font-size="8" fill="#744210">subtotal = (BillDetail.total_price)</text>
            <text x="420" y="445" font-size="8" fill="#744210">total = subtotal - discount + tax</text>
            <text x="420" y="460" font-size="8" fill="#744210">due_amount = total - paid_amount</text>
        </svg>
    </div>

    <!-- Diagram 3: Payment Processing -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Payment Processing - Multiple Modes, Partial Payments &amp; Advances</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="payArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Payment Modes Section -->
            <rect x="10" y="10" width="355" height="235" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Payment Modes (PaymentMode)</text>

            <!-- Cash & Card -->
            <rect x="25" y="55" width="100" height="55" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="75" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Cash</text>
            <text x="75" y="90" text-anchor="middle" font-size="7" fill="#22543d">Immediate</text>
            <text x="75" y="102" text-anchor="middle" font-size="6" fill="#276749">No charges</text>

            <rect x="135" y="55" width="100" height="55" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="185" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Card</text>
            <text x="185" y="90" text-anchor="middle" font-size="7" fill="#2c5282">Credit/Debit</text>
            <text x="185" y="102" text-anchor="middle" font-size="6" fill="#4299e1">transaction_id req</text>

            <rect x="245" y="55" width="100" height="55" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="295" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">UPI/Online</text>
            <text x="295" y="90" text-anchor="middle" font-size="7" fill="#44337a">Digital Payment</text>
            <text x="295" y="102" text-anchor="middle" font-size="6" fill="#805ad5">reference_number</text>

            <!-- Cheque & Bank Transfer -->
            <rect x="25" y="120" width="100" height="55" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="75" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">Cheque</text>
            <text x="75" y="155" text-anchor="middle" font-size="7" fill="#744210">Clearance req</text>
            <text x="75" y="167" text-anchor="middle" font-size="6" fill="#ed8936">cheque_number</text>

            <rect x="135" y="120" width="100" height="55" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="185" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Bank Transfer</text>
            <text x="185" y="155" text-anchor="middle" font-size="7" fill="#7b341e">NEFT/RTGS</text>
            <text x="185" y="167" text-anchor="middle" font-size="6" fill="#dd6b20">UTR number</text>

            <rect x="245" y="120" width="100" height="55" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="295" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Insurance</text>
            <text x="295" y="155" text-anchor="middle" font-size="7" fill="#702459">TPA/Cashless</text>
            <text x="295" y="167" text-anchor="middle" font-size="6" fill="#d53f8c">claim_id linked</text>

            <!-- PaymentMode Config -->
            <rect x="25" y="185" width="320" height="50" rx="4" fill="#f7fafc" stroke="#a0aec0"/>
            <text x="185" y="205" text-anchor="middle" font-weight="bold" font-size="8" fill="#4a5568">PaymentMode Configuration</text>
            <text x="40" y="222" font-size="6" fill="#718096">post_charges_applicable | post_charge_percent | use_for_refund | has_financial_details</text>

            <!-- Payment Flow Section -->
            <rect x="385" y="10" width="355" height="235" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Payment Flow &amp; Recording</text>

            <!-- Payment Steps -->
            <rect x="400" y="55" width="100" height="50" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="450" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">1. Bill Selected</text>
            <text x="450" y="90" text-anchor="middle" font-size="7" fill="#2c5282">due_amount shown</text>

            <rect x="515" y="55" width="100" height="50" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="565" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">2. Amount Enter</text>
            <text x="565" y="90" text-anchor="middle" font-size="7" fill="#276749">Full or partial</text>

            <rect x="630" y="55" width="100" height="50" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="680" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">3. Mode Select</text>
            <text x="680" y="90" text-anchor="middle" font-size="7" fill="#7b341e">Payment method</text>

            <path d="M500,80 L515,80" stroke="#4a5568" stroke-width="1.5" marker-end="url(#payArrow)"/>
            <path d="M615,80 L630,80" stroke="#4a5568" stroke-width="1.5" marker-end="url(#payArrow)"/>

            <!-- Payment Record -->
            <rect x="400" y="115" width="330" height="65" rx="4" fill="#f0fff4" stroke="#48bb78"/>
            <text x="565" y="135" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Payment Record Created</text>
            <text x="415" y="155" font-size="7" fill="#22543d">payment_id generated | bill_id linked</text>
            <text x="415" y="170" font-size="7" fill="#22543d">amount recorded | transaction_id stored | received_by tracked</text>

            <!-- Bill Update -->
            <rect x="400" y="190" width="330" height="45" rx="4" fill="#fffff0" stroke="#d69e2e"/>
            <text x="565" y="210" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Bill Updated</text>
            <text x="420" y="225" font-size="7" fill="#744210">paid_amount += payment.amount | due_amount recalculated | status updated</text>

            <!-- Advance Payment Section -->
            <rect x="10" y="260" width="355" height="230" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="187" y="285" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">IPD Advance Payment (IpdAdvancePayment)</text>

            <!-- Advance Flow -->
            <rect x="25" y="305" width="155" height="90" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="102" y="325" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">At Admission</text>
            <text x="35" y="345" font-size="7" fill="#742a2a"> Deposit collected</text>
            <text x="35" y="360" font-size="7" fill="#742a2a"> receipt_number generated</text>
            <text x="35" y="375" font-size="7" fill="#742a2a"> ipd_id linked</text>
            <text x="35" y="390" font-size="7" fill="#742a2a"> payment_mode recorded</text>

            <!-- Additional Advances -->
            <rect x="195" y="305" width="155" height="90" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="272" y="325" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">During Stay</text>
            <text x="205" y="345" font-size="7" fill="#744210"> Additional deposits</text>
            <text x="205" y="360" font-size="7" fill="#744210"> Multiple receipts</text>
            <text x="205" y="375" font-size="7" fill="#744210"> Running balance tracked</text>
            <text x="205" y="390" font-size="7" fill="#744210"> effective_amount accessor</text>

            <!-- Settlement -->
            <rect x="25" y="405" width="325" height="75" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="187" y="425" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">At Discharge - Final Settlement</text>
            <text x="40" y="445" font-size="7" fill="#22543d">Final Bill Total - Sum(Advances.effective_amount) = Balance Due</text>
            <text x="40" y="460" font-size="7" fill="#22543d">If negative: Refund processed (is_refunded=true, refund_amount set)</text>
            <text x="40" y="475" font-size="7" fill="#22543d">If positive: Additional payment collected</text>

            <!-- Partial Payment Section -->
            <rect x="385" y="260" width="355" height="230" rx="6" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="562" y="285" text-anchor="middle" font-weight="bold" font-size="12" fill="#6b46c1">Partial Payments &amp; Split Modes</text>

            <!-- Partial Payment Flow -->
            <rect x="400" y="305" width="325" height="80" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="562" y="325" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Multiple Payment Records per Bill</text>
            <text x="415" y="345" font-size="7" fill="#44337a">Bill.payments()  hasMany(Payment)</text>
            <text x="415" y="360" font-size="7" fill="#44337a">Each payment: different amount, different mode, different date</text>
            <text x="415" y="375" font-size="7" fill="#44337a">Sum of all payments = paid_amount on Bill</text>

            <!-- Split Payment Example -->
            <rect x="400" y="395" width="325" height="85" rx="4" fill="#f7fafc" stroke="#a0aec0"/>
            <text x="562" y="415" text-anchor="middle" font-weight="bold" font-size="9" fill="#4a5568">Split Payment Example</text>
            <rect x="415" y="430" width="70" height="18" rx="2" fill="#9ae6b4"/>
            <text x="450" y="443" text-anchor="middle" font-size="7" fill="#22543d">Cash: 5000</text>
            <rect x="495" y="430" width="70" height="18" rx="2" fill="#bee3f8"/>
            <text x="530" y="443" text-anchor="middle" font-size="7" fill="#2c5282">Card: 3000</text>
            <rect x="575" y="430" width="70" height="18" rx="2" fill="#e9d8fd"/>
            <text x="610" y="443" text-anchor="middle" font-size="7" fill="#553c9a">UPI: 2000</text>
            <rect x="655" y="430" width="55" height="18" rx="2" fill="#9ae6b4"/>
            <text x="682" y="443" text-anchor="middle" font-size="6" fill="#22543d">Total: 10K</text>
            <text x="420" y="468" font-size="7" fill="#718096">3 Payment records created, Bill.paid_amount = 10,000</text>
        </svg>
    </div>

    <!-- Diagram 4: Insurance Claims -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Insurance Claims - Cashless &amp; Reimbursement Workflows</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <defs>
                <marker id="insArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="insArrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
            </defs>

            <!-- Cashless Flow -->
            <rect x="10" y="10" width="730" height="200" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="375" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Cashless Insurance Flow</text>

            <!-- Step 1 -->
            <rect x="25" y="55" width="100" height="70" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="75" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">1. Pre-Auth</text>
            <text x="75" y="90" text-anchor="middle" font-size="7" fill="#2c5282">Patient presents</text>
            <text x="75" y="102" text-anchor="middle" font-size="7" fill="#2c5282">insurance card</text>
            <text x="75" y="114" text-anchor="middle" font-size="6" fill="#4299e1">InsuranceCompany</text>

            <!-- Step 2 -->
            <rect x="145" y="55" width="100" height="70" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="195" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">2. TPA Approval</text>
            <text x="195" y="90" text-anchor="middle" font-size="7" fill="#276749">Pre-authorization</text>
            <text x="195" y="102" text-anchor="middle" font-size="7" fill="#276749">request sent</text>
            <text x="195" y="114" text-anchor="middle" font-size="6" fill="#48bb78">status: pending</text>

            <!-- Step 3 -->
            <rect x="265" y="55" width="100" height="70" rx="4" fill="#faf089" stroke="#ecc94b"/>
            <text x="315" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">3. Treatment</text>
            <text x="315" y="90" text-anchor="middle" font-size="7" fill="#744210">Services rendered</text>
            <text x="315" y="102" text-anchor="middle" font-size="7" fill="#744210">Bill generated</text>
            <text x="315" y="114" text-anchor="middle" font-size="6" fill="#d69e2e">BillDetails added</text>

            <!-- Step 4 -->
            <rect x="385" y="55" width="100" height="70" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="435" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">4. Claim Submit</text>
            <text x="435" y="90" text-anchor="middle" font-size="7" fill="#7b341e">InsuranceClaim</text>
            <text x="435" y="102" text-anchor="middle" font-size="7" fill="#7b341e">created</text>
            <text x="435" y="114" text-anchor="middle" font-size="6" fill="#ed8936">claim_amount set</text>

            <!-- Step 5 -->
            <rect x="505" y="55" width="100" height="70" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="555" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">5. TPA Review</text>
            <text x="555" y="90" text-anchor="middle" font-size="7" fill="#44337a">Documents verified</text>
            <text x="555" y="102" text-anchor="middle" font-size="7" fill="#44337a">Approval/Rejection</text>
            <text x="555" y="114" text-anchor="middle" font-size="6" fill="#805ad5">approved_amount</text>

            <!-- Step 6 -->
            <rect x="625" y="55" width="100" height="70" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="675" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">6. Settlement</text>
            <text x="675" y="90" text-anchor="middle" font-size="7" fill="#22543d">TPA pays hospital</text>
            <text x="675" y="102" text-anchor="middle" font-size="7" fill="#22543d">Patient pays diff</text>
            <text x="675" y="114" text-anchor="middle" font-size="6" fill="#276749">status: approved</text>

            <path d="M125,90 L145,90" stroke="#4a5568" stroke-width="1.5" marker-end="url(#insArrow)"/>
            <path d="M245,90 L265,90" stroke="#4a5568" stroke-width="1.5" marker-end="url(#insArrow)"/>
            <path d="M365,90 L385,90" stroke="#4a5568" stroke-width="1.5" marker-end="url(#insArrow)"/>
            <path d="M485,90 L505,90" stroke="#4a5568" stroke-width="1.5" marker-end="url(#insArrow)"/>
            <path d="M605,90 L625,90" stroke="#4a5568" stroke-width="1.5" marker-end="url(#insArrow)"/>

            <!-- Insurance Models -->
            <rect x="25" y="140" width="330" height="60" rx="4" fill="#f0fff4" stroke="#48bb78"/>
            <text x="190" y="160" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">InsuranceCompany</text>
            <text x="40" y="178" font-size="7" fill="#22543d">company_id | company_name | contact_person | phone | email | is_active</text>
            <text x="40" y="192" font-size="7" fill="#22543d">Relations: patients(), claims() | CashlessPriceList for contracted rates</text>

            <!-- Claim Model -->
            <rect x="375" y="140" width="350" height="60" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="550" y="160" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">InsuranceClaim</text>
            <text x="390" y="178" font-size="7" fill="#7b341e">claim_id | bill_id  Bill | company_id  InsuranceCompany | claim_number</text>
            <text x="390" y="192" font-size="7" fill="#7b341e">claim_date | claim_amount | approved_amount | status | notes | created_by</text>

            <!-- Claim Status Section -->
            <rect x="10" y="225" width="355" height="115" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="187" y="250" text-anchor="middle" font-weight="bold" font-size="12" fill="#975a16">Claim Status Transitions</text>

            <rect x="30" y="270" width="75" height="25" rx="3" fill="#e2e8f0"/>
            <text x="67" y="287" text-anchor="middle" font-size="7" fill="#4a5568">draft</text>

            <rect x="115" y="270" width="75" height="25" rx="3" fill="#fbd38d"/>
            <text x="152" y="287" text-anchor="middle" font-size="7" fill="#744210">submitted</text>

            <rect x="200" y="270" width="75" height="25" rx="3" fill="#bee3f8"/>
            <text x="237" y="287" text-anchor="middle" font-size="7" fill="#2c5282">under_review</text>

            <rect x="285" y="270" width="65" height="25" rx="3" fill="#9ae6b4"/>
            <text x="317" y="287" text-anchor="middle" font-size="7" fill="#22543d">approved</text>

            <rect x="115" y="305" width="75" height="25" rx="3" fill="#feb2b2"/>
            <text x="152" y="322" text-anchor="middle" font-size="7" fill="#742a2a">rejected</text>

            <rect x="200" y="305" width="75" height="25" rx="3" fill="#e9d8fd"/>
            <text x="237" y="322" text-anchor="middle" font-size="7" fill="#553c9a">partial</text>

            <rect x="285" y="305" width="65" height="25" rx="3" fill="#c6f6d5"/>
            <text x="317" y="322" text-anchor="middle" font-size="7" fill="#276749">settled</text>

            <path d="M105,282 L115,282" stroke="#4a5568" stroke-width="1" marker-end="url(#insArrow)"/>
            <path d="M190,282 L200,282" stroke="#4a5568" stroke-width="1" marker-end="url(#insArrow)"/>
            <path d="M275,282 L285,282" stroke="#4a5568" stroke-width="1" marker-end="url(#insArrow)"/>

            <!-- Reimbursement Flow -->
            <rect x="385" y="225" width="355" height="115" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="562" y="250" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">Reimbursement Flow</text>

            <rect x="400" y="270" width="80" height="60" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="440" y="290" text-anchor="middle" font-weight="bold" font-size="7" fill="#742a2a">1. Patient Pays</text>
            <text x="440" y="305" text-anchor="middle" font-size="6" fill="#742a2a">Full amount</text>
            <text x="440" y="318" text-anchor="middle" font-size="6" fill="#742a2a">at discharge</text>

            <rect x="495" y="270" width="80" height="60" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="535" y="290" text-anchor="middle" font-weight="bold" font-size="7" fill="#744210">2. Documents</text>
            <text x="535" y="305" text-anchor="middle" font-size="6" fill="#744210">Bills, reports</text>
            <text x="535" y="318" text-anchor="middle" font-size="6" fill="#744210">discharge summary</text>

            <rect x="590" y="270" width="80" height="60" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="630" y="290" text-anchor="middle" font-weight="bold" font-size="7" fill="#2b6cb0">3. Submit</text>
            <text x="630" y="305" text-anchor="middle" font-size="6" fill="#2c5282">To insurance</text>
            <text x="630" y="318" text-anchor="middle" font-size="6" fill="#2c5282">company</text>

            <rect x="685" y="270" width="50" height="60" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="710" y="290" text-anchor="middle" font-weight="bold" font-size="7" fill="#22543d">4. Get</text>
            <text x="710" y="305" text-anchor="middle" font-size="6" fill="#22543d">Refund</text>

            <path d="M480,300 L495,300" stroke="#4a5568" stroke-width="1" marker-end="url(#insArrow)"/>
            <path d="M575,300 L590,300" stroke="#4a5568" stroke-width="1" marker-end="url(#insArrow)"/>
            <path d="M670,300 L685,300" stroke="#4a5568" stroke-width="1" marker-end="url(#insArrow)"/>

            <!-- Settlement Calculation -->
            <rect x="10" y="355" width="730" height="115" rx="6" fill="#f7fafc" stroke="#a0aec0" stroke-width="2"/>
            <text x="375" y="380" text-anchor="middle" font-weight="bold" font-size="12" fill="#2d3748">Cashless Settlement Calculation</text>

            <!-- Amount Breakdown -->
            <rect x="25" y="400" width="220" height="60" rx="4" fill="#ebf8ff" stroke="#4299e1"/>
            <text x="135" y="420" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Bill Amounts</text>
            <text x="35" y="438" font-size="7" fill="#2c5282">Bill.total = 1,00,000</text>
            <text x="35" y="452" font-size="7" fill="#2c5282">InsuranceClaim.claim_amount = 1,00,000</text>

            <!-- TPA Decision -->
            <rect x="265" y="400" width="220" height="60" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="375" y="420" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">TPA Approval</text>
            <text x="275" y="438" font-size="7" fill="#7b341e">approved_amount = 85,000</text>
            <text x="275" y="452" font-size="7" fill="#7b341e">Deductions: Non-payable items</text>

            <!-- Patient Liability -->
            <rect x="505" y="400" width="220" height="60" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="615" y="420" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Final Settlement</text>
            <text x="515" y="438" font-size="7" fill="#22543d">TPA Pays: 85,000  Hospital</text>
            <text x="515" y="452" font-size="7" fill="#22543d">Patient Pays: 15,000 (co-pay)</text>

            <path d="M245,430 L265,430" stroke="#4a5568" stroke-width="1.5" marker-end="url(#insArrow)"/>
            <path d="M485,430 L505,430" stroke="#4a5568" stroke-width="1.5" marker-end="url(#insArrow)"/>
        </svg>
    </div>

    <div class="info-box">
        <h4>Billing Workflow Key Points</h4>
        <ul>
            <li><strong>Bill Structure:</strong> Bill (header) with multiple BillDetails (line items), each linked to Service with quantity  unit_price = total_price</li>
            <li><strong>OPD vs IPD:</strong> OPD bills via visit_id (immediate), IPD bills via admission_id with IpdService accrual during stay</li>
            <li><strong>Service Rates:</strong> Standard rate, emergency rates (day/night), ward-wise cost additions, premium service rates</li>
            <li><strong>Payment Processing:</strong> Multiple Payment records per Bill, supports split payments across different modes</li>
            <li><strong>IPD Advances:</strong> IpdAdvancePayment tracks deposits, deducted from final bill, refund if excess</li>
            <li><strong>Payment Status:</strong> pending  partial  paid | overdue | insurance | refunded | cancelled</li>
            <li><strong>Insurance Claims:</strong> InsuranceClaim links Bill to InsuranceCompany, tracks claim_amount vs approved_amount</li>
            <li><strong>Cashless Flow:</strong> Pre-auth  Treatment  Claim  TPA Review  Settlement (TPA + Patient co-pay)</li>
        </ul>
    </div>
</div>

<!-- Section 4.10: Patient Management Module with Workflow Diagrams -->
<div class="section" style="page-break-before: always;">
    <h2>4.10 Patient Management Module</h2>

    <p>The Patient Management Module is the foundation of HIMS, handling patient registration, demographics, medical records, vital signs tracking, document management, consent forms, and patient portal access for self-service capabilities.</p>

    <h3>4.10.1 Patient Management Workflow Diagrams</h3>

    <!-- Diagram 1: Complete Patient Journey -->
    <div class="diagram">
        <div class="diagram-title">Complete Patient Journey - Registration to Comprehensive Medical Record</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="patArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="patArrowBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#3182ce"/>
                </marker>
            </defs>

            <!-- Registration Phase -->
            <rect x="10" y="10" width="180" height="250" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="100" y="35" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">REGISTRATION</text>

            <rect x="20" y="50" width="160" height="45" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="100" y="70" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">New Patient</text>
            <text x="100" y="85" text-anchor="middle" font-size="7" fill="#2c5282">PCD generated (UHID)</text>

            <rect x="20" y="105" width="160" height="45" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="100" y="125" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Demographics</text>
            <text x="100" y="140" text-anchor="middle" font-size="7" fill="#22543d">Name, DOB, Gender, Contact</text>

            <rect x="20" y="160" width="160" height="45" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="100" y="180" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Insurance/Class</text>
            <text x="100" y="195" text-anchor="middle" font-size="7" fill="#7b341e">TPA, Policy, PatientClass</text>

            <rect x="20" y="215" width="160" height="35" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="100" y="237" text-anchor="middle" font-size="8" fill="#553c9a">Photo &amp; Documents</text>

            <!-- Clinical Data Phase -->
            <rect x="200" y="10" width="180" height="250" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="290" y="35" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">CLINICAL DATA</text>

            <rect x="210" y="50" width="160" height="45" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="290" y="70" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Vitals Recording</text>
            <text x="290" y="85" text-anchor="middle" font-size="7" fill="#276749">BP, Temp, Pulse, SpO2</text>

            <rect x="210" y="105" width="160" height="45" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="290" y="125" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Allergies</text>
            <text x="290" y="140" text-anchor="middle" font-size="7" fill="#22543d">Drug, Food, Environmental</text>

            <rect x="210" y="160" width="160" height="45" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="290" y="180" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Medical History</text>
            <text x="290" y="195" text-anchor="middle" font-size="7" fill="#22543d">Past illnesses, surgeries</text>

            <rect x="210" y="215" width="160" height="35" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="290" y="237" text-anchor="middle" font-size="8" fill="#22543d">Vaccinations</text>

            <!-- Care Episodes Phase -->
            <rect x="390" y="10" width="180" height="250" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="480" y="35" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">CARE EPISODES</text>

            <rect x="400" y="50" width="160" height="40" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="480" y="70" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">OPD Visits</text>
            <text x="480" y="82" text-anchor="middle" font-size="7" fill="#7b341e">Consultations</text>

            <rect x="400" y="100" width="160" height="40" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="480" y="120" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">IPD Admissions</text>
            <text x="480" y="132" text-anchor="middle" font-size="7" fill="#7b341e">Inpatient stays</text>

            <rect x="400" y="150" width="160" height="40" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="480" y="170" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">Lab Orders</text>
            <text x="480" y="182" text-anchor="middle" font-size="7" fill="#7b341e">Test results</text>

            <rect x="400" y="200" width="160" height="50" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="480" y="220" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Radiology/Surgery</text>
            <text x="480" y="235" text-anchor="middle" font-size="7" fill="#7b341e">Imaging &amp; OT records</text>

            <!-- Financial Phase -->
            <rect x="580" y="10" width="160" height="250" rx="6" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="660" y="35" text-anchor="middle" font-weight="bold" font-size="11" fill="#6b46c1">FINANCIAL</text>

            <rect x="590" y="50" width="140" height="45" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="660" y="70" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Bills</text>
            <text x="660" y="85" text-anchor="middle" font-size="7" fill="#44337a">OPD/IPD charges</text>

            <rect x="590" y="105" width="140" height="45" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="660" y="125" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Payments</text>
            <text x="660" y="140" text-anchor="middle" font-size="7" fill="#44337a">Receipts, advances</text>

            <rect x="590" y="160" width="140" height="45" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="660" y="180" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">Insurance</text>
            <text x="660" y="195" text-anchor="middle" font-size="7" fill="#702459">Claims processing</text>

            <rect x="590" y="215" width="140" height="35" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="660" y="237" text-anchor="middle" font-size="8" fill="#553c9a">Pharmacy Sales</text>

            <!-- Flow Arrows -->
            <path d="M190,130 L200,130" stroke="#4a5568" stroke-width="2" marker-end="url(#patArrow)"/>
            <path d="M380,130 L390,130" stroke="#4a5568" stroke-width="2" marker-end="url(#patArrow)"/>
            <path d="M570,130 L580,130" stroke="#4a5568" stroke-width="2" marker-end="url(#patArrow)"/>

            <!-- Patient Data Model -->
            <rect x="10" y="275" width="730" height="235" rx="6" fill="#f7fafc" stroke="#a0aec0" stroke-width="1"/>
            <text x="375" y="300" text-anchor="middle" font-weight="bold" font-size="11" fill="#2d3748">Patient Data Model &amp; Relationships</text>

            <!-- Patient Core -->
            <rect x="25" y="320" width="200" height="180" rx="4" fill="#bee3f8" stroke="#3182ce" stroke-width="1"/>
            <text x="125" y="340" text-anchor="middle" font-weight="bold" font-size="10" fill="#2b6cb0">Patient</text>
            <text x="35" y="358" font-size="7" fill="#2c5282">patient_id (PK)</text>
            <text x="35" y="370" font-size="7" fill="#2c5282">pcd: Unique Patient Code (UHID)</text>
            <text x="35" y="382" font-size="7" fill="#2c5282">patient_name, guardian_name</text>
            <text x="35" y="394" font-size="7" fill="#2c5282">dob, age, age_unit, gender</text>
            <text x="35" y="406" font-size="7" fill="#2c5282">blood_group, marital_status</text>
            <text x="35" y="418" font-size="7" fill="#2c5282">mobile, email, address</text>
            <text x="35" y="430" font-size="7" fill="#2c5282">aadhaar_number, pan_number</text>
            <text x="35" y="442" font-size="7" fill="#2c5282">allergies, medical_history</text>
            <text x="35" y="454" font-size="7" fill="#2c5282">emergency_contact_*</text>
            <text x="35" y="466" font-size="7" fill="#2c5282">insurance_id, class_id</text>
            <text x="35" y="478" font-size="7" fill="#2c5282">photo, documents[], is_active</text>
            <text x="35" y="490" font-size="7" fill="#2c5282">registration_date</text>

            <!-- Related Models -->
            <rect x="245" y="320" width="150" height="85" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="320" y="340" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">PatientVital</text>
            <text x="255" y="358" font-size="7" fill="#22543d">vital_id (PK)</text>
            <text x="255" y="370" font-size="7" fill="#22543d">temperature, BP, pulse</text>
            <text x="255" y="382" font-size="7" fill="#22543d">respiratory_rate, SpO2</text>
            <text x="255" y="394" font-size="7" fill="#22543d">weight, height, recorded_at</text>

            <rect x="245" y="415" width="150" height="85" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="320" y="435" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">PatientDocument</text>
            <text x="255" y="453" font-size="7" fill="#7b341e">document_id (PK)</text>
            <text x="255" y="465" font-size="7" fill="#7b341e">document_type, category</text>
            <text x="255" y="477" font-size="7" fill="#7b341e">file_path, is_confidential</text>
            <text x="255" y="489" font-size="7" fill="#7b341e">verified_by, is_archived</text>

            <rect x="415" y="320" width="150" height="85" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="490" y="340" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">PatientConsent</text>
            <text x="425" y="358" font-size="7" fill="#702459">consent_id (PK)</text>
            <text x="425" y="370" font-size="7" fill="#702459">consent_type, consent_for</text>
            <text x="425" y="382" font-size="7" fill="#702459">is_given, given_by, witness</text>
            <text x="425" y="394" font-size="7" fill="#702459">digital_signature_path</text>

            <rect x="415" y="415" width="150" height="85" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="490" y="435" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">PatientClass</text>
            <text x="425" y="453" font-size="7" fill="#44337a">class_id (PK)</text>
            <text x="425" y="465" font-size="7" fill="#44337a">class_name, is_cashless</text>
            <text x="425" y="477" font-size="7" fill="#44337a">copay_patient_percent</text>
            <text x="425" y="489" font-size="7" fill="#44337a">copay_tpa_percent</text>

            <rect x="585" y="320" width="140" height="85" rx="4" fill="#c4f1f9" stroke="#00b5d8"/>
            <text x="655" y="340" text-anchor="middle" font-weight="bold" font-size="9" fill="#086f83">PatientUser</text>
            <text x="595" y="358" font-size="7" fill="#065666">patient_user_id (PK)</text>
            <text x="595" y="370" font-size="7" fill="#065666">username, email, mobile</text>
            <text x="595" y="382" font-size="7" fill="#065666">password (hashed)</text>
            <text x="595" y="394" font-size="7" fill="#065666">OTP verification</text>

            <rect x="585" y="415" width="140" height="85" rx="4" fill="#faf089" stroke="#ecc94b"/>
            <text x="655" y="435" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">PatientVaccination</text>
            <text x="595" y="453" font-size="7" fill="#744210">vaccination_id</text>
            <text x="595" y="465" font-size="7" fill="#744210">scheduled_date</text>
            <text x="595" y="477" font-size="7" fill="#744210">administered_date</text>
            <text x="595" y="489" font-size="7" fill="#744210">batch_number, status</text>

            <!-- Relationship arrows -->
            <path d="M225,360 L245,360" stroke="#38a169" stroke-width="1.5" marker-end="url(#patArrow)"/>
            <path d="M225,450 L245,450" stroke="#dd6b20" stroke-width="1.5" marker-end="url(#patArrow)"/>
            <path d="M395,360 L415,360" stroke="#d53f8c" stroke-width="1" stroke-dasharray="3,2"/>
            <path d="M395,450 L415,450" stroke="#805ad5" stroke-width="1" stroke-dasharray="3,2"/>
            <path d="M565,360 L585,360" stroke="#00b5d8" stroke-width="1" stroke-dasharray="3,2"/>
            <path d="M565,450 L585,450" stroke="#ecc94b" stroke-width="1" stroke-dasharray="3,2"/>
        </svg>
    </div>

    <!-- Diagram 2: Patient Data Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Patient Data Management - Demographics, Documents &amp; Consents</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <defs>
                <marker id="dataArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Demographics Section -->
            <rect x="10" y="10" width="355" height="225" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Patient Demographics</text>

            <!-- Personal Info -->
            <rect x="25" y="55" width="155" height="165" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="102" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Personal Information</text>
            <text x="35" y="95" font-size="7" fill="#2c5282"> patient_name</text>
            <text x="35" y="108" font-size="7" fill="#2c5282"> guardian_name, relation</text>
            <text x="35" y="121" font-size="7" fill="#2c5282"> dob / age + age_unit</text>
            <text x="35" y="134" font-size="7" fill="#2c5282"> gender (M/F/O)</text>
            <text x="35" y="147" font-size="7" fill="#2c5282"> marital_status</text>
            <text x="35" y="160" font-size="7" fill="#2c5282"> blood_group</text>
            <text x="35" y="173" font-size="7" fill="#2c5282"> nationality, religion</text>
            <text x="35" y="186" font-size="7" fill="#2c5282"> occupation</text>
            <text x="35" y="199" font-size="7" fill="#2c5282"> is_bpl, is_foreigner</text>
            <text x="35" y="212" font-size="7" fill="#2c5282"> photo (file path)</text>

            <!-- Contact Info -->
            <rect x="195" y="55" width="155" height="165" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="272" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Contact &amp; Address</text>
            <text x="205" y="95" font-size="7" fill="#22543d"> mobile (primary)</text>
            <text x="205" y="108" font-size="7" fill="#22543d"> phone (alternate)</text>
            <text x="205" y="121" font-size="7" fill="#22543d"> email</text>
            <text x="205" y="134" font-size="7" fill="#22543d"> subscribe_sms</text>
            <text x="205" y="150" font-size="7" fill="#22543d">Current Address:</text>
            <text x="205" y="163" font-size="7" fill="#22543d"> address, area, city</text>
            <text x="205" y="176" font-size="7" fill="#22543d"> district, state, country</text>
            <text x="205" y="189" font-size="7" fill="#22543d"> pincode</text>
            <text x="205" y="205" font-size="7" fill="#22543d">Permanent Address:</text>
            <text x="205" y="218" font-size="7" fill="#22543d"> permanent_* fields</text>

            <!-- Identity & Insurance Section -->
            <rect x="385" y="10" width="355" height="225" rx="6" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#6b46c1">Identity &amp; Insurance</text>

            <!-- ID Documents -->
            <rect x="400" y="55" width="155" height="85" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="477" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">ID Documents</text>
            <text x="410" y="95" font-size="7" fill="#44337a"> aadhaar_number</text>
            <text x="410" y="108" font-size="7" fill="#44337a"> pan_number</text>
            <text x="410" y="121" font-size="7" fill="#44337a"> documents[] (JSON array)</text>
            <text x="410" y="134" font-size="7" fill="#44337a">  - Passport, Voter ID, etc.</text>

            <!-- Insurance Details -->
            <rect x="570" y="55" width="155" height="85" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="647" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Insurance Details</text>
            <text x="580" y="95" font-size="7" fill="#702459"> insurance_id  Company</text>
            <text x="580" y="108" font-size="7" fill="#702459"> insurance_policy_number</text>
            <text x="580" y="121" font-size="7" fill="#702459"> cashless_referral_no</text>
            <text x="580" y="134" font-size="7" fill="#702459"> tpa_id</text>

            <!-- Patient Class -->
            <rect x="400" y="150" width="325" height="75" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="562" y="170" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">PatientClass (Billing Category)</text>
            <text x="415" y="190" font-size="7" fill="#7b341e">class_id  PatientClass | class_code, class_name | is_cashless</text>
            <text x="415" y="205" font-size="7" fill="#7b341e">copay_patient_percent, copay_tpa_percent | pharmacy_cash | service_tax_applicable</text>
            <text x="415" y="220" font-size="7" fill="#7b341e">prior_approval_required, prior_approval_limit | grace_period_days</text>

            <!-- Document Management Section -->
            <rect x="10" y="250" width="355" height="220" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="187" y="275" text-anchor="middle" font-weight="bold" font-size="12" fill="#c05621">Document Management (PatientDocument)</text>

            <!-- Document Types -->
            <rect x="25" y="295" width="155" height="165" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="102" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">Document Types</text>
            <text x="35" y="335" font-size="7" fill="#744210"> id_proof (Aadhaar, PAN)</text>
            <text x="35" y="350" font-size="7" fill="#744210"> insurance_card</text>
            <text x="35" y="365" font-size="7" fill="#744210"> prescription</text>
            <text x="35" y="380" font-size="7" fill="#744210"> lab_report</text>
            <text x="35" y="395" font-size="7" fill="#744210"> radiology_image</text>
            <text x="35" y="410" font-size="7" fill="#744210"> discharge_summary</text>
            <text x="35" y="425" font-size="7" fill="#744210"> consent_form</text>
            <text x="35" y="440" font-size="7" fill="#744210"> referral_letter</text>
            <text x="35" y="455" font-size="7" fill="#744210"> other</text>

            <!-- Document Workflow -->
            <rect x="195" y="295" width="155" height="165" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="272" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Document Workflow</text>
            <text x="205" y="335" font-size="7" fill="#7b341e">Upload:</text>
            <text x="205" y="348" font-size="7" fill="#7b341e"> file_path, file_name</text>
            <text x="205" y="361" font-size="7" fill="#7b341e"> file_type, file_size</text>
            <text x="205" y="374" font-size="7" fill="#7b341e"> uploaded_by  User</text>
            <text x="205" y="390" font-size="7" fill="#7b341e">Verification:</text>
            <text x="205" y="403" font-size="7" fill="#7b341e"> verified_by, verified_at</text>
            <text x="205" y="419" font-size="7" fill="#7b341e">Archival:</text>
            <text x="205" y="432" font-size="7" fill="#7b341e"> is_archived, archived_at</text>
            <text x="205" y="448" font-size="7" fill="#7b341e">Security:</text>
            <text x="205" y="461" font-size="7" fill="#7b341e"> is_confidential flag</text>

            <!-- Consent Management Section -->
            <rect x="385" y="250" width="355" height="220" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="562" y="275" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Consent Management (PatientConsent)</text>

            <!-- Consent Types -->
            <rect x="400" y="295" width="155" height="165" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="477" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Consent Types</text>
            <text x="410" y="335" font-size="7" fill="#22543d"> general_treatment</text>
            <text x="410" y="350" font-size="7" fill="#22543d"> surgery</text>
            <text x="410" y="365" font-size="7" fill="#22543d"> anesthesia</text>
            <text x="410" y="380" font-size="7" fill="#22543d"> blood_transfusion</text>
            <text x="410" y="395" font-size="7" fill="#22543d"> high_risk_procedure</text>
            <text x="410" y="410" font-size="7" fill="#22543d"> discharge_against_advice</text>
            <text x="410" y="425" font-size="7" fill="#22543d"> data_sharing</text>
            <text x="410" y="440" font-size="7" fill="#22543d"> research_participation</text>
            <text x="410" y="455" font-size="7" fill="#22543d"> photography</text>

            <!-- Consent Details -->
            <rect x="570" y="295" width="155" height="165" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="647" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Consent Details</text>
            <text x="580" y="335" font-size="7" fill="#22543d">Given By:</text>
            <text x="580" y="348" font-size="7" fill="#22543d"> given_by (name)</text>
            <text x="580" y="361" font-size="7" fill="#22543d"> relationship to patient</text>
            <text x="580" y="374" font-size="7" fill="#22543d"> witness_name</text>
            <text x="580" y="390" font-size="7" fill="#22543d">Signatures:</text>
            <text x="580" y="403" font-size="7" fill="#22543d"> consent_form_path</text>
            <text x="580" y="416" font-size="7" fill="#22543d"> digital_signature_path</text>
            <text x="580" y="432" font-size="7" fill="#22543d">Revocation:</text>
            <text x="580" y="445" font-size="7" fill="#22543d"> revoked_at, revoked_by</text>
            <text x="580" y="458" font-size="7" fill="#22543d"> revocation_reason</text>
        </svg>
    </div>

    <!-- Diagram 3: Patient Vitals & Clinical Data -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Patient Vitals &amp; Clinical Data - Vital Signs, Allergies &amp; Medical History</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <defs>
                <marker id="vitalArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Vital Signs Section -->
            <rect x="10" y="10" width="450" height="230" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="235" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Vital Signs Recording (PatientVital)</text>

            <!-- Vital Parameters -->
            <rect x="25" y="55" width="130" height="170" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="90" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Parameters</text>
            <text x="35" y="95" font-size="7" fill="#22543d"> temperature (F/C)</text>
            <text x="35" y="112" font-size="7" fill="#22543d"> BP systolic (mmHg)</text>
            <text x="35" y="129" font-size="7" fill="#22543d"> BP diastolic (mmHg)</text>
            <text x="35" y="146" font-size="7" fill="#22543d"> pulse_rate (bpm)</text>
            <text x="35" y="163" font-size="7" fill="#22543d"> respiratory_rate</text>
            <text x="35" y="180" font-size="7" fill="#22543d"> oxygen_saturation %</text>
            <text x="35" y="197" font-size="7" fill="#22543d"> weight (kg)</text>
            <text x="35" y="214" font-size="7" fill="#22543d"> height (cm)</text>

            <!-- Recording Context -->
            <rect x="165" y="55" width="130" height="170" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="230" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Recording Context</text>
            <text x="175" y="95" font-size="7" fill="#22543d">Linked To:</text>
            <text x="175" y="110" font-size="7" fill="#22543d"> visit_id (OPD)</text>
            <text x="175" y="125" font-size="7" fill="#22543d"> admission_id (IPD)</text>
            <text x="175" y="145" font-size="7" fill="#22543d">Metadata:</text>
            <text x="175" y="160" font-size="7" fill="#22543d"> recorded_at (datetime)</text>
            <text x="175" y="175" font-size="7" fill="#22543d"> recorded_by  User</text>
            <text x="175" y="190" font-size="7" fill="#22543d"> notes (free text)</text>
            <text x="175" y="210" font-size="7" fill="#276749">Multiple records per</text>
            <text x="175" y="222" font-size="7" fill="#276749">visit/admission</text>

            <!-- Normal Ranges -->
            <rect x="305" y="55" width="145" height="170" rx="4" fill="#fffff0" stroke="#d69e2e"/>
            <text x="377" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#975a16">Normal Ranges</text>
            <text x="315" y="95" font-size="7" fill="#744210">Temp: 97.8-99.1F</text>
            <text x="315" y="110" font-size="7" fill="#744210">BP: 90-120/60-80</text>
            <text x="315" y="125" font-size="7" fill="#744210">Pulse: 60-100 bpm</text>
            <text x="315" y="140" font-size="7" fill="#744210">Resp: 12-20/min</text>
            <text x="315" y="155" font-size="7" fill="#744210">SpO2: 95-100%</text>
            <text x="315" y="175" font-size="7" fill="#c53030">Alerts Generated:</text>
            <text x="315" y="190" font-size="7" fill="#c53030"> Critical values</text>
            <text x="315" y="205" font-size="7" fill="#c53030"> Trend analysis</text>
            <text x="315" y="220" font-size="7" fill="#c53030"> Early warning score</text>

            <!-- Emergency Contact -->
            <rect x="480" y="10" width="260" height="230" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="610" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">Emergency Information</text>

            <rect x="495" y="55" width="230" height="85" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="610" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">Emergency Contacts</text>
            <text x="505" y="95" font-size="7" fill="#742a2a"> emergency_contact_name</text>
            <text x="505" y="110" font-size="7" fill="#742a2a"> emergency_contact_phone</text>
            <text x="505" y="125" font-size="7" fill="#742a2a"> emergency_contact_relation</text>

            <rect x="495" y="150" width="230" height="80" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="610" y="170" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">Critical Flags</text>
            <text x="505" y="190" font-size="7" fill="#744210"> is_urgent: Priority patient</text>
            <text x="505" y="205" font-size="7" fill="#744210"> charges_type: Emergency rates</text>
            <text x="505" y="220" font-size="7" fill="#744210"> allergies: CRITICAL display</text>

            <!-- Allergies & Medical History Section -->
            <rect x="10" y="255" width="355" height="215" rx="6" fill="#fff5f5" stroke="#e53e3e" stroke-width="2"/>
            <text x="187" y="280" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">Allergies &amp; Medical History</text>

            <!-- Allergies -->
            <rect x="25" y="300" width="155" height="160" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="102" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">Allergies (Text Field)</text>
            <text x="35" y="340" font-size="7" fill="#742a2a">Drug Allergies:</text>
            <text x="35" y="355" font-size="7" fill="#742a2a"> Penicillin, Sulfa drugs</text>
            <text x="35" y="370" font-size="7" fill="#742a2a"> NSAIDs, Aspirin</text>
            <text x="35" y="388" font-size="7" fill="#742a2a">Food Allergies:</text>
            <text x="35" y="403" font-size="7" fill="#742a2a"> Nuts, Shellfish, Eggs</text>
            <text x="35" y="421" font-size="7" fill="#742a2a">Environmental:</text>
            <text x="35" y="436" font-size="7" fill="#742a2a"> Latex, Iodine contrast</text>
            <text x="35" y="454" font-size="7" fill="#c53030"> Displayed prominently</text>

            <!-- Medical History -->
            <rect x="195" y="300" width="155" height="160" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="272" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Medical History (Text)</text>
            <text x="205" y="340" font-size="7" fill="#7b341e">Past Illnesses:</text>
            <text x="205" y="355" font-size="7" fill="#7b341e"> Diabetes, Hypertension</text>
            <text x="205" y="370" font-size="7" fill="#7b341e"> Heart disease, Asthma</text>
            <text x="205" y="388" font-size="7" fill="#7b341e">Past Surgeries:</text>
            <text x="205" y="403" font-size="7" fill="#7b341e"> Appendectomy, C-section</text>
            <text x="205" y="421" font-size="7" fill="#7b341e">Current Medications:</text>
            <text x="205" y="436" font-size="7" fill="#7b341e"> Ongoing prescriptions</text>
            <text x="205" y="454" font-size="7" fill="#7b341e">Family History noted</text>

            <!-- Vaccination Tracking Section -->
            <rect x="385" y="255" width="355" height="215" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="280" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Vaccination Tracking (PatientVaccination)</text>

            <!-- Vaccination Record -->
            <rect x="400" y="300" width="160" height="160" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="480" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Vaccination Record</text>
            <text x="410" y="340" font-size="7" fill="#2c5282"> vaccination_id  Vaccine</text>
            <text x="410" y="355" font-size="7" fill="#2c5282"> scheduled_date</text>
            <text x="410" y="370" font-size="7" fill="#2c5282"> administered_date</text>
            <text x="410" y="385" font-size="7" fill="#2c5282"> batch_number</text>
            <text x="410" y="400" font-size="7" fill="#2c5282"> administered_by</text>
            <text x="410" y="420" font-size="7" fill="#2c5282">Status:</text>
            <text x="410" y="435" font-size="7" fill="#2c5282"> scheduled</text>
            <text x="410" y="450" font-size="7" fill="#2c5282"> administered</text>

            <!-- Vaccine Schedule -->
            <rect x="575" y="300" width="150" height="160" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="650" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Vaccine Types</text>
            <text x="585" y="340" font-size="7" fill="#22543d">Pediatric:</text>
            <text x="585" y="355" font-size="7" fill="#22543d"> BCG, OPV, DPT</text>
            <text x="585" y="370" font-size="7" fill="#22543d"> Hepatitis B, MMR</text>
            <text x="585" y="388" font-size="7" fill="#22543d">Adult:</text>
            <text x="585" y="403" font-size="7" fill="#22543d"> Influenza, Pneumonia</text>
            <text x="585" y="418" font-size="7" fill="#22543d"> Tetanus, COVID-19</text>
            <text x="585" y="436" font-size="7" fill="#22543d">Special:</text>
            <text x="585" y="451" font-size="7" fill="#22543d"> Rabies, Hepatitis A</text>
        </svg>
    </div>

    <!-- Diagram 4: Patient Portal & Engagement -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Patient Portal &amp; Engagement - Self-Service &amp; Feedback</div>
        <svg width="750" height="480" viewBox="0 0 750 480">
            <defs>
                <marker id="portalArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
            </defs>

            <!-- Patient Portal Login Section -->
            <rect x="10" y="10" width="355" height="225" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Patient Portal (PatientUser)</text>

            <!-- Registration Flow -->
            <rect x="25" y="55" width="100" height="55" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="75" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">1. Register</text>
            <text x="75" y="90" text-anchor="middle" font-size="7" fill="#2c5282">Link to Patient</text>
            <text x="75" y="102" text-anchor="middle" font-size="6" fill="#4299e1">patient_id</text>

            <rect x="140" y="55" width="100" height="55" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="190" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">2. Verify</text>
            <text x="190" y="90" text-anchor="middle" font-size="7" fill="#22543d">OTP to mobile</text>
            <text x="190" y="102" text-anchor="middle" font-size="6" fill="#48bb78">10 min expiry</text>

            <rect x="255" y="55" width="100" height="55" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="305" y="75" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">3. Login</text>
            <text x="305" y="90" text-anchor="middle" font-size="7" fill="#22543d">Sanctum token</text>
            <text x="305" y="102" text-anchor="middle" font-size="6" fill="#276749">API access</text>

            <path d="M125,82 L140,82" stroke="#4a5568" stroke-width="1.5" marker-end="url(#portalArrow)"/>
            <path d="M240,82 L255,82" stroke="#4a5568" stroke-width="1.5" marker-end="url(#portalArrow)"/>

            <!-- Portal Features -->
            <rect x="25" y="120" width="320" height="105" rx="4" fill="#f0fff4" stroke="#48bb78"/>
            <text x="185" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Portal Features</text>

            <rect x="35" y="155" width="95" height="60" rx="3" fill="#c6f6d5"/>
            <text x="82" y="173" text-anchor="middle" font-size="7" fill="#22543d">View Records</text>
            <text x="82" y="188" text-anchor="middle" font-size="6" fill="#276749"> Lab results</text>
            <text x="82" y="200" text-anchor="middle" font-size="6" fill="#276749"> Prescriptions</text>
            <text x="82" y="212" text-anchor="middle" font-size="6" fill="#276749"> Bills</text>

            <rect x="140" y="155" width="95" height="60" rx="3" fill="#bee3f8"/>
            <text x="187" y="173" text-anchor="middle" font-size="7" fill="#2c5282">Appointments</text>
            <text x="187" y="188" text-anchor="middle" font-size="6" fill="#2c5282"> Request new</text>
            <text x="187" y="200" text-anchor="middle" font-size="6" fill="#2c5282"> View upcoming</text>
            <text x="187" y="212" text-anchor="middle" font-size="6" fill="#2c5282"> Cancel/Reschedule</text>

            <rect x="245" y="155" width="95" height="60" rx="3" fill="#e9d8fd"/>
            <text x="292" y="173" text-anchor="middle" font-size="7" fill="#553c9a">Downloads</text>
            <text x="292" y="188" text-anchor="middle" font-size="6" fill="#44337a"> Reports PDF</text>
            <text x="292" y="200" text-anchor="middle" font-size="6" fill="#44337a"> Discharge summary</text>
            <text x="292" y="212" text-anchor="middle" font-size="6" fill="#44337a"> Receipts</text>

            <!-- Appointment Request Section -->
            <rect x="385" y="10" width="355" height="225" rx="6" fill="#faf5ff" stroke="#9f7aea" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#6b46c1">Appointment Requests</text>

            <!-- Request Flow -->
            <rect x="400" y="55" width="325" height="80" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="562" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">PatientAppointmentRequest</text>
            <text x="415" y="95" font-size="7" fill="#44337a">patient_user_id  PatientUser | preferred_date, preferred_time</text>
            <text x="415" y="110" font-size="7" fill="#44337a">department_id, doctor_id (optional) | reason, symptoms</text>
            <text x="415" y="125" font-size="7" fill="#44337a">status: pending  approved/rejected  converted_to_appointment</text>

            <!-- Request Status -->
            <rect x="400" y="145" width="325" height="80" rx="4" fill="#f7fafc" stroke="#a0aec0"/>
            <text x="562" y="165" text-anchor="middle" font-weight="bold" font-size="9" fill="#4a5568">Request Status Flow</text>

            <rect x="420" y="185" width="70" height="25" rx="3" fill="#fbd38d"/>
            <text x="455" y="202" text-anchor="middle" font-size="7" fill="#744210">pending</text>

            <rect x="510" y="185" width="70" height="25" rx="3" fill="#9ae6b4"/>
            <text x="545" y="202" text-anchor="middle" font-size="7" fill="#22543d">approved</text>

            <rect x="600" y="185" width="70" height="25" rx="3" fill="#bee3f8"/>
            <text x="635" y="202" text-anchor="middle" font-size="7" fill="#2c5282">scheduled</text>

            <path d="M490,197 L510,197" stroke="#4a5568" stroke-width="1" marker-end="url(#portalArrow)"/>
            <path d="M580,197 L600,197" stroke="#4a5568" stroke-width="1" marker-end="url(#portalArrow)"/>

            <!-- Feedback Section -->
            <rect x="10" y="250" width="355" height="220" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="187" y="275" text-anchor="middle" font-weight="bold" font-size="12" fill="#c05621">Patient Feedback (PatientFeedback)</text>

            <!-- Rating Categories -->
            <rect x="25" y="295" width="155" height="165" rx="4" fill="#fbd38d" stroke="#ed8936"/>
            <text x="102" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">Rating Categories</text>
            <text x="35" y="335" font-size="7" fill="#744210"> overall_rating (1-5)</text>
            <text x="35" y="352" font-size="7" fill="#744210"> cleanliness_rating</text>
            <text x="35" y="369" font-size="7" fill="#744210"> staff_rating</text>
            <text x="35" y="386" font-size="7" fill="#744210"> wait_time_rating</text>
            <text x="35" y="403" font-size="7" fill="#744210"> doctor_rating</text>
            <text x="35" y="425" font-size="7" fill="#744210">Text Fields:</text>
            <text x="35" y="440" font-size="7" fill="#744210"> comments</text>
            <text x="35" y="455" font-size="7" fill="#744210"> suggestions</text>

            <!-- Feedback Context -->
            <rect x="195" y="295" width="155" height="165" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="272" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Feedback Context</text>
            <text x="205" y="335" font-size="7" fill="#7b341e">Reference:</text>
            <text x="205" y="350" font-size="7" fill="#7b341e"> reference_type (visit/admit)</text>
            <text x="205" y="365" font-size="7" fill="#7b341e"> reference_id</text>
            <text x="205" y="380" font-size="7" fill="#7b341e"> doctor_id, department_id</text>
            <text x="205" y="400" font-size="7" fill="#7b341e">Privacy:</text>
            <text x="205" y="415" font-size="7" fill="#7b341e"> is_anonymous option</text>
            <text x="205" y="435" font-size="7" fill="#7b341e">Response:</text>
            <text x="205" y="450" font-size="7" fill="#7b341e"> is_addressed, response</text>

            <!-- Session Management Section -->
            <rect x="385" y="250" width="355" height="220" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="562" y="275" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Security &amp; Session Management</text>

            <!-- Auth Details -->
            <rect x="400" y="295" width="160" height="165" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="480" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Authentication</text>
            <text x="410" y="335" font-size="7" fill="#22543d">PatientUser Model:</text>
            <text x="410" y="350" font-size="7" fill="#22543d"> Extends Authenticatable</text>
            <text x="410" y="365" font-size="7" fill="#22543d"> HasApiTokens (Sanctum)</text>
            <text x="410" y="385" font-size="7" fill="#22543d">Password:</text>
            <text x="410" y="400" font-size="7" fill="#22543d"> Hashed storage</text>
            <text x="410" y="420" font-size="7" fill="#22543d">OTP Verification:</text>
            <text x="410" y="435" font-size="7" fill="#22543d"> generateOtp()</text>
            <text x="410" y="450" font-size="7" fill="#22543d"> verifyOtp()  10 min</text>

            <!-- Session Tracking -->
            <rect x="575" y="295" width="150" height="165" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="650" y="315" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Sessions</text>
            <text x="585" y="335" font-size="7" fill="#22543d">PatientPortalSession:</text>
            <text x="585" y="350" font-size="7" fill="#22543d"> Login tracking</text>
            <text x="585" y="365" font-size="7" fill="#22543d"> IP address logging</text>
            <text x="585" y="380" font-size="7" fill="#22543d"> Device info</text>
            <text x="585" y="400" font-size="7" fill="#22543d">last_login_at tracked</text>
            <text x="585" y="420" font-size="7" fill="#22543d">Status:</text>
            <text x="585" y="435" font-size="7" fill="#22543d"> is_active flag</text>
            <text x="585" y="450" font-size="7" fill="#22543d"> email_verified_at</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>Patient Management Workflow Key Points</h4>
        <ul>
            <li><strong>Patient Registration:</strong> Unique PCD (Patient Code/UHID) generated, comprehensive demographics with current/permanent addresses</li>
            <li><strong>Identity Documents:</strong> Aadhaar, PAN stored; documents[] JSON array for multiple ID proofs; PatientDocument for uploaded files</li>
            <li><strong>Insurance Integration:</strong> insurance_id links to InsuranceCompany; class_id defines billing category (cashless, copay percentages)</li>
            <li><strong>Vital Signs:</strong> PatientVital records temperature, BP, pulse, SpO2, weight, height - linked to OPD visit or IPD admission</li>
            <li><strong>Clinical Alerts:</strong> allergies field displayed prominently; medical_history for past illnesses/surgeries; is_urgent flag for priority</li>
            <li><strong>Consent Management:</strong> PatientConsent tracks consent_type (surgery, anesthesia, blood), digital signatures, revocation capability</li>
            <li><strong>Patient Portal:</strong> PatientUser with Sanctum auth, OTP verification, appointment requests, feedback submission</li>
            <li><strong>Care Episodes:</strong> Patient links to appointments(), opdVisits(), ipdAdmissions(), labOrders(), bills(), vaccinations()</li>
        </ul>
    </div>
</div>

<!-- Section 4.11: Appointment Module -->
<div class="section" style="page-break-before: always;">
    <h2>4.11 Appointment Scheduling Module</h2>
    <p>The appointment system handles patient scheduling with time slot management, multi-channel booking, appointment lifecycle tracking, cancellation/transfer workflows, and patient portal self-service requests.</p>

    <!-- Diagram 1: Appointment Booking & Lifecycle -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Appointment Booking &amp; Lifecycle - Complete Patient Journey</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="apptArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#3182ce"/>
                </marker>
            </defs>

            <!-- Title Row: Booking Channels -->
            <rect x="10" y="10" width="730" height="65" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="375" y="32" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">Booking Channels</text>

            <rect x="30" y="42" width="100" height="25" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="80" y="59" text-anchor="middle" font-size="8" fill="#2c5282">Reception Desk</text>

            <rect x="145" y="42" width="100" height="25" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="195" y="59" text-anchor="middle" font-size="8" fill="#276749">Patient Portal</text>

            <rect x="260" y="42" width="100" height="25" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="310" y="59" text-anchor="middle" font-size="8" fill="#553c9a">Phone Call</text>

            <rect x="375" y="42" width="100" height="25" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="425" y="59" text-anchor="middle" font-size="8" fill="#c05621">Walk-in</text>

            <rect x="490" y="42" width="100" height="25" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="540" y="59" text-anchor="middle" font-size="8" fill="#97266d">Online Booking</text>

            <rect x="605" y="42" width="110" height="25" rx="4" fill="#c4f1f9" stroke="#00b5d8"/>
            <text x="660" y="59" text-anchor="middle" font-size="8" fill="#086f83">Referral Transfer</text>

            <!-- Appointment Model Box -->
            <rect x="10" y="90" width="355" height="200" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="187" y="115" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Appointment Model</text>

            <!-- Core Fields -->
            <rect x="25" y="130" width="160" height="150" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="105" y="148" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Core Fields</text>
            <text x="35" y="166" font-size="7" fill="#22543d">appointment_id (PK)</text>
            <text x="35" y="180" font-size="7" fill="#22543d">appointment_number (unique)</text>
            <text x="35" y="194" font-size="7" fill="#22543d">patient_id  Patient</text>
            <text x="35" y="208" font-size="7" fill="#22543d">doctor_id  Doctor</text>
            <text x="35" y="222" font-size="7" fill="#22543d">department_id  Department</text>
            <text x="35" y="236" font-size="7" fill="#22543d">group_id  DoctorGroup</text>
            <text x="35" y="250" font-size="7" fill="#22543d">skill_set_id  SkillSet</text>
            <text x="35" y="264" font-size="7" fill="#22543d">reference_doctor_id</text>

            <!-- Scheduling Fields -->
            <rect x="195" y="130" width="160" height="150" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="275" y="148" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Scheduling</text>
            <text x="205" y="166" font-size="7" fill="#22543d">appointment_date (date)</text>
            <text x="205" y="180" font-size="7" fill="#22543d">appointment_time (time)</text>
            <text x="205" y="194" font-size="7" fill="#22543d">slot_number</text>
            <text x="205" y="208" font-size="7" fill="#22543d">slot_start_time</text>
            <text x="205" y="222" font-size="7" fill="#22543d">slot_end_time</text>
            <text x="205" y="236" font-size="7" fill="#22543d">duration_minutes</text>
            <text x="205" y="250" font-size="7" fill="#22543d">appointment_type</text>
            <text x="205" y="264" font-size="7" fill="#22543d">booking_mode, priority</text>

            <!-- Appointment Attributes -->
            <rect x="385" y="90" width="355" height="200" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="562" y="115" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">Appointment Attributes</text>

            <!-- Type & Mode -->
            <rect x="400" y="130" width="160" height="75" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="480" y="148" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Type &amp; Mode</text>
            <text x="410" y="166" font-size="7" fill="#44337a">service_type: consultation</text>
            <text x="410" y="180" font-size="7" fill="#44337a">is_online: true/false</text>
            <text x="410" y="194" font-size="7" fill="#44337a">booking_source: web/app/desk</text>

            <!-- Classification -->
            <rect x="570" y="130" width="160" height="75" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="650" y="148" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Classification</text>
            <text x="580" y="166" font-size="7" fill="#702459">class_id  PatientClass</text>
            <text x="580" y="180" font-size="7" fill="#702459">priority: normal/urgent</text>
            <text x="580" y="194" font-size="7" fill="#702459">reminder_sent: boolean</text>

            <!-- Additional Details -->
            <rect x="400" y="215" width="330" height="65" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="565" y="233" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Additional Details</text>
            <text x="410" y="251" font-size="7" fill="#7b341e">reason: Visit reason | notes: Internal notes | opd_id  OpdVisit (when converted)</text>
            <text x="410" y="268" font-size="7" fill="#7b341e">created_by  User | hospital_id  Hospital (multi-tenant)</text>

            <!-- Lifecycle Flow -->
            <rect x="10" y="305" width="730" height="95" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="325" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Appointment Lifecycle Status Flow</text>

            <!-- Status boxes -->
            <rect x="25" y="340" width="75" height="50" rx="4" fill="#e2e8f0" stroke="#718096"/>
            <text x="62" y="360" text-anchor="middle" font-weight="bold" font-size="8" fill="#4a5568">SCHEDULED</text>
            <text x="62" y="375" font-size="6" fill="#718096">Initial booking</text>

            <rect x="115" y="340" width="75" height="50" rx="4" fill="#bee3f8" stroke="#3182ce"/>
            <text x="152" y="360" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">CONFIRMED</text>
            <text x="152" y="375" font-size="6" fill="#2c5282">Staff verified</text>

            <rect x="205" y="340" width="75" height="50" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="242" y="360" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">CHECKED_IN</text>
            <text x="242" y="375" font-size="6" fill="#22543d">At reception</text>

            <rect x="295" y="340" width="75" height="50" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="332" y="360" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">ARRIVED</text>
            <text x="332" y="375" font-size="6" fill="#22543d">Waiting room</text>

            <rect x="385" y="340" width="85" height="50" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="427" y="360" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">IN_CONSULT</text>
            <text x="427" y="375" font-size="6" fill="#744210">With doctor</text>

            <rect x="485" y="340" width="80" height="50" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="525" y="360" text-anchor="middle" font-weight="bold" font-size="8" fill="white">COMPLETED</text>
            <text x="525" y="375" font-size="6" fill="white">Visit done</text>

            <rect x="580" y="340" width="75" height="50" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="617" y="360" text-anchor="middle" font-weight="bold" font-size="8" fill="white">CANCELLED</text>
            <text x="617" y="375" font-size="6" fill="white">By user/staff</text>

            <rect x="670" y="340" width="60" height="50" rx="4" fill="#feb2b2" stroke="#f56565"/>
            <text x="700" y="360" text-anchor="middle" font-weight="bold" font-size="8" fill="#742a2a">NO_SHOW</text>
            <text x="700" y="375" font-size="6" fill="#742a2a">Did not arrive</text>

            <!-- Flow arrows -->
            <path d="M100,365 L113,365" stroke="#3182ce" stroke-width="1.5" marker-end="url(#apptArrow)"/>
            <path d="M190,365 L203,365" stroke="#38a169" stroke-width="1.5" marker-end="url(#apptArrow)"/>
            <path d="M280,365 L293,365" stroke="#48bb78" stroke-width="1.5" marker-end="url(#apptArrow)"/>
            <path d="M370,365 L383,365" stroke="#d69e2e" stroke-width="1.5" marker-end="url(#apptArrow)"/>
            <path d="M470,365 L483,365" stroke="#48bb78" stroke-width="1.5" marker-end="url(#apptArrow)"/>

            <!-- Timestamps Section -->
            <rect x="10" y="415" width="730" height="95" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="375" y="435" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">Lifecycle Timestamps</text>

            <rect x="25" y="450" width="130" height="50" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="90" y="468" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Confirmation</text>
            <text x="90" y="485" text-anchor="middle" font-size="7" fill="#2c5282">confirmed_at, confirmed_by</text>

            <rect x="170" y="450" width="130" height="50" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="235" y="468" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">Check-in</text>
            <text x="235" y="485" text-anchor="middle" font-size="7" fill="#22543d">checked_in_at, arrived_at</text>

            <rect x="315" y="450" width="150" height="50" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="390" y="468" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">Consultation</text>
            <text x="390" y="485" text-anchor="middle" font-size="7" fill="#744210">consultation_started_at, ended_at</text>

            <rect x="480" y="450" width="130" height="50" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="545" y="468" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">Cancellation</text>
            <text x="545" y="485" text-anchor="middle" font-size="7" fill="#742a2a">cancelled_at, cancelled_by</text>

            <rect x="625" y="450" width="105" height="50" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="677" y="468" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Transfer</text>
            <text x="677" y="485" text-anchor="middle" font-size="7" fill="#44337a">transferred_from_id</text>
        </svg>
    </div>

    <!-- Diagram 2: Doctor Schedule & Slot Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Doctor Schedule &amp; Slot Management - OpdTimeSlot Configuration</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="slotArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
            </defs>

            <!-- OpdTimeSlot Model -->
            <rect x="10" y="10" width="355" height="200" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">OpdTimeSlot Model</text>

            <!-- Core Configuration -->
            <rect x="25" y="55" width="155" height="145" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="102" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Core Configuration</text>
            <text x="35" y="95" font-size="7" fill="#22543d">slot_id (PK)</text>
            <text x="35" y="110" font-size="7" fill="#22543d">hospital_id  Hospital</text>
            <text x="35" y="125" font-size="7" fill="#22543d">doctor_id  Doctor</text>
            <text x="35" y="140" font-size="7" fill="#22543d">department_id  Department</text>
            <text x="35" y="158" font-size="7" fill="#22543d">day_of_week:</text>
            <text x="45" y="173" font-size="6" fill="#276749">monday, tuesday, wednesday</text>
            <text x="45" y="186" font-size="6" fill="#276749">thursday, friday, saturday, sunday</text>

            <!-- Time Settings -->
            <rect x="195" y="55" width="155" height="145" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="272" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Time Settings</text>
            <text x="205" y="95" font-size="7" fill="#22543d">start_time (e.g., 09:00:00)</text>
            <text x="205" y="110" font-size="7" fill="#22543d">end_time (e.g., 13:00:00)</text>
            <text x="205" y="125" font-size="7" fill="#22543d">slot_duration_minutes: 15</text>
            <text x="205" y="143" font-size="7" fill="#22543d">Capacity:</text>
            <text x="205" y="158" font-size="7" fill="#22543d">max_patients_per_slot: 2</text>
            <text x="205" y="173" font-size="7" fill="#22543d">max_patients_per_session: 40</text>
            <text x="205" y="188" font-size="7" fill="#22543d">is_active: boolean</text>

            <!-- Slot Generation Process -->
            <rect x="385" y="10" width="355" height="200" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Slot Generation Process</text>

            <!-- getAvailableSlots Method -->
            <rect x="400" y="55" width="325" height="145" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="562" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">getAvailableSlots($doctorId, $date)</text>
            <text x="410" y="95" font-size="7" fill="#2c5282">1. Get day_of_week from $date</text>
            <text x="410" y="110" font-size="7" fill="#2c5282">2. Find active OpdTimeSlot for doctor + day</text>
            <text x="410" y="125" font-size="7" fill="#2c5282">3. Loop: start_time to end_time by slot_duration</text>
            <text x="410" y="143" font-size="7" fill="#2c5282">4. For each slot:</text>
            <text x="425" y="158" font-size="7" fill="#2c5282">- Count existing appointments (not cancelled/no_show)</text>
            <text x="425" y="173" font-size="7" fill="#2c5282">- If booked &lt; max_patients_per_slot  slot available</text>
            <text x="410" y="188" font-size="7" fill="#2c5282">5. Return: slot_number, start_time, end_time, available</text>

            <!-- Weekly Schedule Visualization -->
            <rect x="10" y="225" width="730" height="135" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="375" y="250" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Weekly Schedule Example (Dr. Smith - Cardiology)</text>

            <!-- Days of Week -->
            <rect x="25" y="265" width="95" height="85" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="72" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">MONDAY</text>
            <text x="35" y="300" font-size="7" fill="#22543d">09:00 - 13:00</text>
            <text x="35" y="315" font-size="7" fill="#22543d">15 min slots</text>
            <text x="35" y="330" font-size="7" fill="#22543d">16 slots total</text>
            <text x="35" y="345" font-size="7" fill="#276749">2 patients/slot</text>

            <rect x="130" y="265" width="95" height="85" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="177" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">TUESDAY</text>
            <text x="140" y="300" font-size="7" fill="#22543d">14:00 - 18:00</text>
            <text x="140" y="315" font-size="7" fill="#22543d">20 min slots</text>
            <text x="140" y="330" font-size="7" fill="#22543d">12 slots total</text>
            <text x="140" y="345" font-size="7" fill="#276749">1 patient/slot</text>

            <rect x="235" y="265" width="95" height="85" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="282" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#c53030">WEDNESDAY</text>
            <text x="245" y="300" font-size="7" fill="#742a2a">No slots</text>
            <text x="245" y="315" font-size="7" fill="#742a2a">(Surgery day)</text>

            <rect x="340" y="265" width="95" height="85" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="387" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">THURSDAY</text>
            <text x="350" y="300" font-size="7" fill="#22543d">09:00 - 12:00</text>
            <text x="350" y="315" font-size="7" fill="#22543d">15 min slots</text>
            <text x="350" y="330" font-size="7" fill="#22543d">12 slots total</text>
            <text x="350" y="345" font-size="7" fill="#276749">2 patients/slot</text>

            <rect x="445" y="265" width="95" height="85" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="492" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">FRIDAY</text>
            <text x="455" y="300" font-size="7" fill="#22543d">09:00 - 13:00</text>
            <text x="455" y="315" font-size="7" fill="#22543d">+ 15:00 - 17:00</text>
            <text x="455" y="330" font-size="7" fill="#22543d">24 slots total</text>
            <text x="455" y="345" font-size="7" fill="#276749">2 sessions</text>

            <rect x="550" y="265" width="95" height="85" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="597" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">SATURDAY</text>
            <text x="560" y="300" font-size="7" fill="#7b341e">10:00 - 13:00</text>
            <text x="560" y="315" font-size="7" fill="#7b341e">30 min slots</text>
            <text x="560" y="330" font-size="7" fill="#7b341e">6 slots total</text>
            <text x="560" y="345" font-size="7" fill="#c05621">Premium</text>

            <rect x="655" y="265" width="75" height="85" rx="4" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="692" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#4a5568">SUNDAY</text>
            <text x="665" y="305" font-size="7" fill="#718096">Closed</text>

            <!-- Slot Status Visualization -->
            <rect x="10" y="375" width="730" height="115" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="400" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Slot Availability View (Monday 09:00 - 10:00)</text>

            <!-- Individual Slots -->
            <rect x="25" y="415" width="70" height="60" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="60" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="white">09:00</text>
            <text x="60" y="450" text-anchor="middle" font-size="6" fill="white">0/2 booked</text>
            <text x="60" y="465" text-anchor="middle" font-size="6" fill="white">AVAILABLE</text>

            <rect x="105" y="415" width="70" height="60" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="140" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">09:15</text>
            <text x="140" y="450" text-anchor="middle" font-size="6" fill="#744210">1/2 booked</text>
            <text x="140" y="465" text-anchor="middle" font-size="6" fill="#744210">PARTIAL</text>

            <rect x="185" y="415" width="70" height="60" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="220" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="white">09:30</text>
            <text x="220" y="450" text-anchor="middle" font-size="6" fill="white">2/2 booked</text>
            <text x="220" y="465" text-anchor="middle" font-size="6" fill="white">FULL</text>

            <rect x="265" y="415" width="70" height="60" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="300" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="white">09:45</text>
            <text x="300" y="450" text-anchor="middle" font-size="6" fill="white">0/2 booked</text>
            <text x="300" y="465" text-anchor="middle" font-size="6" fill="white">AVAILABLE</text>

            <!-- Legend -->
            <rect x="365" y="415" width="365" height="60" rx="4" fill="#f7fafc" stroke="#e2e8f0"/>
            <text x="547" y="435" text-anchor="middle" font-weight="bold" font-size="9" fill="#4a5568">Slot Status Legend</text>
            <rect x="380" y="447" width="15" height="12" rx="2" fill="#48bb78"/>
            <text x="400" y="457" font-size="7" fill="#22543d">Available</text>
            <rect x="470" y="447" width="15" height="12" rx="2" fill="#faf089"/>
            <text x="490" y="457" font-size="7" fill="#744210">Partial (has room)</text>
            <rect x="580" y="447" width="15" height="12" rx="2" fill="#fc8181"/>
            <text x="600" y="457" font-size="7" fill="#742a2a">Full (max reached)</text>
            <rect x="680" y="447" width="15" height="12" rx="2" fill="#e2e8f0"/>
            <text x="700" y="457" font-size="7" fill="#718096">Blocked</text>
        </svg>
    </div>

    <!-- Diagram 3: Patient Portal Appointment Request -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Patient Portal Appointment Request - Self-Service Booking Flow</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="portalArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#805ad5"/>
                </marker>
            </defs>

            <!-- PatientAppointmentRequest Model -->
            <rect x="10" y="10" width="355" height="195" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">PatientAppointmentRequest Model</text>

            <!-- Request Fields -->
            <rect x="25" y="55" width="155" height="140" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="102" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Request Fields</text>
            <text x="35" y="95" font-size="7" fill="#44337a">request_id (PK)</text>
            <text x="35" y="110" font-size="7" fill="#44337a">hospital_id  Hospital</text>
            <text x="35" y="125" font-size="7" fill="#44337a">patient_id  Patient</text>
            <text x="35" y="140" font-size="7" fill="#44337a">patient_user_id  PatientUser</text>
            <text x="35" y="155" font-size="7" fill="#44337a">department_id  Department</text>
            <text x="35" y="170" font-size="7" fill="#44337a">doctor_id  Doctor (optional)</text>
            <text x="35" y="185" font-size="7" fill="#44337a">reason: text</text>

            <!-- Schedule Preferences -->
            <rect x="195" y="55" width="155" height="140" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="272" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Schedule Preferences</text>
            <text x="205" y="95" font-size="7" fill="#702459">preferred_date (date)</text>
            <text x="205" y="110" font-size="7" fill="#702459">preferred_time_slot</text>
            <text x="205" y="125" font-size="7" fill="#702459">alternate_date (date)</text>
            <text x="205" y="145" font-size="7" fill="#702459">Review:</text>
            <text x="205" y="160" font-size="7" fill="#702459">reviewed_by  User</text>
            <text x="205" y="175" font-size="7" fill="#702459">reviewed_at (datetime)</text>
            <text x="205" y="190" font-size="7" fill="#702459">rejection_reason</text>

            <!-- Request Status Flow -->
            <rect x="385" y="10" width="355" height="195" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Request Status Workflow</text>

            <!-- Status boxes -->
            <rect x="400" y="55" width="100" height="55" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="450" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#744210">PENDING</text>
            <text x="450" y="92" text-anchor="middle" font-size="7" fill="#744210">Awaiting review</text>
            <text x="450" y="105" text-anchor="middle" font-size="6" fill="#744210">scopePending()</text>

            <rect x="515" y="55" width="100" height="55" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="565" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="white">APPROVED</text>
            <text x="565" y="92" text-anchor="middle" font-size="7" fill="white"> Creates Appointment</text>
            <text x="565" y="105" text-anchor="middle" font-size="6" fill="white">appointment_id set</text>

            <rect x="630" y="55" width="100" height="55" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="680" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="white">REJECTED</text>
            <text x="680" y="92" text-anchor="middle" font-size="7" fill="white">With reason</text>
            <text x="680" y="105" text-anchor="middle" font-size="6" fill="white">rejection_reason set</text>

            <!-- Flow arrows -->
            <path d="M500,82 L513,82" stroke="#38a169" stroke-width="1.5" marker-end="url(#portalArrow)"/>
            <path d="M500,82 L500,130 L615,130 L615,108" stroke="#e53e3e" stroke-width="1" stroke-dasharray="3,2"/>

            <!-- Relationships -->
            <rect x="400" y="120" width="330" height="75" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="565" y="140" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Model Relationships</text>
            <text x="410" y="158" font-size="7" fill="#22543d">patient()  belongsTo(Patient::class)</text>
            <text x="410" y="173" font-size="7" fill="#22543d">patientUser()  belongsTo(PatientUser::class) - Portal account</text>
            <text x="410" y="188" font-size="7" fill="#22543d">appointment()  belongsTo(Appointment::class) - Created on approval</text>

            <!-- Patient Portal Flow -->
            <rect x="10" y="220" width="730" height="135" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="375" y="245" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">Patient Portal Self-Service Flow</text>

            <!-- Step 1: Login -->
            <rect x="25" y="265" width="105" height="80" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="77" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">1. Login</text>
            <text x="35" y="300" font-size="6" fill="#2c5282">PatientUser auth</text>
            <text x="35" y="313" font-size="6" fill="#2c5282">Email/Mobile + OTP</text>
            <text x="35" y="326" font-size="6" fill="#2c5282">Sanctum token</text>
            <text x="35" y="339" font-size="6" fill="#2c5282">'patient' guard</text>

            <!-- Step 2: Select Doctor -->
            <rect x="145" y="265" width="105" height="80" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="197" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">2. Select Doctor</text>
            <text x="155" y="300" font-size="6" fill="#276749">Browse departments</text>
            <text x="155" y="313" font-size="6" fill="#276749">View doctor profiles</text>
            <text x="155" y="326" font-size="6" fill="#276749">Check availability</text>
            <text x="155" y="339" font-size="6" fill="#276749">Optional selection</text>

            <!-- Step 3: Choose Dates -->
            <rect x="265" y="265" width="105" height="80" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="317" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">3. Choose Dates</text>
            <text x="275" y="300" font-size="6" fill="#44337a">preferred_date</text>
            <text x="275" y="313" font-size="6" fill="#44337a">preferred_time_slot</text>
            <text x="275" y="326" font-size="6" fill="#44337a">alternate_date</text>
            <text x="275" y="339" font-size="6" fill="#44337a">Visit reason</text>

            <!-- Step 4: Submit Request -->
            <rect x="385" y="265" width="105" height="80" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="437" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">4. Submit</text>
            <text x="395" y="300" font-size="6" fill="#7b341e">Create request</text>
            <text x="395" y="313" font-size="6" fill="#7b341e">status: 'pending'</text>
            <text x="395" y="326" font-size="6" fill="#7b341e">SMS/Email notify</text>
            <text x="395" y="339" font-size="6" fill="#7b341e">Request ID shown</text>

            <!-- Step 5: Staff Review -->
            <rect x="505" y="265" width="105" height="80" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="557" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">5. Staff Review</text>
            <text x="515" y="300" font-size="6" fill="#702459">Reception views</text>
            <text x="515" y="313" font-size="6" fill="#702459">Check slot avail</text>
            <text x="515" y="326" font-size="6" fill="#702459">reviewed_by set</text>
            <text x="515" y="339" font-size="6" fill="#702459">reviewed_at set</text>

            <!-- Step 6: Outcome -->
            <rect x="625" y="265" width="105" height="80" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="677" y="283" text-anchor="middle" font-weight="bold" font-size="8" fill="white">6. Outcome</text>
            <text x="635" y="300" font-size="6" fill="white">APPROVED:</text>
            <text x="635" y="313" font-size="6" fill="white">  Appointment created</text>
            <text x="635" y="326" font-size="6" fill="white">REJECTED:</text>
            <text x="635" y="339" font-size="6" fill="white">  Reason provided</text>

            <!-- Flow arrows -->
            <path d="M130,305 L143,305" stroke="#38a169" stroke-width="1.5" marker-end="url(#portalArrow)"/>
            <path d="M250,305 L263,305" stroke="#805ad5" stroke-width="1.5" marker-end="url(#portalArrow)"/>
            <path d="M370,305 L383,305" stroke="#ed8936" stroke-width="1.5" marker-end="url(#portalArrow)"/>
            <path d="M490,305 L503,305" stroke="#d53f8c" stroke-width="1.5" marker-end="url(#portalArrow)"/>
            <path d="M610,305 L623,305" stroke="#38a169" stroke-width="1.5" marker-end="url(#portalArrow)"/>

            <!-- Integration Points -->
            <rect x="10" y="370" width="730" height="120" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="395" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Patient Portal Integration</text>

            <rect x="25" y="410" width="170" height="70" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="110" y="430" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">PatientUser Model</text>
            <text x="35" y="448" font-size="7" fill="#7b341e">appointmentRequests()  HasMany</text>
            <text x="35" y="463" font-size="7" fill="#7b341e">patient()  BelongsTo Patient</text>
            <text x="35" y="478" font-size="7" fill="#7b341e">Sanctum: HasApiTokens</text>

            <rect x="210" y="410" width="170" height="70" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="295" y="430" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Auth Guard Config</text>
            <text x="220" y="448" font-size="7" fill="#22543d">config/auth.php:</text>
            <text x="220" y="463" font-size="7" fill="#22543d">'patient' => sanctum driver</text>
            <text x="220" y="478" font-size="7" fill="#22543d">provider: 'patient_users'</text>

            <rect x="395" y="410" width="170" height="70" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="480" y="430" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Notifications</text>
            <text x="405" y="448" font-size="7" fill="#44337a">Request submitted  SMS</text>
            <text x="405" y="463" font-size="7" fill="#44337a">Request approved  SMS</text>
            <text x="405" y="478" font-size="7" fill="#44337a">Request rejected  SMS</text>

            <rect x="580" y="410" width="150" height="70" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="655" y="430" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Additional Features</text>
            <text x="590" y="448" font-size="7" fill="#702459">feedbacks() relation</text>
            <text x="590" y="463" font-size="7" fill="#702459">View appointment history</text>
            <text x="590" y="478" font-size="7" fill="#702459">Cancel own requests</text>
        </svg>
    </div>

    <!-- Diagram 4: Appointment Status Transitions -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Appointment Status Transitions - Cancellation, Transfer &amp; Completion</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="transArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4a5568"/>
                </marker>
                <marker id="transArrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#e53e3e"/>
                </marker>
                <marker id="transArrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
            </defs>

            <!-- Cancellation Section -->
            <rect x="10" y="10" width="355" height="220" rx="6" fill="#fed7d7" stroke="#e53e3e" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">Cancellation Workflow</text>

            <!-- CancelReason Model -->
            <rect x="25" y="55" width="155" height="165" rx="4" fill="#feb2b2" stroke="#f56565"/>
            <text x="102" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">CancelReason Model</text>
            <text x="35" y="95" font-size="7" fill="#742a2a">cancel_reason_id (PK)</text>
            <text x="35" y="110" font-size="7" fill="#742a2a">reason_code</text>
            <text x="35" y="125" font-size="7" fill="#742a2a">reason_name</text>
            <text x="35" y="140" font-size="7" fill="#742a2a">description</text>
            <text x="35" y="158" font-size="7" fill="#742a2a">is_auto_process: bool</text>
            <text x="35" y="173" font-size="7" fill="#742a2a">applicable_for:</text>
            <text x="45" y="188" font-size="6" fill="#9b2c2c">appointment, opd, ipd</text>
            <text x="35" y="205" font-size="7" fill="#742a2a">is_active: bool</text>

            <!-- Cancellation Process -->
            <rect x="195" y="55" width="155" height="165" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="272" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="white">Cancel Process</text>
            <text x="205" y="95" font-size="7" fill="white">canBeCancelled():</text>
            <text x="215" y="110" font-size="6" fill="white">status in [scheduled, confirmed]</text>
            <text x="205" y="128" font-size="7" fill="white">On Cancel:</text>
            <text x="215" y="143" font-size="6" fill="white">cancel_reason_id  set</text>
            <text x="215" y="158" font-size="6" fill="white">cancel_remarks  text</text>
            <text x="215" y="173" font-size="6" fill="white">cancelled_at  now()</text>
            <text x="215" y="188" font-size="6" fill="white">cancelled_by  User</text>
            <text x="215" y="203" font-size="6" fill="white">status  'cancelled'</text>

            <!-- Transfer Section -->
            <rect x="385" y="10" width="355" height="220" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Transfer Workflow</text>

            <!-- Transfer Requirements -->
            <rect x="400" y="55" width="155" height="165" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="477" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Transfer Requirements</text>
            <text x="410" y="95" font-size="7" fill="#2c5282">canBeTransferred():</text>
            <text x="420" y="110" font-size="6" fill="#2c5282">status in [scheduled, confirmed]</text>
            <text x="420" y="123" font-size="6" fill="#2c5282">AND opd_id is null</text>
            <text x="410" y="143" font-size="7" fill="#2c5282">Transfer Reasons:</text>
            <text x="420" y="158" font-size="6" fill="#2c5282"> Doctor unavailable</text>
            <text x="420" y="171" font-size="6" fill="#2c5282"> Patient request</text>
            <text x="420" y="184" font-size="6" fill="#2c5282"> Schedule conflict</text>
            <text x="420" y="197" font-size="6" fill="#2c5282"> Department change</text>
            <text x="420" y="210" font-size="6" fill="#2c5282"> Emergency coverage</text>

            <!-- Transfer Fields -->
            <rect x="570" y="55" width="155" height="165" rx="4" fill="#90cdf4" stroke="#3182ce"/>
            <text x="647" y="75" text-anchor="middle" font-weight="bold" font-size="9" fill="#2a4365">Transfer Fields</text>
            <text x="580" y="95" font-size="7" fill="#2a4365">On Transfer:</text>
            <text x="590" y="110" font-size="6" fill="#2a4365">transferred_from_id</text>
            <text x="600" y="123" font-size="6" fill="#2a4365"> Old appointment_id</text>
            <text x="590" y="138" font-size="6" fill="#2a4365">original_doctor_id</text>
            <text x="600" y="151" font-size="6" fill="#2a4365"> Original doctor</text>
            <text x="580" y="168" font-size="7" fill="#2a4365">New Appointment:</text>
            <text x="590" y="183" font-size="6" fill="#2a4365">doctor_id  New doctor</text>
            <text x="590" y="196" font-size="6" fill="#2a4365">appointment_date  New date</text>
            <text x="590" y="209" font-size="6" fill="#2a4365">Old  status: cancelled</text>

            <!-- Complete Status Flow Diagram -->
            <rect x="10" y="245" width="730" height="245" rx="6" fill="#f7fafc" stroke="#718096" stroke-width="2"/>
            <text x="375" y="270" text-anchor="middle" font-weight="bold" font-size="12" fill="#4a5568">Complete Appointment State Machine</text>

            <!-- SCHEDULED -->
            <rect x="60" y="295" width="90" height="55" rx="6" fill="#e2e8f0" stroke="#718096" stroke-width="2"/>
            <text x="105" y="318" text-anchor="middle" font-weight="bold" font-size="9" fill="#4a5568">SCHEDULED</text>
            <text x="105" y="338" text-anchor="middle" font-size="6" fill="#718096">Initial state</text>

            <!-- CONFIRMED -->
            <rect x="200" y="295" width="90" height="55" rx="6" fill="#bee3f8" stroke="#3182ce" stroke-width="2"/>
            <text x="245" y="318" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">CONFIRMED</text>
            <text x="245" y="338" text-anchor="middle" font-size="6" fill="#2c5282">Staff verified</text>

            <!-- CHECKED_IN -->
            <rect x="340" y="295" width="90" height="55" rx="6" fill="#c6f6d5" stroke="#38a169" stroke-width="2"/>
            <text x="385" y="318" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">CHECKED_IN</text>
            <text x="385" y="338" text-anchor="middle" font-size="6" fill="#22543d">At reception</text>

            <!-- ARRIVED -->
            <rect x="480" y="295" width="90" height="55" rx="6" fill="#9ae6b4" stroke="#48bb78" stroke-width="2"/>
            <text x="525" y="318" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">ARRIVED</text>
            <text x="525" y="338" text-anchor="middle" font-size="6" fill="#22543d">In waiting room</text>

            <!-- IN_CONSULTATION -->
            <rect x="200" y="375" width="110" height="55" rx="6" fill="#faf089" stroke="#d69e2e" stroke-width="2"/>
            <text x="255" y="398" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">IN_CONSULTATION</text>
            <text x="255" y="418" text-anchor="middle" font-size="6" fill="#744210">With doctor</text>

            <!-- COMPLETED -->
            <rect x="360" y="375" width="90" height="55" rx="6" fill="#48bb78" stroke="#38a169" stroke-width="2"/>
            <text x="405" y="398" text-anchor="middle" font-weight="bold" font-size="9" fill="white">COMPLETED</text>
            <text x="405" y="418" text-anchor="middle" font-size="6" fill="white">Visit finished</text>

            <!-- CANCELLED -->
            <rect x="600" y="295" width="90" height="55" rx="6" fill="#fc8181" stroke="#e53e3e" stroke-width="2"/>
            <text x="645" y="318" text-anchor="middle" font-weight="bold" font-size="9" fill="white">CANCELLED</text>
            <text x="645" y="338" text-anchor="middle" font-size="6" fill="white">User/staff</text>

            <!-- NO_SHOW -->
            <rect x="600" y="375" width="90" height="55" rx="6" fill="#feb2b2" stroke="#f56565" stroke-width="2"/>
            <text x="645" y="398" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">NO_SHOW</text>
            <text x="645" y="418" text-anchor="middle" font-size="6" fill="#742a2a">Did not arrive</text>

            <!-- Primary flow arrows (green) -->
            <path d="M150,322 L198,322" stroke="#38a169" stroke-width="2" marker-end="url(#transArrowGreen)"/>
            <path d="M290,322 L338,322" stroke="#38a169" stroke-width="2" marker-end="url(#transArrowGreen)"/>
            <path d="M430,322 L478,322" stroke="#38a169" stroke-width="2" marker-end="url(#transArrowGreen)"/>
            <path d="M525,350 L525,375 L312,375 L312,375" stroke="#38a169" stroke-width="2" marker-end="url(#transArrowGreen)"/>
            <path d="M310,402 L358,402" stroke="#38a169" stroke-width="2" marker-end="url(#transArrowGreen)"/>

            <!-- Cancel arrows (red) from scheduled and confirmed -->
            <path d="M105,350 L105,440 L580,440 L580,350 L598,350" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#transArrowRed)"/>
            <path d="M245,350 L245,365 L580,365 L580,322 L598,322" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#transArrowRed)"/>

            <!-- No-show arrow from ARRIVED -->
            <path d="M570,322 L570,402 L598,402" stroke="#f56565" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#transArrowRed)"/>

            <!-- Legend -->
            <rect x="30" y="450" width="150" height="30" rx="4" fill="#f7fafc" stroke="#e2e8f0"/>
            <path d="M40,465 L70,465" stroke="#38a169" stroke-width="2" marker-end="url(#transArrowGreen)"/>
            <text x="80" y="469" font-size="7" fill="#22543d">Normal progression</text>

            <rect x="195" y="450" width="150" height="30" rx="4" fill="#f7fafc" stroke="#e2e8f0"/>
            <path d="M205,465 L235,465" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#transArrowRed)"/>
            <text x="245" y="469" font-size="7" fill="#742a2a">Cancellation/No-show</text>

            <!-- Scopes info -->
            <rect x="360" y="450" width="370" height="30" rx="4" fill="#ebf8ff" stroke="#3182ce"/>
            <text x="375" y="469" font-size="7" fill="#2b6cb0">Scopes: scopeToday() | scopeUpcoming() | scopeActive() - excludes cancelled/no_show</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>Appointment Scheduling Workflow Key Points</h4>
        <ul>
            <li><strong>Multi-Channel Booking:</strong> Reception desk, patient portal, phone, walk-in, online booking, referral transfers</li>
            <li><strong>Time Slot Management:</strong> OpdTimeSlot configures doctor schedules per day_of_week with slot_duration, max_patients_per_slot</li>
            <li><strong>Slot Availability:</strong> getAvailableSlots($doctorId, $date) calculates real-time availability excluding cancelled/no_show</li>
            <li><strong>Status Lifecycle:</strong> scheduled  confirmed  checked_in  arrived  in_consultation  completed (or cancelled/no_show)</li>
            <li><strong>Patient Portal Requests:</strong> PatientAppointmentRequest allows self-service with preferred_date/alternate_date, pending staff review</li>
            <li><strong>Cancellation:</strong> canBeCancelled() checks status; CancelReason provides standardized reasons with is_auto_process flag</li>
            <li><strong>Transfer Support:</strong> canBeTransferred() allows doctor/date changes; tracks original_doctor_id and transferred_from_id</li>
            <li><strong>OPD Conversion:</strong> opd_id links to OpdVisit when appointment converts to actual consultation</li>
        </ul>
    </div>
</div>

<!-- Section 4.12: Laboratory Module -->
<div class="section" style="page-break-before: always;">
    <h2>4.12 Laboratory Management Module</h2>
    <p>The laboratory system manages test ordering, sample collection, result entry, and reporting with comprehensive tracking from order creation through result delivery to patients and referring physicians.</p>

    <!-- Diagram 1: Lab Order Lifecycle -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Laboratory Order Lifecycle - From Order to Results</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="labArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#805ad5"/>
                </marker>
            </defs>

            <!-- Order Sources -->
            <rect x="10" y="10" width="730" height="65" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="375" y="32" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Lab Order Sources</text>

            <rect x="30" y="42" width="130" height="25" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="95" y="59" text-anchor="middle" font-size="8" fill="#44337a">OPD Consultation</text>

            <rect x="175" y="42" width="130" height="25" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="240" y="59" text-anchor="middle" font-size="8" fill="#702459">IPD Admission</text>

            <rect x="320" y="42" width="130" height="25" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="385" y="59" text-anchor="middle" font-size="8" fill="#22543d">Emergency</text>

            <rect x="465" y="42" width="130" height="25" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="530" y="59" text-anchor="middle" font-size="8" fill="#2c5282">Health Checkup</text>

            <rect x="610" y="42" width="115" height="25" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="667" y="59" text-anchor="middle" font-size="8" fill="#7b341e">External Referral</text>

            <!-- LabOrder Model -->
            <rect x="10" y="90" width="355" height="195" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="187" y="115" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">LabOrder Model</text>

            <!-- Core Fields -->
            <rect x="25" y="135" width="155" height="140" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="102" y="153" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Core Fields</text>
            <text x="35" y="171" font-size="7" fill="#22543d">order_id (PK)</text>
            <text x="35" y="186" font-size="7" fill="#22543d">hospital_id  Hospital</text>
            <text x="35" y="201" font-size="7" fill="#22543d">patient_id  Patient</text>
            <text x="35" y="216" font-size="7" fill="#22543d">doctor_id  Doctor</text>
            <text x="35" y="231" font-size="7" fill="#22543d">order_date (date)</text>
            <text x="35" y="246" font-size="7" fill="#22543d">total_amount (decimal)</text>
            <text x="35" y="261" font-size="7" fill="#22543d">notes, created_by</text>

            <!-- Visit Context -->
            <rect x="195" y="135" width="155" height="140" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="272" y="153" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Visit Context</text>
            <text x="205" y="171" font-size="7" fill="#22543d">visit_id  OpdVisit</text>
            <text x="215" y="186" font-size="6" fill="#276749">(OPD orders)</text>
            <text x="205" y="204" font-size="7" fill="#22543d">admission_id  IpdAdmission</text>
            <text x="215" y="219" font-size="6" fill="#276749">(IPD orders)</text>
            <text x="205" y="240" font-size="7" fill="#22543d">Status Values:</text>
            <text x="215" y="255" font-size="6" fill="#276749">ordered, collected, processing</text>
            <text x="215" y="268" font-size="6" fill="#276749">completed, cancelled</text>

            <!-- LabOrderDetail Model -->
            <rect x="385" y="90" width="355" height="195" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="115" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">LabOrderDetail Model</text>

            <!-- Detail Fields -->
            <rect x="400" y="135" width="155" height="140" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="477" y="153" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Detail Fields</text>
            <text x="410" y="171" font-size="7" fill="#2c5282">detail_id (PK)</text>
            <text x="410" y="186" font-size="7" fill="#2c5282">order_id  LabOrder</text>
            <text x="410" y="201" font-size="7" fill="#2c5282">test_id  LabTest</text>
            <text x="410" y="216" font-size="7" fill="#2c5282">price (decimal)</text>
            <text x="410" y="231" font-size="7" fill="#2c5282">status (per test)</text>
            <text x="410" y="246" font-size="7" fill="#2c5282">notes</text>
            <text x="410" y="261" font-size="7" fill="#2c5282">performed_by  User</text>

            <!-- Result Fields -->
            <rect x="570" y="135" width="155" height="140" rx="4" fill="#90cdf4" stroke="#3182ce"/>
            <text x="647" y="153" text-anchor="middle" font-weight="bold" font-size="9" fill="#2a4365">Result Fields</text>
            <text x="580" y="171" font-size="7" fill="#2a4365">result (text/JSON)</text>
            <text x="580" y="186" font-size="7" fill="#2a4365">result_date (datetime)</text>
            <text x="580" y="206" font-size="7" fill="#2a4365">Comparison:</text>
            <text x="590" y="221" font-size="6" fill="#2a4365">result vs normal_range</text>
            <text x="590" y="236" font-size="6" fill="#2a4365"> High/Low/Normal flag</text>
            <text x="580" y="256" font-size="7" fill="#2a4365">Validated by technician</text>
            <text x="580" y="271" font-size="7" fill="#2a4365">before report release</text>

            <!-- Order Status Flow -->
            <rect x="10" y="300" width="730" height="95" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="322" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Lab Order Status Workflow</text>

            <!-- Status boxes -->
            <rect x="30" y="340" width="100" height="45" rx="4" fill="#e2e8f0" stroke="#718096"/>
            <text x="80" y="358" text-anchor="middle" font-weight="bold" font-size="8" fill="#4a5568">ORDERED</text>
            <text x="80" y="373" font-size="6" fill="#718096">Tests requested</text>

            <rect x="150" y="340" width="100" height="45" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="200" y="358" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">SAMPLE_PENDING</text>
            <text x="200" y="373" font-size="6" fill="#744210">Awaiting collection</text>

            <rect x="270" y="340" width="100" height="45" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="320" y="358" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">COLLECTED</text>
            <text x="320" y="373" font-size="6" fill="#2c5282">Sample received</text>

            <rect x="390" y="340" width="100" height="45" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="440" y="358" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">PROCESSING</text>
            <text x="440" y="373" font-size="6" fill="#44337a">Analysis ongoing</text>

            <rect x="510" y="340" width="100" height="45" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="560" y="358" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">COMPLETED</text>
            <text x="560" y="373" font-size="6" fill="#22543d">Results ready</text>

            <rect x="630" y="340" width="90" height="45" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="675" y="358" text-anchor="middle" font-weight="bold" font-size="8" fill="white">DELIVERED</text>
            <text x="675" y="373" font-size="6" fill="white">Report sent</text>

            <!-- Flow arrows -->
            <path d="M130,362 L148,362" stroke="#805ad5" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <path d="M250,362 L268,362" stroke="#805ad5" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <path d="M370,362 L388,362" stroke="#805ad5" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <path d="M490,362 L508,362" stroke="#805ad5" stroke-width="1.5" marker-end="url(#labArrow)"/>
            <path d="M610,362 L628,362" stroke="#805ad5" stroke-width="1.5" marker-end="url(#labArrow)"/>

            <!-- Relationships & Billing -->
            <rect x="10" y="410" width="730" height="100" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="375" y="432" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Model Relationships &amp; Billing Integration</text>

            <rect x="25" y="448" width="165" height="52" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="107" y="466" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Order  Details</text>
            <text x="35" y="483" font-size="6" fill="#44337a">details()  HasMany LabOrderDetail</text>
            <text x="35" y="495" font-size="6" fill="#44337a">One order has multiple tests</text>

            <rect x="205" y="448" width="165" height="52" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="287" y="466" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Patient &amp; Doctor</text>
            <text x="215" y="483" font-size="6" fill="#276749">patient()  BelongsTo Patient</text>
            <text x="215" y="495" font-size="6" fill="#276749">doctor()  BelongsTo Doctor (ordering)</text>

            <rect x="385" y="448" width="165" height="52" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="467" y="466" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Visit Context</text>
            <text x="395" y="483" font-size="6" fill="#2c5282">opdVisit()  BelongsTo OpdVisit</text>
            <text x="395" y="495" font-size="6" fill="#2c5282">ipdAdmission()  BelongsTo IpdAdmission</text>

            <rect x="565" y="448" width="165" height="52" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="647" y="466" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Billing</text>
            <text x="575" y="483" font-size="6" fill="#7b341e">total_amount: sum of detail.price</text>
            <text x="575" y="495" font-size="6" fill="#7b341e">Links to Bill for payment tracking</text>
        </svg>
    </div>

    <!-- Diagram 2: Test Catalog Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Laboratory Test Catalog - Categories, Tests &amp; Sample Types</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="catArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#38a169"/>
                </marker>
            </defs>

            <!-- LabCategory Model -->
            <rect x="10" y="10" width="355" height="180" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">LabCategory Model</text>

            <!-- Category Fields -->
            <rect x="25" y="55" width="155" height="125" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="102" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Fields</text>
            <text x="35" y="91" font-size="7" fill="#22543d">category_id (PK)</text>
            <text x="35" y="106" font-size="7" fill="#22543d">hospital_id  Hospital</text>
            <text x="35" y="121" font-size="7" fill="#22543d">category_name</text>
            <text x="35" y="136" font-size="7" fill="#22543d">description</text>
            <text x="35" y="151" font-size="7" fill="#22543d">is_active: boolean</text>
            <text x="35" y="168" font-size="7" fill="#22543d">tests()  HasMany</text>

            <!-- Example Categories -->
            <rect x="195" y="55" width="155" height="125" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="272" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Example Categories</text>
            <text x="205" y="91" font-size="7" fill="#22543d"> Hematology</text>
            <text x="205" y="106" font-size="7" fill="#22543d"> Biochemistry</text>
            <text x="205" y="121" font-size="7" fill="#22543d"> Microbiology</text>
            <text x="205" y="136" font-size="7" fill="#22543d"> Serology/Immunology</text>
            <text x="205" y="151" font-size="7" fill="#22543d"> Urinalysis</text>
            <text x="205" y="166" font-size="7" fill="#22543d"> Histopathology</text>

            <!-- LabTest Model -->
            <rect x="385" y="10" width="355" height="180" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">LabTest Model</text>

            <!-- Test Identification -->
            <rect x="400" y="55" width="155" height="125" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="477" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Identification</text>
            <text x="410" y="91" font-size="7" fill="#2c5282">test_id (PK)</text>
            <text x="410" y="106" font-size="7" fill="#2c5282">hospital_id  Hospital</text>
            <text x="410" y="121" font-size="7" fill="#2c5282">test_code (unique)</text>
            <text x="410" y="136" font-size="7" fill="#2c5282">test_name</text>
            <text x="410" y="151" font-size="7" fill="#2c5282">category_id  LabCategory</text>
            <text x="410" y="166" font-size="7" fill="#2c5282">test_category (legacy text)</text>

            <!-- Test Details -->
            <rect x="570" y="55" width="155" height="125" rx="4" fill="#90cdf4" stroke="#3182ce"/>
            <text x="647" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2a4365">Test Details</text>
            <text x="580" y="91" font-size="7" fill="#2a4365">rate (decimal price)</text>
            <text x="580" y="106" font-size="7" fill="#2a4365">sample_type</text>
            <text x="580" y="121" font-size="7" fill="#2a4365">normal_range</text>
            <text x="580" y="136" font-size="7" fill="#2a4365">unit (mg/dL, etc.)</text>
            <text x="580" y="151" font-size="7" fill="#2a4365">tat_hours (turnaround)</text>
            <text x="580" y="166" font-size="7" fill="#2a4365">method, instructions</text>

            <!-- Sample Types Section -->
            <rect x="10" y="205" width="730" height="135" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="230" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Sample Types &amp; Collection Requirements</text>

            <rect x="25" y="250" width="100" height="80" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="75" y="268" text-anchor="middle" font-weight="bold" font-size="8" fill="white">BLOOD</text>
            <text x="35" y="285" font-size="6" fill="white"> Whole blood</text>
            <text x="35" y="298" font-size="6" fill="white"> Serum</text>
            <text x="35" y="311" font-size="6" fill="white"> Plasma</text>
            <text x="35" y="324" font-size="6" fill="white"> EDTA/Plain tubes</text>

            <rect x="140" y="250" width="100" height="80" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="190" y="268" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">URINE</text>
            <text x="150" y="285" font-size="6" fill="#744210"> Random</text>
            <text x="150" y="298" font-size="6" fill="#744210"> Midstream</text>
            <text x="150" y="311" font-size="6" fill="#744210"> 24-hour</text>
            <text x="150" y="324" font-size="6" fill="#744210"> First morning</text>

            <rect x="255" y="250" width="100" height="80" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="305" y="268" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">STOOL</text>
            <text x="265" y="285" font-size="6" fill="#22543d"> Fresh sample</text>
            <text x="265" y="298" font-size="6" fill="#22543d"> Preserved</text>
            <text x="265" y="311" font-size="6" fill="#22543d"> Occult blood</text>
            <text x="265" y="324" font-size="6" fill="#22543d"> Culture</text>

            <rect x="370" y="250" width="100" height="80" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="420" y="268" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">SWAB</text>
            <text x="380" y="285" font-size="6" fill="#44337a"> Throat</text>
            <text x="380" y="298" font-size="6" fill="#44337a"> Nasal</text>
            <text x="380" y="311" font-size="6" fill="#44337a"> Wound</text>
            <text x="380" y="324" font-size="6" fill="#44337a"> Genital</text>

            <rect x="485" y="250" width="100" height="80" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="535" y="268" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">CSF</text>
            <text x="495" y="285" font-size="6" fill="#702459"> Lumbar puncture</text>
            <text x="495" y="298" font-size="6" fill="#702459"> Sterile collection</text>
            <text x="495" y="311" font-size="6" fill="#702459"> Urgent processing</text>
            <text x="495" y="324" font-size="6" fill="#702459"> Multiple tubes</text>

            <rect x="600" y="250" width="125" height="80" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="662" y="268" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">TISSUE/BIOPSY</text>
            <text x="610" y="285" font-size="6" fill="#2c5282"> Formalin fixed</text>
            <text x="610" y="298" font-size="6" fill="#2c5282"> Fresh frozen</text>
            <text x="610" y="311" font-size="6" fill="#2c5282"> FNAC</text>
            <text x="610" y="324" font-size="6" fill="#2c5282"> Histopathology</text>

            <!-- Common Tests by Category -->
            <rect x="10" y="355" width="730" height="135" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="375" y="380" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Common Tests by Category</text>

            <rect x="25" y="395" width="165" height="85" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="107" y="413" text-anchor="middle" font-weight="bold" font-size="8" fill="white">Hematology</text>
            <text x="35" y="430" font-size="6" fill="white"> CBC (Complete Blood Count)</text>
            <text x="35" y="443" font-size="6" fill="white"> ESR (Erythrocyte Sed Rate)</text>
            <text x="35" y="456" font-size="6" fill="white"> PT/INR (Coagulation)</text>
            <text x="35" y="469" font-size="6" fill="white"> Blood Grouping &amp; Rh</text>

            <rect x="205" y="395" width="165" height="85" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="287" y="413" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">Biochemistry</text>
            <text x="215" y="430" font-size="6" fill="#744210"> LFT (Liver Function)</text>
            <text x="215" y="443" font-size="6" fill="#744210"> RFT (Renal Function)</text>
            <text x="215" y="456" font-size="6" fill="#744210"> Lipid Profile</text>
            <text x="215" y="469" font-size="6" fill="#744210"> Blood Glucose (FBS/PPBS)</text>

            <rect x="385" y="395" width="165" height="85" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="467" y="413" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Microbiology</text>
            <text x="395" y="430" font-size="6" fill="#22543d"> Urine Culture &amp; Sensitivity</text>
            <text x="395" y="443" font-size="6" fill="#22543d"> Blood Culture</text>
            <text x="395" y="456" font-size="6" fill="#22543d"> Stool Culture</text>
            <text x="395" y="469" font-size="6" fill="#22543d"> AFB (TB testing)</text>

            <rect x="565" y="395" width="165" height="85" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="647" y="413" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Serology</text>
            <text x="575" y="430" font-size="6" fill="#44337a"> HIV/HBsAg/HCV</text>
            <text x="575" y="443" font-size="6" fill="#44337a"> Thyroid Profile (T3/T4/TSH)</text>
            <text x="575" y="456" font-size="6" fill="#44337a"> Dengue NS1/IgM/IgG</text>
            <text x="575" y="469" font-size="6" fill="#44337a"> Widal Test, VDRL</text>
        </svg>
    </div>

    <!-- Diagram 3: Sample Collection & Processing -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Sample Collection &amp; Processing Workflow</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="sampleArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#3182ce"/>
                </marker>
            </defs>

            <!-- Collection Points -->
            <rect x="10" y="10" width="730" height="120" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="375" y="35" text-anchor="middle" font-weight="bold" font-size="11" fill="#2b6cb0">Sample Collection Points</text>

            <!-- OPD Collection -->
            <rect x="25" y="55" width="160" height="65" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="105" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">OPD Collection Room</text>
            <text x="35" y="90" font-size="6" fill="#2c5282"> Phlebotomy station</text>
            <text x="35" y="103" font-size="6" fill="#2c5282"> Patient verification</text>
            <text x="35" y="116" font-size="6" fill="#2c5282"> Barcode labeling</text>

            <!-- IPD Bedside -->
            <rect x="200" y="55" width="160" height="65" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="280" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">IPD Bedside</text>
            <text x="210" y="90" font-size="6" fill="#276749"> Nurse/technician collection</text>
            <text x="210" y="103" font-size="6" fill="#276749"> Ward-specific timing</text>
            <text x="210" y="116" font-size="6" fill="#276749"> Urgent STAT samples</text>

            <!-- Emergency -->
            <rect x="375" y="55" width="160" height="65" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="455" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Emergency Lab</text>
            <text x="385" y="90" font-size="6" fill="#742a2a"> 24/7 availability</text>
            <text x="385" y="103" font-size="6" fill="#742a2a"> Priority processing</text>
            <text x="385" y="116" font-size="6" fill="#742a2a"> Critical value alerts</text>

            <!-- Home Collection -->
            <rect x="550" y="55" width="175" height="65" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="637" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Home Collection</text>
            <text x="560" y="90" font-size="6" fill="#7b341e"> Scheduled appointments</text>
            <text x="560" y="103" font-size="6" fill="#7b341e"> Cold chain transport</text>
            <text x="560" y="116" font-size="6" fill="#7b341e"> GPS tracking</text>

            <!-- Collection Workflow Steps -->
            <rect x="10" y="145" width="730" height="160" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="375" y="170" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Sample Collection Workflow Steps</text>

            <!-- Step 1: Verify -->
            <rect x="25" y="190" width="130" height="100" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="90" y="208" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">1. VERIFY</text>
            <text x="35" y="225" font-size="6" fill="#22543d"> Patient ID check</text>
            <text x="35" y="238" font-size="6" fill="#22543d"> Order confirmation</text>
            <text x="35" y="251" font-size="6" fill="#22543d"> Test requirements</text>
            <text x="35" y="264" font-size="6" fill="#22543d"> Fasting status</text>
            <text x="35" y="277" font-size="6" fill="#22543d"> Allergies check</text>

            <!-- Step 2: Collect -->
            <rect x="170" y="190" width="130" height="100" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="235" y="208" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">2. COLLECT</text>
            <text x="180" y="225" font-size="6" fill="#22543d"> Select correct tube</text>
            <text x="180" y="238" font-size="6" fill="#22543d"> Proper technique</text>
            <text x="180" y="251" font-size="6" fill="#22543d"> Adequate volume</text>
            <text x="180" y="264" font-size="6" fill="#22543d"> Patient comfort</text>
            <text x="180" y="277" font-size="6" fill="#22543d"> Timestamp record</text>

            <!-- Step 3: Label -->
            <rect x="315" y="190" width="130" height="100" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="380" y="208" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">3. LABEL</text>
            <text x="325" y="225" font-size="6" fill="#2c5282"> Barcode generation</text>
            <text x="325" y="238" font-size="6" fill="#2c5282"> Patient name + MRN</text>
            <text x="325" y="251" font-size="6" fill="#2c5282"> Test codes</text>
            <text x="325" y="264" font-size="6" fill="#2c5282"> Collection time</text>
            <text x="325" y="277" font-size="6" fill="#2c5282"> Collector ID</text>

            <!-- Step 4: Transport -->
            <rect x="460" y="190" width="130" height="100" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="525" y="208" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">4. TRANSPORT</text>
            <text x="470" y="225" font-size="6" fill="#44337a"> Cold chain (2-8C)</text>
            <text x="470" y="238" font-size="6" fill="#44337a"> Light protection</text>
            <text x="470" y="251" font-size="6" fill="#44337a"> Upright position</text>
            <text x="470" y="264" font-size="6" fill="#44337a"> Time constraints</text>
            <text x="470" y="277" font-size="6" fill="#44337a"> Biohazard handling</text>

            <!-- Step 5: Receive -->
            <rect x="605" y="190" width="120" height="100" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="665" y="208" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">5. RECEIVE</text>
            <text x="615" y="225" font-size="6" fill="#7b341e"> Lab reception</text>
            <text x="615" y="238" font-size="6" fill="#7b341e"> Quality check</text>
            <text x="615" y="251" font-size="6" fill="#7b341e"> LIS accessioning</text>
            <text x="615" y="264" font-size="6" fill="#7b341e"> Reject criteria</text>
            <text x="615" y="277" font-size="6" fill="#7b341e"> Status update</text>

            <!-- Arrows between steps -->
            <path d="M155,240 L168,240" stroke="#38a169" stroke-width="1.5" marker-end="url(#sampleArrow)"/>
            <path d="M300,240 L313,240" stroke="#38a169" stroke-width="1.5" marker-end="url(#sampleArrow)"/>
            <path d="M445,240 L458,240" stroke="#38a169" stroke-width="1.5" marker-end="url(#sampleArrow)"/>
            <path d="M590,240 L603,240" stroke="#38a169" stroke-width="1.5" marker-end="url(#sampleArrow)"/>

            <!-- Processing Section -->
            <rect x="10" y="320" width="730" height="170" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="345" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Laboratory Processing &amp; Analysis</text>

            <!-- Pre-analytical -->
            <rect x="25" y="365" width="165" height="115" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="107" y="383" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Pre-Analytical</text>
            <text x="35" y="400" font-size="6" fill="#7b341e"> Centrifugation</text>
            <text x="35" y="413" font-size="6" fill="#7b341e"> Serum/plasma separation</text>
            <text x="35" y="426" font-size="6" fill="#7b341e"> Aliquoting</text>
            <text x="35" y="439" font-size="6" fill="#7b341e"> Sample storage</text>
            <text x="35" y="452" font-size="6" fill="#7b341e"> Instrument loading</text>
            <text x="35" y="468" font-size="7" fill="#c05621">TAT begins</text>

            <!-- Analytical -->
            <rect x="205" y="365" width="165" height="115" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="287" y="383" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Analytical Phase</text>
            <text x="215" y="400" font-size="6" fill="#44337a"> Automated analyzers</text>
            <text x="215" y="413" font-size="6" fill="#44337a"> Manual testing</text>
            <text x="215" y="426" font-size="6" fill="#44337a"> Quality controls</text>
            <text x="215" y="439" font-size="6" fill="#44337a"> Calibration checks</text>
            <text x="215" y="452" font-size="6" fill="#44337a"> Repeat if needed</text>
            <text x="215" y="468" font-size="7" fill="#553c9a">tat_hours monitored</text>

            <!-- Post-analytical -->
            <rect x="385" y="365" width="165" height="115" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="467" y="383" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Post-Analytical</text>
            <text x="395" y="400" font-size="6" fill="#276749"> Result validation</text>
            <text x="395" y="413" font-size="6" fill="#276749"> Normal range comparison</text>
            <text x="395" y="426" font-size="6" fill="#276749"> Critical value alerts</text>
            <text x="395" y="439" font-size="6" fill="#276749"> Pathologist review</text>
            <text x="395" y="452" font-size="6" fill="#276749"> Result authorization</text>
            <text x="395" y="468" font-size="7" fill="#22543d">performed_by set</text>

            <!-- Report Generation -->
            <rect x="565" y="365" width="160" height="115" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="645" y="383" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Report Generation</text>
            <text x="575" y="400" font-size="6" fill="#2c5282"> PDF report creation</text>
            <text x="575" y="413" font-size="6" fill="#2c5282"> Digital signature</text>
            <text x="575" y="426" font-size="6" fill="#2c5282"> Print copy</text>
            <text x="575" y="439" font-size="6" fill="#2c5282"> EMR integration</text>
            <text x="575" y="452" font-size="6" fill="#2c5282"> Patient portal access</text>
            <text x="575" y="468" font-size="7" fill="#2b6cb0">Status: COMPLETED</text>
        </svg>
    </div>

    <!-- Diagram 4: Result Entry & Reporting -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Result Entry, Validation &amp; Reporting Workflow</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="resultArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#48bb78"/>
                </marker>
                <marker id="resultArrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#e53e3e"/>
                </marker>
            </defs>

            <!-- Result Entry Section -->
            <rect x="10" y="10" width="355" height="200" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Result Entry (LabOrderDetail)</text>

            <!-- Result Fields -->
            <rect x="25" y="55" width="155" height="145" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="102" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Result Data</text>
            <text x="35" y="91" font-size="7" fill="#22543d">result (text/JSON)</text>
            <text x="45" y="106" font-size="6" fill="#276749">Single value: "85"</text>
            <text x="45" y="119" font-size="6" fill="#276749">JSON: {"wbc": 7500,...}</text>
            <text x="35" y="136" font-size="7" fill="#22543d">result_date (datetime)</text>
            <text x="35" y="153" font-size="7" fill="#22543d">performed_by  User</text>
            <text x="35" y="170" font-size="7" fill="#22543d">status: 'completed'</text>
            <text x="35" y="187" font-size="7" fill="#22543d">notes (remarks)</text>

            <!-- Reference Ranges -->
            <rect x="195" y="55" width="155" height="145" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="272" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Reference Comparison</text>
            <text x="205" y="91" font-size="7" fill="#22543d">From LabTest model:</text>
            <text x="215" y="106" font-size="6" fill="#276749">normal_range: "70-100"</text>
            <text x="215" y="119" font-size="6" fill="#276749">unit: "mg/dL"</text>
            <text x="205" y="139" font-size="7" fill="#22543d">Result Interpretation:</text>
            <text x="215" y="154" font-size="6" fill="#22543d"> Normal (within range)</text>
            <text x="215" y="167" font-size="6" fill="#d69e2e"> High (above range)</text>
            <text x="215" y="180" font-size="6" fill="#3182ce"> Low (below range)</text>
            <text x="215" y="193" font-size="6" fill="#e53e3e"> Critical (alert!)</text>

            <!-- Validation Section -->
            <rect x="385" y="10" width="355" height="200" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">Result Validation &amp; QC</text>

            <!-- Validation Steps -->
            <rect x="400" y="55" width="155" height="145" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="477" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Validation Checks</text>
            <text x="410" y="91" font-size="7" fill="#2c5282"> Delta check (vs previous)</text>
            <text x="410" y="106" font-size="7" fill="#2c5282"> Biological plausibility</text>
            <text x="410" y="121" font-size="7" fill="#2c5282"> QC sample results</text>
            <text x="410" y="136" font-size="7" fill="#2c5282"> Instrument flags</text>
            <text x="410" y="151" font-size="7" fill="#2c5282"> Repeat if abnormal</text>
            <text x="410" y="166" font-size="7" fill="#2c5282"> Supervisor review</text>
            <text x="410" y="181" font-size="7" fill="#2c5282"> Reflex testing trigger</text>

            <!-- Authorization -->
            <rect x="570" y="55" width="155" height="145" rx="4" fill="#90cdf4" stroke="#3182ce"/>
            <text x="647" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2a4365">Authorization</text>
            <text x="580" y="91" font-size="7" fill="#2a4365">Technician Entry</text>
            <text x="590" y="106" font-size="6" fill="#2a4365"> performed_by set</text>
            <text x="580" y="126" font-size="7" fill="#2a4365">Pathologist Review</text>
            <text x="590" y="141" font-size="6" fill="#2a4365"> For critical/abnormal</text>
            <text x="580" y="161" font-size="7" fill="#2a4365">Digital Signature</text>
            <text x="590" y="176" font-size="6" fill="#2a4365"> Report authorized</text>
            <text x="580" y="193" font-size="7" fill="#2a4365">Status  COMPLETED</text>

            <!-- Critical Values Alert -->
            <rect x="10" y="225" width="355" height="130" rx="6" fill="#fed7d7" stroke="#e53e3e" stroke-width="2"/>
            <text x="187" y="250" text-anchor="middle" font-weight="bold" font-size="11" fill="#c53030">Critical Values Alert System</text>

            <rect x="25" y="270" width="155" height="75" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="102" y="288" text-anchor="middle" font-weight="bold" font-size="9" fill="white">Critical Values</text>
            <text x="35" y="305" font-size="6" fill="white"> Glucose &lt;50 or &gt;400 mg/dL</text>
            <text x="35" y="318" font-size="6" fill="white"> Potassium &lt;2.5 or &gt;6.5 mEq/L</text>
            <text x="35" y="331" font-size="6" fill="white"> Hemoglobin &lt;7 g/dL</text>
            <text x="35" y="344" font-size="6" fill="white"> Platelets &lt;20,000/L</text>

            <rect x="195" y="270" width="155" height="75" rx="4" fill="#feb2b2" stroke="#f56565"/>
            <text x="272" y="288" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">Alert Actions</text>
            <text x="205" y="305" font-size="6" fill="#742a2a"> Immediate phone call</text>
            <text x="205" y="318" font-size="6" fill="#742a2a"> SMS to ordering doctor</text>
            <text x="205" y="331" font-size="6" fill="#742a2a"> Documentation required</text>
            <text x="205" y="344" font-size="6" fill="#742a2a"> Read-back confirmation</text>

            <!-- Report Delivery Section -->
            <rect x="385" y="225" width="355" height="130" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="562" y="250" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Report Delivery Channels</text>

            <rect x="400" y="270" width="100" height="75" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="450" y="288" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Print</text>
            <text x="410" y="305" font-size="6" fill="#44337a"> Hard copy</text>
            <text x="410" y="318" font-size="6" fill="#44337a"> Patient pickup</text>
            <text x="410" y="331" font-size="6" fill="#44337a"> Ward delivery</text>
            <text x="410" y="344" font-size="6" fill="#44337a"> File in chart</text>

            <rect x="515" y="270" width="100" height="75" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="565" y="288" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">Digital</text>
            <text x="525" y="305" font-size="6" fill="#702459"> Patient portal</text>
            <text x="525" y="318" font-size="6" fill="#702459"> Email report</text>
            <text x="525" y="331" font-size="6" fill="#702459"> SMS notification</text>
            <text x="525" y="344" font-size="6" fill="#702459"> Mobile app</text>

            <rect x="630" y="270" width="100" height="75" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="680" y="288" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">EMR</text>
            <text x="640" y="305" font-size="6" fill="#276749"> Auto-populated</text>
            <text x="640" y="318" font-size="6" fill="#276749"> Doctor dashboard</text>
            <text x="640" y="331" font-size="6" fill="#276749"> OPD/IPD view</text>
            <text x="640" y="344" font-size="6" fill="#276749"> Trend analysis</text>

            <!-- Status Flow Summary -->
            <rect x="10" y="370" width="730" height="120" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="395" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">LabOrderDetail Status Transitions</text>

            <!-- Status boxes -->
            <rect x="30" y="415" width="95" height="60" rx="4" fill="#e2e8f0" stroke="#718096"/>
            <text x="77" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#4a5568">PENDING</text>
            <text x="77" y="450" text-anchor="middle" font-size="6" fill="#718096">Awaiting sample</text>
            <text x="77" y="465" text-anchor="middle" font-size="6" fill="#718096">result: null</text>

            <rect x="145" y="415" width="95" height="60" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="192" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">COLLECTED</text>
            <text x="192" y="450" text-anchor="middle" font-size="6" fill="#744210">Sample received</text>
            <text x="192" y="465" text-anchor="middle" font-size="6" fill="#744210">In queue</text>

            <rect x="260" y="415" width="95" height="60" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="307" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">PROCESSING</text>
            <text x="307" y="450" text-anchor="middle" font-size="6" fill="#2c5282">Analysis running</text>
            <text x="307" y="465" text-anchor="middle" font-size="6" fill="#2c5282">On analyzer</text>

            <rect x="375" y="415" width="95" height="60" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="422" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">RESULTED</text>
            <text x="422" y="450" text-anchor="middle" font-size="6" fill="#44337a">Result entered</text>
            <text x="422" y="465" text-anchor="middle" font-size="6" fill="#44337a">Awaiting review</text>

            <rect x="490" y="415" width="95" height="60" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="537" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">VALIDATED</text>
            <text x="537" y="450" text-anchor="middle" font-size="6" fill="#22543d">QC passed</text>
            <text x="537" y="465" text-anchor="middle" font-size="6" fill="#22543d">Authorized</text>

            <rect x="605" y="415" width="95" height="60" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="652" y="435" text-anchor="middle" font-weight="bold" font-size="8" fill="white">COMPLETED</text>
            <text x="652" y="450" text-anchor="middle" font-size="6" fill="white">Report ready</text>
            <text x="652" y="465" text-anchor="middle" font-size="6" fill="white">Delivered</text>

            <!-- Flow arrows -->
            <path d="M125,445 L143,445" stroke="#48bb78" stroke-width="1.5" marker-end="url(#resultArrow)"/>
            <path d="M240,445 L258,445" stroke="#48bb78" stroke-width="1.5" marker-end="url(#resultArrow)"/>
            <path d="M355,445 L373,445" stroke="#48bb78" stroke-width="1.5" marker-end="url(#resultArrow)"/>
            <path d="M470,445 L488,445" stroke="#48bb78" stroke-width="1.5" marker-end="url(#resultArrow)"/>
            <path d="M585,445 L603,445" stroke="#48bb78" stroke-width="1.5" marker-end="url(#resultArrow)"/>
        </svg>
    </div>

    <div class="info-box">
        <h4>Laboratory Management Workflow Key Points</h4>
        <ul>
            <li><strong>Test Catalog:</strong> LabCategory organizes tests; LabTest defines test_code, rate, sample_type, normal_range, unit, tat_hours, method</li>
            <li><strong>Order Management:</strong> LabOrder links to patient, doctor, OPD visit or IPD admission; details() contains individual tests</li>
            <li><strong>Sample Types:</strong> Blood (serum/plasma/EDTA), Urine, Stool, Swab, CSF, Tissue - each with specific collection requirements</li>
            <li><strong>Collection Workflow:</strong> Verify patient  Collect sample  Label with barcode  Transport with cold chain  Receive at lab</li>
            <li><strong>Processing Phases:</strong> Pre-analytical (centrifugation, aliquoting)  Analytical (testing)  Post-analytical (validation, reporting)</li>
            <li><strong>Result Entry:</strong> LabOrderDetail stores result, result_date, performed_by; compared against normal_range for interpretation</li>
            <li><strong>Critical Values:</strong> Immediate phone notification to ordering doctor with read-back confirmation required</li>
            <li><strong>Report Delivery:</strong> Print, patient portal, email, SMS, and direct EMR integration for seamless clinical workflow</li>
        </ul>
    </div>
</div>

<!-- Section 4.13: Radiology Module -->
<div class="section" style="page-break-before: always;">
    <h2>4.13 Radiology &amp; Imaging Module</h2>
    <p>The radiology system manages diagnostic imaging orders, modality scheduling, PACS/DICOM integration, radiologist reporting with critical findings alerts, and image delivery to clinicians through the EMR.</p>

    <!-- Diagram 1: Radiology Order Lifecycle -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Radiology Order Lifecycle - From Order to Report</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="radArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#d53f8c"/>
                </marker>
            </defs>

            <!-- Order Sources -->
            <rect x="10" y="10" width="730" height="65" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="375" y="32" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Radiology Order Sources</text>

            <rect x="50" y="42" width="130" height="25" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="115" y="59" text-anchor="middle" font-size="8" fill="#44337a">OPD Consultation</text>

            <rect x="200" y="42" width="130" height="25" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="265" y="59" text-anchor="middle" font-size="8" fill="#702459">IPD Admission</text>

            <rect x="350" y="42" width="130" height="25" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="415" y="59" text-anchor="middle" font-size="8" fill="#742a2a">Emergency</text>

            <rect x="500" y="42" width="130" height="25" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="565" y="59" text-anchor="middle" font-size="8" fill="#22543d">Pre-Operative</text>

            <rect x="650" y="42" width="80" height="25" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="690" y="59" text-anchor="middle" font-size="8" fill="#7b341e">Referral</text>

            <!-- RadiologyOrder Model -->
            <rect x="10" y="90" width="355" height="200" rx="6" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="187" y="115" text-anchor="middle" font-weight="bold" font-size="12" fill="#97266d">RadiologyOrder Model</text>

            <!-- Core Fields -->
            <rect x="25" y="135" width="155" height="145" rx="4" fill="#fbb6ce" stroke="#d53f8c"/>
            <text x="102" y="153" text-anchor="middle" font-weight="bold" font-size="9" fill="#702459">Core Fields</text>
            <text x="35" y="171" font-size="7" fill="#702459">radiology_order_id (PK)</text>
            <text x="35" y="186" font-size="7" fill="#702459">order_number (RAD+date)</text>
            <text x="35" y="201" font-size="7" fill="#702459">hospital_id  Hospital</text>
            <text x="35" y="216" font-size="7" fill="#702459">patient_id  Patient</text>
            <text x="35" y="231" font-size="7" fill="#702459">referring_doctor_id</text>
            <text x="35" y="246" font-size="7" fill="#702459">order_date, order_time</text>
            <text x="35" y="261" font-size="7" fill="#702459">priority: routine/urgent/stat</text>

            <!-- Clinical Context -->
            <rect x="195" y="135" width="155" height="145" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="272" y="153" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Clinical Context</text>
            <text x="205" y="171" font-size="7" fill="#702459">opd_id  OpdVisit</text>
            <text x="205" y="186" font-size="7" fill="#702459">ipd_id  IpdAdmission</text>
            <text x="205" y="201" font-size="7" fill="#702459">clinical_indication</text>
            <text x="205" y="216" font-size="7" fill="#702459">clinical_history</text>
            <text x="205" y="231" font-size="7" fill="#702459">pregnancy_status</text>
            <text x="205" y="249" font-size="7" fill="#702459">Billing:</text>
            <text x="215" y="264" font-size="6" fill="#97266d">total_amount, discount, net</text>

            <!-- RadiologyOrderDetail Model -->
            <rect x="385" y="90" width="355" height="200" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="115" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">RadiologyOrderDetail Model</text>

            <!-- Detail Fields -->
            <rect x="400" y="135" width="155" height="145" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="477" y="153" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Detail Fields</text>
            <text x="410" y="171" font-size="7" fill="#2c5282">detail_id (PK)</text>
            <text x="410" y="186" font-size="7" fill="#2c5282">radiology_order_id  Order</text>
            <text x="410" y="201" font-size="7" fill="#2c5282">radiology_test_id  Test</text>
            <text x="410" y="216" font-size="7" fill="#2c5282">modality_id  Modality</text>
            <text x="410" y="231" font-size="7" fill="#2c5282">rate, amount</text>
            <text x="410" y="246" font-size="7" fill="#2c5282">scheduled_datetime</text>
            <text x="410" y="261" font-size="7" fill="#2c5282">status (per test)</text>

            <!-- Contrast Options -->
            <rect x="570" y="135" width="155" height="145" rx="4" fill="#90cdf4" stroke="#3182ce"/>
            <text x="647" y="153" text-anchor="middle" font-weight="bold" font-size="9" fill="#2a4365">Contrast Options</text>
            <text x="580" y="171" font-size="7" fill="#2a4365">with_contrast: boolean</text>
            <text x="580" y="186" font-size="7" fill="#2a4365">contrast_rate (if applicable)</text>
            <text x="580" y="206" font-size="7" fill="#2a4365">Contrast Types:</text>
            <text x="590" y="221" font-size="6" fill="#2a4365"> Iodinated (CT)</text>
            <text x="590" y="234" font-size="6" fill="#2a4365"> Gadolinium (MRI)</text>
            <text x="590" y="247" font-size="6" fill="#2a4365"> Barium (Fluoroscopy)</text>
            <text x="580" y="265" font-size="7" fill="#2a4365">Allergy screening required</text>

            <!-- Order Status Flow -->
            <rect x="10" y="305" width="730" height="95" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="327" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Radiology Order Status Workflow</text>

            <!-- Status boxes -->
            <rect x="25" y="345" width="95" height="45" rx="4" fill="#e2e8f0" stroke="#718096"/>
            <text x="72" y="363" text-anchor="middle" font-weight="bold" font-size="8" fill="#4a5568">ORDERED</text>
            <text x="72" y="378" font-size="6" fill="#718096">Tests requested</text>

            <rect x="135" y="345" width="95" height="45" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="182" y="363" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">SCHEDULED</text>
            <text x="182" y="378" font-size="6" fill="#744210">Time slot assigned</text>

            <rect x="245" y="345" width="95" height="45" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="292" y="363" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">CHECKED_IN</text>
            <text x="292" y="378" font-size="6" fill="#2c5282">Patient arrived</text>

            <rect x="355" y="345" width="95" height="45" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="402" y="363" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">IMAGING</text>
            <text x="402" y="378" font-size="6" fill="#44337a">Scan in progress</text>

            <rect x="465" y="345" width="95" height="45" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="512" y="363" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">REPORTING</text>
            <text x="512" y="378" font-size="6" fill="#702459">Radiologist review</text>

            <rect x="575" y="345" width="95" height="45" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="622" y="363" text-anchor="middle" font-weight="bold" font-size="8" fill="white">COMPLETED</text>
            <text x="622" y="378" font-size="6" fill="white">Report ready</text>

            <!-- Flow arrows -->
            <path d="M120,367 L133,367" stroke="#d53f8c" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <path d="M230,367 L243,367" stroke="#d53f8c" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <path d="M340,367 L353,367" stroke="#d53f8c" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <path d="M450,367 L463,367" stroke="#d53f8c" stroke-width="1.5" marker-end="url(#radArrow)"/>
            <path d="M560,367 L573,367" stroke="#d53f8c" stroke-width="1.5" marker-end="url(#radArrow)"/>

            <!-- Cancelled status -->
            <rect x="685" y="345" width="50" height="45" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="710" y="368" text-anchor="middle" font-weight="bold" font-size="7" fill="white">CANCEL</text>

            <!-- Relationships -->
            <rect x="10" y="415" width="730" height="95" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="375" y="437" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Model Relationships &amp; Report Generation</text>

            <rect x="25" y="455" width="165" height="45" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="107" y="473" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Order  Details</text>
            <text x="35" y="490" font-size="6" fill="#276749">details()  HasMany RadiologyOrderDetail</text>

            <rect x="205" y="455" width="165" height="45" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="287" y="473" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Order  Report</text>
            <text x="215" y="490" font-size="6" fill="#276749">report()  HasOne RadiologyReport</text>

            <rect x="385" y="455" width="165" height="45" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="467" y="473" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">Referring Doctor</text>
            <text x="395" y="490" font-size="6" fill="#2c5282">referringDoctor()  BelongsTo Doctor</text>

            <rect x="565" y="455" width="165" height="45" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="647" y="473" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Order Number</text>
            <text x="575" y="490" font-size="6" fill="#7b341e">RAD + YYYYMMDD + sequence</text>
        </svg>
    </div>

    <!-- Diagram 2: Modality & Test Catalog -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Radiology Modalities &amp; Test Catalog</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="modArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#805ad5"/>
                </marker>
            </defs>

            <!-- RadiologyModality Model -->
            <rect x="10" y="10" width="355" height="175" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">RadiologyModality Model</text>

            <!-- Modality Fields -->
            <rect x="25" y="55" width="155" height="120" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="102" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Fields</text>
            <text x="35" y="91" font-size="7" fill="#44337a">modality_id (PK)</text>
            <text x="35" y="106" font-size="7" fill="#44337a">hospital_id  Hospital</text>
            <text x="35" y="121" font-size="7" fill="#44337a">modality_code (CT, MR, US)</text>
            <text x="35" y="136" font-size="7" fill="#44337a">modality_name</text>
            <text x="35" y="151" font-size="7" fill="#44337a">room_number</text>
            <text x="35" y="166" font-size="7" fill="#44337a">default_tat_hours</text>

            <!-- Modality Options -->
            <rect x="195" y="55" width="155" height="120" rx="4" fill="#d6bcfa" stroke="#805ad5"/>
            <text x="272" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Options</text>
            <text x="205" y="91" font-size="7" fill="#44337a">is_contrast_available: bool</text>
            <text x="205" y="106" font-size="7" fill="#44337a">is_active: boolean</text>
            <text x="205" y="124" font-size="7" fill="#44337a">Relationship:</text>
            <text x="215" y="139" font-size="6" fill="#553c9a">tests()  HasMany</text>
            <text x="215" y="152" font-size="6" fill="#553c9a">RadiologyTest</text>
            <text x="205" y="168" font-size="7" fill="#44337a">scopeActive()</text>

            <!-- RadiologyTest Model -->
            <rect x="385" y="10" width="355" height="175" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">RadiologyTest Model</text>

            <!-- Test Identification -->
            <rect x="400" y="55" width="155" height="120" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="477" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Identification</text>
            <text x="410" y="91" font-size="7" fill="#2c5282">radiology_test_id (PK)</text>
            <text x="410" y="106" font-size="7" fill="#2c5282">modality_id  Modality</text>
            <text x="410" y="121" font-size="7" fill="#2c5282">test_code (unique)</text>
            <text x="410" y="136" font-size="7" fill="#2c5282">test_name</text>
            <text x="410" y="151" font-size="7" fill="#2c5282">body_part (chest, head...)</text>
            <text x="410" y="166" font-size="7" fill="#2c5282">laterality (left/right/both)</text>

            <!-- Test Details -->
            <rect x="570" y="55" width="155" height="120" rx="4" fill="#90cdf4" stroke="#3182ce"/>
            <text x="647" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2a4365">Details &amp; Pricing</text>
            <text x="580" y="91" font-size="7" fill="#2a4365">cpt_code (billing)</text>
            <text x="580" y="106" font-size="7" fill="#2a4365">rate (base price)</text>
            <text x="580" y="121" font-size="7" fill="#2a4365">contrast_required: bool</text>
            <text x="580" y="136" font-size="7" fill="#2a4365">contrast_rate (add-on)</text>
            <text x="580" y="151" font-size="7" fill="#2a4365">consent_required: bool</text>
            <text x="580" y="166" font-size="7" fill="#2a4365">tat_hours, is_active</text>

            <!-- Modality Types -->
            <rect x="10" y="200" width="730" height="145" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="225" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Imaging Modality Types</text>

            <!-- X-Ray -->
            <rect x="25" y="245" width="100" height="90" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="75" y="263" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">X-RAY (CR/DR)</text>
            <text x="35" y="280" font-size="6" fill="#2c5282"> Chest PA/Lateral</text>
            <text x="35" y="293" font-size="6" fill="#2c5282"> Abdomen</text>
            <text x="35" y="306" font-size="6" fill="#2c5282"> Extremities</text>
            <text x="35" y="319" font-size="6" fill="#2c5282"> Spine views</text>

            <!-- CT Scan -->
            <rect x="140" y="245" width="100" height="90" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="190" y="263" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">CT SCAN</text>
            <text x="150" y="280" font-size="6" fill="#702459"> CT Head/Brain</text>
            <text x="150" y="293" font-size="6" fill="#702459"> CT Chest (HRCT)</text>
            <text x="150" y="306" font-size="6" fill="#702459"> CT Abdomen</text>
            <text x="150" y="319" font-size="6" fill="#702459"> CT Angiography</text>

            <!-- MRI -->
            <rect x="255" y="245" width="100" height="90" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="305" y="263" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">MRI</text>
            <text x="265" y="280" font-size="6" fill="#44337a"> MRI Brain</text>
            <text x="265" y="293" font-size="6" fill="#44337a"> MRI Spine</text>
            <text x="265" y="306" font-size="6" fill="#44337a"> MRI Knee/Joint</text>
            <text x="265" y="319" font-size="6" fill="#44337a"> MRA/MRV</text>

            <!-- Ultrasound -->
            <rect x="370" y="245" width="100" height="90" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="420" y="263" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">ULTRASOUND</text>
            <text x="380" y="280" font-size="6" fill="#276749"> USG Abdomen</text>
            <text x="380" y="293" font-size="6" fill="#276749"> USG Pelvis</text>
            <text x="380" y="306" font-size="6" fill="#276749"> Obstetric USG</text>
            <text x="380" y="319" font-size="6" fill="#276749"> Doppler studies</text>

            <!-- Mammography -->
            <rect x="485" y="245" width="100" height="90" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="535" y="263" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">MAMMOGRAPHY</text>
            <text x="495" y="280" font-size="6" fill="#7b341e"> Screening</text>
            <text x="495" y="293" font-size="6" fill="#7b341e"> Diagnostic</text>
            <text x="495" y="306" font-size="6" fill="#7b341e"> Tomosynthesis</text>
            <text x="495" y="319" font-size="6" fill="#7b341e"> BI-RADS scoring</text>

            <!-- Fluoroscopy -->
            <rect x="600" y="245" width="125" height="90" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="662" y="263" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">FLUOROSCOPY</text>
            <text x="610" y="280" font-size="6" fill="#744210"> Barium Swallow</text>
            <text x="610" y="293" font-size="6" fill="#744210"> Barium Meal/Enema</text>
            <text x="610" y="306" font-size="6" fill="#744210"> IVP/MCU/RGU</text>
            <text x="610" y="319" font-size="6" fill="#744210"> Hysterosalpingography</text>

            <!-- Test Preparation Instructions -->
            <rect x="10" y="360" width="730" height="130" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="375" y="385" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Patient Preparation Instructions (preparation_instructions field)</text>

            <rect x="25" y="405" width="165" height="75" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="107" y="423" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Fasting Required</text>
            <text x="35" y="440" font-size="6" fill="#276749"> CT Abdomen with contrast</text>
            <text x="35" y="453" font-size="6" fill="#276749"> USG Abdomen</text>
            <text x="35" y="466" font-size="6" fill="#276749"> Barium studies</text>
            <text x="35" y="479" font-size="6" fill="#276749">6-8 hours fasting</text>

            <rect x="205" y="405" width="165" height="75" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="287" y="423" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">Bladder Full</text>
            <text x="215" y="440" font-size="6" fill="#744210"> USG Pelvis</text>
            <text x="215" y="453" font-size="6" fill="#744210"> Early Obstetric USG</text>
            <text x="215" y="466" font-size="6" fill="#744210">Drink 4-5 glasses water</text>
            <text x="215" y="479" font-size="6" fill="#744210">1 hour before scan</text>

            <rect x="385" y="405" width="165" height="75" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="467" y="423" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">Contrast Prep</text>
            <text x="395" y="440" font-size="6" fill="#702459"> Kidney function test (eGFR)</text>
            <text x="395" y="453" font-size="6" fill="#702459"> Allergy history check</text>
            <text x="395" y="466" font-size="6" fill="#702459"> Hydration protocol</text>
            <text x="395" y="479" font-size="6" fill="#702459"> Consent signed</text>

            <rect x="565" y="405" width="165" height="75" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="647" y="423" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">MRI Screening</text>
            <text x="575" y="440" font-size="6" fill="#44337a"> Metal implants check</text>
            <text x="575" y="453" font-size="6" fill="#44337a"> Pacemaker exclusion</text>
            <text x="575" y="466" font-size="6" fill="#44337a"> Claustrophobia assess</text>
            <text x="575" y="479" font-size="6" fill="#44337a"> Remove jewelry/metals</text>
        </svg>
    </div>

    <!-- Diagram 3: Imaging & PACS Integration -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Imaging Workflow &amp; PACS/DICOM Integration</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="pacsArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#3182ce"/>
                </marker>
            </defs>

            <!-- RadiologyImage Model -->
            <rect x="10" y="10" width="355" height="200" rx="6" fill="#ebf8ff" stroke="#3182ce" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2b6cb0">RadiologyImage Model</text>

            <!-- Image Fields -->
            <rect x="25" y="55" width="155" height="145" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="102" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2b6cb0">Image Fields</text>
            <text x="35" y="91" font-size="7" fill="#2c5282">image_id (PK)</text>
            <text x="35" y="106" font-size="7" fill="#2c5282">hospital_id  Hospital</text>
            <text x="35" y="121" font-size="7" fill="#2c5282">report_id  RadiologyReport</text>
            <text x="35" y="136" font-size="7" fill="#2c5282">detail_id  OrderDetail</text>
            <text x="35" y="151" font-size="7" fill="#2c5282">image_type (DICOM, JPG)</text>
            <text x="35" y="166" font-size="7" fill="#2c5282">file_path</text>
            <text x="35" y="181" font-size="7" fill="#2c5282">thumbnail_path</text>
            <text x="35" y="196" font-size="7" fill="#2c5282">image_notes</text>

            <!-- DICOM UIDs -->
            <rect x="195" y="55" width="155" height="145" rx="4" fill="#90cdf4" stroke="#3182ce"/>
            <text x="272" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#2a4365">DICOM Identifiers</text>
            <text x="205" y="91" font-size="7" fill="#2a4365">study_instance_uid</text>
            <text x="215" y="106" font-size="6" fill="#2a4365">Unique study ID</text>
            <text x="205" y="124" font-size="7" fill="#2a4365">series_instance_uid</text>
            <text x="215" y="139" font-size="6" fill="#2a4365">Series within study</text>
            <text x="205" y="157" font-size="7" fill="#2a4365">sop_instance_uid</text>
            <text x="215" y="172" font-size="6" fill="#2a4365">Individual image</text>
            <text x="205" y="190" font-size="7" fill="#2a4365">pacs_reference_id</text>

            <!-- PACS Architecture -->
            <rect x="385" y="10" width="355" height="200" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">PACS Architecture</text>

            <!-- PACS Components -->
            <rect x="400" y="55" width="155" height="145" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="477" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">PACS Components</text>
            <text x="410" y="91" font-size="7" fill="#276749">Modality Worklist (MWL)</text>
            <text x="420" y="106" font-size="6" fill="#22543d">Patient scheduling</text>
            <text x="410" y="124" font-size="7" fill="#276749">DICOM Storage (SCP)</text>
            <text x="420" y="139" font-size="6" fill="#22543d">Image archive</text>
            <text x="410" y="157" font-size="7" fill="#276749">DICOM Query/Retrieve</text>
            <text x="420" y="172" font-size="6" fill="#22543d">Image access</text>
            <text x="410" y="190" font-size="7" fill="#276749">Web Viewer (WADO)</text>

            <!-- Integration Points -->
            <rect x="570" y="55" width="155" height="145" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="647" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Integration Points</text>
            <text x="580" y="91" font-size="7" fill="#276749">HL7/FHIR messaging</text>
            <text x="580" y="106" font-size="7" fill="#276749">ORM (Order Message)</text>
            <text x="580" y="121" font-size="7" fill="#276749">ORU (Result Message)</text>
            <text x="580" y="139" font-size="7" fill="#276749">ADT (Patient Info)</text>
            <text x="580" y="157" font-size="7" fill="#276749">DICOM MPPS</text>
            <text x="590" y="172" font-size="6" fill="#22543d">Procedure tracking</text>
            <text x="580" y="190" font-size="7" fill="#276749">IHE Profiles</text>

            <!-- Imaging Workflow -->
            <rect x="10" y="225" width="730" height="135" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="375" y="250" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Imaging Acquisition Workflow</text>

            <!-- Step 1: Check-in -->
            <rect x="25" y="270" width="130" height="80" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="90" y="288" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">1. CHECK-IN</text>
            <text x="35" y="305" font-size="6" fill="#44337a"> Patient verification</text>
            <text x="35" y="318" font-size="6" fill="#44337a"> Order confirmation</text>
            <text x="35" y="331" font-size="6" fill="#44337a"> Consent if required</text>
            <text x="35" y="344" font-size="6" fill="#44337a"> Prep verification</text>

            <!-- Step 2: Worklist -->
            <rect x="170" y="270" width="130" height="80" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="235" y="288" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">2. WORKLIST</text>
            <text x="180" y="305" font-size="6" fill="#702459"> Pull patient from MWL</text>
            <text x="180" y="318" font-size="6" fill="#702459"> Auto-populate DICOM</text>
            <text x="180" y="331" font-size="6" fill="#702459"> Verify demographics</text>
            <text x="180" y="344" font-size="6" fill="#702459"> Select protocol</text>

            <!-- Step 3: Acquisition -->
            <rect x="315" y="270" width="130" height="80" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="380" y="288" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">3. ACQUISITION</text>
            <text x="325" y="305" font-size="6" fill="#7b341e"> Position patient</text>
            <text x="325" y="318" font-size="6" fill="#7b341e"> Execute scan</text>
            <text x="325" y="331" font-size="6" fill="#7b341e"> Contrast injection</text>
            <text x="325" y="344" font-size="6" fill="#7b341e"> Multiple series</text>

            <!-- Step 4: QC -->
            <rect x="460" y="270" width="130" height="80" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="525" y="288" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">4. QC REVIEW</text>
            <text x="470" y="305" font-size="6" fill="#276749"> Image quality check</text>
            <text x="470" y="318" font-size="6" fill="#276749"> Coverage complete</text>
            <text x="470" y="331" font-size="6" fill="#276749"> Artifacts review</text>
            <text x="470" y="344" font-size="6" fill="#276749"> Retake if needed</text>

            <!-- Step 5: Archive -->
            <rect x="605" y="270" width="120" height="80" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="665" y="288" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">5. ARCHIVE</text>
            <text x="615" y="305" font-size="6" fill="#2c5282"> Send to PACS</text>
            <text x="615" y="318" font-size="6" fill="#2c5282"> Verify storage</text>
            <text x="615" y="331" font-size="6" fill="#2c5282"> MPPS complete</text>
            <text x="615" y="344" font-size="6" fill="#2c5282"> Status  REPORTING</text>

            <!-- Image Viewing -->
            <rect x="10" y="375" width="730" height="115" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="400" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Image Viewing &amp; Distribution</text>

            <rect x="25" y="420" width="165" height="60" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="107" y="438" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">PACS Workstation</text>
            <text x="35" y="455" font-size="6" fill="#7b341e"> Full DICOM viewer</text>
            <text x="35" y="468" font-size="6" fill="#7b341e"> MPR/3D reconstruction</text>
            <text x="35" y="481" font-size="6" fill="#7b341e"> Measurement tools</text>

            <rect x="205" y="420" width="165" height="60" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="287" y="438" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Web Viewer (EMR)</text>
            <text x="215" y="455" font-size="6" fill="#276749"> Zero-footprint viewer</text>
            <text x="215" y="468" font-size="6" fill="#276749"> Embedded in HIMS</text>
            <text x="215" y="481" font-size="6" fill="#276749"> Thumbnail + full image</text>

            <rect x="385" y="420" width="165" height="60" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="467" y="438" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Patient Portal</text>
            <text x="395" y="455" font-size="6" fill="#44337a"> Report PDF download</text>
            <text x="395" y="468" font-size="6" fill="#44337a"> Key images viewing</text>
            <text x="395" y="481" font-size="6" fill="#44337a"> Share via link</text>

            <rect x="565" y="420" width="165" height="60" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="647" y="438" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">CD/DVD Export</text>
            <text x="575" y="455" font-size="6" fill="#702459"> DICOM media</text>
            <text x="575" y="468" font-size="6" fill="#702459"> Included viewer</text>
            <text x="575" y="481" font-size="6" fill="#702459"> For referrals</text>
        </svg>
    </div>

    <!-- Diagram 4: Reporting & Verification -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Radiologist Reporting &amp; Verification Workflow</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="repArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#48bb78"/>
                </marker>
                <marker id="repArrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#e53e3e"/>
                </marker>
            </defs>

            <!-- RadiologyReport Model -->
            <rect x="10" y="10" width="355" height="210" rx="6" fill="#f0fff4" stroke="#38a169" stroke-width="2"/>
            <text x="187" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">RadiologyReport Model</text>

            <!-- Report Fields -->
            <rect x="25" y="55" width="155" height="155" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="102" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Report Fields</text>
            <text x="35" y="91" font-size="7" fill="#22543d">report_id (PK)</text>
            <text x="35" y="106" font-size="7" fill="#22543d">radiology_order_id  Order</text>
            <text x="35" y="121" font-size="7" fill="#22543d">detail_id  OrderDetail</text>
            <text x="35" y="136" font-size="7" fill="#22543d">patient_id  Patient</text>
            <text x="35" y="151" font-size="7" fill="#22543d">reporting_radiologist_id</text>
            <text x="35" y="166" font-size="7" fill="#22543d">report_date, report_time</text>
            <text x="35" y="181" font-size="7" fill="#22543d">report_status</text>
            <text x="35" y="196" font-size="7" fill="#22543d">report_pdf_path</text>

            <!-- Report Content -->
            <rect x="195" y="55" width="155" height="155" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="272" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Report Content</text>
            <text x="205" y="91" font-size="7" fill="#22543d">technique (procedure)</text>
            <text x="205" y="106" font-size="7" fill="#22543d">findings (detailed)</text>
            <text x="205" y="121" font-size="7" fill="#22543d">impression (summary)</text>
            <text x="205" y="136" font-size="7" fill="#22543d">recommendations</text>
            <text x="205" y="154" font-size="7" fill="#22543d">Verification:</text>
            <text x="215" y="169" font-size="6" fill="#276749">verified_by  Doctor</text>
            <text x="215" y="182" font-size="6" fill="#276749">verified_at (datetime)</text>
            <text x="205" y="199" font-size="7" fill="#22543d">images()  HasMany</text>

            <!-- Critical Findings -->
            <rect x="385" y="10" width="355" height="210" rx="6" fill="#fed7d7" stroke="#e53e3e" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">Critical Findings Workflow</text>

            <!-- Critical Fields -->
            <rect x="400" y="55" width="155" height="155" rx="4" fill="#fc8181" stroke="#e53e3e"/>
            <text x="477" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="white">Critical Finding Fields</text>
            <text x="410" y="91" font-size="7" fill="white">critical_finding: boolean</text>
            <text x="410" y="106" font-size="7" fill="white">critical_finding_communicated</text>
            <text x="410" y="121" font-size="7" fill="white">communicated_to (name)</text>
            <text x="410" y="136" font-size="7" fill="white">communicated_at (datetime)</text>
            <text x="410" y="156" font-size="7" fill="white">Examples:</text>
            <text x="420" y="171" font-size="6" fill="white"> Pulmonary embolism</text>
            <text x="420" y="184" font-size="6" fill="white"> Aortic dissection</text>
            <text x="420" y="197" font-size="6" fill="white"> Tension pneumothorax</text>

            <!-- Communication Protocol -->
            <rect x="570" y="55" width="155" height="155" rx="4" fill="#feb2b2" stroke="#f56565"/>
            <text x="647" y="73" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">Alert Protocol</text>
            <text x="580" y="91" font-size="7" fill="#742a2a">1. Immediate phone call</text>
            <text x="590" y="106" font-size="6" fill="#9b2c2c">to referring doctor</text>
            <text x="580" y="124" font-size="7" fill="#742a2a">2. Document call details</text>
            <text x="590" y="139" font-size="6" fill="#9b2c2c">communicated_to field</text>
            <text x="580" y="157" font-size="7" fill="#742a2a">3. Timestamp recording</text>
            <text x="590" y="172" font-size="6" fill="#9b2c2c">communicated_at</text>
            <text x="580" y="190" font-size="7" fill="#742a2a">4. Read-back confirm</text>
            <text x="580" y="205" font-size="7" fill="#742a2a">5. Escalation if no contact</text>

            <!-- Report Status Flow -->
            <rect x="10" y="235" width="730" height="120" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="375" y="260" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">Report Status Workflow</text>

            <!-- Status boxes -->
            <rect x="30" y="280" width="105" height="60" rx="4" fill="#e2e8f0" stroke="#718096"/>
            <text x="82" y="300" text-anchor="middle" font-weight="bold" font-size="8" fill="#4a5568">PENDING</text>
            <text x="82" y="315" text-anchor="middle" font-size="6" fill="#718096">Awaiting radiologist</text>
            <text x="82" y="330" text-anchor="middle" font-size="6" fill="#718096">In worklist queue</text>

            <rect x="155" y="280" width="105" height="60" rx="4" fill="#faf089" stroke="#d69e2e"/>
            <text x="207" y="300" text-anchor="middle" font-weight="bold" font-size="8" fill="#744210">DICTATING</text>
            <text x="207" y="315" text-anchor="middle" font-size="6" fill="#744210">Voice/typing report</text>
            <text x="207" y="330" text-anchor="middle" font-size="6" fill="#744210">Draft in progress</text>

            <rect x="280" y="280" width="105" height="60" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="332" y="300" text-anchor="middle" font-weight="bold" font-size="8" fill="#2b6cb0">PRELIMINARY</text>
            <text x="332" y="315" text-anchor="middle" font-size="6" fill="#2c5282">Draft complete</text>
            <text x="332" y="330" text-anchor="middle" font-size="6" fill="#2c5282">Awaiting verification</text>

            <rect x="405" y="280" width="105" height="60" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="457" y="300" text-anchor="middle" font-weight="bold" font-size="8" fill="#276749">VERIFIED</text>
            <text x="457" y="315" text-anchor="middle" font-size="6" fill="#22543d">Attending approved</text>
            <text x="457" y="330" text-anchor="middle" font-size="6" fill="#22543d">verified_by set</text>

            <rect x="530" y="280" width="105" height="60" rx="4" fill="#48bb78" stroke="#38a169"/>
            <text x="582" y="300" text-anchor="middle" font-weight="bold" font-size="8" fill="white">FINALIZED</text>
            <text x="582" y="315" text-anchor="middle" font-size="6" fill="white">PDF generated</text>
            <text x="582" y="330" text-anchor="middle" font-size="6" fill="white">Signed/sealed</text>

            <rect x="655" y="280" width="75" height="60" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="692" y="300" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">AMENDED</text>
            <text x="692" y="315" text-anchor="middle" font-size="6" fill="#44337a">Correction</text>
            <text x="692" y="330" text-anchor="middle" font-size="6" fill="#44337a">added</text>

            <!-- Arrows -->
            <path d="M135,310 L153,310" stroke="#805ad5" stroke-width="1.5" marker-end="url(#repArrow)"/>
            <path d="M260,310 L278,310" stroke="#805ad5" stroke-width="1.5" marker-end="url(#repArrow)"/>
            <path d="M385,310 L403,310" stroke="#805ad5" stroke-width="1.5" marker-end="url(#repArrow)"/>
            <path d="M510,310 L528,310" stroke="#805ad5" stroke-width="1.5" marker-end="url(#repArrow)"/>
            <path d="M635,310 L653,310" stroke="#805ad5" stroke-width="1.5" marker-end="url(#repArrow)"/>

            <!-- Report Distribution -->
            <rect x="10" y="370" width="730" height="120" rx="6" fill="#fffaf0" stroke="#ed8936" stroke-width="2"/>
            <text x="375" y="395" text-anchor="middle" font-weight="bold" font-size="11" fill="#c05621">Report Distribution &amp; Access</text>

            <rect x="25" y="415" width="165" height="65" rx="4" fill="#feebc8" stroke="#dd6b20"/>
            <text x="107" y="433" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">EMR Integration</text>
            <text x="35" y="450" font-size="6" fill="#7b341e"> Auto-populate in OPD/IPD</text>
            <text x="35" y="463" font-size="6" fill="#7b341e"> Link to order in patient chart</text>
            <text x="35" y="476" font-size="6" fill="#7b341e"> Embedded image viewer</text>

            <rect x="205" y="415" width="165" height="65" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="287" y="433" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Referring Doctor</text>
            <text x="215" y="450" font-size="6" fill="#276749"> Dashboard notification</text>
            <text x="215" y="463" font-size="6" fill="#276749"> SMS/Email alert</text>
            <text x="215" y="476" font-size="6" fill="#276749"> Critical findings call</text>

            <rect x="385" y="415" width="165" height="65" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="467" y="433" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Patient Portal</text>
            <text x="395" y="450" font-size="6" fill="#44337a"> Report PDF download</text>
            <text x="395" y="463" font-size="6" fill="#44337a"> Key image thumbnails</text>
            <text x="395" y="476" font-size="6" fill="#44337a"> After doctor review</text>

            <rect x="565" y="415" width="165" height="65" rx="4" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="647" y="433" text-anchor="middle" font-weight="bold" font-size="8" fill="#97266d">Printing &amp; Export</text>
            <text x="575" y="450" font-size="6" fill="#702459"> Hardcopy report</text>
            <text x="575" y="463" font-size="6" fill="#702459"> CD with images</text>
            <text x="575" y="476" font-size="6" fill="#702459"> External referral package</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>Radiology &amp; Imaging Workflow Key Points</h4>
        <ul>
            <li><strong>Modality Management:</strong> RadiologyModality defines equipment (CT, MRI, X-Ray, USG) with room_number, contrast availability, and default TAT</li>
            <li><strong>Test Catalog:</strong> RadiologyTest includes test_code, body_part, laterality, cpt_code, rate, contrast_required, consent_required, preparation_instructions</li>
            <li><strong>Order Workflow:</strong> RadiologyOrder with priority levels (routine/urgent/stat), clinical_indication, pregnancy_status; details() for multiple tests</li>
            <li><strong>Scheduling:</strong> RadiologyOrderDetail tracks scheduled_datetime, with_contrast, amount per test; status per individual exam</li>
            <li><strong>PACS Integration:</strong> RadiologyImage stores DICOM UIDs (study/series/sop_instance_uid), pacs_reference_id for seamless image access</li>
            <li><strong>Reporting:</strong> RadiologyReport with structured format (technique, findings, impression, recommendations); verified_by for attending sign-off</li>
            <li><strong>Critical Findings:</strong> critical_finding flag triggers immediate communication protocol with communicated_to and communicated_at documentation</li>
            <li><strong>Distribution:</strong> Reports accessible via EMR, patient portal, print, CD export; images viewable in zero-footprint web viewer</li>
        </ul>
    </div>
</div>

<!-- Section 4.14: IPD (In-Patient Department) Module -->
<div class="section" style="page-break-before: always;">
    <h2>4.14 IPD (In-Patient Department) Module</h2>

    <p>The IPD module manages patient admissions, ward/bed allocation, clinical documentation, and discharge workflows for hospitalized patients.</p>

    <!-- Diagram 1: IPD Admission & Discharge Lifecycle -->
    <div class="diagram">
        <div class="diagram-title">IPD Admission & Discharge Lifecycle</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="ipdArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#2b6cb0"/>
                </marker>
                <linearGradient id="admitGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#48bb78"/>
                    <stop offset="100%" style="stop-color:#38a169"/>
                </linearGradient>
                <linearGradient id="treatGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#4299e1"/>
                    <stop offset="100%" style="stop-color:#3182ce"/>
                </linearGradient>
                <linearGradient id="dischargeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#ed8936"/>
                    <stop offset="100%" style="stop-color:#dd6b20"/>
                </linearGradient>
            </defs>

            <!-- Title Bar -->
            <rect x="10" y="10" width="730" height="35" rx="6" fill="url(#admitGrad)"/>
            <text x="375" y="33" text-anchor="middle" font-weight="bold" font-size="14" fill="white">IPD Admission Sources & Registration Flow</text>

            <!-- Admission Sources -->
            <rect x="10" y="55" width="180" height="120" rx="6" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="100" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">Admission Sources</text>

            <rect x="20" y="85" width="70" height="35" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="55" y="100" text-anchor="middle" font-size="7" fill="#22543d">OPD</text>
            <text x="55" y="112" text-anchor="middle" font-size="6" fill="#276749">opd_id</text>

            <rect x="100" y="85" width="80" height="35" rx="4" fill="#fed7d7" stroke="#fc8181"/>
            <text x="140" y="100" text-anchor="middle" font-size="7" fill="#742a2a">Emergency</text>
            <text x="140" y="112" text-anchor="middle" font-size="6" fill="#9b2c2c">is_emergency</text>

            <rect x="20" y="130" width="70" height="35" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="55" y="145" text-anchor="middle" font-size="7" fill="#744210">Referral</text>
            <text x="55" y="157" text-anchor="middle" font-size="6" fill="#975a16">referral_from</text>

            <rect x="100" y="130" width="80" height="35" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="140" y="145" text-anchor="middle" font-size="7" fill="#44337a">MLC Case</text>
            <text x="140" y="157" text-anchor="middle" font-size="6" fill="#553c9a">mlc_number</text>

            <!-- Arrow -->
            <path d="M195,110 L220,110" stroke="#2b6cb0" stroke-width="2" marker-end="url(#ipdArrow)"/>

            <!-- Registration Box -->
            <rect x="225" y="55" width="170" height="120" rx="6" fill="#ebf8ff" stroke="#4299e1" stroke-width="2"/>
            <text x="310" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#2c5282">Admission Registration</text>

            <text x="235" y="93" font-size="7" fill="#2b6cb0"> ipd_number (auto-generated)</text>
            <text x="235" y="106" font-size="7" fill="#2b6cb0"> admission_date/time</text>
            <text x="235" y="119" font-size="7" fill="#2b6cb0"> admission_type</text>
            <text x="235" y="132" font-size="7" fill="#2b6cb0"> diagnosis_at_admission</text>
            <text x="235" y="145" font-size="7" fill="#2b6cb0"> icd_code (ICD-10)</text>
            <text x="235" y="158" font-size="7" fill="#2b6cb0"> treatment_plan</text>
            <text x="235" y="171" font-size="7" fill="#2b6cb0"> attendant details</text>

            <!-- Arrow -->
            <path d="M400,110 L425,110" stroke="#2b6cb0" stroke-width="2" marker-end="url(#ipdArrow)"/>

            <!-- Doctor Assignment -->
            <rect x="430" y="55" width="150" height="120" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="505" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">Doctor Assignment</text>

            <rect x="440" y="85" width="130" height="25" rx="3" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="505" y="100" text-anchor="middle" font-size="7" fill="#44337a">admitting_doctor_id</text>

            <rect x="440" y="115" width="130" height="25" rx="3" fill="#d6bcfa" stroke="#805ad5"/>
            <text x="505" y="130" text-anchor="middle" font-size="7" fill="#44337a">treating_doctor_id</text>

            <rect x="440" y="145" width="130" height="25" rx="3" fill="#b794f4" stroke="#6b46c1"/>
            <text x="505" y="160" text-anchor="middle" font-size="7" fill="white">consultant_doctor_id</text>

            <!-- Arrow -->
            <path d="M585,110 L610,110" stroke="#2b6cb0" stroke-width="2" marker-end="url(#ipdArrow)"/>

            <!-- Bed Assignment -->
            <rect x="615" y="55" width="125" height="120" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="677" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#975a16">Bed Allocation</text>

            <text x="625" y="93" font-size="7" fill="#744210"> ward_id</text>
            <text x="625" y="106" font-size="7" fill="#744210"> bed_id</text>
            <text x="625" y="119" font-size="7" fill="#744210"> class_id (ward class)</text>
            <text x="625" y="132" font-size="7" fill="#744210"> expected_los</text>

            <rect x="625" y="140" width="105" height="25" rx="3" fill="#faf089" stroke="#d69e2e"/>
            <text x="677" y="156" text-anchor="middle" font-size="7" fill="#744210">bed.occupy()</text>

            <!-- Treatment Phase -->
            <rect x="10" y="190" width="730" height="35" rx="6" fill="url(#treatGrad)"/>
            <text x="375" y="213" text-anchor="middle" font-weight="bold" font-size="14" fill="white">In-Patient Treatment Phase</text>

            <!-- Treatment Components -->
            <rect x="10" y="235" width="145" height="100" rx="6" fill="#ebf8ff" stroke="#4299e1" stroke-width="2"/>
            <text x="82" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">Progress Notes</text>
            <text x="20" y="273" font-size="6" fill="#2b6cb0"> SOAP format</text>
            <text x="20" y="286" font-size="6" fill="#2b6cb0"> note_type classification</text>
            <text x="20" y="299" font-size="6" fill="#2b6cb0"> Daily rounds documentation</text>
            <text x="20" y="312" font-size="6" fill="#2b6cb0"> Doctor sign-off</text>
            <text x="82" y="328" text-anchor="middle" font-size="6" fill="#2c5282" font-style="italic">IpdProgressNote</text>

            <rect x="165" y="235" width="145" height="100" rx="6" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="237" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Nursing Charts</text>
            <text x="175" y="273" font-size="6" fill="#22543d"> Shift-based charting</text>
            <text x="175" y="286" font-size="6" fill="#22543d"> Vital signs monitoring</text>
            <text x="175" y="299" font-size="6" fill="#22543d"> I/O balance tracking</text>
            <text x="175" y="312" font-size="6" fill="#22543d"> Wound/IV assessment</text>
            <text x="237" y="328" text-anchor="middle" font-size="6" fill="#276749" font-style="italic">IpdNursingChart</text>

            <rect x="320" y="235" width="145" height="100" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="392" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Medications</text>
            <text x="330" y="273" font-size="6" fill="#44337a"> Prescription orders</text>
            <text x="330" y="286" font-size="6" fill="#44337a"> Dosage & frequency</text>
            <text x="330" y="299" font-size="6" fill="#44337a"> Route (oral/IV/IM)</text>
            <text x="330" y="312" font-size="6" fill="#44337a"> Start/end dates</text>
            <text x="392" y="328" text-anchor="middle" font-size="6" fill="#553c9a" font-style="italic">IpdMedication</text>

            <rect x="475" y="235" width="135" height="100" rx="6" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="542" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Investigations</text>
            <text x="485" y="273" font-size="6" fill="#975a16"> Lab/radiology orders</text>
            <text x="485" y="286" font-size="6" fill="#975a16"> Priority levels</text>
            <text x="485" y="299" font-size="6" fill="#975a16"> Result tracking</text>
            <text x="485" y="312" font-size="6" fill="#975a16"> lab_order_id link</text>
            <text x="542" y="328" text-anchor="middle" font-size="6" fill="#c05621" font-style="italic">IpdInvestigation</text>

            <rect x="620" y="235" width="120" height="100" rx="6" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="680" y="255" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Services</text>
            <text x="630" y="273" font-size="6" fill="#702459"> Procedures</text>
            <text x="630" y="286" font-size="6" fill="#702459"> Consultations</text>
            <text x="630" y="299" font-size="6" fill="#702459"> Rate & billing</text>
            <text x="630" y="312" font-size="6" fill="#702459"> Package support</text>
            <text x="680" y="328" text-anchor="middle" font-size="6" fill="#97266d" font-style="italic">IpdService</text>

            <!-- Discharge Phase -->
            <rect x="10" y="350" width="730" height="35" rx="6" fill="url(#dischargeGrad)"/>
            <text x="375" y="373" text-anchor="middle" font-weight="bold" font-size="14" fill="white">Discharge & Outcome Documentation</text>

            <!-- Discharge Types -->
            <rect x="10" y="395" width="180" height="115" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="100" y="415" text-anchor="middle" font-weight="bold" font-size="10" fill="#975a16">Discharge Types</text>

            <rect x="20" y="425" width="75" height="30" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="57" y="443" text-anchor="middle" font-size="8" fill="#22543d">Normal</text>

            <rect x="105" y="425" width="75" height="30" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="142" y="443" text-anchor="middle" font-size="8" fill="#975a16">LAMA</text>

            <rect x="20" y="465" width="75" height="30" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="57" y="483" text-anchor="middle" font-size="8" fill="#553c9a">Transfer</text>

            <rect x="105" y="465" width="75" height="30" rx="4" fill="#fed7d7" stroke="#fc8181"/>
            <text x="142" y="483" text-anchor="middle" font-size="8" fill="#742a2a">Death</text>

            <!-- Arrow -->
            <path d="M195,455 L220,455" stroke="#c05621" stroke-width="2" marker-end="url(#ipdArrow)"/>

            <!-- Discharge Summary -->
            <rect x="225" y="395" width="180" height="115" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
            <text x="315" y="415" text-anchor="middle" font-weight="bold" font-size="10" fill="#92400e">Discharge Summary</text>

            <text x="235" y="433" font-size="7" fill="#78350f"> discharge_date/time</text>
            <text x="235" y="446" font-size="7" fill="#78350f"> final_diagnosis</text>
            <text x="235" y="459" font-size="7" fill="#78350f"> condition_at_discharge</text>
            <text x="235" y="472" font-size="7" fill="#78350f"> discharge_summary text</text>
            <text x="235" y="485" font-size="7" fill="#78350f"> followup_advice</text>
            <text x="235" y="498" font-size="7" fill="#78350f"> followup_date</text>

            <!-- Arrow -->
            <path d="M410,455 L435,455" stroke="#c05621" stroke-width="2" marker-end="url(#ipdArrow)"/>

            <!-- Final Billing -->
            <rect x="440" y="395" width="150" height="115" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
            <text x="515" y="415" text-anchor="middle" font-weight="bold" font-size="10" fill="#166534">Final Settlement</text>

            <text x="450" y="433" font-size="7" fill="#15803d"> total_charges</text>
            <text x="450" y="446" font-size="7" fill="#15803d"> discount_amount</text>
            <text x="450" y="459" font-size="7" fill="#15803d"> tax_amount</text>
            <text x="450" y="472" font-size="7" fill="#15803d"> net_amount</text>
            <text x="450" y="485" font-size="7" fill="#15803d"> advance_amount</text>
            <text x="450" y="498" font-size="7" fill="#15803d"> due_amount</text>

            <!-- Arrow -->
            <path d="M595,455 L620,455" stroke="#c05621" stroke-width="2" marker-end="url(#ipdArrow)"/>

            <!-- Bed Release -->
            <rect x="625" y="395" width="115" height="115" rx="6" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="682" y="415" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">Completion</text>

            <rect x="635" y="430" width="95" height="30" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="682" y="448" text-anchor="middle" font-size="8" fill="#22543d">bed.release()</text>

            <rect x="635" y="470" width="95" height="30" rx="4" fill="#bbf7d0" stroke="#4ade80"/>
            <text x="682" y="488" text-anchor="middle" font-size="8" fill="#166534">status=discharged</text>
        </svg>
    </div>

    <!-- Diagram 2: Ward & Bed Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Ward & Bed Management System</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="bedArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#4299e1"/>
                </marker>
            </defs>

            <!-- Ward Structure -->
            <rect x="10" y="10" width="360" height="230" rx="8" fill="#f7fafc" stroke="#4a5568" stroke-width="2"/>
            <text x="190" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2d3748">Ward Model Structure</text>

            <rect x="25" y="50" width="330" height="180" rx="6" fill="#ebf8ff" stroke="#4299e1" stroke-width="2"/>
            <text x="190" y="72" text-anchor="middle" font-weight="bold" font-size="10" fill="#2c5282">Ward</text>

            <text x="40" y="95" font-size="8" fill="#2b6cb0" font-weight="bold">Primary Key:</text>
            <text x="130" y="95" font-size="8" fill="#2b6cb0">ward_id</text>

            <text x="40" y="115" font-size="8" fill="#2b6cb0" font-weight="bold">Attributes:</text>
            <text x="40" y="130" font-size="7" fill="#4a5568"> ward_code (unique identifier)</text>
            <text x="40" y="143" font-size="7" fill="#4a5568"> ward_name</text>
            <text x="40" y="156" font-size="7" fill="#4a5568"> ward_type (general/icu/nicu/picu/ccu/isolation)</text>
            <text x="40" y="169" font-size="7" fill="#4a5568"> total_beds (capacity)</text>
            <text x="40" y="182" font-size="7" fill="#4a5568"> charges_per_day (default rate)</text>
            <text x="40" y="195" font-size="7" fill="#4a5568"> department_id (FK to Department)</text>
            <text x="40" y="208" font-size="7" fill="#4a5568"> is_active (boolean)</text>

            <text x="40" y="225" font-size="8" fill="#38a169" font-weight="bold">Relations:</text>
            <text x="110" y="225" font-size="7" fill="#38a169">beds(), availableBeds(), department()</text>

            <!-- Bed Structure -->
            <rect x="380" y="10" width="360" height="230" rx="8" fill="#f7fafc" stroke="#4a5568" stroke-width="2"/>
            <text x="560" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2d3748">Bed Model Structure</text>

            <rect x="395" y="50" width="330" height="180" rx="6" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="560" y="72" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">Bed</text>

            <text x="410" y="95" font-size="8" fill="#22543d" font-weight="bold">Primary Key:</text>
            <text x="500" y="95" font-size="8" fill="#22543d">bed_id</text>

            <text x="410" y="115" font-size="8" fill="#22543d" font-weight="bold">Attributes:</text>
            <text x="410" y="130" font-size="7" fill="#4a5568"> bed_number, room_number, floor</text>
            <text x="410" y="143" font-size="7" fill="#4a5568"> ward_id (FK to Ward)</text>
            <text x="410" y="156" font-size="7" fill="#4a5568"> bed_type (standard/deluxe/vip/icu)</text>
            <text x="410" y="169" font-size="7" fill="#4a5568"> charges_per_day (override ward rate)</text>
            <text x="410" y="182" font-size="7" fill="#4a5568"> status (available/occupied/reserved/maintenance)</text>
            <text x="410" y="195" font-size="7" fill="#4a5568"> is_isolation, is_ventilator (special beds)</text>
            <text x="410" y="208" font-size="7" fill="#4a5568"> current_patient_id, current_ipd_id</text>

            <text x="410" y="225" font-size="8" fill="#805ad5" font-weight="bold">Methods:</text>
            <text x="470" y="225" font-size="7" fill="#805ad5">occupy(), release(), scopes</text>

            <!-- Relationship Arrow -->
            <path d="M355,145 L380,145" stroke="#4299e1" stroke-width="2" marker-end="url(#bedArrow)"/>
            <text x="367" y="138" font-size="7" fill="#4299e1">1:N</text>

            <!-- Bed Status Flow -->
            <rect x="10" y="250" width="360" height="240" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="190" y="275" text-anchor="middle" font-weight="bold" font-size="12" fill="#975a16">Bed Status State Machine</text>

            <!-- Available State -->
            <rect x="40" y="295" width="100" height="50" rx="25" fill="#c6f6d5" stroke="#38a169" stroke-width="2"/>
            <text x="90" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">AVAILABLE</text>
            <text x="90" y="335" text-anchor="middle" font-size="6" fill="#276749">is_available=true</text>

            <!-- Occupied State -->
            <rect x="200" y="295" width="100" height="50" rx="25" fill="#fed7d7" stroke="#fc8181" stroke-width="2"/>
            <text x="250" y="320" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">OCCUPIED</text>
            <text x="250" y="335" text-anchor="middle" font-size="6" fill="#9b2c2c">patient assigned</text>

            <!-- Reserved State -->
            <rect x="40" y="375" width="100" height="50" rx="25" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="90" y="400" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">RESERVED</text>
            <text x="90" y="415" text-anchor="middle" font-size="6" fill="#975a16">pre-booked</text>

            <!-- Maintenance State -->
            <rect x="200" y="375" width="100" height="50" rx="25" fill="#e9d8fd" stroke="#805ad5" stroke-width="2"/>
            <text x="250" y="400" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">MAINTENANCE</text>
            <text x="250" y="415" text-anchor="middle" font-size="6" fill="#44337a">cleaning/repair</text>

            <!-- Transition Arrows -->
            <path d="M140,320 L195,320" stroke="#2b6cb0" stroke-width="1.5" marker-end="url(#bedArrow)"/>
            <text x="167" y="312" font-size="6" fill="#2b6cb0">occupy()</text>

            <path d="M195,325 L145,325" stroke="#38a169" stroke-width="1.5" marker-end="url(#bedArrow)"/>
            <text x="167" y="340" font-size="6" fill="#38a169">release()</text>

            <path d="M90,345 L90,370" stroke="#ed8936" stroke-width="1.5" marker-end="url(#bedArrow)"/>
            <text x="95" y="360" font-size="6" fill="#ed8936">reserve</text>

            <path d="M140,390 L195,350" stroke="#2b6cb0" stroke-width="1.5" marker-end="url(#bedArrow)"/>

            <path d="M250,345 L250,370" stroke="#805ad5" stroke-width="1.5" marker-end="url(#bedArrow)"/>
            <text x="255" y="360" font-size="6" fill="#805ad5">clean</text>

            <path d="M200,405 L145,405" stroke="#38a169" stroke-width="1.5" marker-end="url(#bedArrow)"/>
            <text x="172" y="418" font-size="6" fill="#38a169">ready</text>

            <!-- Bed Legend -->
            <rect x="315" y="295" width="45" height="130" rx="4" fill="#f7fafc" stroke="#a0aec0"/>
            <text x="337" y="315" text-anchor="middle" font-weight="bold" font-size="7" fill="#4a5568">Legend</text>

            <circle cx="327" cy="335" r="6" fill="#c6f6d5" stroke="#38a169"/>
            <text x="340" y="338" font-size="6" fill="#4a5568">Free</text>

            <circle cx="327" cy="355" r="6" fill="#fed7d7" stroke="#fc8181"/>
            <text x="340" y="358" font-size="6" fill="#4a5568">Used</text>

            <circle cx="327" cy="375" r="6" fill="#feebc8" stroke="#ed8936"/>
            <text x="340" y="378" font-size="6" fill="#4a5568">Hold</text>

            <circle cx="327" cy="395" r="6" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="340" y="398" font-size="6" fill="#4a5568">Maint</text>

            <circle cx="327" cy="415" r="6" fill="#bee3f8" stroke="#4299e1"/>
            <text x="340" y="418" font-size="6" fill="#4a5568">ICU</text>

            <!-- Bed Transfer -->
            <rect x="380" y="250" width="360" height="240" rx="8" fill="#fff5f5" stroke="#fc8181" stroke-width="2"/>
            <text x="560" y="275" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">Bed Transfer Process</text>

            <rect x="395" y="290" width="330" height="90" rx="6" fill="#fed7d7" stroke="#f56565" stroke-width="2"/>
            <text x="560" y="312" text-anchor="middle" font-weight="bold" font-size="10" fill="#c53030">BedTransfer Model</text>

            <text x="410" y="332" font-size="7" fill="#742a2a"> transfer_id (PK)</text>
            <text x="410" y="345" font-size="7" fill="#742a2a"> ipd_id (current admission)</text>
            <text x="410" y="358" font-size="7" fill="#742a2a"> from_bed_id, to_bed_id</text>
            <text x="410" y="371" font-size="7" fill="#742a2a"> from_ward_id, to_ward_id</text>
            <text x="570" y="332" font-size="7" fill="#742a2a"> transfer_datetime</text>
            <text x="570" y="345" font-size="7" fill="#742a2a"> transfer_reason</text>
            <text x="570" y="358" font-size="7" fill="#742a2a"> transferred_by (User)</text>
            <text x="570" y="371" font-size="7" fill="#742a2a"> remarks</text>

            <!-- Transfer Flow Diagram -->
            <rect x="410" y="395" width="80" height="40" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="450" y="413" text-anchor="middle" font-size="8" fill="#22543d">From Bed</text>
            <text x="450" y="427" text-anchor="middle" font-size="6" fill="#276749">release()</text>

            <path d="M495,415 L525,415" stroke="#c53030" stroke-width="2" marker-end="url(#bedArrow)"/>
            <text x="510" y="408" font-size="6" fill="#c53030">transfer</text>

            <rect x="530" y="395" width="80" height="40" rx="4" fill="#fed7d7" stroke="#fc8181"/>
            <text x="570" y="413" text-anchor="middle" font-size="8" fill="#742a2a">To Bed</text>
            <text x="570" y="427" text-anchor="middle" font-size="6" fill="#9b2c2c">occupy()</text>

            <path d="M615,415 L645,415" stroke="#38a169" stroke-width="2" marker-end="url(#bedArrow)"/>

            <rect x="650" y="395" width="75" height="40" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="687" y="413" text-anchor="middle" font-size="8" fill="#553c9a">Update</text>
            <text x="687" y="427" text-anchor="middle" font-size="6" fill="#44337a">IPD bed_id</text>

            <!-- Transfer Reasons -->
            <text x="410" y="455" font-size="7" fill="#742a2a" font-weight="bold">Common Transfer Reasons:</text>
            <text x="410" y="470" font-size="6" fill="#4a5568"> ICU step-up/step-down</text>
            <text x="410" y="482" font-size="6" fill="#4a5568"> Patient request (private room)</text>
            <text x="560" y="470" font-size="6" fill="#4a5568"> Ward closure/maintenance</text>
            <text x="560" y="482" font-size="6" fill="#4a5568"> Isolation requirement</text>
        </svg>
    </div>

    <!-- Diagram 3: Clinical Documentation -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Clinical Documentation Workflow</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="clinArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#38a169"/>
                </marker>
            </defs>

            <!-- Progress Notes Section -->
            <rect x="10" y="10" width="365" height="250" rx="8" fill="#ebf8ff" stroke="#4299e1" stroke-width="2"/>
            <text x="192" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2c5282">Doctor Progress Notes (SOAP)</text>

            <rect x="25" y="50" width="335" height="200" rx="6" fill="#fff" stroke="#bee3f8" stroke-width="1"/>

            <!-- SOAP Format -->
            <rect x="35" y="60" width="150" height="55" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="110" y="78" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">S - Subjective</text>
            <text x="45" y="93" font-size="6" fill="#276749">Patient complaints</text>
            <text x="45" y="105" font-size="6" fill="#276749">History from patient/family</text>

            <rect x="195" y="60" width="155" height="55" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="272" y="78" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">O - Objective</text>
            <text x="205" y="93" font-size="6" fill="#2b6cb0">Physical examination</text>
            <text x="205" y="105" font-size="6" fill="#2b6cb0">Vital signs, lab results</text>

            <rect x="35" y="125" width="150" height="55" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="110" y="143" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">A - Assessment</text>
            <text x="45" y="158" font-size="6" fill="#975a16">Diagnosis interpretation</text>
            <text x="45" y="170" font-size="6" fill="#975a16">Clinical reasoning</text>

            <rect x="195" y="125" width="155" height="55" rx="4" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="272" y="143" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">P - Plan</text>
            <text x="205" y="158" font-size="6" fill="#44337a">Treatment modifications</text>
            <text x="205" y="170" font-size="6" fill="#44337a">Orders & instructions</text>

            <!-- Note Types -->
            <text x="35" y="200" font-size="8" fill="#2c5282" font-weight="bold">Note Types:</text>
            <rect x="35" y="210" width="55" height="25" rx="3" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="62" y="226" text-anchor="middle" font-size="7" fill="#22543d">admission</text>

            <rect x="97" y="210" width="45" height="25" rx="3" fill="#bee3f8" stroke="#4299e1"/>
            <text x="119" y="226" text-anchor="middle" font-size="7" fill="#2c5282">daily</text>

            <rect x="149" y="210" width="55" height="25" rx="3" fill="#feebc8" stroke="#ed8936"/>
            <text x="176" y="226" text-anchor="middle" font-size="7" fill="#c05621">progress</text>

            <rect x="211" y="210" width="60" height="25" rx="3" fill="#e9d8fd" stroke="#805ad5"/>
            <text x="241" y="226" text-anchor="middle" font-size="7" fill="#553c9a">procedure</text>

            <rect x="278" y="210" width="70" height="25" rx="3" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="313" y="226" text-anchor="middle" font-size="7" fill="#97266d">discharge</text>

            <!-- Nursing Charts Section -->
            <rect x="385" y="10" width="355" height="250" rx="8" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="562" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Nursing Documentation</text>

            <!-- Shift-based Charting -->
            <rect x="400" y="50" width="325" height="60" rx="6" fill="#c6f6d5" stroke="#38a169"/>
            <text x="562" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Shift-Based Charting</text>

            <rect x="410" y="80" width="70" height="22" rx="3" fill="#fff" stroke="#68d391"/>
            <text x="445" y="94" text-anchor="middle" font-size="7" fill="#276749">Morning</text>

            <rect x="490" y="80" width="70" height="22" rx="3" fill="#fff" stroke="#68d391"/>
            <text x="525" y="94" text-anchor="middle" font-size="7" fill="#276749">Afternoon</text>

            <rect x="570" y="80" width="70" height="22" rx="3" fill="#fff" stroke="#68d391"/>
            <text x="605" y="94" text-anchor="middle" font-size="7" fill="#276749">Night</text>

            <rect x="650" y="80" width="65" height="22" rx="3" fill="#9ae6b4" stroke="#38a169"/>
            <text x="682" y="94" text-anchor="middle" font-size="7" fill="#22543d">PRN</text>

            <!-- Vital Signs -->
            <rect x="400" y="120" width="155" height="65" rx="6" fill="#e6fffa" stroke="#38b2ac"/>
            <text x="477" y="138" text-anchor="middle" font-weight="bold" font-size="9" fill="#285e61">Vital Signs</text>
            <text x="410" y="153" font-size="6" fill="#2c7a7b"> bp_systolic / bp_diastolic</text>
            <text x="410" y="164" font-size="6" fill="#2c7a7b"> pulse, temperature</text>
            <text x="410" y="175" font-size="6" fill="#2c7a7b"> spo2, respiratory_rate</text>

            <!-- I/O Balance -->
            <rect x="565" y="120" width="160" height="65" rx="6" fill="#fffaf0" stroke="#ed8936"/>
            <text x="645" y="138" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Intake/Output (I/O)</text>
            <text x="575" y="153" font-size="6" fill="#975a16">Intake: oral_ml + iv_ml</text>
            <text x="575" y="164" font-size="6" fill="#975a16">Output: urine + drain + vomit</text>
            <text x="575" y="175" font-size="6" fill="#975a16">fluid_balance = I - O</text>

            <!-- Assessments -->
            <rect x="400" y="195" width="325" height="55" rx="6" fill="#faf5ff" stroke="#805ad5"/>
            <text x="562" y="213" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Clinical Assessments</text>

            <text x="410" y="230" font-size="6" fill="#44337a"> general_condition</text>
            <text x="410" y="242" font-size="6" fill="#44337a"> pain_assessment</text>
            <text x="510" y="230" font-size="6" fill="#44337a"> wound_assessment</text>
            <text x="510" y="242" font-size="6" fill="#44337a"> iv_site_assessment</text>
            <text x="630" y="230" font-size="6" fill="#44337a"> nursing_notes</text>
            <text x="630" y="242" font-size="6" fill="#44337a"> patient_response</text>

            <!-- Medication Administration -->
            <rect x="10" y="270" width="365" height="240" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="192" y="295" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">Medication Administration</text>

            <rect x="25" y="310" width="335" height="190" rx="6" fill="#fff" stroke="#d6bcfa" stroke-width="1"/>

            <!-- Prescription Details -->
            <text x="35" y="330" font-size="9" fill="#553c9a" font-weight="bold">IpdMedication Model Fields:</text>

            <rect x="35" y="340" width="155" height="75" rx="4" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="112" y="358" text-anchor="middle" font-weight="bold" font-size="8" fill="#553c9a">Prescription</text>
            <text x="45" y="373" font-size="6" fill="#44337a"> drug_id (link to Drug)</text>
            <text x="45" y="385" font-size="6" fill="#44337a"> medicine_name</text>
            <text x="45" y="397" font-size="6" fill="#44337a"> dosage (e.g., 500mg)</text>
            <text x="45" y="409" font-size="6" fill="#44337a"> prescribed_by (Doctor)</text>

            <rect x="200" y="340" width="150" height="75" rx="4" fill="#d6bcfa" stroke="#805ad5"/>
            <text x="275" y="358" text-anchor="middle" font-weight="bold" font-size="8" fill="#44337a">Schedule</text>
            <text x="210" y="373" font-size="6" fill="#553c9a"> frequency (TDS, BD, OD)</text>
            <text x="210" y="385" font-size="6" fill="#553c9a"> route (oral/IV/IM/SC)</text>
            <text x="210" y="397" font-size="6" fill="#553c9a"> start_date, end_date</text>
            <text x="210" y="409" font-size="6" fill="#553c9a"> instructions</text>

            <!-- Medication Status -->
            <text x="35" y="435" font-size="8" fill="#553c9a" font-weight="bold">Medication Status:</text>

            <rect x="35" y="445" width="75" height="30" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="72" y="463" text-anchor="middle" font-size="8" fill="#22543d">Active</text>
            <text x="72" y="473" text-anchor="middle" font-size="5" fill="#276749">is_active=true</text>

            <rect x="120" y="445" width="75" height="30" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="157" y="463" text-anchor="middle" font-size="8" fill="#c05621">On Hold</text>
            <text x="157" y="473" text-anchor="middle" font-size="5" fill="#975a16">temporarily paused</text>

            <rect x="205" y="445" width="75" height="30" rx="4" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="242" y="463" text-anchor="middle" font-size="8" fill="#4a5568">Stopped</text>
            <text x="242" y="473" text-anchor="middle" font-size="5" fill="#718096">is_active=false</text>

            <rect x="290" y="445" width="60" height="30" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="320" y="463" text-anchor="middle" font-size="8" fill="#22543d">PRN</text>
            <text x="320" y="473" text-anchor="middle" font-size="5" fill="#276749">as needed</text>

            <!-- Investigations Section -->
            <rect x="385" y="270" width="355" height="240" rx="8" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="562" y="295" text-anchor="middle" font-weight="bold" font-size="12" fill="#c05621">IPD Investigations & Orders</text>

            <rect x="400" y="310" width="325" height="190" rx="6" fill="#fff" stroke="#fbd38d" stroke-width="1"/>

            <!-- Investigation Model -->
            <text x="410" y="330" font-size="9" fill="#c05621" font-weight="bold">IpdInvestigation Model:</text>

            <rect x="410" y="340" width="145" height="70" rx="4" fill="#fef3c7" stroke="#f59e0b"/>
            <text x="482" y="355" text-anchor="middle" font-weight="bold" font-size="8" fill="#92400e">Order Details</text>
            <text x="420" y="370" font-size="6" fill="#78350f"> investigation_type (lab/radio)</text>
            <text x="420" y="382" font-size="6" fill="#78350f"> test_id, investigation_name</text>
            <text x="420" y="394" font-size="6" fill="#78350f"> priority (routine/urgent/stat)</text>
            <text x="420" y="406" font-size="6" fill="#78350f"> clinical_notes</text>

            <rect x="565" y="340" width="150" height="70" rx="4" fill="#fed7aa" stroke="#ed8936"/>
            <text x="640" y="355" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Tracking</text>
            <text x="575" y="370" font-size="6" fill="#975a16"> order_date, order_time</text>
            <text x="575" y="382" font-size="6" fill="#975a16"> ordered_by (Doctor)</text>
            <text x="575" y="394" font-size="6" fill="#975a16"> lab_order_id (link)</text>
            <text x="575" y="406" font-size="6" fill="#975a16"> result, result_datetime</text>

            <!-- Investigation Status Flow -->
            <text x="410" y="430" font-size="8" fill="#c05621" font-weight="bold">Investigation Status Flow:</text>

            <rect x="410" y="440" width="55" height="25" rx="4" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="437" y="456" text-anchor="middle" font-size="7" fill="#4a5568">ordered</text>

            <path d="M467,452 L480,452" stroke="#ed8936" stroke-width="1.5" marker-end="url(#clinArrow)"/>

            <rect x="483" y="440" width="65" height="25" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="515" y="456" text-anchor="middle" font-size="6" fill="#c05621">sample</text>

            <path d="M550,452 L563,452" stroke="#ed8936" stroke-width="1.5" marker-end="url(#clinArrow)"/>

            <rect x="566" y="440" width="60" height="25" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="596" y="456" text-anchor="middle" font-size="6" fill="#2c5282">processing</text>

            <path d="M628,452 L641,452" stroke="#ed8936" stroke-width="1.5" marker-end="url(#clinArrow)"/>

            <rect x="644" y="440" width="66" height="25" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="677" y="456" text-anchor="middle" font-size="6" fill="#22543d">completed</text>

            <!-- Priority Indicators -->
            <text x="410" y="485" font-size="7" fill="#c05621" font-weight="bold">Priority Levels:</text>
            <rect x="490" y="473" width="45" height="18" rx="3" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="512" y="485" text-anchor="middle" font-size="6" fill="#4a5568">routine</text>

            <rect x="540" y="473" width="45" height="18" rx="3" fill="#feebc8" stroke="#ed8936"/>
            <text x="562" y="485" text-anchor="middle" font-size="6" fill="#c05621">urgent</text>

            <rect x="590" y="473" width="45" height="18" rx="3" fill="#fed7d7" stroke="#fc8181"/>
            <text x="612" y="485" text-anchor="middle" font-size="6" fill="#c53030">stat</text>
        </svg>
    </div>

    <!-- Diagram 4: IPD Billing & Services -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">IPD Billing & Services Workflow</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="billArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#38a169"/>
                </marker>
                <linearGradient id="billGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#38a169"/>
                    <stop offset="100%" style="stop-color:#2f855a"/>
                </linearGradient>
            </defs>

            <!-- Service Capture -->
            <rect x="10" y="10" width="730" height="35" rx="6" fill="url(#billGrad)"/>
            <text x="375" y="33" text-anchor="middle" font-weight="bold" font-size="14" fill="white">IPD Service Capture & Charges</text>

            <!-- Service Types -->
            <rect x="10" y="55" width="240" height="150" rx="6" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="130" y="77" text-anchor="middle" font-weight="bold" font-size="11" fill="#276749">Service Types</text>

            <rect x="25" y="90" width="100" height="45" rx="4" fill="#c6f6d5" stroke="#38a169"/>
            <text x="75" y="110" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Bed Charges</text>
            <text x="75" y="125" text-anchor="middle" font-size="6" fill="#276749">per day  LOS</text>

            <rect x="135" y="90" width="100" height="45" rx="4" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="185" y="110" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Procedures</text>
            <text x="185" y="125" text-anchor="middle" font-size="6" fill="#276749">service_type</text>

            <rect x="25" y="145" width="100" height="45" rx="4" fill="#68d391" stroke="#38a169"/>
            <text x="75" y="165" text-anchor="middle" font-weight="bold" font-size="8" fill="white">Consultations</text>
            <text x="75" y="180" text-anchor="middle" font-size="6" fill="#f0fff4">doctor visits</text>

            <rect x="135" y="145" width="100" height="45" rx="4" fill="#48bb78" stroke="#2f855a"/>
            <text x="185" y="165" text-anchor="middle" font-weight="bold" font-size="8" fill="white">Investigations</text>
            <text x="185" y="180" text-anchor="middle" font-size="6" fill="#f0fff4">lab/radiology</text>

            <!-- IpdService Model -->
            <rect x="260" y="55" width="240" height="150" rx="6" fill="#ebf8ff" stroke="#4299e1" stroke-width="2"/>
            <text x="380" y="77" text-anchor="middle" font-weight="bold" font-size="11" fill="#2c5282">IpdService Model</text>

            <text x="275" y="97" font-size="7" fill="#2b6cb0" font-weight="bold">Fields:</text>
            <text x="275" y="112" font-size="6" fill="#4a5568"> ipd_service_id (PK)</text>
            <text x="275" y="125" font-size="6" fill="#4a5568"> ipd_id (FK to IpdAdmission)</text>
            <text x="275" y="138" font-size="6" fill="#4a5568"> service_date, service_type</text>
            <text x="275" y="151" font-size="6" fill="#4a5568"> service_id, service_name</text>
            <text x="275" y="164" font-size="6" fill="#4a5568"> quantity, rate, amount</text>
            <text x="275" y="177" font-size="6" fill="#4a5568"> discount, net_amount</text>
            <text x="275" y="190" font-size="6" fill="#4a5568"> is_package, is_billed, bill_id</text>

            <!-- Billing Status -->
            <rect x="510" y="55" width="230" height="150" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
            <text x="625" y="77" text-anchor="middle" font-weight="bold" font-size="11" fill="#92400e">Billing Status Tracking</text>

            <rect x="525" y="95" width="95" height="40" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="572" y="113" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">UNBILLED</text>
            <text x="572" y="128" text-anchor="middle" font-size="6" fill="#975a16">is_billed=false</text>

            <path d="M625,115 L645,115" stroke="#38a169" stroke-width="2" marker-end="url(#billArrow)"/>

            <rect x="650" y="95" width="80" height="40" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="690" y="113" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">BILLED</text>
            <text x="690" y="128" text-anchor="middle" font-size="6" fill="#276749">is_billed=true</text>

            <text x="525" y="155" font-size="7" fill="#92400e" font-weight="bold">Running Bill Calculation:</text>
            <text x="525" y="170" font-size="6" fill="#78350f">services.unbilled().sum('net_amount')</text>
            <text x="525" y="183" font-size="6" fill="#78350f">+ (bed_charges  los_days)</text>
            <text x="525" y="196" font-size="6" fill="#78350f">= current_balance_due</text>

            <!-- Advance Payments -->
            <rect x="10" y="215" width="365" height="145" rx="6" fill="#e9d8fd" stroke="#805ad5" stroke-width="2"/>
            <text x="192" y="237" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">Advance Payment Management</text>

            <rect x="25" y="250" width="165" height="100" rx="4" fill="#faf5ff" stroke="#9f7aea"/>
            <text x="107" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">IpdAdvancePayment</text>

            <text x="35" y="288" font-size="6" fill="#44337a"> advance_id (PK)</text>
            <text x="35" y="301" font-size="6" fill="#44337a"> ipd_id (FK)</text>
            <text x="35" y="314" font-size="6" fill="#44337a"> receipt_number (auto)</text>
            <text x="35" y="327" font-size="6" fill="#44337a"> payment_date, amount</text>
            <text x="35" y="340" font-size="6" fill="#44337a"> payment_mode, reference_number</text>

            <rect x="200" y="250" width="165" height="100" rx="4" fill="#d6bcfa" stroke="#805ad5"/>
            <text x="282" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#44337a">Refund Handling</text>

            <text x="210" y="288" font-size="6" fill="#553c9a"> is_refunded (boolean)</text>
            <text x="210" y="301" font-size="6" fill="#553c9a"> refund_amount</text>
            <text x="210" y="314" font-size="6" fill="#553c9a"> refund_date</text>
            <text x="210" y="327" font-size="6" fill="#553c9a"> received_by (User)</text>
            <text x="210" y="340" font-size="6" fill="#553c9a">Accessor: effective_amount</text>

            <!-- Final Bill -->
            <rect x="385" y="215" width="355" height="145" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
            <text x="562" y="237" text-anchor="middle" font-weight="bold" font-size="12" fill="#166534">Final Bill Settlement</text>

            <rect x="400" y="250" width="160" height="100" rx="4" fill="#bbf7d0" stroke="#4ade80"/>
            <text x="480" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#166534">IpdAdmission Billing</text>

            <text x="410" y="288" font-size="6" fill="#15803d"> total_charges</text>
            <text x="410" y="301" font-size="6" fill="#15803d"> discount_amount</text>
            <text x="410" y="314" font-size="6" fill="#15803d"> tax_amount</text>
            <text x="410" y="327" font-size="6" fill="#15803d"> net_amount</text>
            <text x="410" y="340" font-size="6" fill="#15803d"> bill_id (FK to Bill)</text>

            <rect x="570" y="250" width="160" height="100" rx="4" fill="#86efac" stroke="#22c55e"/>
            <text x="650" y="270" text-anchor="middle" font-weight="bold" font-size="9" fill="#166534">Payment Summary</text>

            <text x="580" y="288" font-size="6" fill="#15803d"> advance_amount (sum)</text>
            <text x="580" y="301" font-size="6" fill="#15803d"> paid_amount</text>
            <text x="580" y="314" font-size="6" fill="#15803d"> due_amount (balance)</text>
            <text x="580" y="327" font-size="6" fill="#15803d"> credit_limit</text>
            <text x="580" y="340" font-size="6" fill="#15803d">calculateRunningBill()</text>

            <!-- Insurance Section -->
            <rect x="10" y="370" width="365" height="140" rx="6" fill="#fff5f5" stroke="#fc8181" stroke-width="2"/>
            <text x="192" y="392" text-anchor="middle" font-weight="bold" font-size="12" fill="#c53030">Insurance & TPA Processing</text>

            <rect x="25" y="405" width="165" height="95" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="107" y="425" text-anchor="middle" font-weight="bold" font-size="9" fill="#c53030">Insurance Details</text>

            <text x="35" y="443" font-size="6" fill="#742a2a"> insurance_applicable (bool)</text>
            <text x="35" y="456" font-size="6" fill="#742a2a"> insurance_id (FK)</text>
            <text x="35" y="469" font-size="6" fill="#742a2a"> tpa_name</text>
            <text x="35" y="482" font-size="6" fill="#742a2a"> scheme_type</text>
            <text x="35" y="495" font-size="6" fill="#742a2a"> class_id (room category)</text>

            <rect x="200" y="405" width="165" height="95" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="282" y="425" text-anchor="middle" font-weight="bold" font-size="9" fill="#742a2a">Pre-Authorization</text>

            <text x="210" y="443" font-size="6" fill="#9b2c2c"> insurance_approval_number</text>
            <text x="210" y="456" font-size="6" fill="#9b2c2c"> pre_auth_amount</text>
            <text x="210" y="469" font-size="6" fill="#9b2c2c"> approved_amount</text>
            <text x="210" y="482" font-size="6" fill="#9b2c2c"> Claim submission</text>
            <text x="210" y="495" font-size="6" fill="#9b2c2c"> Settlement tracking</text>

            <!-- Length of Stay -->
            <rect x="385" y="370" width="355" height="140" rx="6" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="562" y="392" text-anchor="middle" font-weight="bold" font-size="12" fill="#975a16">Length of Stay (LOS) Calculation</text>

            <rect x="400" y="410" width="325" height="90" rx="4" fill="#fef3c7" stroke="#f59e0b"/>

            <text x="420" y="435" font-size="8" fill="#92400e" font-weight="bold">LOS Accessor (getLosDaysAttribute):</text>

            <rect x="420" y="445" width="140" height="45" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="490" y="465" text-anchor="middle" font-size="7" fill="#c05621">admission_date</text>
            <text x="490" y="480" text-anchor="middle" font-size="6" fill="#975a16">Start date</text>

            <path d="M565,467 L590,467" stroke="#d69e2e" stroke-width="2" marker-end="url(#billArrow)"/>
            <text x="577" y="460" font-size="7" fill="#92400e">diffInDays</text>

            <rect x="595" y="445" width="120" height="45" rx="4" fill="#fde68a" stroke="#fbbf24"/>
            <text x="655" y="465" text-anchor="middle" font-size="7" fill="#92400e">discharge_date</text>
            <text x="655" y="480" text-anchor="middle" font-size="6" fill="#b45309">or today()</text>

            <!-- Auto Charges Note -->
            <text x="420" y="510" font-size="6" fill="#78350f" font-style="italic">* Bed charges auto-calculated: los_days  (bed.charges_per_day ?? ward.charges_per_day)</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>IPD Module Workflow Key Points</h4>
        <ul>
            <li><strong>Admission Sources:</strong> IpdAdmission supports OPD referral (opd_id), emergency (is_emergency), MLC cases (mlc_number), and external referrals</li>
            <li><strong>Doctor Roles:</strong> Three distinct doctor assignments - admitting_doctor_id, treating_doctor_id, consultant_doctor_id for clear responsibility</li>
            <li><strong>Bed Management:</strong> Ward  Bed hierarchy with status tracking (available/occupied/reserved/maintenance); occupy() and release() methods for state management</li>
            <li><strong>Clinical Documentation:</strong> IpdProgressNote uses SOAP format (Subjective, Objective, Assessment, Plan) with note_type classification</li>
            <li><strong>Nursing Charts:</strong> IpdNursingChart tracks shift-based vitals, I/O balance (fluid_balance accessor), wound/IV assessments</li>
            <li><strong>Medications:</strong> IpdMedication with drug linkage, dosage/route/frequency, active/stopped status, and date ranges</li>
            <li><strong>Investigations:</strong> IpdInvestigation with priority levels (routine/urgent/stat), status workflow, and lab_order_id integration</li>
            <li><strong>Services & Billing:</strong> IpdService captures all charges; calculateRunningBill() provides real-time balance; IpdAdvancePayment tracks deposits with refund support</li>
            <li><strong>Insurance:</strong> Full TPA workflow with pre-authorization, approved amounts, and scheme tracking</li>
            <li><strong>Discharge:</strong> Multiple discharge types (normal/LAMA/transfer/death) with comprehensive summary, follow-up scheduling, and bed release</li>
        </ul>
    </div>
</div>

<!-- Section 4.15: OPD (Out-Patient Department) Module -->
<div class="section" style="page-break-before: always;">
    <h2>4.15 OPD (Out-Patient Department) Module</h2>

    <p>The OPD module manages outpatient visits, consultations, doctor queues, prescriptions, and billing for walk-in and appointment-based patients.</p>

    <!-- Diagram 1: OPD Visit Registration & Flow -->
    <div class="diagram">
        <div class="diagram-title">OPD Visit Registration & Patient Flow</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="opdArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#2b6cb0"/>
                </marker>
                <linearGradient id="opdRegGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#4299e1"/>
                    <stop offset="100%" style="stop-color:#3182ce"/>
                </linearGradient>
                <linearGradient id="opdConsGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#48bb78"/>
                    <stop offset="100%" style="stop-color:#38a169"/>
                </linearGradient>
                <linearGradient id="opdBillGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#ed8936"/>
                    <stop offset="100%" style="stop-color:#dd6b20"/>
                </linearGradient>
            </defs>

            <!-- Registration Phase -->
            <rect x="10" y="10" width="730" height="35" rx="6" fill="url(#opdRegGrad)"/>
            <text x="375" y="33" text-anchor="middle" font-weight="bold" font-size="14" fill="white">OPD Registration & Token Generation</text>

            <!-- Visit Types -->
            <rect x="10" y="55" width="175" height="130" rx="6" fill="#ebf8ff" stroke="#4299e1" stroke-width="2"/>
            <text x="97" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#2c5282">Visit Types</text>

            <rect x="20" y="85" width="70" height="35" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="55" y="100" text-anchor="middle" font-size="8" fill="#2c5282">New</text>
            <text x="55" y="115" text-anchor="middle" font-size="6" fill="#4a90d9">visit_type</text>

            <rect x="100" y="85" width="75" height="35" rx="4" fill="#90cdf4" stroke="#3182ce"/>
            <text x="137" y="100" text-anchor="middle" font-size="8" fill="#2c5282">Follow-up</text>
            <text x="137" y="115" text-anchor="middle" font-size="6" fill="#2b6cb0">free_followup</text>

            <rect x="20" y="130" width="70" height="45" rx="4" fill="#63b3ed" stroke="#2b77cb"/>
            <text x="55" y="148" text-anchor="middle" font-size="8" fill="white">Review</text>
            <text x="55" y="163" text-anchor="middle" font-size="6" fill="#ebf8ff">charge_type</text>

            <rect x="100" y="130" width="75" height="45" rx="4" fill="#4299e1" stroke="#2b6cb0"/>
            <text x="137" y="148" text-anchor="middle" font-size="8" fill="white">Referral</text>
            <text x="137" y="163" text-anchor="middle" font-size="6" fill="#ebf8ff">reference_doctor</text>

            <!-- Arrow -->
            <path d="M190,120 L215,120" stroke="#2b6cb0" stroke-width="2" marker-end="url(#opdArrow)"/>

            <!-- Registration Details -->
            <rect x="220" y="55" width="180" height="130" rx="6" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="310" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#276749">Registration Fields</text>

            <text x="230" y="93" font-size="7" fill="#22543d"> opd_number (auto-generated)</text>
            <text x="230" y="106" font-size="7" fill="#22543d"> visit_date, visit_time</text>
            <text x="230" y="119" font-size="7" fill="#22543d"> department_id, doctor_id</text>
            <text x="230" y="132" font-size="7" fill="#22543d"> registration_purpose</text>
            <text x="230" y="145" font-size="7" fill="#22543d"> class_id (patient class)</text>
            <text x="230" y="158" font-size="7" fill="#22543d"> entry_card_id (if applicable)</text>
            <text x="230" y="171" font-size="7" fill="#22543d"> health_package_id</text>

            <!-- Arrow -->
            <path d="M405,120 L430,120" stroke="#2b6cb0" stroke-width="2" marker-end="url(#opdArrow)"/>

            <!-- Token Generation -->
            <rect x="435" y="55" width="145" height="130" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="507" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">Token System</text>

            <rect x="445" y="90" width="125" height="35" rx="4" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="507" y="107" text-anchor="middle" font-size="8" fill="#553c9a">token_number</text>
            <text x="507" y="120" text-anchor="middle" font-size="6" fill="#6b46c1">Auto-generated</text>

            <text x="450" y="145" font-size="6" fill="#44337a"> token_per_doctor</text>
            <text x="450" y="158" font-size="6" fill="#44337a"> token_per_department</text>
            <text x="450" y="171" font-size="6" fill="#44337a"> token_generation mode</text>

            <!-- Arrow -->
            <path d="M585,120 L610,120" stroke="#2b6cb0" stroke-width="2" marker-end="url(#opdArrow)"/>

            <!-- Queue -->
            <rect x="615" y="55" width="125" height="130" rx="6" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="677" y="75" text-anchor="middle" font-weight="bold" font-size="10" fill="#c05621">Doctor Queue</text>

            <rect x="625" y="90" width="105" height="25" rx="4" fill="#fef3c7" stroke="#f59e0b"/>
            <text x="677" y="106" text-anchor="middle" font-size="7" fill="#92400e">status: waiting</text>

            <rect x="625" y="120" width="105" height="25" rx="4" fill="#fed7aa" stroke="#ed8936"/>
            <text x="677" y="136" text-anchor="middle" font-size="7" fill="#c05621">status: in_consultation</text>

            <rect x="625" y="150" width="105" height="25" rx="4" fill="#fdba74" stroke="#ea580c"/>
            <text x="677" y="166" text-anchor="middle" font-size="7" fill="#9a3412">status: completed</text>

            <!-- Consultation Phase -->
            <rect x="10" y="195" width="730" height="35" rx="6" fill="url(#opdConsGrad)"/>
            <text x="375" y="218" text-anchor="middle" font-weight="bold" font-size="14" fill="white">Consultation & Clinical Documentation</text>

            <!-- Vitals -->
            <rect x="10" y="240" width="145" height="115" rx="6" fill="#e6fffa" stroke="#38b2ac" stroke-width="2"/>
            <text x="82" y="260" text-anchor="middle" font-weight="bold" font-size="9" fill="#285e61">Vitals Recording</text>
            <text x="20" y="278" font-size="6" fill="#2c7a7b"> vitals_bp_systolic/diastolic</text>
            <text x="20" y="291" font-size="6" fill="#2c7a7b"> vitals_pulse</text>
            <text x="20" y="304" font-size="6" fill="#2c7a7b"> vitals_temperature</text>
            <text x="20" y="317" font-size="6" fill="#2c7a7b"> vitals_spo2</text>
            <text x="20" y="330" font-size="6" fill="#2c7a7b"> vitals_weight, height</text>
            <text x="82" y="348" text-anchor="middle" font-size="6" fill="#285e61" font-style="italic">PatientVital</text>

            <!-- Clinical Notes -->
            <rect x="165" y="240" width="150" height="115" rx="6" fill="#ebf8ff" stroke="#4299e1" stroke-width="2"/>
            <text x="240" y="260" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">Clinical Notes</text>
            <text x="175" y="278" font-size="6" fill="#2b6cb0"> chief_complaints</text>
            <text x="175" y="291" font-size="6" fill="#2b6cb0"> history_of_illness</text>
            <text x="175" y="304" font-size="6" fill="#2b6cb0"> examination_notes</text>
            <text x="175" y="317" font-size="6" fill="#2b6cb0"> diagnosis</text>
            <text x="175" y="330" font-size="6" fill="#2b6cb0"> advice</text>
            <text x="240" y="348" text-anchor="middle" font-size="6" fill="#2c5282" font-style="italic">OpdVisit fields</text>

            <!-- Prescription -->
            <rect x="325" y="240" width="135" height="115" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="392" y="260" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Prescription</text>
            <text x="335" y="278" font-size="6" fill="#44337a"> Rx medications</text>
            <text x="335" y="291" font-size="6" fill="#44337a"> Dosage & frequency</text>
            <text x="335" y="304" font-size="6" fill="#44337a"> Duration</text>
            <text x="335" y="317" font-size="6" fill="#44337a"> Special instructions</text>
            <text x="335" y="330" font-size="6" fill="#44337a"> items() relationship</text>
            <text x="392" y="348" text-anchor="middle" font-size="6" fill="#553c9a" font-style="italic">Prescription</text>

            <!-- Investigations -->
            <rect x="470" y="240" width="135" height="115" rx="6" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="537" y="260" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Investigations</text>
            <text x="480" y="278" font-size="6" fill="#975a16"> Lab tests ordered</text>
            <text x="480" y="291" font-size="6" fill="#975a16"> Radiology orders</text>
            <text x="480" y="304" font-size="6" fill="#975a16"> Priority levels</text>
            <text x="480" y="317" font-size="6" fill="#975a16"> clinical_notes</text>
            <text x="480" y="330" font-size="6" fill="#975a16"> labOrders() relation</text>
            <text x="537" y="348" text-anchor="middle" font-size="6" fill="#c05621" font-style="italic">OpdInvestigation</text>

            <!-- Services -->
            <rect x="615" y="240" width="125" height="115" rx="6" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="677" y="260" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Services</text>
            <text x="625" y="278" font-size="6" fill="#702459"> Procedures</text>
            <text x="625" y="291" font-size="6" fill="#702459"> Minor surgeries</text>
            <text x="625" y="304" font-size="6" fill="#702459"> quantity, rate</text>
            <text x="625" y="317" font-size="6" fill="#702459"> discount, tax</text>
            <text x="625" y="330" font-size="6" fill="#702459"> is_free_followup</text>
            <text x="677" y="348" text-anchor="middle" font-size="6" fill="#97266d" font-style="italic">OpdVisitService</text>

            <!-- Billing Phase -->
            <rect x="10" y="365" width="730" height="35" rx="6" fill="url(#opdBillGrad)"/>
            <text x="375" y="388" text-anchor="middle" font-weight="bold" font-size="14" fill="white">Billing & Follow-up</text>

            <!-- Billing Details -->
            <rect x="10" y="410" width="240" height="100" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
            <text x="130" y="430" text-anchor="middle" font-weight="bold" font-size="10" fill="#166534">Bill Generation</text>

            <text x="25" y="450" font-size="7" fill="#15803d"> consultation_fee</text>
            <text x="25" y="463" font-size="7" fill="#15803d"> total_amount (services + investigations)</text>
            <text x="25" y="476" font-size="7" fill="#15803d"> discount_amount, tax_amount</text>
            <text x="25" y="489" font-size="7" fill="#15803d"> net_amount, paid_amount, due_amount</text>
            <text x="25" y="502" font-size="7" fill="#15803d"> payment_status, bill_id</text>

            <!-- Payment Status -->
            <rect x="260" y="410" width="240" height="100" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
            <text x="380" y="430" text-anchor="middle" font-weight="bold" font-size="10" fill="#92400e">Payment Status</text>

            <rect x="275" y="445" width="65" height="25" rx="4" fill="#bbf7d0" stroke="#22c55e"/>
            <text x="307" y="461" text-anchor="middle" font-size="7" fill="#166534">paid</text>

            <rect x="350" y="445" width="65" height="25" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="382" y="461" text-anchor="middle" font-size="7" fill="#c05621">partial</text>

            <rect x="425" y="445" width="65" height="25" rx="4" fill="#fed7d7" stroke="#fc8181"/>
            <text x="457" y="461" text-anchor="middle" font-size="7" fill="#c53030">unpaid</text>

            <text x="275" y="490" font-size="6" fill="#78350f"> Insurance billing (is_insurance)</text>
            <text x="275" y="502" font-size="6" fill="#78350f"> MLC cases (is_mlc, mlc_number)</text>

            <!-- Follow-up -->
            <rect x="510" y="410" width="230" height="100" rx="6" fill="#e9d8fd" stroke="#805ad5" stroke-width="2"/>
            <text x="625" y="430" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">Follow-up Scheduling</text>

            <text x="525" y="450" font-size="7" fill="#44337a"> followup_date</text>
            <text x="525" y="463" font-size="7" fill="#44337a"> followup_instructions</text>
            <text x="525" y="476" font-size="7" fill="#44337a"> is_free_followup (within validity)</text>
            <text x="525" y="489" font-size="7" fill="#44337a"> previous_visit_id (chain link)</text>
            <text x="525" y="502" font-size="7" fill="#44337a"> registration_expiry_date</text>
        </svg>
    </div>

    <!-- Diagram 2: OPD Configuration & Rate Management -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">OPD Configuration & Rate Management</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="configArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#805ad5"/>
                </marker>
            </defs>

            <!-- OPD Configuration -->
            <rect x="10" y="10" width="360" height="235" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="190" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">OpdConfiguration Model</text>

            <!-- Entry Card Settings -->
            <rect x="25" y="50" width="160" height="90" rx="6" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="105" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Entry Card Settings</text>
            <text x="35" y="88" font-size="6" fill="#44337a"> charge_entry_card (bool)</text>
            <text x="35" y="100" font-size="6" fill="#44337a"> entry_card_amount</text>
            <text x="35" y="112" font-size="6" fill="#44337a"> entry_card_validity_type</text>
            <text x="35" y="124" font-size="6" fill="#44337a">  (one_time/daily/monthly/</text>
            <text x="35" y="136" font-size="6" fill="#44337a">   half_yearly/yearly/lifetime)</text>

            <!-- Consultation Settings -->
            <rect x="195" y="50" width="160" height="90" rx="6" fill="#d6bcfa" stroke="#805ad5"/>
            <text x="275" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#44337a">Consultation Settings</text>
            <text x="205" y="88" font-size="6" fill="#553c9a"> consultation_charge_mode</text>
            <text x="205" y="100" font-size="6" fill="#553c9a"> rate_type</text>
            <text x="205" y="112" font-size="6" fill="#553c9a"> allow_rate_override</text>
            <text x="205" y="124" font-size="6" fill="#553c9a"> require_doctor_approval</text>
            <text x="205" y="136" font-size="6" fill="#553c9a"> registration_mode</text>

            <!-- Token Settings -->
            <rect x="25" y="150" width="160" height="85" rx="6" fill="#b794f4" stroke="#6b46c1"/>
            <text x="105" y="170" text-anchor="middle" font-weight="bold" font-size="9" fill="white">Token Settings</text>
            <text x="35" y="188" font-size="6" fill="#faf5ff"> token_generation (mode)</text>
            <text x="35" y="200" font-size="6" fill="#faf5ff"> token_per_doctor (bool)</text>
            <text x="35" y="212" font-size="6" fill="#faf5ff"> token_per_department (bool)</text>
            <text x="35" y="224" font-size="6" fill="#faf5ff"> Reset daily/per-session</text>

            <!-- Follow-up Settings -->
            <rect x="195" y="150" width="160" height="85" rx="6" fill="#9f7aea" stroke="#553c9a"/>
            <text x="275" y="170" text-anchor="middle" font-weight="bold" font-size="9" fill="white">Follow-up Settings</text>
            <text x="205" y="188" font-size="6" fill="#faf5ff"> enable_free_followup</text>
            <text x="205" y="200" font-size="6" fill="#faf5ff"> default_followup_validity_days</text>
            <text x="205" y="212" font-size="6" fill="#faf5ff"> default_free_followup_days</text>
            <text x="205" y="224" font-size="6" fill="#faf5ff"> Auto-link to previous visit</text>

            <!-- Doctor OPD Rate -->
            <rect x="380" y="10" width="360" height="235" rx="8" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="560" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">DoctorOpdRate Model</text>

            <rect x="395" y="50" width="330" height="85" rx="6" fill="#c6f6d5" stroke="#38a169"/>
            <text x="560" y="70" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Rate Attributes</text>
            <text x="410" y="88" font-size="7" fill="#276749"> doctor_id (FK)</text>
            <text x="410" y="101" font-size="7" fill="#276749"> class_id (patient class - optional)</text>
            <text x="410" y="114" font-size="7" fill="#276749"> visit_type (new/followup/review)</text>
            <text x="410" y="127" font-size="7" fill="#276749"> charge_type (normal/emergency/vip)</text>

            <rect x="395" y="145" width="160" height="90" rx="6" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="475" y="165" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">Rate Values</text>
            <text x="410" y="183" font-size="6" fill="#276749"> rate (consultation fee)</text>
            <text x="410" y="196" font-size="6" fill="#276749"> free_followup_rate</text>
            <text x="410" y="209" font-size="6" fill="#276749"> effective_from date</text>
            <text x="410" y="222" font-size="6" fill="#276749"> effective_to date</text>

            <rect x="565" y="145" width="160" height="90" rx="6" fill="#68d391" stroke="#38a169"/>
            <text x="645" y="165" text-anchor="middle" font-weight="bold" font-size="9" fill="white">Rate Lookup</text>
            <text x="580" y="183" font-size="6" fill="#f0fff4">getRate() static method:</text>
            <text x="580" y="196" font-size="6" fill="#f0fff4">1. Check class-specific rate</text>
            <text x="580" y="209" font-size="6" fill="#f0fff4">2. Fallback to general rate</text>
            <text x="580" y="222" font-size="6" fill="#f0fff4">3. Check date validity</text>

            <!-- Rate Hierarchy -->
            <rect x="10" y="255" width="730" height="235" rx="8" fill="#fffff0" stroke="#d69e2e" stroke-width="2"/>
            <text x="375" y="280" text-anchor="middle" font-weight="bold" font-size="12" fill="#975a16">Rate Determination Hierarchy</text>

            <!-- Rate Flow -->
            <rect x="30" y="300" width="130" height="60" rx="6" fill="#fef3c7" stroke="#f59e0b"/>
            <text x="95" y="325" text-anchor="middle" font-weight="bold" font-size="9" fill="#92400e">Visit Request</text>
            <text x="95" y="345" text-anchor="middle" font-size="6" fill="#b45309">Doctor + Type + Class</text>

            <path d="M165,330 L195,330" stroke="#d69e2e" stroke-width="2" marker-end="url(#configArrow)"/>

            <rect x="200" y="300" width="130" height="60" rx="6" fill="#fde68a" stroke="#fbbf24"/>
            <text x="265" y="320" text-anchor="middle" font-weight="bold" font-size="8" fill="#92400e">Class-Specific</text>
            <text x="265" y="335" text-anchor="middle" font-size="6" fill="#b45309">DoctorOpdRate with</text>
            <text x="265" y="348" text-anchor="middle" font-size="6" fill="#b45309">class_id match</text>

            <path d="M335,330 L365,330" stroke="#d69e2e" stroke-width="2" marker-end="url(#configArrow)"/>

            <rect x="370" y="300" width="130" height="60" rx="6" fill="#fcd34d" stroke="#f59e0b"/>
            <text x="435" y="320" text-anchor="middle" font-weight="bold" font-size="8" fill="#78350f">Doctor Rate</text>
            <text x="435" y="335" text-anchor="middle" font-size="6" fill="#92400e">DoctorOpdRate</text>
            <text x="435" y="348" text-anchor="middle" font-size="6" fill="#92400e">class_id = null</text>

            <path d="M505,330 L535,330" stroke="#d69e2e" stroke-width="2" marker-end="url(#configArrow)"/>

            <rect x="540" y="300" width="130" height="60" rx="6" fill="#fbbf24" stroke="#f59e0b"/>
            <text x="605" y="320" text-anchor="middle" font-weight="bold" font-size="8" fill="#78350f">Department Rate</text>
            <text x="605" y="335" text-anchor="middle" font-size="6" fill="#92400e">Default department</text>
            <text x="605" y="348" text-anchor="middle" font-size="6" fill="#92400e">consultation fee</text>

            <!-- Configuration Flags -->
            <rect x="30" y="380" width="220" height="100" rx="6" fill="#fef3c7" stroke="#f59e0b"/>
            <text x="140" y="400" text-anchor="middle" font-weight="bold" font-size="9" fill="#92400e">Configuration Flags</text>
            <text x="45" y="420" font-size="6" fill="#78350f"> use_doctor_wise_rates (bool)</text>
            <text x="45" y="433" font-size="6" fill="#78350f"> use_class_wise_rates (bool)</text>
            <text x="45" y="446" font-size="6" fill="#78350f"> allow_rate_override (bool)</text>
            <text x="45" y="459" font-size="6" fill="#78350f"> require_doctor_approval_for_rate_change</text>
            <text x="45" y="472" font-size="6" fill="#78350f"> require_payment_before_consultation</text>

            <!-- Mandatory Settings -->
            <rect x="265" y="380" width="220" height="100" rx="6" fill="#e6fffa" stroke="#38b2ac"/>
            <text x="375" y="400" text-anchor="middle" font-weight="bold" font-size="9" fill="#285e61">Mandatory Settings</text>
            <text x="280" y="420" font-size="6" fill="#2c7a7b"> mandatory_vitals (bool)</text>
            <text x="280" y="433" font-size="6" fill="#2c7a7b"> mandatory_chief_complaint (bool)</text>
            <text x="280" y="446" font-size="6" fill="#2c7a7b"> allow_multiple_visits_per_day</text>
            <text x="280" y="459" font-size="6" fill="#2c7a7b"> appointment_expiry_days</text>
            <text x="280" y="472" font-size="6" fill="#2c7a7b"> auto_cancel_expired_appointments</text>

            <!-- Appointment Settings -->
            <rect x="500" y="380" width="225" height="100" rx="6" fill="#fed7e2" stroke="#d53f8c"/>
            <text x="612" y="400" text-anchor="middle" font-weight="bold" font-size="9" fill="#97266d">Appointment Settings</text>
            <text x="515" y="420" font-size="6" fill="#702459"> appointment_expiry_days</text>
            <text x="515" y="433" font-size="6" fill="#702459"> auto_cancel_expired_appointments</text>
            <text x="515" y="446" font-size="6" fill="#702459"> appointment_cancel_time</text>
            <text x="515" y="459" font-size="6" fill="#702459"> Links to OpdTimeSlot for scheduling</text>
            <text x="515" y="472" font-size="6" fill="#702459"> Appointment  OpdVisit conversion</text>
        </svg>
    </div>

    <!-- Diagram 3: Doctor Schedule & Time Slots -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Doctor Schedule & Time Slot Management</div>
        <svg width="750" height="500" viewBox="0 0 750 500">
            <defs>
                <marker id="slotArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#4299e1"/>
                </marker>
            </defs>

            <!-- OpdTimeSlot Model -->
            <rect x="10" y="10" width="360" height="230" rx="8" fill="#ebf8ff" stroke="#4299e1" stroke-width="2"/>
            <text x="190" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#2c5282">OpdTimeSlot Model</text>

            <rect x="25" y="50" width="330" height="180" rx="6" fill="#fff" stroke="#bee3f8" stroke-width="1"/>

            <text x="40" y="75" font-size="8" fill="#2c5282" font-weight="bold">Primary Key:</text>
            <text x="120" y="75" font-size="8" fill="#2c5282">slot_id</text>

            <text x="40" y="95" font-size="8" fill="#2c5282" font-weight="bold">Attributes:</text>
            <text x="40" y="112" font-size="7" fill="#4a5568"> doctor_id (FK to Doctor)</text>
            <text x="40" y="127" font-size="7" fill="#4a5568"> department_id (FK to Department)</text>
            <text x="40" y="142" font-size="7" fill="#4a5568"> day_of_week (monday/tuesday/.../sunday)</text>
            <text x="40" y="157" font-size="7" fill="#4a5568"> start_time, end_time</text>
            <text x="40" y="172" font-size="7" fill="#4a5568"> slot_duration_minutes (e.g., 15, 20, 30)</text>
            <text x="40" y="187" font-size="7" fill="#4a5568"> max_patients_per_slot</text>
            <text x="40" y="202" font-size="7" fill="#4a5568"> max_patients_per_session</text>
            <text x="40" y="217" font-size="7" fill="#4a5568"> is_active (boolean)</text>

            <!-- Weekly Schedule Visual -->
            <rect x="380" y="10" width="360" height="230" rx="8" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="560" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#276749">Weekly Schedule Example</text>

            <!-- Day Headers -->
            <rect x="395" y="50" width="45" height="25" rx="3" fill="#c6f6d5" stroke="#38a169"/>
            <text x="417" y="67" text-anchor="middle" font-size="7" fill="#22543d">Mon</text>

            <rect x="445" y="50" width="45" height="25" rx="3" fill="#c6f6d5" stroke="#38a169"/>
            <text x="467" y="67" text-anchor="middle" font-size="7" fill="#22543d">Tue</text>

            <rect x="495" y="50" width="45" height="25" rx="3" fill="#c6f6d5" stroke="#38a169"/>
            <text x="517" y="67" text-anchor="middle" font-size="7" fill="#22543d">Wed</text>

            <rect x="545" y="50" width="45" height="25" rx="3" fill="#c6f6d5" stroke="#38a169"/>
            <text x="567" y="67" text-anchor="middle" font-size="7" fill="#22543d">Thu</text>

            <rect x="595" y="50" width="45" height="25" rx="3" fill="#c6f6d5" stroke="#38a169"/>
            <text x="617" y="67" text-anchor="middle" font-size="7" fill="#22543d">Fri</text>

            <rect x="645" y="50" width="45" height="25" rx="3" fill="#9ae6b4" stroke="#48bb78"/>
            <text x="667" y="67" text-anchor="middle" font-size="7" fill="#22543d">Sat</text>

            <rect x="695" y="50" width="35" height="25" rx="3" fill="#feebc8" stroke="#ed8936"/>
            <text x="712" y="67" text-anchor="middle" font-size="6" fill="#c05621">Sun</text>

            <!-- Morning Session -->
            <text x="395" y="95" font-size="7" fill="#276749" font-weight="bold">Morning (09:00-13:00)</text>

            <rect x="395" y="100" width="45" height="35" rx="3" fill="#68d391" stroke="#38a169"/>
            <text x="417" y="118" text-anchor="middle" font-size="6" fill="white">09-13</text>
            <text x="417" y="130" text-anchor="middle" font-size="5" fill="#f0fff4">20 slots</text>

            <rect x="445" y="100" width="45" height="35" rx="3" fill="#68d391" stroke="#38a169"/>
            <text x="467" y="118" text-anchor="middle" font-size="6" fill="white">09-13</text>
            <text x="467" y="130" text-anchor="middle" font-size="5" fill="#f0fff4">20 slots</text>

            <rect x="495" y="100" width="45" height="35" rx="3" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="517" y="120" text-anchor="middle" font-size="6" fill="#718096">OFF</text>

            <rect x="545" y="100" width="45" height="35" rx="3" fill="#68d391" stroke="#38a169"/>
            <text x="567" y="118" text-anchor="middle" font-size="6" fill="white">09-13</text>
            <text x="567" y="130" text-anchor="middle" font-size="5" fill="#f0fff4">20 slots</text>

            <rect x="595" y="100" width="45" height="35" rx="3" fill="#68d391" stroke="#38a169"/>
            <text x="617" y="118" text-anchor="middle" font-size="6" fill="white">09-12</text>
            <text x="617" y="130" text-anchor="middle" font-size="5" fill="#f0fff4">15 slots</text>

            <rect x="645" y="100" width="45" height="35" rx="3" fill="#68d391" stroke="#38a169"/>
            <text x="667" y="118" text-anchor="middle" font-size="6" fill="white">10-13</text>
            <text x="667" y="130" text-anchor="middle" font-size="5" fill="#f0fff4">15 slots</text>

            <rect x="695" y="100" width="35" height="35" rx="3" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="712" y="120" text-anchor="middle" font-size="5" fill="#718096">OFF</text>

            <!-- Evening Session -->
            <text x="395" y="155" font-size="7" fill="#276749" font-weight="bold">Evening (17:00-20:00)</text>

            <rect x="395" y="160" width="45" height="35" rx="3" fill="#4299e1" stroke="#2b6cb0"/>
            <text x="417" y="178" text-anchor="middle" font-size="6" fill="white">17-20</text>
            <text x="417" y="190" text-anchor="middle" font-size="5" fill="#ebf8ff">15 slots</text>

            <rect x="445" y="160" width="45" height="35" rx="3" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="467" y="180" text-anchor="middle" font-size="6" fill="#718096">OFF</text>

            <rect x="495" y="160" width="45" height="35" rx="3" fill="#4299e1" stroke="#2b6cb0"/>
            <text x="517" y="178" text-anchor="middle" font-size="6" fill="white">17-20</text>
            <text x="517" y="190" text-anchor="middle" font-size="5" fill="#ebf8ff">15 slots</text>

            <rect x="545" y="160" width="45" height="35" rx="3" fill="#4299e1" stroke="#2b6cb0"/>
            <text x="567" y="178" text-anchor="middle" font-size="6" fill="white">17-20</text>
            <text x="567" y="190" text-anchor="middle" font-size="5" fill="#ebf8ff">15 slots</text>

            <rect x="595" y="160" width="45" height="35" rx="3" fill="#4299e1" stroke="#2b6cb0"/>
            <text x="617" y="178" text-anchor="middle" font-size="6" fill="white">17-19</text>
            <text x="617" y="190" text-anchor="middle" font-size="5" fill="#ebf8ff">10 slots</text>

            <rect x="645" y="160" width="45" height="35" rx="3" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="667" y="180" text-anchor="middle" font-size="6" fill="#718096">OFF</text>

            <rect x="695" y="160" width="35" height="35" rx="3" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="712" y="180" text-anchor="middle" font-size="5" fill="#718096">OFF</text>

            <!-- Legend -->
            <rect x="395" y="205" width="335" height="25" rx="4" fill="#f7fafc" stroke="#e2e8f0"/>
            <circle cx="415" cy="217" r="6" fill="#68d391"/>
            <text x="430" y="220" font-size="6" fill="#4a5568">Morning</text>
            <circle cx="480" cy="217" r="6" fill="#4299e1"/>
            <text x="495" y="220" font-size="6" fill="#4a5568">Evening</text>
            <circle cx="545" cy="217" r="6" fill="#e2e8f0"/>
            <text x="560" y="220" font-size="6" fill="#4a5568">Off</text>
            <text x="620" y="220" font-size="6" fill="#4a5568">Slot Duration: 15 min</text>

            <!-- Slot Generation -->
            <rect x="10" y="250" width="365" height="240" rx="8" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="192" y="275" text-anchor="middle" font-weight="bold" font-size="12" fill="#553c9a">Slot Generation Methods</text>

            <rect x="25" y="290" width="335" height="90" rx="6" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="192" y="310" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">getAvailableSlots($doctorId, $date)</text>

            <text x="40" y="330" font-size="6" fill="#44337a">1. Get day_of_week from date</text>
            <text x="40" y="343" font-size="6" fill="#44337a">2. Fetch OpdTimeSlot records for doctor + day</text>
            <text x="40" y="356" font-size="6" fill="#44337a">3. Generate time slots based on duration</text>
            <text x="40" y="369" font-size="6" fill="#44337a">4. Check Appointment count for each slot</text>
            <text x="40" y="382" font-size="6" fill="#44337a">5. Return slots with available capacity</text>

            <rect x="25" y="390" width="335" height="90" rx="6" fill="#d6bcfa" stroke="#805ad5"/>
            <text x="192" y="410" text-anchor="middle" font-weight="bold" font-size="9" fill="#44337a">generateSlots() Instance Method</text>

            <text x="40" y="430" font-size="6" fill="#553c9a">1. Parse start_time and end_time</text>
            <text x="40" y="443" font-size="6" fill="#553c9a">2. Calculate slot intervals</text>
            <text x="40" y="456" font-size="6" fill="#553c9a">3. Generate slot_number sequence</text>
            <text x="40" y="469" font-size="6" fill="#553c9a">4. Return array of time ranges</text>

            <!-- Queue Management -->
            <rect x="385" y="250" width="355" height="240" rx="8" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="562" y="275" text-anchor="middle" font-weight="bold" font-size="12" fill="#c05621">Queue & Token Display</text>

            <!-- Queue Flow -->
            <rect x="400" y="295" width="85" height="55" rx="6" fill="#fef3c7" stroke="#f59e0b"/>
            <text x="442" y="315" text-anchor="middle" font-weight="bold" font-size="8" fill="#92400e">Token #1</text>
            <text x="442" y="330" text-anchor="middle" font-size="6" fill="#b45309">Waiting</text>
            <text x="442" y="343" text-anchor="middle" font-size="5" fill="#78350f">09:00</text>

            <path d="M490,322 L510,322" stroke="#ed8936" stroke-width="1.5" marker-end="url(#slotArrow)"/>

            <rect x="515" y="295" width="85" height="55" rx="6" fill="#fed7aa" stroke="#ed8936"/>
            <text x="557" y="315" text-anchor="middle" font-weight="bold" font-size="8" fill="#c05621">Token #2</text>
            <text x="557" y="330" text-anchor="middle" font-size="6" fill="#ea580c">In Consult</text>
            <text x="557" y="343" text-anchor="middle" font-size="5" fill="#9a3412">09:15</text>

            <path d="M605,322 L625,322" stroke="#ed8936" stroke-width="1.5" marker-end="url(#slotArrow)"/>

            <rect x="630" y="295" width="85" height="55" rx="6" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="672" y="315" text-anchor="middle" font-weight="bold" font-size="8" fill="#22543d">Token #3</text>
            <text x="672" y="330" text-anchor="middle" font-size="6" fill="#276749">Completed</text>
            <text x="672" y="343" text-anchor="middle" font-size="5" fill="#166534">09:30</text>

            <!-- Status Definitions -->
            <rect x="400" y="365" width="325" height="115" rx="6" fill="#fff" stroke="#fbd38d"/>
            <text x="562" y="385" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">OpdVisit Status Flow</text>

            <rect x="415" y="400" width="70" height="25" rx="4" fill="#e2e8f0" stroke="#a0aec0"/>
            <text x="450" y="416" text-anchor="middle" font-size="7" fill="#4a5568">registered</text>

            <path d="M490,412 L510,412" stroke="#4299e1" stroke-width="1.5" marker-end="url(#slotArrow)"/>

            <rect x="515" y="400" width="60" height="25" rx="4" fill="#feebc8" stroke="#ed8936"/>
            <text x="545" y="416" text-anchor="middle" font-size="7" fill="#c05621">waiting</text>

            <path d="M580,412 L600,412" stroke="#4299e1" stroke-width="1.5" marker-end="url(#slotArrow)"/>

            <rect x="605" y="400" width="70" height="25" rx="4" fill="#bee3f8" stroke="#4299e1"/>
            <text x="640" y="416" text-anchor="middle" font-size="6" fill="#2c5282">in_consult</text>

            <path d="M678,412 L698,412" stroke="#48bb78" stroke-width="1.5" marker-end="url(#slotArrow)"/>

            <rect x="700" y="400" width="20" height="25" rx="4" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="710" y="416" text-anchor="middle" font-size="5" fill="#22543d"></text>

            <!-- Cancelled path -->
            <path d="M545,428 L545,450 L640,450" stroke="#fc8181" stroke-width="1.5" marker-end="url(#slotArrow)"/>
            <rect x="645" y="438" width="60" height="25" rx="4" fill="#fed7d7" stroke="#fc8181"/>
            <text x="675" y="454" text-anchor="middle" font-size="7" fill="#c53030">cancelled</text>

            <text x="415" y="478" font-size="6" fill="#78350f"> cancel_reason_id tracks cancellation reason</text>
        </svg>
    </div>

    <!-- Diagram 4: OPD Visit Status & Relationships -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">OPD Visit Model & Relationships</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <defs>
                <marker id="relArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#38a169"/>
                </marker>
            </defs>

            <!-- Central OpdVisit -->
            <rect x="250" y="10" width="250" height="200" rx="8" fill="#ebf8ff" stroke="#4299e1" stroke-width="3"/>
            <text x="375" y="35" text-anchor="middle" font-weight="bold" font-size="14" fill="#2c5282">OpdVisit</text>
            <text x="375" y="50" text-anchor="middle" font-size="8" fill="#4299e1">Primary Key: opd_id</text>

            <line x1="260" y1="58" x2="490" y2="58" stroke="#bee3f8" stroke-width="1"/>

            <text x="265" y="75" font-size="7" fill="#2b6cb0" font-weight="bold">Core Fields:</text>
            <text x="265" y="90" font-size="6" fill="#4a5568">opd_number, visit_date, visit_time</text>
            <text x="265" y="103" font-size="6" fill="#4a5568">patient_id, doctor_id, department_id</text>
            <text x="265" y="116" font-size="6" fill="#4a5568">visit_type, charge_type, token_number</text>

            <text x="265" y="133" font-size="7" fill="#2b6cb0" font-weight="bold">Clinical:</text>
            <text x="265" y="148" font-size="6" fill="#4a5568">chief_complaints, examination_notes</text>
            <text x="265" y="161" font-size="6" fill="#4a5568">diagnosis, advice, vitals_*</text>

            <text x="265" y="178" font-size="7" fill="#2b6cb0" font-weight="bold">Billing:</text>
            <text x="265" y="193" font-size="6" fill="#4a5568">consultation_fee, total_amount, net_amount</text>

            <!-- Patient -->
            <rect x="10" y="30" width="120" height="60" rx="6" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
            <text x="70" y="55" text-anchor="middle" font-weight="bold" font-size="9" fill="#276749">Patient</text>
            <text x="70" y="70" text-anchor="middle" font-size="6" fill="#22543d">patient_id</text>
            <path d="M130,60 L245,100" stroke="#48bb78" stroke-width="1.5" marker-end="url(#relArrow)"/>
            <text x="180" y="72" font-size="6" fill="#48bb78">belongsTo</text>

            <!-- Doctor -->
            <rect x="620" y="30" width="120" height="60" rx="6" fill="#faf5ff" stroke="#805ad5" stroke-width="2"/>
            <text x="680" y="55" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Doctor</text>
            <text x="680" y="70" text-anchor="middle" font-size="6" fill="#44337a">doctor_id</text>
            <path d="M615,60 L505,100" stroke="#805ad5" stroke-width="1.5" marker-end="url(#relArrow)"/>
            <text x="555" y="72" font-size="6" fill="#805ad5">belongsTo</text>

            <!-- Department -->
            <rect x="10" y="120" width="120" height="60" rx="6" fill="#feebc8" stroke="#ed8936" stroke-width="2"/>
            <text x="70" y="145" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Department</text>
            <text x="70" y="160" text-anchor="middle" font-size="6" fill="#975a16">department_id</text>
            <path d="M130,150 L245,130" stroke="#ed8936" stroke-width="1.5" marker-end="url(#relArrow)"/>
            <text x="175" y="135" font-size="6" fill="#ed8936">belongsTo</text>

            <!-- Bill -->
            <rect x="620" y="120" width="120" height="60" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
            <text x="680" y="145" text-anchor="middle" font-weight="bold" font-size="9" fill="#166534">Bill</text>
            <text x="680" y="160" text-anchor="middle" font-size="6" fill="#15803d">bill_id</text>
            <path d="M615,150 L505,130" stroke="#22c55e" stroke-width="1.5" marker-end="url(#relArrow)"/>
            <text x="555" y="135" font-size="6" fill="#22c55e">belongsTo</text>

            <!-- HasMany Relationships -->
            <rect x="10" y="230" width="170" height="130" rx="6" fill="#e9d8fd" stroke="#805ad5" stroke-width="2"/>
            <text x="95" y="250" text-anchor="middle" font-weight="bold" font-size="10" fill="#553c9a">HasMany Relations</text>

            <rect x="20" y="260" width="70" height="25" rx="3" fill="#d6bcfa" stroke="#9f7aea"/>
            <text x="55" y="276" text-anchor="middle" font-size="6" fill="#553c9a">services()</text>

            <rect x="100" y="260" width="70" height="25" rx="3" fill="#d6bcfa" stroke="#9f7aea"/>
            <text x="135" y="276" text-anchor="middle" font-size="6" fill="#553c9a">investigations()</text>

            <rect x="20" y="290" width="70" height="25" rx="3" fill="#d6bcfa" stroke="#9f7aea"/>
            <text x="55" y="306" text-anchor="middle" font-size="6" fill="#553c9a">vitals()</text>

            <rect x="100" y="290" width="70" height="25" rx="3" fill="#d6bcfa" stroke="#9f7aea"/>
            <text x="135" y="306" text-anchor="middle" font-size="6" fill="#553c9a">prescriptions()</text>

            <rect x="20" y="320" width="70" height="25" rx="3" fill="#d6bcfa" stroke="#9f7aea"/>
            <text x="55" y="336" text-anchor="middle" font-size="6" fill="#553c9a">labOrders()</text>

            <rect x="100" y="320" width="70" height="25" rx="3" fill="#d6bcfa" stroke="#9f7aea"/>
            <text x="135" y="336" text-anchor="middle" font-size="6" fill="#553c9a">followupVisits()</text>

            <path d="M180,290 L245,200" stroke="#805ad5" stroke-width="1.5" marker-end="url(#relArrow)"/>

            <!-- Self-Referential -->
            <rect x="200" y="230" width="160" height="130" rx="6" fill="#fed7e2" stroke="#d53f8c" stroke-width="2"/>
            <text x="280" y="250" text-anchor="middle" font-weight="bold" font-size="10" fill="#97266d">Visit Chain</text>

            <rect x="215" y="265" width="130" height="40" rx="4" fill="#fce7f3" stroke="#ec4899"/>
            <text x="280" y="282" text-anchor="middle" font-size="7" fill="#9d174d">previous_visit_id</text>
            <text x="280" y="297" text-anchor="middle" font-size="5" fill="#be185d">Links to parent OpdVisit</text>

            <rect x="215" y="315" width="130" height="35" rx="4" fill="#fbcfe8" stroke="#d53f8c"/>
            <text x="280" y="332" text-anchor="middle" font-size="7" fill="#9d174d">followupVisits()</text>
            <text x="280" y="345" text-anchor="middle" font-size="5" fill="#be185d">HasMany children</text>

            <path d="M280,230 L375,210" stroke="#d53f8c" stroke-width="1.5" marker-end="url(#relArrow)"/>

            <!-- Special Cases -->
            <rect x="380" y="230" width="160" height="130" rx="6" fill="#fff5f5" stroke="#fc8181" stroke-width="2"/>
            <text x="460" y="250" text-anchor="middle" font-weight="bold" font-size="10" fill="#c53030">Special Cases</text>

            <rect x="395" y="265" width="130" height="40" rx="4" fill="#fed7d7" stroke="#f56565"/>
            <text x="460" y="282" text-anchor="middle" font-size="7" fill="#c53030">MLC (Medico-Legal)</text>
            <text x="460" y="297" text-anchor="middle" font-size="5" fill="#9b2c2c">is_mlc, mlc_number, police_station</text>

            <rect x="395" y="315" width="130" height="35" rx="4" fill="#feb2b2" stroke="#fc8181"/>
            <text x="460" y="332" text-anchor="middle" font-size="7" fill="#c53030">Insurance</text>
            <text x="460" y="345" text-anchor="middle" font-size="5" fill="#9b2c2c">is_insurance, insurance_company</text>

            <path d="M460,230 L400,210" stroke="#fc8181" stroke-width="1.5" marker-end="url(#relArrow)"/>

            <!-- Other Relations -->
            <rect x="560" y="230" width="180" height="130" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
            <text x="650" y="250" text-anchor="middle" font-weight="bold" font-size="10" fill="#92400e">Other Relations</text>

            <text x="575" y="270" font-size="6" fill="#78350f"> referenceDoctor()</text>
            <text x="575" y="285" font-size="6" fill="#78350f"> patientClass()</text>
            <text x="575" y="300" font-size="6" fill="#78350f"> healthPackage()</text>
            <text x="575" y="315" font-size="6" fill="#78350f"> cancelReason()</text>
            <text x="575" y="330" font-size="6" fill="#78350f"> doctorGroup()</text>
            <text x="575" y="345" font-size="6" fill="#78350f"> entryCard()</text>

            <path d="M560,290 L505,200" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#relArrow)"/>

            <!-- OPD to IPD Conversion -->
            <rect x="10" y="380" width="730" height="130" rx="8" fill="#f7fafc" stroke="#4a5568" stroke-width="2"/>
            <text x="375" y="405" text-anchor="middle" font-weight="bold" font-size="12" fill="#2d3748">OPD  IPD Admission Workflow</text>

            <rect x="30" y="420" width="130" height="70" rx="6" fill="#ebf8ff" stroke="#4299e1"/>
            <text x="95" y="445" text-anchor="middle" font-weight="bold" font-size="9" fill="#2c5282">OPD Visit</text>
            <text x="95" y="460" text-anchor="middle" font-size="6" fill="#4299e1">Doctor recommends</text>
            <text x="95" y="475" text-anchor="middle" font-size="6" fill="#4299e1">admission</text>

            <path d="M165,455 L205,455" stroke="#4a5568" stroke-width="2" marker-end="url(#relArrow)"/>

            <rect x="210" y="420" width="130" height="70" rx="6" fill="#feebc8" stroke="#ed8936"/>
            <text x="275" y="445" text-anchor="middle" font-weight="bold" font-size="9" fill="#c05621">Admission Desk</text>
            <text x="275" y="460" text-anchor="middle" font-size="6" fill="#975a16">Ward/Bed selection</text>
            <text x="275" y="475" text-anchor="middle" font-size="6" fill="#975a16">Payment processing</text>

            <path d="M345,455 L385,455" stroke="#4a5568" stroke-width="2" marker-end="url(#relArrow)"/>

            <rect x="390" y="420" width="130" height="70" rx="6" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="455" y="445" text-anchor="middle" font-weight="bold" font-size="9" fill="#22543d">IPD Admission</text>
            <text x="455" y="460" text-anchor="middle" font-size="6" fill="#276749">opd_id linked</text>
            <text x="455" y="475" text-anchor="middle" font-size="6" fill="#276749">Carries OPD history</text>

            <path d="M525,455 L565,455" stroke="#4a5568" stroke-width="2" marker-end="url(#relArrow)"/>

            <rect x="570" y="420" width="150" height="70" rx="6" fill="#faf5ff" stroke="#805ad5"/>
            <text x="645" y="445" text-anchor="middle" font-weight="bold" font-size="9" fill="#553c9a">Data Carried Over</text>
            <text x="585" y="460" font-size="6" fill="#44337a"> diagnosis_at_admission</text>
            <text x="585" y="473" font-size="6" fill="#44337a"> doctor assignments</text>
            <text x="585" y="486" font-size="6" fill="#44337a"> vitals, chief_complaints</text>
        </svg>
    </div>

    <div class="info-box">
        <h4>OPD Module Workflow Key Points</h4>
        <ul>
            <li><strong>Visit Types:</strong> OpdVisit supports new, follow-up, and review visits with charge_type variations (normal/emergency/VIP)</li>
            <li><strong>Token System:</strong> Configurable token generation per doctor or department via OpdConfiguration; auto-incrementing token_number</li>
            <li><strong>Rate Management:</strong> DoctorOpdRate enables doctor-specific and class-specific consultation fees with date-based validity</li>
            <li><strong>Time Slots:</strong> OpdTimeSlot defines doctor schedules per day with slot_duration_minutes and max_patients_per_slot</li>
            <li><strong>Clinical Documentation:</strong> Vitals captured inline (vitals_*) or via PatientVital model; chief_complaints, examination_notes, diagnosis, advice</li>
            <li><strong>Prescriptions:</strong> Linked via prescriptions() HasMany relationship with PrescriptionItem for individual medications</li>
            <li><strong>Investigations:</strong> OpdInvestigation tracks lab/radiology orders with priority levels; links to LabOrder via labOrders()</li>
            <li><strong>Follow-up Chain:</strong> previous_visit_id creates visit chains; is_free_followup based on OpdConfiguration.default_free_followup_days</li>
            <li><strong>Entry Cards:</strong> Optional entry_card_id with configurable validity (one_time to lifetime) via OpdConfiguration</li>
            <li><strong>IPD Conversion:</strong> OPD visits can be converted to IPD admissions with opd_id linkage for continuity of care</li>
        </ul>
    </div>
</div>

<!-- Section 5: Database Schema -->
<div class="section">
    <h1>5. Database Schema</h1>

    <h2>5.1 Entity Relationship Overview</h2>

    <div class="diagram">
        <div class="diagram-title">Core Entity Relationships</div>
        <svg width="750" height="450" viewBox="0 0 750 450">
            <!-- Hospital (Central) -->
            <rect x="300" y="20" width="150" height="60" rx="8" class="arch-box"/>
            <text x="375" y="45" class="arch-text" font-size="11">Hospital</text>
            <text x="375" y="60" class="arch-text" font-size="8">(Multi-tenant root)</text>

            <!-- User -->
            <rect x="100" y="120" width="120" height="50" rx="8" class="arch-box-green"/>
            <text x="160" y="150" class="arch-text" font-size="10">User</text>

            <!-- Patient -->
            <rect x="300" y="120" width="150" height="50" rx="8" class="arch-box-orange"/>
            <text x="375" y="150" class="arch-text" font-size="10">Patient</text>

            <!-- Doctor -->
            <rect x="530" y="120" width="120" height="50" rx="8" class="arch-box-purple"/>
            <text x="590" y="150" class="arch-text" font-size="10">Doctor</text>

            <!-- Lines from Hospital -->
            <line x1="325" y1="80" x2="180" y2="120" stroke="#4a5568" stroke-width="1"/>
            <line x1="375" y1="80" x2="375" y2="120" stroke="#4a5568" stroke-width="1"/>
            <line x1="425" y1="80" x2="570" y2="120" stroke="#4a5568" stroke-width="1"/>

            <!-- OPD Visit -->
            <rect x="150" y="220" width="120" height="50" rx="8" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="210" y="250" class="arch-text-dark" font-size="10">OPD Visit</text>

            <!-- IPD Admission -->
            <rect x="300" y="220" width="150" height="50" rx="8" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="375" y="250" class="arch-text-dark" font-size="10">IPD Admission</text>

            <!-- Appointment -->
            <rect x="480" y="220" width="120" height="50" rx="8" fill="#c6f6d5" stroke="#48bb78"/>
            <text x="540" y="250" class="arch-text-dark" font-size="10">Appointment</text>

            <!-- Lines from Patient -->
            <line x1="340" y1="170" x2="230" y2="220" stroke="#4a5568" stroke-width="1"/>
            <line x1="375" y1="170" x2="375" y2="220" stroke="#4a5568" stroke-width="1"/>
            <line x1="410" y1="170" x2="520" y2="220" stroke="#4a5568" stroke-width="1"/>

            <!-- Lab Order -->
            <rect x="30" y="310" width="100" height="45" rx="8" fill="#fed7d7" stroke="#f56565"/>
            <text x="80" y="337" class="arch-text-dark" font-size="9">Lab Order</text>

            <!-- Radiology Order -->
            <rect x="150" y="310" width="100" height="45" rx="8" fill="#fed7d7" stroke="#f56565"/>
            <text x="200" y="332" class="arch-text-dark" font-size="8">Radiology</text>
            <text x="200" y="345" class="arch-text-dark" font-size="8">Order</text>

            <!-- Bill -->
            <rect x="270" y="310" width="100" height="45" rx="8" fill="#feebc8" stroke="#ed8936"/>
            <text x="320" y="337" class="arch-text-dark" font-size="9">Bill</text>

            <!-- Payment -->
            <rect x="390" y="310" width="100" height="45" rx="8" fill="#feebc8" stroke="#ed8936"/>
            <text x="440" y="337" class="arch-text-dark" font-size="9">Payment</text>

            <!-- Prescription -->
            <rect x="510" y="310" width="100" height="45" rx="8" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="560" y="337" class="arch-text-dark" font-size="9">Prescription</text>

            <!-- OT Schedule -->
            <rect x="630" y="310" width="100" height="45" rx="8" fill="#e9d8fd" stroke="#9f7aea"/>
            <text x="680" y="337" class="arch-text-dark" font-size="9">OT Schedule</text>

            <!-- Lines from visits -->
            <line x1="190" y1="270" x2="90" y2="310" stroke="#4a5568" stroke-width="1"/>
            <line x1="210" y1="270" x2="200" y2="310" stroke="#4a5568" stroke-width="1"/>
            <line x1="350" y1="270" x2="320" y2="310" stroke="#4a5568" stroke-width="1"/>
            <line x1="400" y1="270" x2="440" y2="310" stroke="#4a5568" stroke-width="1"/>
            <line x1="230" y1="270" x2="560" y2="310" stroke="#4a5568" stroke-width="1"/>
            <line x1="420" y1="270" x2="680" y2="310" stroke="#4a5568" stroke-width="1"/>

            <!-- Ward/Bed -->
            <rect x="30" y="390" width="80" height="40" rx="5" fill="#bee3f8" stroke="#3182ce"/>
            <text x="70" y="415" class="arch-text-dark" font-size="8">Ward</text>

            <rect x="130" y="390" width="80" height="40" rx="5" fill="#bee3f8" stroke="#3182ce"/>
            <text x="170" y="415" class="arch-text-dark" font-size="8">Bed</text>

            <!-- Department -->
            <rect x="230" y="390" width="100" height="40" rx="5" fill="#bee3f8" stroke="#3182ce"/>
            <text x="280" y="415" class="arch-text-dark" font-size="8">Department</text>

            <!-- Service -->
            <rect x="350" y="390" width="80" height="40" rx="5" fill="#bee3f8" stroke="#3182ce"/>
            <text x="390" y="415" class="arch-text-dark" font-size="8">Service</text>

            <!-- Drug -->
            <rect x="450" y="390" width="80" height="40" rx="5" fill="#bee3f8" stroke="#3182ce"/>
            <text x="490" y="415" class="arch-text-dark" font-size="8">Drug</text>

            <!-- Item -->
            <rect x="550" y="390" width="80" height="40" rx="5" fill="#bee3f8" stroke="#3182ce"/>
            <text x="590" y="415" class="arch-text-dark" font-size="8">Item</text>

            <!-- Role -->
            <rect x="650" y="390" width="80" height="40" rx="5" fill="#bee3f8" stroke="#3182ce"/>
            <text x="690" y="415" class="arch-text-dark" font-size="8">Role</text>
        </svg>
    </div>

    <h2>5.2 Core Tables Summary</h2>

    <table>
        <tr>
            <th>Category</th>
            <th>Tables</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>Core</td>
            <td>hospitals, users, roles, permissions</td>
            <td>Multi-tenant and authentication</td>
        </tr>
        <tr>
            <td>Patient</td>
            <td>patients, patient_classes, patient_vitals, patient_documents</td>
            <td>Patient registry and demographics</td>
        </tr>
        <tr>
            <td>Clinical</td>
            <td>opd_visits, ipd_admissions, appointments, prescriptions</td>
            <td>Clinical transactions</td>
        </tr>
        <tr>
            <td>Doctor</td>
            <td>doctors, doctor_groups, doctor_opd_rates, skill_sets</td>
            <td>Physician management</td>
        </tr>
        <tr>
            <td>Laboratory</td>
            <td>lab_categories, lab_tests, lab_orders, lab_order_details</td>
            <td>Lab operations</td>
        </tr>
        <tr>
            <td>Radiology</td>
            <td>radiology_modalities, radiology_tests, radiology_orders, radiology_reports</td>
            <td>Imaging operations</td>
        </tr>
        <tr>
            <td>OT</td>
            <td>operation_theaters, ot_schedules, ot_procedures, surgery_types</td>
            <td>Surgery management</td>
        </tr>
        <tr>
            <td>Pharmacy</td>
            <td>drugs, drug_batches, drug_categories, pharmacy_sales</td>
            <td>Pharmacy operations</td>
        </tr>
        <tr>
            <td>Inventory</td>
            <td>items, stores, suppliers, purchase_orders, indents, grn</td>
            <td>Stock management</td>
        </tr>
        <tr>
            <td>Billing</td>
            <td>services, bills, bill_details, payments, payment_modes</td>
            <td>Revenue cycle</td>
        </tr>
        <tr>
            <td>IPD</td>
            <td>wards, beds, ipd_progress_notes, ipd_nursing_charts, ipd_medications</td>
            <td>Inpatient care</td>
        </tr>
        <tr>
            <td>Registration</td>
            <td>birth_registrations, death_registrations</td>
            <td>Vital events</td>
        </tr>
        <tr>
            <td>MRD</td>
            <td>medical_record_requests, mrd_file_movements, icd_codes</td>
            <td>Medical records</td>
        </tr>
        <tr>
            <td>Integration</td>
            <td>abha_registrations, fhir_resources, hl7_messages</td>
            <td>Interoperability</td>
        </tr>
    </table>

    <h2>5.3 Migration Files</h2>

    <table>
        <tr>
            <th>Migration</th>
            <th>Size</th>
            <th>Tables Created</th>
        </tr>
        <tr><td>create_users_table</td><td>-</td><td>users, sessions, password_reset_tokens</td></tr>
        <tr><td>create_hospitals_table</td><td>-</td><td>hospitals</td></tr>
        <tr><td>create_hims_tables</td><td>34.5 KB</td><td>Core HIMS entities (30+ tables)</td></tr>
        <tr><td>create_opd_masters_tables</td><td>20.3 KB</td><td>OPD master data</td></tr>
        <tr><td>create_opd_transaction_tables</td><td>10.7 KB</td><td>OPD transactions</td></tr>
        <tr><td>create_rbac_tables</td><td>-</td><td>roles, permissions, pivots</td></tr>
        <tr><td>create_notification_tables</td><td>5.6 KB</td><td>SMS gateways, templates, logs</td></tr>
        <tr><td>create_radiology_tables</td><td>9 KB</td><td>Radiology module</td></tr>
        <tr><td>create_ot_tables</td><td>14.1 KB</td><td>Operation theater</td></tr>
        <tr><td>create_inventory_tables</td><td>18.4 KB</td><td>Inventory management</td></tr>
        <tr><td>create_birth_death_tables</td><td>11 KB</td><td>Vital registration</td></tr>
        <tr><td>create_mrd_tables</td><td>9.7 KB</td><td>Medical records</td></tr>
        <tr><td>create_patient_portal_tables</td><td>7.3 KB</td><td>Patient portal</td></tr>
        <tr><td>create_abha_tables</td><td>6.8 KB</td><td>ABHA integration</td></tr>
        <tr><td>create_fhir_tables</td><td>6.2 KB</td><td>FHIR/HL7</td></tr>
    </table>

    <h2>5.4 Detailed Entity Relationship Diagrams</h2>

    <p>The following diagrams illustrate the detailed database schema with table structures, primary keys, foreign keys, and relationships.</p>

    <!-- Patient Management Schema -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Patient Management Schema</div>
        <svg width="750" height="520" viewBox="0 0 750 520">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="510" fill="#f8fafc" rx="10"/>

            <!-- Patients Table -->
            <rect x="20" y="30" width="220" height="280" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <rect x="20" y="30" width="220" height="28" rx="6" fill="#3182ce"/>
            <text x="130" y="49" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">patients</text>
            <text x="28" y="72" font-size="9" fill="#2d3748">PK patient_id BIGINT</text>
            <text x="28" y="86" font-size="9" fill="#718096">pcd VARCHAR(20) UNIQUE</text>
            <text x="28" y="100" font-size="9" fill="#718096">patient_name VARCHAR(100)</text>
            <text x="28" y="114" font-size="9" fill="#718096">guardian_name VARCHAR(100)</text>
            <text x="28" y="128" font-size="9" fill="#718096">dob DATE</text>
            <text x="28" y="142" font-size="9" fill="#718096">age INT, age_unit ENUM</text>
            <text x="28" y="156" font-size="9" fill="#718096">gender ENUM(m/f/o)</text>
            <text x="28" y="170" font-size="9" fill="#718096">blood_group VARCHAR(5)</text>
            <text x="28" y="184" font-size="9" fill="#718096">mobile, email VARCHAR</text>
            <text x="28" y="198" font-size="9" fill="#718096">address TEXT</text>
            <text x="28" y="212" font-size="9" fill="#718096">city, state, pincode</text>
            <text x="28" y="226" font-size="9" fill="#718096">aadhaar_number VARCHAR(12)</text>
            <text x="28" y="240" font-size="9" fill="#e53e3e">FK insurance_id  insurance</text>
            <text x="28" y="254" font-size="9" fill="#718096">insurance_policy_number</text>
            <text x="28" y="268" font-size="9" fill="#718096">emergency_contact_*</text>
            <text x="28" y="282" font-size="9" fill="#718096">allergies, medical_history</text>
            <text x="28" y="296" font-size="9" fill="#718096">is_active, timestamps</text>

            <!-- Insurance Companies Table -->
            <rect x="270" y="30" width="200" height="160" rx="6" fill="#fff" stroke="#48bb78" stroke-width="2"/>
            <rect x="270" y="30" width="200" height="28" rx="6" fill="#48bb78"/>
            <text x="370" y="49" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">insurance_companies</text>
            <text x="278" y="72" font-size="9" fill="#2d3748">PK insurance_id BIGINT</text>
            <text x="278" y="86" font-size="9" fill="#718096">company_code VARCHAR(20)</text>
            <text x="278" y="100" font-size="9" fill="#718096">company_name VARCHAR(100)</text>
            <text x="278" y="114" font-size="9" fill="#718096">address TEXT</text>
            <text x="278" y="128" font-size="9" fill="#718096">phone, email VARCHAR</text>
            <text x="278" y="142" font-size="9" fill="#718096">contact_person VARCHAR(100)</text>
            <text x="278" y="156" font-size="9" fill="#718096">discount_percent DECIMAL</text>
            <text x="278" y="170" font-size="9" fill="#718096">is_active, timestamps</text>

            <!-- Doctors Table -->
            <rect x="500" y="30" width="230" height="200" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <rect x="500" y="30" width="230" height="28" rx="6" fill="#9f7aea"/>
            <text x="615" y="49" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">doctors</text>
            <text x="508" y="72" font-size="9" fill="#2d3748">PK doctor_id BIGINT</text>
            <text x="508" y="86" font-size="9" fill="#718096">doctor_code VARCHAR(20) UNIQUE</text>
            <text x="508" y="100" font-size="9" fill="#718096">full_name VARCHAR(100)</text>
            <text x="508" y="114" font-size="9" fill="#718096">qualification, specialization</text>
            <text x="508" y="128" font-size="9" fill="#e53e3e">FK department_id  departments</text>
            <text x="508" y="142" font-size="9" fill="#e53e3e">FK skill_set_id  skill_sets</text>
            <text x="508" y="156" font-size="9" fill="#718096">mobile, email VARCHAR</text>
            <text x="508" y="170" font-size="9" fill="#718096">consultation_fee DECIMAL</text>
            <text x="508" y="184" font-size="9" fill="#718096">opd_available, ipd_available</text>
            <text x="508" y="198" font-size="9" fill="#718096">is_active BOOL, timestamps</text>

            <!-- Departments Table -->
            <rect x="270" y="210" width="200" height="130" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <rect x="270" y="210" width="200" height="28" rx="6" fill="#ed8936"/>
            <text x="370" y="229" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">departments</text>
            <text x="278" y="252" font-size="9" fill="#2d3748">PK department_id BIGINT</text>
            <text x="278" y="266" font-size="9" fill="#718096">department_code VARCHAR(20)</text>
            <text x="278" y="280" font-size="9" fill="#718096">department_name VARCHAR(100)</text>
            <text x="278" y="294" font-size="9" fill="#718096">description TEXT</text>
            <text x="278" y="308" font-size="9" fill="#718096">is_active BOOL</text>
            <text x="278" y="322" font-size="9" fill="#718096">timestamps</text>

            <!-- Appointments Table -->
            <rect x="20" y="330" width="220" height="180" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <rect x="20" y="330" width="220" height="28" rx="6" fill="#f56565"/>
            <text x="130" y="349" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">appointments</text>
            <text x="28" y="372" font-size="9" fill="#2d3748">PK appointment_id BIGINT</text>
            <text x="28" y="386" font-size="9" fill="#718096">appointment_number UNIQUE</text>
            <text x="28" y="400" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="28" y="414" font-size="9" fill="#e53e3e">FK doctor_id  doctors</text>
            <text x="28" y="428" font-size="9" fill="#e53e3e">FK department_id  departments</text>
            <text x="28" y="442" font-size="9" fill="#718096">appointment_date DATE</text>
            <text x="28" y="456" font-size="9" fill="#718096">appointment_time TIME</text>
            <text x="28" y="470" font-size="9" fill="#718096">status ENUM(scheduled...)</text>
            <text x="28" y="484" font-size="9" fill="#718096">reason, notes TEXT</text>
            <text x="28" y="498" font-size="9" fill="#718096">created_by, timestamps</text>

            <!-- Patient Vitals Table -->
            <rect x="500" y="250" width="230" height="160" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <rect x="500" y="250" width="230" height="28" rx="6" fill="#38b2ac"/>
            <text x="615" y="269" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">patient_vitals</text>
            <text x="508" y="292" font-size="9" fill="#2d3748">PK vital_id BIGINT</text>
            <text x="508" y="306" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="508" y="320" font-size="9" fill="#e53e3e">FK opd_id  opd_visits</text>
            <text x="508" y="334" font-size="9" fill="#e53e3e">FK ipd_id  ipd_admissions</text>
            <text x="508" y="348" font-size="9" fill="#718096">bp_systolic/diastolic INT</text>
            <text x="508" y="362" font-size="9" fill="#718096">pulse, spo2, temperature</text>
            <text x="508" y="376" font-size="9" fill="#718096">weight, height, bmi DECIMAL</text>
            <text x="508" y="390" font-size="9" fill="#718096">recorded_by, recorded_at</text>

            <!-- Relationship Lines -->
            <line x1="240" y1="240" x2="270" y2="100" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>
            <line x1="240" y1="200" x2="270" y2="260" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="470" y1="260" x2="500" y2="140" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="130" y1="310" x2="130" y2="330" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="240" y1="400" x2="500" y2="130" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>
            <line x1="240" y1="160" x2="500" y2="306" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>

            <!-- Legend -->
            <rect x="500" y="430" width="230" height="80" rx="6" fill="#edf2f7" stroke="#a0aec0"/>
            <text x="615" y="448" text-anchor="middle" font-weight="bold" font-size="10" fill="#2d3748">Legend</text>
            <text x="508" y="465" font-size="9" fill="#2d3748">PK = Primary Key</text>
            <text x="508" y="480" font-size="9" fill="#e53e3e">FK = Foreign Key</text>
            <line x1="508" y1="490" x2="540" y2="490" stroke="#e53e3e" stroke-width="1.5"/>
            <text x="548" y="494" font-size="9" fill="#718096">Relationship</text>
        </svg>
    </div>

    <!-- OPD/IPD Clinical Schema -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Clinical Operations Schema (OPD &amp; IPD)</div>
        <svg width="750" height="600" viewBox="0 0 750 600">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="590" fill="#f8fafc" rx="10"/>

            <!-- OPD Visits Table -->
            <rect x="20" y="20" width="220" height="260" rx="6" fill="#fff" stroke="#48bb78" stroke-width="2"/>
            <rect x="20" y="20" width="220" height="28" rx="6" fill="#48bb78"/>
            <text x="130" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">opd_visits</text>
            <text x="28" y="62" font-size="9" fill="#2d3748">PK opd_id BIGINT</text>
            <text x="28" y="76" font-size="9" fill="#718096">opd_number VARCHAR(20) UNIQUE</text>
            <text x="28" y="90" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="28" y="104" font-size="9" fill="#e53e3e">FK doctor_id  doctors</text>
            <text x="28" y="118" font-size="9" fill="#e53e3e">FK department_id  departments</text>
            <text x="28" y="132" font-size="9" fill="#718096">visit_date DATE, visit_time TIME</text>
            <text x="28" y="146" font-size="9" fill="#718096">token_number INT</text>
            <text x="28" y="160" font-size="9" fill="#718096">visit_type ENUM(new/followup)</text>
            <text x="28" y="174" font-size="9" fill="#718096">chief_complaints TEXT</text>
            <text x="28" y="188" font-size="9" fill="#718096">diagnosis TEXT</text>
            <text x="28" y="202" font-size="9" fill="#718096">vitals_bp, pulse, temp, spo2</text>
            <text x="28" y="216" font-size="9" fill="#718096">consultation_fee DECIMAL</text>
            <text x="28" y="230" font-size="9" fill="#718096">status ENUM(waiting/...)</text>
            <text x="28" y="244" font-size="9" fill="#718096">followup_date, payment_status</text>
            <text x="28" y="258" font-size="9" fill="#718096">created_by, timestamps</text>

            <!-- IPD Admissions Table -->
            <rect x="270" y="20" width="230" height="300" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <rect x="270" y="20" width="230" height="28" rx="6" fill="#3182ce"/>
            <text x="385" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">ipd_admissions</text>
            <text x="278" y="62" font-size="9" fill="#2d3748">PK ipd_id BIGINT</text>
            <text x="278" y="76" font-size="9" fill="#718096">ipd_number VARCHAR(20) UNIQUE</text>
            <text x="278" y="90" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="278" y="104" font-size="9" fill="#e53e3e">FK department_id  departments</text>
            <text x="278" y="118" font-size="9" fill="#e53e3e">FK admitting_doctor_id  doctors</text>
            <text x="278" y="132" font-size="9" fill="#e53e3e">FK treating_doctor_id  doctors</text>
            <text x="278" y="146" font-size="9" fill="#e53e3e">FK ward_id  wards</text>
            <text x="278" y="160" font-size="9" fill="#e53e3e">FK bed_id  beds</text>
            <text x="278" y="174" font-size="9" fill="#718096">admission_date DATETIME</text>
            <text x="278" y="188" font-size="9" fill="#718096">admission_type ENUM</text>
            <text x="278" y="202" font-size="9" fill="#718096">diagnosis_at_admission TEXT</text>
            <text x="278" y="216" font-size="9" fill="#718096">mlc_case BOOL, mlc_number</text>
            <text x="278" y="230" font-size="9" fill="#718096">insurance_applicable BOOL</text>
            <text x="278" y="244" font-size="9" fill="#718096">attendant_name, mobile</text>
            <text x="278" y="258" font-size="9" fill="#718096">discharge_date DATETIME</text>
            <text x="278" y="272" font-size="9" fill="#718096">discharge_type ENUM</text>
            <text x="278" y="286" font-size="9" fill="#718096">final_diagnosis, discharge_summary</text>
            <text x="278" y="300" font-size="9" fill="#718096">status ENUM, timestamps</text>

            <!-- Wards Table -->
            <rect x="530" y="20" width="200" height="140" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <rect x="530" y="20" width="200" height="28" rx="6" fill="#ed8936"/>
            <text x="630" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">wards</text>
            <text x="538" y="62" font-size="9" fill="#2d3748">PK ward_id BIGINT</text>
            <text x="538" y="76" font-size="9" fill="#718096">ward_code VARCHAR(20) UNIQUE</text>
            <text x="538" y="90" font-size="9" fill="#718096">ward_name VARCHAR(100)</text>
            <text x="538" y="104" font-size="9" fill="#718096">ward_type ENUM(gen/icu/...)</text>
            <text x="538" y="118" font-size="9" fill="#718096">total_beds INT</text>
            <text x="538" y="132" font-size="9" fill="#718096">charges_per_day DECIMAL</text>
            <text x="538" y="146" font-size="9" fill="#e53e3e">FK department_id  departments</text>

            <!-- Beds Table -->
            <rect x="530" y="180" width="200" height="120" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <rect x="530" y="180" width="200" height="28" rx="6" fill="#f56565"/>
            <text x="630" y="199" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">beds</text>
            <text x="538" y="222" font-size="9" fill="#2d3748">PK bed_id BIGINT</text>
            <text x="538" y="236" font-size="9" fill="#718096">bed_number VARCHAR(20)</text>
            <text x="538" y="250" font-size="9" fill="#e53e3e">FK ward_id  wards</text>
            <text x="538" y="264" font-size="9" fill="#718096">bed_type ENUM(std/icu/...)</text>
            <text x="538" y="278" font-size="9" fill="#718096">status ENUM(available/...)</text>

            <!-- Prescriptions Table -->
            <rect x="20" y="300" width="220" height="150" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <rect x="20" y="300" width="220" height="28" rx="6" fill="#9f7aea"/>
            <text x="130" y="319" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">prescriptions</text>
            <text x="28" y="342" font-size="9" fill="#2d3748">PK prescription_id BIGINT</text>
            <text x="28" y="356" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="28" y="370" font-size="9" fill="#e53e3e">FK opd_id  opd_visits</text>
            <text x="28" y="384" font-size="9" fill="#e53e3e">FK ipd_id  ipd_admissions</text>
            <text x="28" y="398" font-size="9" fill="#e53e3e">FK doctor_id  doctors</text>
            <text x="28" y="412" font-size="9" fill="#718096">prescription_date DATE</text>
            <text x="28" y="426" font-size="9" fill="#718096">diagnosis, instructions TEXT</text>
            <text x="28" y="440" font-size="9" fill="#718096">is_dispensed BOOL</text>

            <!-- Prescription Items -->
            <rect x="20" y="470" width="220" height="120" rx="6" fill="#fff" stroke="#805ad5" stroke-width="2"/>
            <rect x="20" y="470" width="220" height="28" rx="6" fill="#805ad5"/>
            <text x="130" y="489" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">prescription_items</text>
            <text x="28" y="512" font-size="9" fill="#2d3748">PK item_id BIGINT</text>
            <text x="28" y="526" font-size="9" fill="#e53e3e">FK prescription_id  prescriptions</text>
            <text x="28" y="540" font-size="9" fill="#e53e3e">FK drug_id  drugs</text>
            <text x="28" y="554" font-size="9" fill="#718096">medicine_name, dosage</text>
            <text x="28" y="568" font-size="9" fill="#718096">frequency, duration, quantity</text>
            <text x="28" y="582" font-size="9" fill="#718096">instructions TEXT</text>

            <!-- IPD Medications Table -->
            <rect x="270" y="340" width="230" height="130" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <rect x="270" y="340" width="230" height="28" rx="6" fill="#38b2ac"/>
            <text x="385" y="359" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">ipd_medications</text>
            <text x="278" y="382" font-size="9" fill="#2d3748">PK medication_id BIGINT</text>
            <text x="278" y="396" font-size="9" fill="#e53e3e">FK ipd_id  ipd_admissions</text>
            <text x="278" y="410" font-size="9" fill="#e53e3e">FK drug_id  drugs</text>
            <text x="278" y="424" font-size="9" fill="#718096">medicine_name, dosage, route</text>
            <text x="278" y="438" font-size="9" fill="#718096">frequency, start_date, end_date</text>
            <text x="278" y="452" font-size="9" fill="#e53e3e">FK prescribed_by  doctors</text>

            <!-- Nursing Notes Table -->
            <rect x="270" y="490" width="230" height="100" rx="6" fill="#fff" stroke="#dd6b20" stroke-width="2"/>
            <rect x="270" y="490" width="230" height="28" rx="6" fill="#dd6b20"/>
            <text x="385" y="509" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">nursing_notes</text>
            <text x="278" y="532" font-size="9" fill="#2d3748">PK note_id BIGINT</text>
            <text x="278" y="546" font-size="9" fill="#e53e3e">FK ipd_id  ipd_admissions</text>
            <text x="278" y="560" font-size="9" fill="#718096">note_date DATETIME, shift ENUM</text>
            <text x="278" y="574" font-size="9" fill="#718096">notes, observations TEXT</text>

            <!-- Skill Sets Table -->
            <rect x="530" y="320" width="200" height="100" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <rect x="530" y="320" width="200" height="28" rx="6" fill="#667eea"/>
            <text x="630" y="339" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">skill_sets</text>
            <text x="538" y="362" font-size="9" fill="#2d3748">PK skill_set_id BIGINT</text>
            <text x="538" y="376" font-size="9" fill="#718096">skill_code VARCHAR(20)</text>
            <text x="538" y="390" font-size="9" fill="#718096">skill_name VARCHAR(100)</text>
            <text x="538" y="404" font-size="9" fill="#718096">description, is_active</text>

            <!-- OPD Investigations -->
            <rect x="530" y="440" width="200" height="150" rx="6" fill="#fff" stroke="#d69e2e" stroke-width="2"/>
            <rect x="530" y="440" width="200" height="28" rx="6" fill="#d69e2e"/>
            <text x="630" y="459" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">opd_investigations</text>
            <text x="538" y="482" font-size="9" fill="#2d3748">PK investigation_id BIGINT</text>
            <text x="538" y="496" font-size="9" fill="#e53e3e">FK opd_id  opd_visits</text>
            <text x="538" y="510" font-size="9" fill="#718096">investigation_type ENUM</text>
            <text x="538" y="524" font-size="9" fill="#e53e3e">FK test_id  lab_tests</text>
            <text x="538" y="538" font-size="9" fill="#718096">investigation_name</text>
            <text x="538" y="552" font-size="9" fill="#718096">rate, priority, status</text>
            <text x="538" y="566" font-size="9" fill="#718096">ordered_by, ordered_at</text>
            <text x="538" y="580" font-size="9" fill="#718096">timestamps</text>

            <!-- Relationship Lines -->
            <line x1="500" y1="146" x2="530" y2="80" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="500" y1="160" x2="530" y2="240" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="630" y1="160" x2="630" y2="180" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="240" y1="200" x2="270" y2="200" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>
            <line x1="130" y1="280" x2="130" y2="300" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="130" y1="450" x2="130" y2="470" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="385" y1="320" x2="385" y2="340" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="385" y1="470" x2="385" y2="490" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="240" y1="160" x2="530" y2="496" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>
        </svg>
    </div>

    <!-- Laboratory & Radiology Schema -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Laboratory &amp; Radiology Schema</div>
        <svg width="750" height="550" viewBox="0 0 750 550">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="540" fill="#f8fafc" rx="10"/>

            <!-- Lab Categories -->
            <rect x="20" y="20" width="170" height="100" rx="6" fill="#fff" stroke="#48bb78" stroke-width="2"/>
            <rect x="20" y="20" width="170" height="28" rx="6" fill="#48bb78"/>
            <text x="105" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">lab_categories</text>
            <text x="28" y="62" font-size="9" fill="#2d3748">PK category_id BIGINT</text>
            <text x="28" y="76" font-size="9" fill="#718096">category_name VARCHAR</text>
            <text x="28" y="90" font-size="9" fill="#718096">description TEXT</text>
            <text x="28" y="104" font-size="9" fill="#718096">is_active BOOL</text>

            <!-- Lab Tests -->
            <rect x="20" y="140" width="170" height="160" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <rect x="20" y="140" width="170" height="28" rx="6" fill="#38b2ac"/>
            <text x="105" y="159" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">lab_tests</text>
            <text x="28" y="182" font-size="9" fill="#2d3748">PK test_id BIGINT</text>
            <text x="28" y="196" font-size="9" fill="#718096">test_code VARCHAR(20)</text>
            <text x="28" y="210" font-size="9" fill="#718096">test_name VARCHAR(100)</text>
            <text x="28" y="224" font-size="9" fill="#e53e3e">FK category_id  lab_cat</text>
            <text x="28" y="238" font-size="9" fill="#718096">rate DECIMAL(10,2)</text>
            <text x="28" y="252" font-size="9" fill="#718096">sample_type, normal_range</text>
            <text x="28" y="266" font-size="9" fill="#718096">unit, tat_hours INT</text>
            <text x="28" y="280" font-size="9" fill="#718096">is_active, timestamps</text>

            <!-- Lab Orders -->
            <rect x="20" y="320" width="170" height="170" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <rect x="20" y="320" width="170" height="28" rx="6" fill="#3182ce"/>
            <text x="105" y="339" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">lab_orders</text>
            <text x="28" y="362" font-size="9" fill="#2d3748">PK order_id BIGINT</text>
            <text x="28" y="376" font-size="9" fill="#718096">order_number UNIQUE</text>
            <text x="28" y="390" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="28" y="404" font-size="9" fill="#e53e3e">FK opd_id  opd_visits</text>
            <text x="28" y="418" font-size="9" fill="#e53e3e">FK ipd_id  ipd_admissions</text>
            <text x="28" y="432" font-size="9" fill="#718096">order_date DATE</text>
            <text x="28" y="446" font-size="9" fill="#e53e3e">FK referred_by  doctors</text>
            <text x="28" y="460" font-size="9" fill="#718096">priority ENUM, total_amount</text>
            <text x="28" y="474" font-size="9" fill="#718096">status ENUM, timestamps</text>

            <!-- Lab Order Details -->
            <rect x="210" y="320" width="170" height="140" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <rect x="210" y="320" width="170" height="28" rx="6" fill="#667eea"/>
            <text x="295" y="339" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">lab_order_details</text>
            <text x="218" y="362" font-size="9" fill="#2d3748">PK detail_id BIGINT</text>
            <text x="218" y="376" font-size="9" fill="#e53e3e">FK order_id  lab_orders</text>
            <text x="218" y="390" font-size="9" fill="#e53e3e">FK test_id  lab_tests</text>
            <text x="218" y="404" font-size="9" fill="#718096">rate DECIMAL(10,2)</text>
            <text x="218" y="418" font-size="9" fill="#718096">result_value VARCHAR</text>
            <text x="218" y="432" font-size="9" fill="#718096">result_status ENUM</text>
            <text x="218" y="446" font-size="9" fill="#718096">verified_by, verified_at</text>

            <!-- Radiology Modalities -->
            <rect x="410" y="20" width="160" height="120" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <rect x="410" y="20" width="160" height="28" rx="6" fill="#ed8936"/>
            <text x="490" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">radiology_modalities</text>
            <text x="418" y="62" font-size="9" fill="#2d3748">PK modality_id BIGINT</text>
            <text x="418" y="76" font-size="9" fill="#e53e3e">FK hospital_id  hospitals</text>
            <text x="418" y="90" font-size="9" fill="#718096">modality_code, name</text>
            <text x="418" y="104" font-size="9" fill="#718096">room_number</text>
            <text x="418" y="118" font-size="9" fill="#718096">is_contrast_available</text>
            <text x="418" y="132" font-size="9" fill="#718096">default_tat_hours</text>

            <!-- Radiology Tests -->
            <rect x="590" y="20" width="150" height="140" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <rect x="590" y="20" width="150" height="28" rx="6" fill="#f56565"/>
            <text x="665" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">radiology_tests</text>
            <text x="598" y="62" font-size="9" fill="#2d3748">PK radiology_test_id</text>
            <text x="598" y="76" font-size="9" fill="#e53e3e">FK modality_id  mod</text>
            <text x="598" y="90" font-size="9" fill="#718096">test_code, test_name</text>
            <text x="598" y="104" font-size="9" fill="#718096">body_part, laterality</text>
            <text x="598" y="118" font-size="9" fill="#718096">rate, contrast_rate</text>
            <text x="598" y="132" font-size="9" fill="#718096">consent_required BOOL</text>
            <text x="598" y="146" font-size="9" fill="#718096">preparation_instructions</text>

            <!-- Radiology Orders -->
            <rect x="410" y="160" width="160" height="180" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <rect x="410" y="160" width="160" height="28" rx="6" fill="#9f7aea"/>
            <text x="490" y="179" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">radiology_orders</text>
            <text x="418" y="202" font-size="9" fill="#2d3748">PK radiology_order_id</text>
            <text x="418" y="216" font-size="9" fill="#718096">order_number UNIQUE</text>
            <text x="418" y="230" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="418" y="244" font-size="9" fill="#e53e3e">FK opd_id  opd_visits</text>
            <text x="418" y="258" font-size="9" fill="#e53e3e">FK ipd_id  ipd_admissions</text>
            <text x="418" y="272" font-size="9" fill="#e53e3e">FK referring_doctor_id</text>
            <text x="418" y="286" font-size="9" fill="#718096">clinical_indication</text>
            <text x="418" y="300" font-size="9" fill="#718096">priority, pregnancy_status</text>
            <text x="418" y="314" font-size="9" fill="#718096">total_amount, status</text>
            <text x="418" y="328" font-size="9" fill="#718096">timestamps</text>

            <!-- Radiology Order Details -->
            <rect x="590" y="180" width="150" height="130" rx="6" fill="#fff" stroke="#805ad5" stroke-width="2"/>
            <rect x="590" y="180" width="150" height="28" rx="6" fill="#805ad5"/>
            <text x="665" y="199" text-anchor="middle" fill="#fff" font-weight="bold" font-size="9">radiology_order_details</text>
            <text x="598" y="222" font-size="9" fill="#2d3748">PK detail_id BIGINT</text>
            <text x="598" y="236" font-size="9" fill="#e53e3e">FK radiology_order_id</text>
            <text x="598" y="250" font-size="9" fill="#e53e3e">FK radiology_test_id</text>
            <text x="598" y="264" font-size="9" fill="#e53e3e">FK modality_id</text>
            <text x="598" y="278" font-size="9" fill="#718096">rate, with_contrast</text>
            <text x="598" y="292" font-size="9" fill="#718096">scheduled_datetime</text>
            <text x="598" y="306" font-size="9" fill="#718096">status ENUM</text>

            <!-- Radiology Reports -->
            <rect x="410" y="360" width="160" height="180" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <rect x="410" y="360" width="160" height="28" rx="6" fill="#38b2ac"/>
            <text x="490" y="379" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">radiology_reports</text>
            <text x="418" y="402" font-size="9" fill="#2d3748">PK report_id BIGINT</text>
            <text x="418" y="416" font-size="9" fill="#e53e3e">FK radiology_order_id</text>
            <text x="418" y="430" font-size="9" fill="#e53e3e">FK detail_id</text>
            <text x="418" y="444" font-size="9" fill="#e53e3e">FK patient_id</text>
            <text x="418" y="458" font-size="9" fill="#e53e3e">FK reporting_radiologist</text>
            <text x="418" y="472" font-size="9" fill="#718096">report_date, time</text>
            <text x="418" y="486" font-size="9" fill="#718096">technique, findings TEXT</text>
            <text x="418" y="500" font-size="9" fill="#718096">impression TEXT</text>
            <text x="418" y="514" font-size="9" fill="#718096">critical_finding BOOL</text>
            <text x="418" y="528" font-size="9" fill="#718096">report_status, verified_by</text>

            <!-- Radiology Images -->
            <rect x="590" y="330" width="150" height="140" rx="6" fill="#fff" stroke="#dd6b20" stroke-width="2"/>
            <rect x="590" y="330" width="150" height="28" rx="6" fill="#dd6b20"/>
            <text x="665" y="349" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">radiology_images</text>
            <text x="598" y="372" font-size="9" fill="#2d3748">PK image_id BIGINT</text>
            <text x="598" y="386" font-size="9" fill="#e53e3e">FK report_id  reports</text>
            <text x="598" y="400" font-size="9" fill="#e53e3e">FK detail_id</text>
            <text x="598" y="414" font-size="9" fill="#718096">image_type VARCHAR</text>
            <text x="598" y="428" font-size="9" fill="#718096">file_path, thumbnail</text>
            <text x="598" y="442" font-size="9" fill="#718096">study_instance_uid</text>
            <text x="598" y="456" font-size="9" fill="#718096">pacs_reference_id</text>

            <!-- Relationship Lines -->
            <line x1="105" y1="120" x2="105" y2="140" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="105" y1="300" x2="105" y2="320" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="190" y1="380" x2="210" y2="380" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="295" y1="320" x2="105" y2="200" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>
            <line x1="570" y1="80" x2="590" y2="80" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="570" y1="240" x2="590" y2="240" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="665" y1="160" x2="665" y2="180" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="490" y1="340" x2="490" y2="360" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="570" y1="420" x2="590" y2="400" stroke="#e53e3e" stroke-width="1.5"/>

            <!-- Section Labels -->
            <rect x="20" y="500" width="170" height="40" rx="6" fill="#e6fffa" stroke="#38b2ac"/>
            <text x="105" y="525" text-anchor="middle" font-weight="bold" font-size="10" fill="#234e52">LABORATORY MODULE</text>

            <rect x="410" y="500" width="330" height="40" rx="6" fill="#fef3c7" stroke="#d69e2e"/>
            <text x="575" y="525" text-anchor="middle" font-weight="bold" font-size="10" fill="#744210">RADIOLOGY MODULE</text>
        </svg>
    </div>

    <!-- Pharmacy & Inventory Schema -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Pharmacy &amp; Inventory Schema</div>
        <svg width="750" height="580" viewBox="0 0 750 580">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="570" fill="#f8fafc" rx="10"/>

            <!-- Drug Categories -->
            <rect x="20" y="20" width="150" height="90" rx="6" fill="#fff" stroke="#48bb78" stroke-width="2"/>
            <rect x="20" y="20" width="150" height="28" rx="6" fill="#48bb78"/>
            <text x="95" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">drug_categories</text>
            <text x="28" y="62" font-size="9" fill="#2d3748">PK category_id BIGINT</text>
            <text x="28" y="76" font-size="9" fill="#718096">category_name</text>
            <text x="28" y="90" font-size="9" fill="#718096">description, is_active</text>

            <!-- Drugs -->
            <rect x="20" y="130" width="150" height="200" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <rect x="20" y="130" width="150" height="28" rx="6" fill="#3182ce"/>
            <text x="95" y="149" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">drugs</text>
            <text x="28" y="172" font-size="9" fill="#2d3748">PK drug_id BIGINT</text>
            <text x="28" y="186" font-size="9" fill="#718096">drug_code UNIQUE</text>
            <text x="28" y="200" font-size="9" fill="#718096">drug_name, generic_name</text>
            <text x="28" y="214" font-size="9" fill="#e53e3e">FK category_id</text>
            <text x="28" y="228" font-size="9" fill="#e53e3e">FK schedule_id</text>
            <text x="28" y="242" font-size="9" fill="#718096">manufacturer</text>
            <text x="28" y="256" font-size="9" fill="#718096">drug_form ENUM</text>
            <text x="28" y="270" font-size="9" fill="#718096">strength, unit, pack_size</text>
            <text x="28" y="284" font-size="9" fill="#718096">mrp, purchase_rate</text>
            <text x="28" y="298" font-size="9" fill="#718096">sale_rate, reorder_level</text>
            <text x="28" y="312" font-size="9" fill="#718096">is_narcotic, is_active</text>

            <!-- Drug Batches -->
            <rect x="20" y="350" width="150" height="130" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <rect x="20" y="350" width="150" height="28" rx="6" fill="#9f7aea"/>
            <text x="95" y="369" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">drug_batches</text>
            <text x="28" y="392" font-size="9" fill="#2d3748">PK batch_id BIGINT</text>
            <text x="28" y="406" font-size="9" fill="#e53e3e">FK drug_id  drugs</text>
            <text x="28" y="420" font-size="9" fill="#718096">batch_number VARCHAR</text>
            <text x="28" y="434" font-size="9" fill="#718096">expiry_date DATE</text>
            <text x="28" y="448" font-size="9" fill="#718096">quantity INT</text>
            <text x="28" y="462" font-size="9" fill="#718096">purchase_rate, mrp</text>

            <!-- Pharmacy Sales -->
            <rect x="190" y="130" width="170" height="170" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <rect x="190" y="130" width="170" height="28" rx="6" fill="#ed8936"/>
            <text x="275" y="149" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">pharmacy_sales</text>
            <text x="198" y="172" font-size="9" fill="#2d3748">PK sale_id BIGINT</text>
            <text x="198" y="186" font-size="9" fill="#718096">sale_number UNIQUE</text>
            <text x="198" y="200" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="198" y="214" font-size="9" fill="#e53e3e">FK opd_id, ipd_id</text>
            <text x="198" y="228" font-size="9" fill="#718096">sale_date DATE</text>
            <text x="198" y="242" font-size="9" fill="#718096">subtotal, discount_*</text>
            <text x="198" y="256" font-size="9" fill="#718096">tax_amount, total_amount</text>
            <text x="198" y="270" font-size="9" fill="#718096">payment_mode ENUM</text>
            <text x="198" y="284" font-size="9" fill="#718096">payment_status ENUM</text>

            <!-- Pharmacy Sale Details -->
            <rect x="190" y="320" width="170" height="120" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <rect x="190" y="320" width="170" height="28" rx="6" fill="#f56565"/>
            <text x="275" y="339" text-anchor="middle" fill="#fff" font-weight="bold" font-size="9">pharmacy_sale_details</text>
            <text x="198" y="362" font-size="9" fill="#2d3748">PK detail_id BIGINT</text>
            <text x="198" y="376" font-size="9" fill="#e53e3e">FK sale_id  pharma_sales</text>
            <text x="198" y="390" font-size="9" fill="#e53e3e">FK drug_id  drugs</text>
            <text x="198" y="404" font-size="9" fill="#e53e3e">FK batch_id  drug_batches</text>
            <text x="198" y="418" font-size="9" fill="#718096">quantity, rate, discount</text>
            <text x="198" y="432" font-size="9" fill="#718096">tax, amount</text>

            <!-- Stores -->
            <rect x="400" y="20" width="160" height="120" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <rect x="400" y="20" width="160" height="28" rx="6" fill="#38b2ac"/>
            <text x="480" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">stores</text>
            <text x="408" y="62" font-size="9" fill="#2d3748">PK store_id BIGINT</text>
            <text x="408" y="76" font-size="9" fill="#e53e3e">FK hospital_id  hospitals</text>
            <text x="408" y="90" font-size="9" fill="#718096">store_code UNIQUE</text>
            <text x="408" y="104" font-size="9" fill="#718096">store_name, store_type</text>
            <text x="408" y="118" font-size="9" fill="#718096">location, in_charge_id</text>

            <!-- Items -->
            <rect x="580" y="20" width="160" height="180" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <rect x="580" y="20" width="160" height="28" rx="6" fill="#667eea"/>
            <text x="660" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">items</text>
            <text x="588" y="62" font-size="9" fill="#2d3748">PK item_id BIGINT</text>
            <text x="588" y="76" font-size="9" fill="#e53e3e">FK hospital_id</text>
            <text x="588" y="90" font-size="9" fill="#718096">item_code UNIQUE</text>
            <text x="588" y="104" font-size="9" fill="#718096">item_name, generic_name</text>
            <text x="588" y="118" font-size="9" fill="#e53e3e">FK category_id  item_cat</text>
            <text x="588" y="132" font-size="9" fill="#718096">item_type ENUM</text>
            <text x="588" y="146" font-size="9" fill="#718096">unit_of_measure, pack_size</text>
            <text x="588" y="160" font-size="9" fill="#718096">hsn_code, gst_percent</text>
            <text x="588" y="174" font-size="9" fill="#718096">reorder_level, min/max_stock</text>
            <text x="588" y="188" font-size="9" fill="#718096">is_batch_tracked, is_active</text>

            <!-- Item Stock -->
            <rect x="400" y="160" width="160" height="160" rx="6" fill="#fff" stroke="#d69e2e" stroke-width="2"/>
            <rect x="400" y="160" width="160" height="28" rx="6" fill="#d69e2e"/>
            <text x="480" y="179" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">item_stock</text>
            <text x="408" y="202" font-size="9" fill="#2d3748">PK stock_id BIGINT</text>
            <text x="408" y="216" font-size="9" fill="#e53e3e">FK store_id  stores</text>
            <text x="408" y="230" font-size="9" fill="#e53e3e">FK item_id  items</text>
            <text x="408" y="244" font-size="9" fill="#718096">batch_number VARCHAR</text>
            <text x="408" y="258" font-size="9" fill="#718096">expiry_date DATE</text>
            <text x="408" y="272" font-size="9" fill="#718096">quantity, reserved_qty</text>
            <text x="408" y="286" font-size="9" fill="#718096">purchase_rate, mrp</text>
            <text x="408" y="300" font-size="9" fill="#e53e3e">FK supplier_id  suppliers</text>

            <!-- Suppliers -->
            <rect x="580" y="220" width="160" height="130" rx="6" fill="#fff" stroke="#dd6b20" stroke-width="2"/>
            <rect x="580" y="220" width="160" height="28" rx="6" fill="#dd6b20"/>
            <text x="660" y="239" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">suppliers</text>
            <text x="588" y="262" font-size="9" fill="#2d3748">PK supplier_id BIGINT</text>
            <text x="588" y="276" font-size="9" fill="#e53e3e">FK hospital_id</text>
            <text x="588" y="290" font-size="9" fill="#718096">supplier_code, name</text>
            <text x="588" y="304" font-size="9" fill="#718096">contact_person, phone</text>
            <text x="588" y="318" font-size="9" fill="#718096">address, gst_number</text>
            <text x="588" y="332" font-size="9" fill="#718096">credit_limit, credit_days</text>

            <!-- Purchase Orders -->
            <rect x="400" y="340" width="160" height="150" rx="6" fill="#fff" stroke="#805ad5" stroke-width="2"/>
            <rect x="400" y="340" width="160" height="28" rx="6" fill="#805ad5"/>
            <text x="480" y="359" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">purchase_orders</text>
            <text x="408" y="382" font-size="9" fill="#2d3748">PK po_id BIGINT</text>
            <text x="408" y="396" font-size="9" fill="#718096">po_number UNIQUE</text>
            <text x="408" y="410" font-size="9" fill="#e53e3e">FK supplier_id  suppliers</text>
            <text x="408" y="424" font-size="9" fill="#e53e3e">FK store_id  stores</text>
            <text x="408" y="438" font-size="9" fill="#718096">po_date, expected_delivery</text>
            <text x="408" y="452" font-size="9" fill="#718096">subtotal, discount, tax</text>
            <text x="408" y="466" font-size="9" fill="#718096">total_amount, status</text>
            <text x="408" y="480" font-size="9" fill="#718096">approved_by, approved_at</text>

            <!-- GRN -->
            <rect x="580" y="370" width="160" height="140" rx="6" fill="#fff" stroke="#e53e3e" stroke-width="2"/>
            <rect x="580" y="370" width="160" height="28" rx="6" fill="#e53e3e"/>
            <text x="660" y="389" text-anchor="middle" fill="#fff" font-weight="bold" font-size="9">goods_receipt_notes</text>
            <text x="588" y="412" font-size="9" fill="#2d3748">PK grn_id BIGINT</text>
            <text x="588" y="426" font-size="9" fill="#718096">grn_number UNIQUE</text>
            <text x="588" y="440" font-size="9" fill="#e53e3e">FK po_id  purchase_orders</text>
            <text x="588" y="454" font-size="9" fill="#e53e3e">FK supplier_id, store_id</text>
            <text x="588" y="468" font-size="9" fill="#718096">grn_date, invoice_number</text>
            <text x="588" y="482" font-size="9" fill="#718096">subtotal, discount, tax</text>
            <text x="588" y="496" font-size="9" fill="#718096">total_amount, status</text>

            <!-- Stock Movements -->
            <rect x="190" y="460" width="170" height="110" rx="6" fill="#fff" stroke="#319795" stroke-width="2"/>
            <rect x="190" y="460" width="170" height="28" rx="6" fill="#319795"/>
            <text x="275" y="479" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">stock_movements</text>
            <text x="198" y="502" font-size="9" fill="#2d3748">PK movement_id BIGINT</text>
            <text x="198" y="516" font-size="9" fill="#e53e3e">FK store_id, item_id, stock_id</text>
            <text x="198" y="530" font-size="9" fill="#718096">movement_type ENUM</text>
            <text x="198" y="544" font-size="9" fill="#718096">reference_type/id</text>
            <text x="198" y="558" font-size="9" fill="#718096">quantity, balance_after, rate</text>

            <!-- Relationship Lines -->
            <line x1="95" y1="110" x2="95" y2="130" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="95" y1="330" x2="95" y2="350" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="170" y1="220" x2="190" y2="220" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="275" y1="300" x2="275" y2="320" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="360" y1="380" x2="170" y2="380" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>
            <line x1="480" y1="140" x2="480" y2="160" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="560" y1="200" x2="560" y2="240" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="560" y1="240" x2="560" y2="300" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="560" y1="400" x2="560" y2="440" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="480" y1="320" x2="480" y2="340" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="560" y1="440" x2="400" y2="400" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>

            <!-- Section Labels -->
            <rect x="20" y="500" width="150" height="65" rx="6" fill="#ebf8ff" stroke="#3182ce"/>
            <text x="95" y="520" text-anchor="middle" font-weight="bold" font-size="10" fill="#2c5282">PHARMACY</text>
            <text x="95" y="535" text-anchor="middle" font-size="8" fill="#4a5568">Drug Management</text>
            <text x="95" y="550" text-anchor="middle" font-size="8" fill="#4a5568">&amp; Dispensing</text>

            <rect x="400" y="510" width="340" height="55" rx="6" fill="#fef5e7" stroke="#d69e2e"/>
            <text x="570" y="530" text-anchor="middle" font-weight="bold" font-size="10" fill="#744210">INVENTORY MANAGEMENT</text>
            <text x="570" y="548" text-anchor="middle" font-size="8" fill="#4a5568">Procurement, Stock Control &amp; Movement Tracking</text>
        </svg>
    </div>

    <!-- Billing & RBAC Schema -->
    <div class="diagram" style="page-break-before: always;">
        <div class="diagram-title">Billing &amp; Access Control Schema</div>
        <svg width="750" height="550" viewBox="0 0 750 550">
            <!-- Background -->
            <rect x="5" y="5" width="740" height="540" fill="#f8fafc" rx="10"/>

            <!-- Services Table -->
            <rect x="20" y="20" width="170" height="130" rx="6" fill="#fff" stroke="#48bb78" stroke-width="2"/>
            <rect x="20" y="20" width="170" height="28" rx="6" fill="#48bb78"/>
            <text x="105" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">services</text>
            <text x="28" y="62" font-size="9" fill="#2d3748">PK service_id BIGINT</text>
            <text x="28" y="76" font-size="9" fill="#718096">service_code UNIQUE</text>
            <text x="28" y="90" font-size="9" fill="#718096">service_name VARCHAR</text>
            <text x="28" y="104" font-size="9" fill="#e53e3e">FK department_id  depts</text>
            <text x="28" y="118" font-size="9" fill="#718096">service_type ENUM</text>
            <text x="28" y="132" font-size="9" fill="#718096">rate DECIMAL, is_active</text>

            <!-- Bills Table -->
            <rect x="20" y="170" width="170" height="200" rx="6" fill="#fff" stroke="#3182ce" stroke-width="2"/>
            <rect x="20" y="170" width="170" height="28" rx="6" fill="#3182ce"/>
            <text x="105" y="189" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">bills</text>
            <text x="28" y="212" font-size="9" fill="#2d3748">PK bill_id BIGINT</text>
            <text x="28" y="226" font-size="9" fill="#718096">bill_number UNIQUE</text>
            <text x="28" y="240" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="28" y="254" font-size="9" fill="#e53e3e">FK opd_id  opd_visits</text>
            <text x="28" y="268" font-size="9" fill="#e53e3e">FK ipd_id  ipd_admissions</text>
            <text x="28" y="282" font-size="9" fill="#718096">bill_date DATE</text>
            <text x="28" y="296" font-size="9" fill="#718096">bill_type ENUM</text>
            <text x="28" y="310" font-size="9" fill="#718096">subtotal, discount_amount</text>
            <text x="28" y="324" font-size="9" fill="#718096">tax_amount, total_amount</text>
            <text x="28" y="338" font-size="9" fill="#718096">paid_amount, due_amount</text>
            <text x="28" y="352" font-size="9" fill="#718096">payment_status ENUM</text>

            <!-- Bill Details Table -->
            <rect x="210" y="170" width="170" height="150" rx="6" fill="#fff" stroke="#9f7aea" stroke-width="2"/>
            <rect x="210" y="170" width="170" height="28" rx="6" fill="#9f7aea"/>
            <text x="295" y="189" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">bill_details</text>
            <text x="218" y="212" font-size="9" fill="#2d3748">PK detail_id BIGINT</text>
            <text x="218" y="226" font-size="9" fill="#e53e3e">FK bill_id  bills</text>
            <text x="218" y="240" font-size="9" fill="#718096">item_type ENUM</text>
            <text x="218" y="254" font-size="9" fill="#718096">item_id BIGINT</text>
            <text x="218" y="268" font-size="9" fill="#718096">item_name VARCHAR</text>
            <text x="218" y="282" font-size="9" fill="#718096">quantity INT, rate</text>
            <text x="218" y="296" font-size="9" fill="#718096">discount, tax, amount</text>

            <!-- Payments Table -->
            <rect x="20" y="390" width="170" height="150" rx="6" fill="#fff" stroke="#ed8936" stroke-width="2"/>
            <rect x="20" y="390" width="170" height="28" rx="6" fill="#ed8936"/>
            <text x="105" y="409" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">payments</text>
            <text x="28" y="432" font-size="9" fill="#2d3748">PK payment_id BIGINT</text>
            <text x="28" y="446" font-size="9" fill="#718096">payment_number UNIQUE</text>
            <text x="28" y="460" font-size="9" fill="#e53e3e">FK bill_id  bills</text>
            <text x="28" y="474" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="28" y="488" font-size="9" fill="#718096">amount DECIMAL</text>
            <text x="28" y="502" font-size="9" fill="#718096">payment_date, payment_mode</text>
            <text x="28" y="516" font-size="9" fill="#718096">reference_number, status</text>

            <!-- Insurance Claims Table -->
            <rect x="210" y="340" width="170" height="150" rx="6" fill="#fff" stroke="#f56565" stroke-width="2"/>
            <rect x="210" y="340" width="170" height="28" rx="6" fill="#f56565"/>
            <text x="295" y="359" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">insurance_claims</text>
            <text x="218" y="382" font-size="9" fill="#2d3748">PK claim_id BIGINT</text>
            <text x="218" y="396" font-size="9" fill="#718096">claim_number UNIQUE</text>
            <text x="218" y="410" font-size="9" fill="#e53e3e">FK patient_id  patients</text>
            <text x="218" y="424" font-size="9" fill="#e53e3e">FK bill_id  bills</text>
            <text x="218" y="438" font-size="9" fill="#e53e3e">FK insurance_id  ins_co</text>
            <text x="218" y="452" font-size="9" fill="#718096">claimed_amount DECIMAL</text>
            <text x="218" y="466" font-size="9" fill="#718096">approved_amount, settled</text>
            <text x="218" y="480" font-size="9" fill="#718096">status ENUM, settlement_date</text>

            <!-- Hospitals Table -->
            <rect x="420" y="20" width="160" height="120" rx="6" fill="#fff" stroke="#38b2ac" stroke-width="2"/>
            <rect x="420" y="20" width="160" height="28" rx="6" fill="#38b2ac"/>
            <text x="500" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">hospitals</text>
            <text x="428" y="62" font-size="9" fill="#2d3748">PK hospital_id BIGINT</text>
            <text x="428" y="76" font-size="9" fill="#718096">hospital_code UNIQUE</text>
            <text x="428" y="90" font-size="9" fill="#718096">hospital_name VARCHAR</text>
            <text x="428" y="104" font-size="9" fill="#718096">address, phone, email</text>
            <text x="428" y="118" font-size="9" fill="#718096">license_no, is_active</text>

            <!-- Users Table -->
            <rect x="600" y="20" width="140" height="160" rx="6" fill="#fff" stroke="#667eea" stroke-width="2"/>
            <rect x="600" y="20" width="140" height="28" rx="6" fill="#667eea"/>
            <text x="670" y="39" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">users</text>
            <text x="608" y="62" font-size="9" fill="#2d3748">PK user_id BIGINT</text>
            <text x="608" y="76" font-size="9" fill="#e53e3e">FK hospital_id  hosps</text>
            <text x="608" y="90" font-size="9" fill="#718096">name VARCHAR</text>
            <text x="608" y="104" font-size="9" fill="#718096">email UNIQUE</text>
            <text x="608" y="118" font-size="9" fill="#718096">password (hashed)</text>
            <text x="608" y="132" font-size="9" fill="#e53e3e">FK department_id</text>
            <text x="608" y="146" font-size="9" fill="#e53e3e">FK role_id  roles</text>
            <text x="608" y="160" font-size="9" fill="#718096">is_super_admin BOOL</text>

            <!-- Roles Table -->
            <rect x="420" y="160" width="160" height="120" rx="6" fill="#fff" stroke="#d69e2e" stroke-width="2"/>
            <rect x="420" y="160" width="160" height="28" rx="6" fill="#d69e2e"/>
            <text x="500" y="179" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">roles</text>
            <text x="428" y="202" font-size="9" fill="#2d3748">PK role_id BIGINT</text>
            <text x="428" y="216" font-size="9" fill="#e53e3e">FK hospital_id  hospitals</text>
            <text x="428" y="230" font-size="9" fill="#718096">role_code VARCHAR</text>
            <text x="428" y="244" font-size="9" fill="#718096">role_name VARCHAR</text>
            <text x="428" y="258" font-size="9" fill="#718096">is_system_role BOOL</text>
            <text x="428" y="272" font-size="9" fill="#718096">is_active, timestamps</text>

            <!-- Permissions Table -->
            <rect x="600" y="200" width="140" height="120" rx="6" fill="#fff" stroke="#805ad5" stroke-width="2"/>
            <rect x="600" y="200" width="140" height="28" rx="6" fill="#805ad5"/>
            <text x="670" y="219" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">permissions</text>
            <text x="608" y="242" font-size="9" fill="#2d3748">PK permission_id BIGINT</text>
            <text x="608" y="256" font-size="9" fill="#718096">permission_code UNIQUE</text>
            <text x="608" y="270" font-size="9" fill="#718096">permission_name</text>
            <text x="608" y="284" font-size="9" fill="#718096">module VARCHAR</text>
            <text x="608" y="298" font-size="9" fill="#718096">action VARCHAR</text>
            <text x="608" y="312" font-size="9" fill="#718096">description TEXT</text>

            <!-- Role Permissions Pivot -->
            <rect x="420" y="300" width="160" height="90" rx="6" fill="#fff" stroke="#dd6b20" stroke-width="2"/>
            <rect x="420" y="300" width="160" height="28" rx="6" fill="#dd6b20"/>
            <text x="500" y="319" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">role_permissions</text>
            <text x="428" y="342" font-size="9" fill="#e53e3e">PK,FK role_id  roles</text>
            <text x="428" y="356" font-size="9" fill="#e53e3e">PK,FK permission_id  perms</text>
            <text x="428" y="370" font-size="9" fill="#718096">created_at TIMESTAMP</text>

            <!-- User Roles Pivot -->
            <rect x="600" y="340" width="140" height="90" rx="6" fill="#fff" stroke="#e53e3e" stroke-width="2"/>
            <rect x="600" y="340" width="140" height="28" rx="6" fill="#e53e3e"/>
            <text x="670" y="359" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">user_roles</text>
            <text x="608" y="382" font-size="9" fill="#e53e3e">PK,FK user_id  users</text>
            <text x="608" y="396" font-size="9" fill="#e53e3e">PK,FK role_id  roles</text>
            <text x="608" y="410" font-size="9" fill="#e53e3e">FK assigned_by  users</text>
            <text x="608" y="424" font-size="9" fill="#718096">assigned_at TIMESTAMP</text>

            <!-- Audit Logs Table -->
            <rect x="420" y="410" width="160" height="130" rx="6" fill="#fff" stroke="#718096" stroke-width="2"/>
            <rect x="420" y="410" width="160" height="28" rx="6" fill="#718096"/>
            <text x="500" y="429" text-anchor="middle" fill="#fff" font-weight="bold" font-size="10">audit_logs</text>
            <text x="428" y="452" font-size="9" fill="#2d3748">PK log_id BIGINT</text>
            <text x="428" y="466" font-size="9" fill="#e53e3e">FK user_id  users</text>
            <text x="428" y="480" font-size="9" fill="#718096">action VARCHAR</text>
            <text x="428" y="494" font-size="9" fill="#718096">table_name, record_id</text>
            <text x="428" y="508" font-size="9" fill="#718096">old_values JSON</text>
            <text x="428" y="522" font-size="9" fill="#718096">new_values JSON</text>

            <!-- Relationship Lines -->
            <line x1="190" y1="240" x2="210" y2="220" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="105" y1="370" x2="105" y2="390" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="190" y1="340" x2="210" y2="360" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>
            <line x1="580" y1="80" x2="600" y2="80" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="580" y1="220" x2="600" y2="220" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="500" y1="280" x2="500" y2="300" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="580" y1="330" x2="600" y2="360" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="580" y1="330" x2="500" y2="280" stroke="#e53e3e" stroke-width="1.5"/>
            <line x1="670" y1="180" x2="670" y2="200" stroke="#e53e3e" stroke-width="1.5" stroke-dasharray="4"/>
            <line x1="670" y1="320" x2="670" y2="340" stroke="#e53e3e" stroke-width="1.5"/>

            <!-- Section Labels -->
            <rect x="20" y="500" width="360" height="40" rx="6" fill="#ebf8ff" stroke="#3182ce"/>
            <text x="200" y="525" text-anchor="middle" font-weight="bold" font-size="11" fill="#2c5282">BILLING &amp; REVENUE CYCLE</text>

            <rect x="420" y="460" width="320" height="40" rx="6" fill="#faf5ff" stroke="#805ad5"/>
            <text x="580" y="485" text-anchor="middle" font-weight="bold" font-size="11" fill="#553c9a">ROLE-BASED ACCESS CONTROL (RBAC)</text>
        </svg>
    </div>

    <h2>5.5 Key Relationships Summary</h2>

    <table>
        <tr>
            <th>Parent Table</th>
            <th>Child Table</th>
            <th>Relationship</th>
            <th>Foreign Key</th>
        </tr>
        <tr>
            <td>hospitals</td>
            <td>users, patients, doctors, all modules</td>
            <td>One-to-Many</td>
            <td>hospital_id</td>
        </tr>
        <tr>
            <td>patients</td>
            <td>appointments, opd_visits, ipd_admissions, bills</td>
            <td>One-to-Many</td>
            <td>patient_id</td>
        </tr>
        <tr>
            <td>doctors</td>
            <td>appointments, opd_visits, prescriptions</td>
            <td>One-to-Many</td>
            <td>doctor_id</td>
        </tr>
        <tr>
            <td>opd_visits</td>
            <td>prescriptions, lab_orders, radiology_orders</td>
            <td>One-to-Many</td>
            <td>opd_id</td>
        </tr>
        <tr>
            <td>ipd_admissions</td>
            <td>ipd_medications, nursing_notes, bills</td>
            <td>One-to-Many</td>
            <td>ipd_id</td>
        </tr>
        <tr>
            <td>lab_orders</td>
            <td>lab_order_details</td>
            <td>One-to-Many</td>
            <td>order_id</td>
        </tr>
        <tr>
            <td>radiology_orders</td>
            <td>radiology_order_details, radiology_reports</td>
            <td>One-to-Many</td>
            <td>radiology_order_id</td>
        </tr>
        <tr>
            <td>bills</td>
            <td>bill_details, payments</td>
            <td>One-to-Many</td>
            <td>bill_id</td>
        </tr>
        <tr>
            <td>roles</td>
            <td>role_permissions, user_roles</td>
            <td>Many-to-Many</td>
            <td>role_id</td>
        </tr>
        <tr>
            <td>stores</td>
            <td>item_stock, stock_movements, transfers</td>
            <td>One-to-Many</td>
            <td>store_id</td>
        </tr>
        <tr>
            <td>wards</td>
            <td>beds</td>
            <td>One-to-Many</td>
            <td>ward_id</td>
        </tr>
        <tr>
            <td>drugs</td>
            <td>drug_batches, prescription_items</td>
            <td>One-to-Many</td>
            <td>drug_id</td>
        </tr>
    </table>

    <div class="info-box">
        <h4>Multi-Tenancy Implementation</h4>
        <p>All major tables include a <code>hospital_id</code> foreign key that references the <code>hospitals</code> table. This enables:</p>
        <ul>
            <li>Complete data isolation between hospitals</li>
            <li>Single database shared across all tenants</li>
            <li>Global scopes automatically filter queries by current hospital</li>
            <li>Super admin users can switch between hospitals</li>
        </ul>
    </div>
</div>

<!-- Section 6: API Architecture -->
<div class="section">
    <h1>6. API Architecture</h1>

    <h2>6.1 Authentication</h2>

    <p>HIMS uses Laravel Sanctum for API token authentication with two separate guards:</p>

    <table>
        <tr>
            <th>Guard</th>
            <th>User Type</th>
            <th>Token Prefix</th>
            <th>Use Case</th>
        </tr>
        <tr>
            <td>sanctum</td>
            <td>Staff (User model)</td>
            <td>Authorization: Bearer {token}</td>
            <td>Admin, doctors, nurses, staff</td>
        </tr>
        <tr>
            <td>patient</td>
            <td>Patient (PatientUser model)</td>
            <td>Authorization: Bearer {token}</td>
            <td>Patient portal access</td>
        </tr>
    </table>

    <h3>Login Request Example</h3>
    <pre><code>POST /api/login
Content-Type: application/json

{
    "email": "admin@hospital.com",
    "password": "password123"
}

Response:
{
    "success": true,
    "token": "1|abc123xyz...",
    "user": {
        "id": 1,
        "name": "Admin User",
        "email": "admin@hospital.com",
        "current_hospital_id": 1
    }
}</code></pre>

    <h2>6.2 API Endpoint Summary</h2>

    <table>
        <tr>
            <th>Module</th>
            <th>Prefix</th>
            <th>Endpoints</th>
            <th>Methods</th>
        </tr>
        <tr><td>Authentication</td><td>/api</td><td>5</td><td>login, logout, user, change-password, switch-hospital</td></tr>
        <tr><td>Hospitals</td><td>/api/hospitals</td><td>6</td><td>CRUD + stats</td></tr>
        <tr><td>Patients</td><td>/api/patients</td><td>12</td><td>CRUD + history, search, VIP, documents</td></tr>
        <tr><td>Appointments</td><td>/api/appointments</td><td>15</td><td>CRUD + confirm, check-in, cancel, reschedule</td></tr>
        <tr><td>OPD</td><td>/api/opd-visits</td><td>12</td><td>CRUD + consultation workflow</td></tr>
        <tr><td>IPD</td><td>/api/ipd-admissions</td><td>23</td><td>CRUD + case sheet operations</td></tr>
        <tr><td>Laboratory</td><td>/api/lab-*</td><td>8</td><td>Categories, tests, orders, results</td></tr>
        <tr><td>Radiology</td><td>/api/radiology/*</td><td>16</td><td>Full radiology workflow</td></tr>
        <tr><td>OT</td><td>/api/ot/*</td><td>16</td><td>Scheduling, procedures</td></tr>
        <tr><td>Pharmacy</td><td>/api/drug-*</td><td>8</td><td>Drugs, batches, sales</td></tr>
        <tr><td>Inventory</td><td>/api/inventory/*</td><td>18</td><td>Full procurement cycle</td></tr>
        <tr><td>Billing</td><td>/api/services, bills</td><td>10</td><td>Services, billing, payments</td></tr>
        <tr><td>RBAC</td><td>/api/roles</td><td>7</td><td>Roles, permissions</td></tr>
        <tr><td>Notifications</td><td>/api/notifications</td><td>8</td><td>Gateways, templates, send</td></tr>
        <tr><td>Patient Portal</td><td>/api/patient-portal</td><td>15</td><td>Self-service features</td></tr>
        <tr><td>FHIR</td><td>/api/fhir/r4</td><td>7</td><td>FHIR R4 resources</td></tr>
        <tr><td>ABHA</td><td>/api/abha</td><td>9</td><td>Health ID integration</td></tr>
    </table>

    <h2>6.3 Response Formats</h2>

    <h3>Success Response</h3>
    <pre><code>{
    "success": true,
    "data": { ... },
    "message": "Operation successful"
}</code></pre>

    <h3>Paginated Response</h3>
    <pre><code>{
    "data": [ ... ],
    "links": {
        "first": "https://api/resource?page=1",
        "last": "https://api/resource?page=10",
        "prev": null,
        "next": "https://api/resource?page=2"
    },
    "meta": {
        "current_page": 1,
        "last_page": 10,
        "per_page": 15,
        "total": 150
    }
}</code></pre>

    <h3>Validation Error (422)</h3>
    <pre><code>{
    "success": false,
    "message": "The given data was invalid.",
    "errors": {
        "email": ["The email field is required."],
        "password": ["The password must be at least 8 characters."]
    }
}</code></pre>
</div>

<!-- Section 7: Integration -->
<div class="section">
    <h1>7. Integration & Interoperability</h1>

    <h2>7.1 ABHA/ABDM Integration (India)</h2>

    <p>HIMS integrates with India's Ayushman Bharat Digital Mission (ABDM) for health ID management:</p>

    <div class="diagram">
        <div class="diagram-title">ABHA Registration Flow</div>
        <svg width="700" height="120" viewBox="0 0 700 120">
            <rect x="10" y="35" width="110" height="50" rx="8" class="arch-box"/>
            <text x="65" y="55" class="arch-text" font-size="8">Generate</text>
            <text x="65" y="70" class="arch-text" font-size="8">Aadhaar OTP</text>

            <rect x="150" y="35" width="110" height="50" rx="8" class="arch-box"/>
            <text x="205" y="55" class="arch-text" font-size="8">Verify</text>
            <text x="205" y="70" class="arch-text" font-size="8">OTP</text>

            <rect x="290" y="35" width="110" height="50" rx="8" class="arch-box-green"/>
            <text x="345" y="55" class="arch-text" font-size="8">Create</text>
            <text x="345" y="70" class="arch-text" font-size="8">ABHA ID</text>

            <rect x="430" y="35" width="110" height="50" rx="8" class="arch-box-orange"/>
            <text x="485" y="55" class="arch-text" font-size="8">Link to</text>
            <text x="485" y="70" class="arch-text" font-size="8">Patient</text>

            <rect x="570" y="35" width="110" height="50" rx="8" class="arch-box-purple"/>
            <text x="625" y="55" class="arch-text" font-size="8">Share</text>
            <text x="625" y="70" class="arch-text" font-size="8">Records</text>

            <line x1="120" y1="60" x2="150" y2="60" class="arch-arrow"/>
            <line x1="260" y1="60" x2="290" y2="60" class="arch-arrow"/>
            <line x1="400" y1="60" x2="430" y2="60" class="arch-arrow"/>
            <line x1="540" y1="60" x2="570" y2="60" class="arch-arrow"/>
        </svg>
    </div>

    <h2>7.2 FHIR R4 API</h2>

    <p>HIMS exposes FHIR R4 compliant endpoints for healthcare interoperability:</p>

    <table>
        <tr>
            <th>Resource</th>
            <th>Endpoint</th>
            <th>Operations</th>
        </tr>
        <tr>
            <td>CapabilityStatement</td>
            <td>/api/fhir/r4/metadata</td>
            <td>GET (Server capabilities)</td>
        </tr>
        <tr>
            <td>Patient</td>
            <td>/api/fhir/r4/Patient</td>
            <td>Search, Read</td>
        </tr>
        <tr>
            <td>Observation</td>
            <td>/api/fhir/r4/Observation</td>
            <td>Search (Vitals, Lab results)</td>
        </tr>
        <tr>
            <td>DiagnosticReport</td>
            <td>/api/fhir/r4/DiagnosticReport</td>
            <td>Search (Lab, Radiology)</td>
        </tr>
        <tr>
            <td>MedicationRequest</td>
            <td>/api/fhir/r4/MedicationRequest</td>
            <td>Search (Prescriptions)</td>
        </tr>
    </table>

    <h2>7.3 HL7 Messaging</h2>

    <p>Support for HL7 v2.x message processing for legacy system integration:</p>

    <ul>
        <li>ADT (Admit/Discharge/Transfer) messages</li>
        <li>ORM (Order) messages</li>
        <li>ORU (Results) messages</li>
        <li>Message parsing and generation</li>
        <li>Transaction logging</li>
    </ul>
</div>

<!-- Section 8: Security -->
<div class="section">
    <h1>8. Security & Compliance</h1>

    <h2>8.1 Role-Based Access Control</h2>

    <table>
        <tr>
            <th>Role</th>
            <th>Description</th>
            <th>Key Permissions</th>
        </tr>
        <tr>
            <td>super_admin</td>
            <td>System administrator</td>
            <td>All permissions, manage hospitals</td>
        </tr>
        <tr>
            <td>hospital_admin</td>
            <td>Hospital administrator</td>
            <td>All hospital operations, user management</td>
        </tr>
        <tr>
            <td>doctor</td>
            <td>Physician</td>
            <td>OPD, IPD, prescriptions, orders</td>
        </tr>
        <tr>
            <td>nurse</td>
            <td>Nursing staff</td>
            <td>Vitals, nursing charts, medication admin</td>
        </tr>
        <tr>
            <td>receptionist</td>
            <td>Front desk</td>
            <td>Registration, appointments, basic billing</td>
        </tr>
        <tr>
            <td>lab_technician</td>
            <td>Laboratory staff</td>
            <td>Lab orders, sample collection, results</td>
        </tr>
        <tr>
            <td>radiologist</td>
            <td>Radiology staff</td>
            <td>Radiology orders, reports, images</td>
        </tr>
        <tr>
            <td>pharmacist</td>
            <td>Pharmacy staff</td>
            <td>Drug dispensing, sales</td>
        </tr>
        <tr>
            <td>billing_staff</td>
            <td>Billing department</td>
            <td>Bills, payments, refunds</td>
        </tr>
        <tr>
            <td>store_manager</td>
            <td>Inventory manager</td>
            <td>Stock, indents, purchase orders</td>
        </tr>
    </table>

    <h2>8.2 Security Features</h2>

    <div class="module-grid">
        <div class="module-card no-break">
            <h4>Authentication</h4>
            <ul>
                <li>Token-based API authentication</li>
                <li>Password hashing (bcrypt)</li>
                <li>Session management</li>
                <li>OTP verification (patient portal)</li>
            </ul>
        </div>
        <div class="module-card no-break">
            <h4>Authorization</h4>
            <ul>
                <li>Role-based access control</li>
                <li>Permission-based restrictions</li>
                <li>Hospital scope isolation</li>
                <li>Middleware protection</li>
            </ul>
        </div>
        <div class="module-card no-break">
            <h4>Data Protection</h4>
            <ul>
                <li>HTTPS/TLS encryption</li>
                <li>Database encryption at rest</li>
                <li>Sensitive data masking</li>
                <li>Audit logging</li>
            </ul>
        </div>
        <div class="module-card no-break">
            <h4>API Security</h4>
            <ul>
                <li>Rate limiting</li>
                <li>CORS configuration</li>
                <li>Input validation</li>
                <li>SQL injection prevention</li>
            </ul>
        </div>
    </div>

    <h2>8.3 Compliance Considerations</h2>

    <div class="info-box">
        <strong>Healthcare Data Protection:</strong>
        <ul>
            <li>Patient data encryption and access controls</li>
            <li>Audit trail for all data modifications</li>
            <li>Consent management for data sharing</li>
            <li>Role-based data visibility</li>
            <li>Secure file storage for medical documents</li>
        </ul>
    </div>
</div>

<!-- Section 9: Deployment -->
<div class="section">
    <h1>9. Deployment Guide</h1>

    <h2>9.1 Production Deployment Steps</h2>

    <ol>
        <li><strong>Server Preparation</strong>
            <pre><code># Update system
sudo apt update && sudo apt upgrade -y

# Install required packages
sudo apt install nginx php8.2-fpm mysql-server nodejs npm -y

# Install PHP extensions
sudo apt install php8.2-{bcmath,ctype,curl,dom,fileinfo,json,mbstring,openssl,pdo,pdo_mysql,tokenizer,xml,zip,gd} -y</code></pre>
        </li>

        <li><strong>Clone and Configure</strong>
            <pre><code>cd /var/www/html
git clone &lt;repository&gt; hims-laravel
cd hims-laravel
composer install --optimize-autoloader --no-dev
cp .env.example .env
php artisan key:generate</code></pre>
        </li>

        <li><strong>Database Setup</strong>
            <pre><code># Create database
mysql -u root -p -e "CREATE DATABASE hims_production;"

# Configure .env with database credentials
# Run migrations
php artisan migrate --force
php artisan db:seed</code></pre>
        </li>

        <li><strong>Build Frontend</strong>
            <pre><code>npm install
npm run build</code></pre>
        </li>

        <li><strong>Set Permissions</strong>
            <pre><code>sudo chown -R www-data:www-data /var/www/html/hims-laravel
sudo chmod -R 755 /var/www/html/hims-laravel
sudo chmod -R 775 storage bootstrap/cache</code></pre>
        </li>

        <li><strong>Optimize for Production</strong>
            <pre><code>php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan optimize</code></pre>
        </li>
    </ol>

    <h2>9.2 Environment Configuration</h2>

    <pre><code># Application
APP_NAME="HIMS"
APP_ENV=production
APP_DEBUG=false
APP_URL=https://hims.example.com

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=hims_production
DB_USERNAME=hims_user
DB_PASSWORD=secure_password

# Cache & Queue
CACHE_STORE=database
QUEUE_CONNECTION=database
SESSION_DRIVER=database

# Security
SANCTUM_STATEFUL_DOMAINS=hims.example.com</code></pre>
</div>

<!-- Section 10: Maintenance -->
<div class="section">
    <h1>10. Maintenance & Operations</h1>

    <h2>10.1 Backup Procedures</h2>

    <pre><code># Database backup
mysqldump -u hims_user -p hims_production | gzip > backup_$(date +%Y%m%d).sql.gz

# Files backup
tar -czf files_backup_$(date +%Y%m%d).tar.gz /var/www/html/hims-laravel/storage</code></pre>

    <h2>10.2 Monitoring</h2>

    <table>
        <tr>
            <th>Log File</th>
            <th>Location</th>
            <th>Purpose</th>
        </tr>
        <tr>
            <td>Laravel Log</td>
            <td>storage/logs/laravel.log</td>
            <td>Application errors and debug</td>
        </tr>
        <tr>
            <td>Nginx Access</td>
            <td>/var/log/nginx/access.log</td>
            <td>HTTP request logging</td>
        </tr>
        <tr>
            <td>Nginx Error</td>
            <td>/var/log/nginx/error.log</td>
            <td>Server errors</td>
        </tr>
        <tr>
            <td>MySQL Error</td>
            <td>/var/log/mysql/error.log</td>
            <td>Database errors</td>
        </tr>
    </table>

    <h2>10.3 Common Maintenance Commands</h2>

    <pre><code># Clear all caches
php artisan optimize:clear

# Rebuild caches
php artisan optimize

# Check queue status
php artisan queue:failed

# Retry failed jobs
php artisan queue:retry all

# Run migrations
php artisan migrate --force

# View routes
php artisan route:list</code></pre>

    <h2>10.4 Update Procedure</h2>

    <pre><code># 1. Enable maintenance mode
php artisan down --message="System upgrade in progress"

# 2. Backup database
mysqldump -u hims_user -p hims_production > pre_update_backup.sql

# 3. Pull latest code
git pull origin main

# 4. Update dependencies
composer install --optimize-autoloader --no-dev
npm install && npm run build

# 5. Run migrations
php artisan migrate --force

# 6. Clear and rebuild caches
php artisan optimize:clear
php artisan optimize

# 7. Restart services
sudo systemctl restart php8.2-fpm
sudo systemctl restart hims-queue

# 8. Disable maintenance mode
php artisan up</code></pre>
</div>

<!-- Section 11: Troubleshooting -->
<div class="section">
    <h1>11. Troubleshooting</h1>

    <h2>11.1 Common Issues</h2>

    <table>
        <tr>
            <th>Issue</th>
            <th>Possible Cause</th>
            <th>Solution</th>
        </tr>
        <tr>
            <td>500 Internal Server Error</td>
            <td>Permission issues, config error</td>
            <td>Check storage permissions, run php artisan config:clear</td>
        </tr>
        <tr>
            <td>401 Unauthorized</td>
            <td>Invalid or expired token</td>
            <td>Re-authenticate, check token in request header</td>
        </tr>
        <tr>
            <td>Database connection error</td>
            <td>Wrong credentials, MySQL down</td>
            <td>Verify .env settings, check MySQL status</td>
        </tr>
        <tr>
            <td>Queue not processing</td>
            <td>Worker stopped</td>
            <td>Restart queue worker service</td>
        </tr>
        <tr>
            <td>Session issues</td>
            <td>Cookie/session config</td>
            <td>Clear sessions, check SANCTUM_STATEFUL_DOMAINS</td>
        </tr>
        <tr>
            <td>Slow performance</td>
            <td>Missing indexes, N+1 queries</td>
            <td>Enable query logging, add database indexes</td>
        </tr>
    </table>

    <h2>11.2 Debug Commands</h2>

    <pre><code># Check Laravel log
tail -f storage/logs/laravel.log

# Test database connection
php artisan tinker
>>> DB::connection()->getPdo();

# Check PHP configuration
php -i | grep memory_limit

# Test specific route
php artisan route:list --path=patients

# Check queue worker
sudo systemctl status hims-queue</code></pre>
</div>

<!-- Appendix -->
<div class="section">
    <h1>Appendices</h1>

    <h2>A. API Endpoint Quick Reference</h2>

    <table>
        <tr><th>Category</th><th>Endpoints</th></tr>
        <tr><td>Authentication</td><td>POST /login, /logout, /change-password, /switch-hospital</td></tr>
        <tr><td>Patients</td><td>GET/POST /patients, /patients/{id}, /patients-search</td></tr>
        <tr><td>Appointments</td><td>GET/POST /appointments, /appointments/{id}/confirm, /cancel</td></tr>
        <tr><td>OPD</td><td>GET/POST /opd-visits, /start-consultation, /complete-consultation</td></tr>
        <tr><td>IPD</td><td>GET/POST /ipd-admissions, /progress-notes, /nursing-charts</td></tr>
        <tr><td>Lab</td><td>GET/POST /lab-orders, /lab-tests, /lab-categories</td></tr>
        <tr><td>Radiology</td><td>GET/POST /radiology/orders, /reports, /modalities</td></tr>
        <tr><td>OT</td><td>GET/POST /ot/schedules, /procedures, /theaters</td></tr>
        <tr><td>Billing</td><td>GET/POST /services, /bills, /payments</td></tr>
        <tr><td>Inventory</td><td>GET/POST /inventory/items, /indents, /purchase-orders</td></tr>
    </table>

    <h2>B. Environment Variables Reference</h2>

    <table>
        <tr><th>Variable</th><th>Description</th><th>Default</th></tr>
        <tr><td>APP_NAME</td><td>Application name</td><td>HIMS</td></tr>
        <tr><td>APP_ENV</td><td>Environment (local/production)</td><td>production</td></tr>
        <tr><td>APP_DEBUG</td><td>Debug mode</td><td>false</td></tr>
        <tr><td>DB_CONNECTION</td><td>Database driver</td><td>mysql</td></tr>
        <tr><td>CACHE_STORE</td><td>Cache driver</td><td>database</td></tr>
        <tr><td>QUEUE_CONNECTION</td><td>Queue driver</td><td>database</td></tr>
        <tr><td>SESSION_DRIVER</td><td>Session driver</td><td>database</td></tr>
    </table>

    <h2>C. Contact & Support</h2>

    <div class="info-box">
        <p><strong>Technical Support:</strong> support@hims.example.com</p>
        <p><strong>API Documentation:</strong> https://hims.example.com/api-docs/</p>
        <p><strong>System Status:</strong> https://status.hims.example.com</p>
    </div>

    <div style="text-align: center; margin-top: 50px; padding: 30px; background: #f7fafc; border-radius: 10px;">
        <h3 style="color: #2c5282; margin-bottom: 10px;">HIMS - Hospital Information Management System</h3>
        <p style="color: #4a5568;">Version 1.0.0 | January 2026</p>
        <p style="color: #718096; font-size: 10px;">This document is confidential and intended for authorized personnel only.</p>
    </div>
</div>

</body>
</html>
